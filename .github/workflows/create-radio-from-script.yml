name: Create Radio from Script

on:
  workflow_dispatch:
    inputs:
      script:
        description: 'ãƒ©ã‚¸ã‚ªç•ªçµ„ã®å°æœ¬'
        required: true
        type: string

env:
  AIVIS_API_KEY: ${{ secrets.AIVIS_API_KEY }}

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      folder-name: ${{ steps.create-branch.outputs.folder-name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create branch for radio generation
        id: create-branch
        run: |
          BRANCH_NAME="radio/$(date +%Y%m%d)-${{ github.run_id }}"
          FOLDER_NAME="radio-$(date +%Y%m%d)-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin $BRANCH_NAME
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"
          echo "Folder name: $FOLDER_NAME"

  script-analysis:
    runs-on: ubuntu-latest
    needs: [setup-branch]
    permissions:
      contents: write
    outputs:
      analysis-completed: ${{ steps.analysis.outputs.completed }}
      opening-script: ${{ steps.analysis.outputs.opening-script }}
      main-script: ${{ steps.analysis.outputs.main-script }}
      ending-script: ${{ steps.analysis.outputs.ending-script }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: å°æœ¬åˆ†æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ“‹ Script Analysis Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_SCRIPT="${{ inputs.script }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          ANALYSIS_DIR="$FOLDER_NAME/analysis"
          
          echo "User script: $USER_SCRIPT"
          echo "Analysis folder: $ANALYSIS_DIR"
          
          # åˆ†æãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$ANALYSIS_DIR" ]; then
            mkdir -p "$ANALYSIS_DIR"
            echo "ğŸ“ Created analysis folder: $ANALYSIS_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯ãƒ©ã‚¸ã‚ªç•ªçµ„ã®æ§‹æˆä½œå®¶ã§ã™ã€‚æä¾›ã•ã‚ŒãŸå°æœ¬ã‚’åˆ†æã—ã€ã€Œã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã€ã€Œãƒ¡ã‚¤ãƒ³ã€ã€Œã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã€ã®3ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ†å‰²ã—ã¦ãã ã•ã„ã€‚

          **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å°æœ¬**: $USER_SCRIPT

          **ã‚¿ã‚¹ã‚¯**:
          1. å°æœ¬å…¨ä½“ã‚’åˆ†æã—ã€è‡ªç„¶ãªåŒºåˆ‡ã‚Šã§3ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ†å‰²
          2. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ©ã‚¸ã‚ªç•ªçµ„ã¨ã—ã¦è‡ªç„¶ã«èã“ãˆã‚‹ã‚ˆã†èª¿æ•´
          3. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å°æœ¬ã‚’ãã‚Œãã‚Œãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          4. åˆ†æçµæœã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ

          **ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜**:
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: $ANALYSIS_DIR/opening-script.txt
          - ãƒ¡ã‚¤ãƒ³: $ANALYSIS_DIR/main-script.txt
          - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: $ANALYSIS_DIR/ending-script.txt
          - åˆ†æãƒ¬ãƒãƒ¼ãƒˆ: $ANALYSIS_DIR/script-analysis.md
          - å…¨ä½“æ§‹æˆ: $ANALYSIS_DIR/script-structure.json

          **åˆ†å‰²ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³**:
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: æŒ¨æ‹¶ã€å°å…¥ã€ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒç´¹ä»‹ãªã©ï¼ˆç´„30ç§’åˆ†ã€150-200æ–‡å­—ç¨‹åº¦ï¼‰
          - ãƒ¡ã‚¤ãƒ³: ä¸»è¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€è©³ç´°ãªå†…å®¹ï¼ˆç´„30ç§’åˆ†ã€150-200æ–‡å­—ç¨‹åº¦ï¼‰
          - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: ã¾ã¨ã‚ã€ç· ã‚ã®è¨€è‘‰ã€æ¬¡å›äºˆå‘Šãªã©ï¼ˆç´„30ç§’åˆ†ã€150-200æ–‡å­—ç¨‹åº¦ï¼‰
          
          **é‡è¦**: å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ç´„30ç§’ã§èª­ã¿ä¸Šã’ã‚‰ã‚Œã‚‹é•·ã•ï¼ˆ150-200æ–‡å­—ç¨‹åº¦ï¼‰ã«èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
          æ—¥æœ¬èªã®æ¨™æº–çš„ãªèª­ã¿ä¸Šã’é€Ÿåº¦ã¯1ç§’ã‚ãŸã‚Š5-7æ–‡å­—ã§ã™ã€‚

          **æ³¨æ„äº‹é …**:
          - å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ç‹¬ç«‹ã—ã¦éŸ³å£°ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€æ–‡ç« ã¨ã—ã¦å®Œçµã•ã›ã‚‹
          - SSMLå¯¾å¿œã®ãŸã‚ã€é©åˆ‡ãª<break>ã‚¿ã‚°ã‚„<prosody>ã‚¿ã‚°ã‚’è¿½åŠ å¯èƒ½
          - æ„Ÿæƒ…è¡¨ç¾ãŒå¿…è¦ãªç®‡æ‰€ã¯<aivis:emotion>ã‚¿ã‚°ã‚’ä½¿ç”¨
          - txtãƒ•ã‚¡ã‚¤ãƒ«ã¯éŸ³å£°ç”Ÿæˆç”¨ï¼ˆæ”¹è¡Œã‚„SSMLã‚¿ã‚°å«ã‚€ï¼‰

          **JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼**:
          å…¨ä½“ã®æ–‡å­—æ•°ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®æƒ…å ±ã‚’JSONå½¢å¼ã§è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚
          å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ¨å®šæ™‚é–“ã¯30ç§’ã§çµ±ä¸€ã—ã¦ãã ã•ã„ã€‚"
          
          echo "ğŸš€ Starting Script Analysis Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 15 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo ""
          echo "ğŸ“‹ Checking analyzed script files..."
          
          # ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ã®ç¢ºèª
          if [ -f "$ANALYSIS_DIR/opening-script.txt" ]; then
            OPENING_SCRIPT=$(cat "$ANALYSIS_DIR/opening-script.txt" | head -100 | tr '\n' ' ')
            echo "::notice::âœ… Opening script generated"
            echo "Opening preview: ${OPENING_SCRIPT:0:100}..."
            echo "opening-script=$OPENING_SCRIPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Opening script file not found"
            exit 1
          fi
          
          # ãƒ¡ã‚¤ãƒ³å°æœ¬ã®ç¢ºèª
          if [ -f "$ANALYSIS_DIR/main-script.txt" ]; then
            MAIN_SCRIPT=$(cat "$ANALYSIS_DIR/main-script.txt" | head -100 | tr '\n' ' ')
            echo "::notice::âœ… Main script generated"
            echo "Main preview: ${MAIN_SCRIPT:0:100}..."
            echo "main-script=$MAIN_SCRIPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Main script file not found"
            exit 1
          fi
          
          # ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬ã®ç¢ºèª
          if [ -f "$ANALYSIS_DIR/ending-script.txt" ]; then
            ENDING_SCRIPT=$(cat "$ANALYSIS_DIR/ending-script.txt" | head -100 | tr '\n' ' ')
            echo "::notice::âœ… Ending script generated"
            echo "Ending preview: ${ENDING_SCRIPT:0:100}..."
            echo "ending-script=$ENDING_SCRIPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Ending script file not found"
            exit 1
          fi
          
          # åˆ†æãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª
          if [ -f "$ANALYSIS_DIR/script-analysis.md" ]; then
            echo "::notice::âœ… Script analysis report generated"
          else
            echo "::warning::âš ï¸ Script analysis report not found"
          fi
          
          # æ§‹æˆJSONã®ç¢ºèª
          if [ -f "$ANALYSIS_DIR/script-structure.json" ]; then
            echo "::notice::âœ… Script structure JSON generated"
            cat "$ANALYSIS_DIR/script-structure.json"
          else
            echo "::warning::âš ï¸ Script structure JSON not found"
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push analysis
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No analysis files to commit"
          else
            git commit -m "Add script analysis: ${{ inputs.script }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  voice-generation:
    runs-on: ubuntu-latest
    needs: [setup-branch, script-analysis]
    permissions:
      contents: write
    outputs:
      voice-completed: ${{ steps.voice.outputs.completed }}
      opening-duration: ${{ steps.voice.outputs.opening-duration }}
      main-duration: ${{ steps.voice.outputs.main-duration }}
      ending-duration: ${{ steps.voice.outputs.ending-duration }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg sox
          npm install @anthropic-ai/claude-code
      
      - name: éŸ³å£°ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Aivis Cloud API)
        id: voice
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          AIVIS_API_KEY: ${{ secrets.AIVIS_API_KEY }}
        run: |
          echo "::group::ğŸ™ï¸ Voice Generation Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          ANALYSIS_DIR="$FOLDER_NAME/analysis"
          VOICE_DIR="$FOLDER_NAME/voice"
          
          echo "Analysis folder: $ANALYSIS_DIR"
          echo "Voice folder: $VOICE_DIR"
          
          # éŸ³å£°ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$VOICE_DIR" ]; then
            mkdir -p "$VOICE_DIR"
            echo "ğŸ“ Created voice folder: $VOICE_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="Aivis Cloud APIã‚’ä½¿ç”¨ã—ã¦ã€å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®éŸ³å£°ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **APIã‚­ãƒ¼**: ç’°å¢ƒå¤‰æ•°AIVIS_API_KEYã«è¨­å®šæ¸ˆã¿
          **åˆ†æãƒ•ã‚©ãƒ«ãƒ€**: $ANALYSIS_DIR
          **éŸ³å£°ä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€**: $VOICE_DIR

          **ã‚¿ã‚¹ã‚¯**:
          1. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å°æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
             - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: $ANALYSIS_DIR/opening-script.txt
             - ãƒ¡ã‚¤ãƒ³: $ANALYSIS_DIR/main-script.txt
             - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: $ANALYSIS_DIR/ending-script.txt
          
          2. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«Aivis Cloud APIã§éŸ³å£°ç”Ÿæˆ
             - ãƒ¢ãƒ‡ãƒ«UUID: a59cb814-0083-4369-8542-f51a29e72af7
             - å‡ºåŠ›å½¢å¼: mp3
             - SSMLã‚¿ã‚°æœ‰åŠ¹
             - æ„Ÿæƒ…è¡¨ç¾: é©åˆ‡ã«èª¿æ•´
             - è©±é€Ÿ: 1.0ï¼ˆæ¨™æº–ï¼‰
          
          3. ç”Ÿæˆã—ãŸéŸ³å£°ã‚’ä¿å­˜
             - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: $VOICE_DIR/opening-voice.mp3
             - ãƒ¡ã‚¤ãƒ³: $VOICE_DIR/main-voice.mp3
             - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: $VOICE_DIR/ending-voice.mp3
          
          4. å„éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’æ¸¬å®šã—ã¦è¨˜éŒ²
             - ffprobeã¾ãŸã¯soxiã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨
             - çµæœã‚’$VOICE_DIR/voice-durations.jsonã«ä¿å­˜

          **éŸ³å£°ç”Ÿæˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
          - use_ssml: true
          - emotional_intensity: 1.0
          - speaking_rate: 1.0
          - output_format: mp3
          - output_sampling_rate: 44100
          - output_audio_channels: mono
          - output_bitrate: 128

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - APIã‚­ãƒ¼ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—: \$AIVIS_API_KEY
          - Bashãƒ„ãƒ¼ãƒ«ã§curlã‚³ãƒãƒ³ãƒ‰ã§APIã‚’å‘¼ã³å‡ºã™
          - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          - å„éŸ³å£°ã®é•·ã•ï¼ˆç§’ï¼‰ã‚’æ­£ç¢ºã«æ¸¬å®š
          - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’é©åˆ‡ã«å®Ÿè£…

          **éŸ³å£°é•·æ¸¬å®šã®ã‚³ãƒãƒ³ãƒ‰ä¾‹**:
          ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 file.mp3

          **JSONå½¢å¼**:
          {
            \"opening\": {
              \"file\": \"opening-voice.mp3\",
              \"duration_seconds\": æ•°å€¤
            },
            \"main\": {
              \"file\": \"main-voice.mp3\",
              \"duration_seconds\": æ•°å€¤
            },
            \"ending\": {
              \"file\": \"ending-voice.mp3\",
              \"duration_seconds\": æ•°å€¤
            }
          }"
          
          echo "ğŸš€ Starting Voice Generation Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Bash" \
            --max-turns 20 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo ""
          echo "ğŸ™ï¸ Checking generated voice files..."
          
          # å„éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªã¨é•·ã•ã®å–å¾—
          if [ -f "$VOICE_DIR/opening-voice.mp3" ]; then
            OPENING_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$VOICE_DIR/opening-voice.mp3" | cut -d. -f1)
            echo "::notice::âœ… Opening voice generated (${OPENING_DURATION}s)"
            echo "opening-duration=$OPENING_DURATION" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Opening voice file not found"
            exit 1
          fi
          
          if [ -f "$VOICE_DIR/main-voice.mp3" ]; then
            MAIN_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$VOICE_DIR/main-voice.mp3" | cut -d. -f1)
            echo "::notice::âœ… Main voice generated (${MAIN_DURATION}s)"
            echo "main-duration=$MAIN_DURATION" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Main voice file not found"
            exit 1
          fi
          
          if [ -f "$VOICE_DIR/ending-voice.mp3" ]; then
            ENDING_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$VOICE_DIR/ending-voice.mp3" | cut -d. -f1)
            echo "::notice::âœ… Ending voice generated (${ENDING_DURATION}s)"
            echo "ending-duration=$ENDING_DURATION" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Ending voice file not found"
            exit 1
          fi
          
          # éŸ³å£°é•·JSONã®ç¢ºèª
          if [ -f "$VOICE_DIR/voice-durations.json" ]; then
            echo "::notice::âœ… Voice durations JSON generated"
            cat "$VOICE_DIR/voice-durations.json"
          else
            echo "::warning::âš ï¸ Voice durations JSON not found"
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push voice
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No voice files to commit"
          else
            git commit -m "Add generated voice files"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  bgm-generation:
    runs-on: ubuntu-latest
    needs: [setup-branch, script-analysis, voice-generation]
    permissions:
      contents: write
    outputs:
      bgm-completed: ${{ steps.bgm.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: BGMç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: bgm
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸµ BGM Generation Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          ANALYSIS_DIR="$FOLDER_NAME/analysis"
          BGM_DIR="$FOLDER_NAME/bgm"
          OPENING_DURATION="${{ needs.voice-generation.outputs.opening-duration }}"
          MAIN_DURATION="${{ needs.voice-generation.outputs.main-duration }}"
          ENDING_DURATION="${{ needs.voice-generation.outputs.ending-duration }}"
          
          echo "BGM folder: $BGM_DIR"
          echo "Opening duration: ${OPENING_DURATION}s"
          echo "Main duration: ${MAIN_DURATION}s"
          echo "Ending duration: ${ENDING_DURATION}s"
          
          # BGMãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$BGM_DIR" ]; then
            mkdir -p "$BGM_DIR"
            echo "ğŸ“ Created BGM folder: $BGM_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "ğŸ“‹ MCP Configuration Check:"
          echo "Working directory: $(pwd)"
          echo "MCP config path: $MCP_CONFIG_PATH"
          echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="MCPãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®BGMã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **BGMä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€**: $BGM_DIR
          **å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é•·ã•**:
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: ${OPENING_DURATION}ç§’
          - ãƒ¡ã‚¤ãƒ³: ${MAIN_DURATION}ç§’
          - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: ${ENDING_DURATION}ç§’

          **ã‚¿ã‚¹ã‚¯**:
          1. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å°æœ¬å†…å®¹ã‚’åˆ†æï¼ˆ$ANALYSIS_DIRå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«å‚ç…§ï¼‰
          2. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«é©ã—ãŸBGMã‚’MCPãƒ„ãƒ¼ãƒ«ã§ç”Ÿæˆ
          3. ç”Ÿæˆã—ãŸBGMã‚’ä¿å­˜

          **BGMç”Ÿæˆã®è¦ä»¶**:
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: æ˜ã‚‹ãæœŸå¾…æ„Ÿã®ã‚ã‚‹BGMï¼ˆ${OPENING_DURATION}ç§’ï¼‰
            â†’ ãƒ•ã‚¡ã‚¤ãƒ«å: $BGM_DIR/opening-bgm.mp3
          - ãƒ¡ã‚¤ãƒ³: è½ã¡ç€ã„ãŸé›°å›²æ°—ã®BGMï¼ˆ${MAIN_DURATION}ç§’ï¼‰
            â†’ ãƒ•ã‚¡ã‚¤ãƒ«å: $BGM_DIR/main-bgm.mp3
          - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: ç· ã‚ããã‚Šã«é©ã—ãŸBGMï¼ˆ${ENDING_DURATION}ç§’ï¼‰
            â†’ ãƒ•ã‚¡ã‚¤ãƒ«å: $BGM_DIR/ending-bgm.mp3

          **BGMç”Ÿæˆã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³**:
          - ãƒ©ã‚¸ã‚ªç•ªçµ„ã®BGMã¨ã—ã¦é©åˆ‡ãªéŸ³é‡ã¨é›°å›²æ°—
          - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é‚ªé­”ã«ãªã‚‰ãªã„æ§ãˆã‚ãªéŸ³æ¥½
          - å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é›°å›²æ°—ã«åˆã‚ã›ãŸé¸æ›²
          - é•·ã•ã¯å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®éŸ³å£°ã«åˆã‚ã›ã‚‹

          **ä½¿ç”¨å¯èƒ½ãªMCPãƒ„ãƒ¼ãƒ«**:
          - mcp__bgm-fal-musicgen-large__musicgen_large_submit
          - mcp__bgm-fal-musicgen-large__musicgen_large_status
          - mcp__bgm-fal-musicgen-large__musicgen_large_result
          ã¾ãŸã¯ä»–ã®é©åˆ‡ãªBGMç”ŸæˆMCPãƒ„ãƒ¼ãƒ«

          **é‡è¦**:
          - ç”Ÿæˆã•ã‚ŒãŸBGMã®URLã‚’å–å¾—å¾Œã€å¿…ãšBashãƒ„ãƒ¼ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯æŒ‡å®šé€šã‚Šã«ä¿å­˜
          - å„BGMã®å®Ÿéš›ã®é•·ã•ã‚’ç¢ºèªã—ã¦ãƒ­ã‚°ã«å‡ºåŠ›"
          
          echo "ğŸš€ Starting BGM Generation Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "Read,Write,Bash,mcp__bgm-fal-musicgen-large__musicgen_large_submit,mcp__bgm-fal-musicgen-large__musicgen_large_status,mcp__bgm-fal-musicgen-large__musicgen_large_result" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸBGMãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo ""
          echo "ğŸµ Checking generated BGM files..."
          
          if [ -f "$BGM_DIR/opening-bgm.mp3" ]; then
            echo "::notice::âœ… Opening BGM generated"
            ls -lh "$BGM_DIR/opening-bgm.mp3"
          else
            echo "::error::âŒ Opening BGM file not found"
            exit 1
          fi
          
          if [ -f "$BGM_DIR/main-bgm.mp3" ]; then
            echo "::notice::âœ… Main BGM generated"
            ls -lh "$BGM_DIR/main-bgm.mp3"
          else
            echo "::error::âŒ Main BGM file not found"
            exit 1
          fi
          
          if [ -f "$BGM_DIR/ending-bgm.mp3" ]; then
            echo "::notice::âœ… Ending BGM generated"
            ls -lh "$BGM_DIR/ending-bgm.mp3"
          else
            echo "::error::âŒ Ending BGM file not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push BGM
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No BGM files to commit"
          else
            git commit -m "Add generated BGM files"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  audio-mixing:
    runs-on: ubuntu-latest
    needs: [setup-branch, voice-generation, bgm-generation]
    permissions:
      contents: write
    outputs:
      mixing-completed: ${{ steps.mixing.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg sox
          npm install @anthropic-ai/claude-code
      
      - name: éŸ³å£°ãƒŸã‚­ã‚·ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: mixing
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ§ Audio Mixing Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          VOICE_DIR="$FOLDER_NAME/voice"
          BGM_DIR="$FOLDER_NAME/bgm"
          FINAL_DIR="$FOLDER_NAME/final"
          
          echo "Voice folder: $VOICE_DIR"
          echo "BGM folder: $BGM_DIR"
          echo "Final folder: $FINAL_DIR"
          
          # æœ€çµ‚å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$FINAL_DIR" ]; then
            mkdir -p "$FINAL_DIR"
            echo "ğŸ“ Created final folder: $FINAL_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ffmpegã‚’ä½¿ç”¨ã—ã¦ã€éŸ³å£°ã¨BGMã‚’çµåˆã—ã€æœ€çµ‚çš„ãªãƒ©ã‚¸ã‚ªç•ªçµ„ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **ç´ æãƒ•ã‚©ãƒ«ãƒ€**:
          - éŸ³å£°: $VOICE_DIR
          - BGM: $BGM_DIR
          - æœ€çµ‚å‡ºåŠ›: $FINAL_DIR

          **ã‚¿ã‚¹ã‚¯**:
          1. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®éŸ³å£°ã¨BGMã‚’çµåˆï¼ˆBGMéŸ³é‡ã¯60%ã«èª¿æ•´ï¼‰
             - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: opening-voice.mp3 + opening-bgm.mp3 â†’ opening-mixed.mp3
             - ãƒ¡ã‚¤ãƒ³: main-voice.mp3 + main-bgm.mp3 â†’ main-mixed.mp3
             - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: ending-voice.mp3 + ending-bgm.mp3 â†’ ending-mixed.mp3
          
          2. 3ã¤ã®ãƒŸãƒƒã‚¯ã‚¹æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã«çµåˆ
             - å‡ºåŠ›: $FINAL_DIR/radio-program.mp3
          
          3. æœ€çµ‚çš„ãªãƒ©ã‚¸ã‚ªç•ªçµ„ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
             - $FINAL_DIR/radio-metadata.json

          **ffmpegã‚³ãƒãƒ³ãƒ‰ã®ä¾‹**:
          # éŸ³å£°ã¨BGMã®ãƒŸãƒƒã‚¯ã‚¹ï¼ˆBGMéŸ³é‡60%ï¼‰
          ffmpeg -i voice.mp3 -i bgm.mp3 -filter_complex \"[1:a]volume=0.6[bgm];[0:a][bgm]amix=inputs=2:duration=first:dropout_transition=2\" -c:a mp3 -b:a 192k mixed.mp3
          
          # è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®çµåˆ
          ffmpeg -i \"concat:file1.mp3|file2.mp3|file3.mp3\" -acodec copy output.mp3
          
          **æ³¨æ„äº‹é …**:
          - BGMã®éŸ³é‡ã¯éŸ³å£°ãŒèãå–ã‚Šã‚„ã™ã„ã‚ˆã†60%ã«èª¿æ•´
          - å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã«0.5ç§’ã®ç„¡éŸ³ã‚’æŒ¿å…¥
          - æœ€çµ‚å‡ºåŠ›ã¯é«˜å“è³ªï¼ˆ192kbpsï¼‰ã§ä¿å­˜
          - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’é©åˆ‡ã«å®Ÿè£…

          **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿JSONå½¢å¼**:
          {
            \"title\": \"AI Generated Radio Program\",
            \"created_at\": \"YYYY-MM-DD HH:MM:SS\",
            \"total_duration_seconds\": æ•°å€¤,
            \"sections\": {
              \"opening\": \"é•·ã•\",
              \"main\": \"é•·ã•\",
              \"ending\": \"é•·ã•\"
            },
            \"format\": \"mp3\",
            \"bitrate\": \"192kbps\"
          }"
          
          echo "ğŸš€ Starting Audio Mixing Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Bash" \
            --max-turns 15 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # æœ€çµ‚å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo ""
          echo "ğŸ§ Checking final radio program..."
          
          if [ -f "$FINAL_DIR/radio-program.mp3" ]; then
            echo "::notice::âœ… Final radio program generated"
            ls -lh "$FINAL_DIR/radio-program.mp3"
            
            # æœ€çµ‚ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’å–å¾—
            TOTAL_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$FINAL_DIR/radio-program.mp3")
            echo "Total duration: ${TOTAL_DURATION} seconds"
          else
            echo "::error::âŒ Final radio program file not found"
            exit 1
          fi
          
          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
          if [ -f "$FINAL_DIR/radio-metadata.json" ]; then
            echo "::notice::âœ… Radio metadata generated"
            cat "$FINAL_DIR/radio-metadata.json"
          else
            echo "::warning::âš ï¸ Radio metadata not found"
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push final audio
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No final audio files to commit"
          else
            git commit -m "Add final radio program"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  create-pr:
    runs-on: ubuntu-latest
    needs: [setup-branch, script-analysis, voice-generation, bgm-generation, audio-mixing]
    permissions:
      contents: write
      pull-requests: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          BRANCH_NAME="${{ needs.setup-branch.outputs.branch-name }}"
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æœ€çµ‚æˆæœç‰©ã®ç¢ºèªã¨ã‚³ãƒŸãƒƒãƒˆ
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          echo "=== Final Radio Generation Summary ==="
          echo "Radio folder: $FOLDER_NAME"
          
          VOICE_COUNT=0
          BGM_COUNT=0
          FINAL_COUNT=0
          
          if [ -d "$FOLDER_NAME" ]; then
            echo "âœ… Radio folder exists: $FOLDER_NAME"
            echo "Contents:"
            ls -la "$FOLDER_NAME"
            
            # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -d "$FOLDER_NAME/voice" ]; then
              VOICE_COUNT=$(find "$FOLDER_NAME/voice" -name "*.mp3" | wc -l)
              echo "âœ… Voice directory exists with $VOICE_COUNT files"
            fi
            
            # BGMãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -d "$FOLDER_NAME/bgm" ]; then
              BGM_COUNT=$(find "$FOLDER_NAME/bgm" -name "*.mp3" | wc -l)
              echo "âœ… BGM directory exists with $BGM_COUNT files"
            fi
            
            # æœ€çµ‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -d "$FOLDER_NAME/final" ]; then
              FINAL_COUNT=$(find "$FOLDER_NAME/final" -name "*.mp3" | wc -l)
              echo "âœ… Final directory exists with $FINAL_COUNT files"
            fi
          fi
          
          # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add "$FOLDER_NAME/" 2>/dev/null || true
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
          COMMIT_MESSAGE="Add new AI-generated radio program
          
          å°æœ¬: ${{ inputs.script }}
          ç”Ÿæˆæ—¥æ™‚: $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC
          
          ğŸ“Š Generation Summary:
          - Voice files: $VOICE_COUNT (Aivis Cloud API)
          - BGM files: $BGM_COUNT (MCP Tools)
          - Final program: $FINAL_COUNT
          
          ğŸ¤– Generated with Claude Code SDK & kamuicode MCP
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          # ã‚³ãƒŸãƒƒãƒˆ
          if git diff --cached --quiet; then
            echo "Warning: No changes to commit"
            git commit --allow-empty -m "$COMMIT_MESSAGE"
          else
            git commit -m "$COMMIT_MESSAGE"
          fi
          
          # ãƒ—ãƒƒã‚·ãƒ¥
          git push origin $BRANCH_NAME
          
          # æœ€çµ‚ãƒ©ã‚¸ã‚ªç•ªçµ„ã®ãƒ‘ã‚¹å–å¾—
          FINAL_RADIO_PATH=""
          if [ -f "$FOLDER_NAME/final/radio-program.mp3" ]; then
            FINAL_RADIO_PATH="$FOLDER_NAME/final/radio-program.mp3"
          fi
          
          # GitHub Actions Summaryã«çµæœã‚’å‡ºåŠ›
          echo "# ğŸ“» AIãƒ©ã‚¸ã‚ªç•ªçµ„ç”Ÿæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ ç”Ÿæˆæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **å°æœ¬ï¼ˆå†’é ­ï¼‰**: ${{ inputs.script }}:0:100}..." >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿæˆæ—¥æ™‚**: $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“Š ç”Ÿæˆçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ™ï¸ **éŸ³å£°**: $VOICE_COUNT ãƒ•ã‚¡ã‚¤ãƒ« (Aivis Cloud API)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸµ **BGM**: $BGM_COUNT ãƒ•ã‚¡ã‚¤ãƒ« (MCP Tools)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“» **æœ€çµ‚ç•ªçµ„**: $FINAL_COUNT ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$FINAL_RADIO_PATH" ]; then
            echo "## ğŸ“» ç”Ÿæˆã•ã‚ŒãŸãƒ©ã‚¸ã‚ªç•ªçµ„" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ **ãƒ•ã‚¡ã‚¤ãƒ«**: \`$FINAL_RADIO_PATH\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã¯GitHub Actions Summaryã§ã¯å†ç”Ÿã§ãã¾ã›ã‚“ã€‚ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”— æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          echo "1. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ©ã‚¸ã‚ªç•ªçµ„ã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "2. å¿…è¦ã«å¿œã˜ã¦ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ãƒœãƒ‡ã‚£ã‚’ä½œæˆ
          PR_BODY="ğŸ¤– Claude Code SDK & kamuicode MCPã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ©ã‚¸ã‚ªç•ªçµ„ã§ã™."
          PR_BODY="$PR_BODY"$'\n\n'"å°æœ¬ï¼ˆå†’é ­ï¼‰: ${{ inputs.script }}:0:200}..."
          PR_BODY="$PR_BODY"$'\n\n'"ç”Ÿæˆãƒ•ãƒ­ãƒ¼:"
          PR_BODY="$PR_BODY"$'\n'"1. ğŸ“‹ å°æœ¬ã‚’3ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ†æãƒ»åˆ†å‰²"
          PR_BODY="$PR_BODY"$'\n'"2. ğŸ™ï¸ Aivis Cloud APIã§å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®éŸ³å£°ç”Ÿæˆ"
          PR_BODY="$PR_BODY"$'\n'"3. ğŸµ MCPãƒ„ãƒ¼ãƒ«ã§å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®BGMç”Ÿæˆ"
          PR_BODY="$PR_BODY"$'\n'"4. ğŸ§ ffmpegã§éŸ³å£°ã¨BGMã‚’çµåˆ"
          PR_BODY="$PR_BODY"$'\n\n'"æˆæœç‰©:"
          PR_BODY="$PR_BODY"$'\n'"- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«: $VOICE_COUNT"
          PR_BODY="$PR_BODY"$'\n'"- BGMãƒ•ã‚¡ã‚¤ãƒ«: $BGM_COUNT"
          PR_BODY="$PR_BODY"$'\n'"- æœ€çµ‚ç•ªçµ„: $FINAL_COUNT"
          
          if [ -n "$FINAL_RADIO_PATH" ]; then
            # GitHubã®ç”Ÿãƒ•ã‚¡ã‚¤ãƒ«URLæ§‹ç¯‰
            GITHUB_AUDIO_URL="https://github.com/${{ github.repository }}/raw/$BRANCH_NAME/$FINAL_RADIO_PATH"
            PR_BODY="$PR_BODY"$'\n\n'"## ğŸ“» ç”Ÿæˆã•ã‚ŒãŸãƒ©ã‚¸ã‚ªç•ªçµ„"
            PR_BODY="$PR_BODY"$'\n\n'"<audio controls>"
            PR_BODY="$PR_BODY"$'\n'"  <source src=\"$GITHUB_AUDIO_URL\" type=\"audio/mpeg\">"
            PR_BODY="$PR_BODY"$'\n'"  ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚"
            PR_BODY="$PR_BODY"$'\n'"  <a href=\"$GITHUB_AUDIO_URL\">éŸ³å£°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å†ç”Ÿ</a>"
            PR_BODY="$PR_BODY"$'\n'"</audio>"
            PR_BODY="$PR_BODY"$'\n\n'"ğŸ“ **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: \`$FINAL_RADIO_PATH\`"
          fi
          
          PR_BODY="$PR_BODY
          
          ---
          ğŸ¤– Generated with [Claude Code SDK & kamuicode MCP](https://github.com/AI-Summoner/ai-summoner)"
          
          # PRä½œæˆ
          gh pr create \
            --title "æ–°ã—ã„AIç”Ÿæˆãƒ©ã‚¸ã‚ªç•ªçµ„: ${{ inputs.script }}:0:50}..." \
            --body "$PR_BODY" \
            --base main \
            --head $BRANCH_NAME