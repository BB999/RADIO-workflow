name: BGM Generation Ending (Minimal)
on:
  workflow_call:
    outputs:
      bgm-url:
        value: ${{ jobs.generate.outputs.url }}
      bgm-file:
        value: ${{ jobs.generate.outputs.file }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.bgm.outputs.music-url }}
      file: ${{ steps.bgm.outputs.music-file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code --ignore-scripts
      
      - name: Generate Ending BGM with Google Lyria
        id: bgm
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸµ Ending BGM Generation with Google Lyria"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="kamuicodeã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°BGMã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          ã€BGMè¦ä»¶ã€‘
          - é•·ã•: 15ç§’ï¼ˆãƒ«ãƒ¼ãƒ—ç”¨ãƒ™ãƒ¼ã‚¹éŸ³æ¥½ï¼‰
          - ã‚¹ã‚¿ã‚¤ãƒ«: æ¸©ã‹ã„ç· ã‚ããã‚Šç³»ã€æ„Ÿè¬ã‚’è¾¼ã‚ãŸ
          - é›°å›²æ°—: å®‰ã‚‰ãã€æ¬¡å›ã¸ã®æœŸå¾…æ„Ÿã€æ„Ÿè¬ã®æ°—æŒã¡
          - æ¥½å™¨: ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹ã€æš–ã‹ã„ãƒ”ã‚¢ãƒã€å„ªã—ã„ã‚·ãƒ³ã‚»ãƒ‘ãƒƒãƒ‰
          - ç‰¹å¾´: ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã‚„ã™ã„æ§‹æˆã€ä½™éŸ»ãŒæ®‹ã‚‹

          ã€ç”Ÿæˆè¨­å®šã€‘
          - ãƒ¢ãƒ‡ãƒ«: Google Lyria (msc-google-lyria)
          - å“è³ª: é«˜å“è³ª
          - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: WAV

          ç”Ÿæˆã•ã‚ŒãŸBGMã®URLã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"
          
          echo "ğŸš€ Starting Ending BGM Generation..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          echo "ğŸ¤– Claude Code CLIå®Ÿè¡Œé–‹å§‹"
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            echo "âœ… MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            
            # Claude Codeã®å®Ÿè¡Œã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            BGM_RESULT=$(timeout 300 npx @anthropic-ai/claude-code \
              --mcp-config="$MCP_CONFIG_ABS_PATH" \
              --print \
              --verbose \
              "$PROMPT" 2>&1) || {
                CLAUDE_EXIT_CODE=$?
                echo "::warning::âš ï¸ Claude Codeå®Ÿè¡Œå¤±æ•— (exit code: $CLAUDE_EXIT_CODE)"
                if [ $CLAUDE_EXIT_CODE -eq 124 ]; then
                  echo "::warning::âš ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ (5åˆ†)"
                fi
                echo "::warning::ã‚¨ãƒ©ãƒ¼å‡ºåŠ›: $BGM_RESULT"
                BGM_RESULT=""
              }
          else
            echo "::warning::âš ï¸ MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $MCP_CONFIG_ABS_PATH"
            echo "::warning::ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:"
            ls -la || true
            BGM_RESULT=""
          fi
          
          echo "ğŸµ BGMç”Ÿæˆçµæœ (æœ€åˆã®500æ–‡å­—):"
          echo "$BGM_RESULT" | head -c 500
          echo ""
          
          # çµæœã‹ã‚‰URLã‚’æŠ½å‡º
          MUSIC_URL=$(echo "$BGM_RESULT" | grep -oP 'https://[^\s]+\.(wav|mp3|m4a)' | head -1)
          MUSIC_FILE="bgm-ending.wav"
          
          echo "ğŸ” URLæŠ½å‡ºçµæœ: '$MUSIC_URL'"
          
          # URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          if [ ! -z "$MUSIC_URL" ] && [[ "$MUSIC_URL" =~ ^https:// ]]; then
            echo "âœ… æœ‰åŠ¹ãªBGM URLãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $MUSIC_URL"
            
            # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
            if curl -L "$MUSIC_URL" -o "$MUSIC_FILE" --max-time 60; then
              if [ -s "$MUSIC_FILE" ]; then
                FILE_SIZE=$(stat -c%s "$MUSIC_FILE")
                echo "âœ… BGMãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ (${FILE_SIZE} bytes)"
                
                # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç°¡æ˜“æ¤œè¨¼
                file "$MUSIC_FILE"
                
                # ffmpegã§ãƒ«ãƒ¼ãƒ—æ‹¡å¼µ
                sudo apt-get update && sudo apt-get install -y ffmpeg
                if ffmpeg -stream_loop -1 -i "$MUSIC_FILE" -t 30 -ar 44100 -ac 2 -c:a pcm_s16le "bgm-ending-30s.wav" -y; then
                  echo "âœ… BGMãƒ«ãƒ¼ãƒ—æ‹¡å¼µæˆåŠŸ"
                  echo "music-url=$MUSIC_URL" >> $GITHUB_OUTPUT
                  echo "music-file=bgm-ending-30s.wav" >> $GITHUB_OUTPUT
                else
                  echo "::error::âŒ ffmpegå‡¦ç†å¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨"
                fi
              else
                echo "::warning::âš ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™"
              fi
            else
              echo "::warning::âš ï¸ BGMãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
            fi
          fi
          
          # BGMç”Ÿæˆå¤±æ•—æ™‚ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åœæ­¢
          if [ ! -f "bgm-ending-30s.wav" ] || [ ! -s "bgm-ending-30s.wav" ]; then
            echo "::error::âŒ BGMç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "::error::è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°:"
            echo "::error::Claude Codeå®Ÿè¡Œçµæœ: $BGM_RESULT"
            echo "::error::æŠ½å‡ºã•ã‚ŒãŸURL: '$MUSIC_URL'"
            echo "::error::ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:"
            ls -la || true
            echo "::error::MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
            if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
              echo "::error::MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™: $MCP_CONFIG_ABS_PATH"
              head -20 "$MCP_CONFIG_ABS_PATH" || true
            else
              echo "::error::MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $MCP_CONFIG_ABS_PATH"
            fi
            exit 1
          fi
          
          # æœ€çµ‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
          if [ -f "bgm-ending-30s.wav" ]; then
            FINAL_SIZE=$(stat -c%s "bgm-ending-30s.wav")
            echo "âœ… æœ€çµ‚BGMãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå®Œäº† (${FINAL_SIZE} bytes)"
          else
            echo "::error::âŒ æœ€çµ‚BGMãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
          
          echo "::endgroup::"
      
      - name: Upload BGM artifact
        uses: actions/upload-artifact@v4
        with:
          name: bgm-ending
          path: bgm-ending-30s.wav
          retention-days: 1