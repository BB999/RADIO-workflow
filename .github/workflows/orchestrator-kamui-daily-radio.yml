name: Kamui Daily Radio Production (Minimal)
on:
  workflow_dispatch:
    inputs:
      development-report:
        description: 'ç¥å¨ã‚¢ãƒ—ãƒªã®é–‹ç™ºé€²æ—ãƒ»æœ€æ–°æƒ…å ±'
        required: true
        type: string
      public:
        description: 'å…¬é–‹è¨­å®š'
        required: false
        type: boolean
        default: false
      gemini-summary:
        description: 'Geminiã¾ã¨ã‚'
        required: false
        type: boolean
        default: false

permissions:
  contents: write  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆã«å¿…è¦
  pull-requests: write  # PRä½œæˆã«å¿…è¦

jobs:
  api-check:
    runs-on: ubuntu-latest
    outputs:
      api-status: ${{ steps.check.outputs.status }}
    steps:
      - name: Check API availability
        id: check
        run: |
          echo "ğŸ” APIæ¥ç¶šãƒã‚§ãƒƒã‚¯é–‹å§‹..."
          
          AIVIS_STATUS="failed"
          
          # AIVIS Cloud API å‹•ä½œãƒã‚§ãƒƒã‚¯
          echo "ğŸ“¡ AIVIS Cloud API å‹•ä½œãƒã‚§ãƒƒã‚¯ä¸­..."
          
          # APIã‚­ãƒ¼ç¢ºèª
          if [ -z "${{ secrets.AIVIS_API_KEY }}" ]; then
            echo "::error::AIVIS_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "::error::GitHub Secrets ã« AIVIS_API_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„"
            AIVIS_STATUS="missing_key"
          else
            echo "âœ… APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ (å…ˆé ­10æ–‡å­—: ${AIVIS_API_KEY:0:10}...)"
            
            # è©³ç´°ãªcurlãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
            echo "ğŸ” APIæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹..."
            echo "  ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: https://api.aivis-project.com/v1/tts/synthesize"
            echo "  ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£: {\"model_uuid\": \"test\", \"text\": \"ãƒ†ã‚¹ãƒˆ\", \"output_format\": \"wav\"}"
            
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
            RESPONSE_FILE="aivis_response.json"
            ERROR_FILE="aivis_error.txt"
            
            # curlã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰
            HTTP_STATUS=$(curl -s -w "%{http_code}" \
              -X POST "https://api.aivis-project.com/v1/tts/synthesize" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.AIVIS_API_KEY }}" \
              -d '{
                "model_uuid": "test",
                "text": "ãƒ†ã‚¹ãƒˆ",
                "output_format": "wav"
              }' \
              --connect-timeout 30 \
              --max-time 60 \
              -o "$RESPONSE_FILE" \
              --stderr "$ERROR_FILE" \
              --verbose) || {
                echo "::error::curlå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
                echo "::error::curlã‚¨ãƒ©ãƒ¼è©³ç´°:"
                cat "$ERROR_FILE" || echo "ã‚¨ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“"
                HTTP_STATUS="000"
            }
            
            echo "ğŸ“Š APIãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°:"
            echo "  HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: $HTTP_STATUS"
            echo "  ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(stat -c%s "$RESPONSE_FILE" 2>/dev/null || echo "0") bytes"
            
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã®è¡¨ç¤ºï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰
            if [ -f "$RESPONSE_FILE" ]; then
              echo "  ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ï¼ˆå…ˆé ­500æ–‡å­—ï¼‰:"
              head -c 500 "$RESPONSE_FILE" || echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“"
            fi
            
            # ã‚¨ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤º
            if [ -f "$ERROR_FILE" ] && [ -s "$ERROR_FILE" ]; then
              echo "  curlã‚¨ãƒ©ãƒ¼å‡ºåŠ›:"
              cat "$ERROR_FILE"
            fi
            
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… AIVIS Cloud API å‹•ä½œç¢ºèªæˆåŠŸ"
              AIVIS_STATUS="ok"
            elif [ "$HTTP_STATUS" = "422" ]; then
              echo "âœ… AIVIS Cloud API å‹•ä½œç¢ºèªæˆåŠŸ (ãƒ†ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹æ¤œè¨¼å¿œç­”)"
              echo "  APIã‚µãƒ¼ãƒãƒ¼ãŒæ­£å¸¸ã«å¿œç­”ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼ã®æ¤œè¨¼ãŒå‹•ä½œã—ã¦ã„ã¾ã™"
              AIVIS_STATUS="ok"
            elif [ "$HTTP_STATUS" = "401" ]; then
              echo "::error::AIVIS Cloud API èªè¨¼å¤±æ•— (HTTP 401)"
              echo "::error::APIã‚­ãƒ¼ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            elif [ "$HTTP_STATUS" = "403" ]; then
              echo "::error::AIVIS Cloud API ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ (HTTP 403)"
              echo "::error::APIã‚­ãƒ¼ã«ååˆ†ãªæ¨©é™ãŒãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            elif [ "$HTTP_STATUS" = "429" ]; then
              echo "::error::AIVIS Cloud API ãƒ¬ãƒ¼ãƒˆåˆ¶é™ (HTTP 429)"
              echo "::error::ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ãŒåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚å¾Œã§å†è©¦è¡Œã—ã¦ãã ã•ã„"
            elif [ "$HTTP_STATUS" = "000" ]; then
              echo "::error::AIVIS Cloud API æ¥ç¶šå¤±æ•—"
              echo "::error::ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã§ã™"
            else
              echo "::error::AIVIS Cloud API äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ (HTTP $HTTP_STATUS)"
              echo "::error::ã‚µãƒ¼ãƒ“ã‚¹å´ã®å•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            fi
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            rm -f "$RESPONSE_FILE" "$ERROR_FILE"
          fi
          
          # å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
          if [ "$AIVIS_STATUS" = "ok" ]; then
            echo "âœ… AIVIS Cloud APIå‹•ä½œãƒã‚§ãƒƒã‚¯å®Œäº† - å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™"
            echo "status=ready" >> $GITHUB_OUTPUT
          else
            echo "::error::AIVIS Cloud APIã®å‹•ä½œãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åœæ­¢ã—ã¾ã™ã€‚"
            echo "aivis_status=$AIVIS_STATUS" >> $GITHUB_OUTPUT
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

  input-processing:
    needs: api-check
    if: ${{ inputs.gemini-summary == true }}
    uses: ./.github/workflows/module-input-processing.yml
    with:
      development-report: ${{ inputs.development-report }}
    secrets: inherit

  planning:
    needs: [api-check]
    if: needs.api-check.result == 'success'
    uses: ./.github/workflows/module-radio-planning.yml
    with:
      processed-summary: ''
      use-processed-input: false
      development-report: ${{ inputs.development-report }}
    secrets: inherit

  voice-opening:
    needs: planning
    if: needs.planning.result == 'success'
    uses: ./.github/workflows/module-voice-generation-opening.yml
    with:
      script-text: ${{ needs.planning.outputs.script-opening }}
      voice-config: ${{ needs.planning.outputs.voice-config }}
    secrets: inherit

  voice-main:
    needs: planning
    if: needs.planning.result == 'success'
    uses: ./.github/workflows/module-voice-generation-main.yml
    with:
      script-text: ${{ needs.planning.outputs.script-main }}
      voice-config: ${{ needs.planning.outputs.voice-config }}
    secrets: inherit

  voice-main-part2:
    needs: planning
    if: needs.planning.result == 'success'
    uses: ./.github/workflows/module-voice-generation-main-part2.yml
    with:
      script-text: ${{ needs.planning.outputs.script-main-part2 }}
      voice-config: ${{ needs.planning.outputs.voice-config }}
    secrets: inherit

  voice-ending:
    needs: planning
    if: needs.planning.result == 'success'
    uses: ./.github/workflows/module-voice-generation-ending.yml
    with:
      script-text: ${{ needs.planning.outputs.script-ending }}
      voice-config: ${{ needs.planning.outputs.voice-config }}
    secrets: inherit

  voice-jingle:
    needs: planning
    if: needs.planning.result == 'success'
    uses: ./.github/workflows/module-voice-generation-jingle.yml
    with:
      script-text: ${{ needs.planning.outputs.script-jingle }}
      voice-config: ${{ needs.planning.outputs.voice-config }}
    secrets: inherit

  bgm-opening:
    needs: planning
    if: needs.planning.result == 'success'
    uses: ./.github/workflows/module-bgm-generation-opening.yml
    secrets: inherit

  bgm-main:
    needs: planning
    if: needs.planning.result == 'success'
    uses: ./.github/workflows/module-bgm-generation-main.yml
    secrets: inherit

  bgm-main-part2:
    needs: planning
    if: needs.planning.result == 'success'
    uses: ./.github/workflows/module-bgm-generation-main-part2.yml
    secrets: inherit

  bgm-ending:
    needs: planning
    if: needs.planning.result == 'success'
    uses: ./.github/workflows/module-bgm-generation-ending.yml
    secrets: inherit

  bgm-jingle:
    needs: planning
    uses: ./.github/workflows/module-bgm-generation-jingle.yml
    secrets: inherit

  audio-mixing-opening:
    needs: [voice-opening, bgm-opening]
    if: success()  # ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ãƒ»BGMç”ŸæˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ãƒŸã‚­ã‚·ãƒ³ã‚°å®Ÿè¡Œ
    uses: ./.github/workflows/module-audio-mixing-opening.yml
    with:
      voice-opening: ${{ needs.voice-opening.outputs.audio-file }}
      bgm-opening: ${{ needs.bgm-opening.outputs.bgm-file }}
    secrets: inherit

  audio-mixing-main:
    needs: [voice-main, bgm-main]
    if: success()  # ãƒ¡ã‚¤ãƒ³å‰åŠéŸ³å£°ãƒ»BGMç”ŸæˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ãƒŸã‚­ã‚·ãƒ³ã‚°å®Ÿè¡Œ
    uses: ./.github/workflows/module-audio-mixing-main.yml
    with:
      voice-main: ${{ needs.voice-main.outputs.audio-file }}
      bgm-main: ${{ needs.bgm-main.outputs.bgm-file }}
    secrets: inherit

  audio-mixing-main-part2:
    needs: [voice-main-part2, bgm-main-part2]
    if: success()  # ãƒ¡ã‚¤ãƒ³å¾ŒåŠéŸ³å£°ãƒ»BGMç”ŸæˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ãƒŸã‚­ã‚·ãƒ³ã‚°å®Ÿè¡Œ
    uses: ./.github/workflows/module-audio-mixing-main-part2.yml
    with:
      voice-main-part2: ${{ needs.voice-main-part2.outputs.audio-file }}
      bgm-main-part2: ${{ needs.bgm-main-part2.outputs.bgm-file }}
    secrets: inherit

  audio-mixing-ending:
    needs: [voice-ending, bgm-ending]
    if: success()  # ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°éŸ³å£°ãƒ»BGMç”ŸæˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ãƒŸã‚­ã‚·ãƒ³ã‚°å®Ÿè¡Œ
    uses: ./.github/workflows/module-audio-mixing-ending.yml
    with:
      voice-ending: ${{ needs.voice-ending.outputs.audio-file }}
      bgm-ending: ${{ needs.bgm-ending.outputs.bgm-file }}
    secrets: inherit

  audio-mixing-jingle:
    needs: [voice-jingle, bgm-jingle]
    if: success()  # ã‚¸ãƒ³ã‚°ãƒ«éŸ³å£°ãƒ»BGMç”ŸæˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ãƒŸã‚­ã‚·ãƒ³ã‚°å®Ÿè¡Œ
    uses: ./.github/workflows/module-audio-mixing-jingle.yml
    with:
      voice-jingle: ${{ needs.voice-jingle.outputs.audio-file }}
      bgm-jingle: ${{ needs.bgm-jingle.outputs.bgm-file }}
    secrets: inherit

  audio-mixing-final:
    needs: [audio-mixing-opening, audio-mixing-main, audio-mixing-main-part2, audio-mixing-jingle, audio-mixing-ending]
    if: success()  # å…¨ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³éŸ³å£°ãƒŸã‚­ã‚·ãƒ³ã‚°ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿æœ€çµ‚çµåˆå®Ÿè¡Œ
    uses: ./.github/workflows/module-audio-mixing-final.yml
    with:
      opening-audio: ${{ needs.audio-mixing-opening.outputs.mixed-audio }}
      main-audio: ${{ needs.audio-mixing-main.outputs.mixed-audio }}
      main-part2-audio: ${{ needs.audio-mixing-main-part2.outputs.mixed-audio }}
      jingle-audio: ${{ needs.audio-mixing-jingle.outputs.mixed-audio }}
      ending-audio: ${{ needs.audio-mixing-ending.outputs.mixed-audio }}
    secrets: inherit

  publish:
    needs: audio-mixing-final
    if: false  # ãƒªãƒªãƒ¼ã‚¹ç„¡åŠ¹åŒ–
    runs-on: ubuntu-latest
    steps:
      - name: Download final audio artifact
        uses: actions/download-artifact@v4
        with:
          name: final-audio
          path: release-files
      
      - name: List release files
        run: |
          echo "::group::ğŸ“ ãƒªãƒªãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«"
          ls -la release-files/
          echo "::endgroup::"
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: radio-${{ github.run_id }}
          name: ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ª - ${{ steps.date.outputs.date }}
          body: |
            ## ğŸ™ï¸ ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ª
            
            ### ç•ªçµ„æƒ…å ±
            - æ”¾é€æ—¥: ${{ steps.date.outputs.date }}
            - æ™‚é–“: 240ç§’ï¼ˆ4åˆ†ï¼‰
            - MC: AIç”Ÿæˆï¼ˆ20ä»£å¥³æ€§ï¼‰
            
            ### å†…å®¹
            ç¥å¨ã‚¢ãƒ—ãƒªã®æœ€æ–°é–‹ç™ºæƒ…å ±ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚
            
            **é–‹ç™ºé€²æ—**: ${{ inputs.development-report }}
            
            ğŸµ Generated with [Claude Code](https://claude.ai/code)
          files: |
            release-files/final-radio.mp3
            release-files/metadata.json

  create-pr:
    needs: [planning, audio-mixing-final]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download final audio artifact
        uses: actions/download-artifact@v4
        with:
          name: final-audio
          path: radio-output
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Create feature branch
        run: |
          BRANCH_NAME="radio/daily-radio-${{ steps.date.outputs.date }}-${{ github.run_id }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        id: branch
      
      - name: Commit generated files
        run: |
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’radio-outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
          mkdir -p radio-output
          
          # Gitã«è¿½åŠ 
          git add radio-output/
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git commit -m "$(cat <<'EOF'
          ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªç”Ÿæˆ - ${{ steps.date.outputs.date }}
          
          - éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«: final-radio.mp3 (240ç§’ã€-23 LUFS)
          - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿: metadata.json
          - é–‹ç™ºé€²æ—: ${{ inputs.development-report }}
          
          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"
      
      - name: Push branch
        run: |
          git push origin "${{ steps.branch.outputs.branch_name }}"
      
      - name: Create Pull Request
        run: |
          # å°æœ¬ã®å†…å®¹ã‚’å–å¾—ã—ã¦SSMLã‚¿ã‚°ã‚’é™¤å»
          OPENING_TEXT=$(echo "${{ needs.planning.outputs.script-opening }}" | sed 's/<[^>]*>//g' | sed 's/^ *//' | sed 's/ *$//')
          MAIN_TEXT=$(echo "${{ needs.planning.outputs.script-main }}" | sed 's/<[^>]*>//g' | sed 's/^ *//' | sed 's/ *$//')
          MAIN_PART2_TEXT=$(echo "${{ needs.planning.outputs.script-main-part2 }}" | sed 's/<[^>]*>//g' | sed 's/^ *//' | sed 's/ *$//')
          JINGLE_TEXT=$(echo "${{ needs.planning.outputs.script-jingle }}" | sed 's/<[^>]*>//g' | sed 's/^ *//' | sed 's/ *$//')
          ENDING_TEXT=$(echo "${{ needs.planning.outputs.script-ending }}" | sed 's/<[^>]*>//g' | sed 's/^ *//' | sed 's/ *$//')
          
          # æ–‡å­—æ•°è¨ˆç®—ï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
          OPENING_COUNT=$(echo "$OPENING_TEXT" | wc -m)
          MAIN_COUNT=$(echo "$MAIN_TEXT" | wc -m)
          MAIN_PART2_COUNT=$(echo "$MAIN_PART2_TEXT" | wc -m)
          JINGLE_COUNT=$(echo "$JINGLE_TEXT" | wc -m)
          ENDING_COUNT=$(echo "$ENDING_TEXT" | wc -m)
          TOTAL_COUNT=$((OPENING_COUNT + MAIN_COUNT + MAIN_PART2_COUNT + JINGLE_COUNT + ENDING_COUNT))
          
          # éŸ³å£°IDã¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰æ¥½æ›²æƒ…å ±ã‚’å–å¾—
          VOICE_ID="ä¸æ˜"
          SELECTED_MUSIC="ä¸æ˜"
          ARTIST_NAME="ä¸æ˜"
          SONG_NAME="ä¸æ˜"
          if [ -f "radio-output/USE_UUID.md" ]; then
            VOICE_ID=$(grep "Voice UUID:" radio-output/USE_UUID.md | cut -d' ' -f3 2>/dev/null || echo "ä¸æ˜")
            SELECTED_MUSIC_FILE=$(grep "Selected Music File:" radio-output/USE_UUID.md | cut -d' ' -f4- 2>/dev/null || echo "ä¸æ˜")
            ARTIST_NAME=$(grep "Artist:" radio-output/USE_UUID.md | cut -d' ' -f2- 2>/dev/null || echo "ä¸æ˜")
            SONG_NAME=$(grep "Song:" radio-output/USE_UUID.md | cut -d' ' -f2- 2>/dev/null || echo "ä¸æ˜")
            
            # æ›²åæƒ…å ±ã‚’æ•´ç†ï¼ˆã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã¨æ¥½æ›²åãŒå–å¾—ã§ããŸå ´åˆï¼‰
            if [ "$ARTIST_NAME" != "ä¸æ˜" ] && [ "$SONG_NAME" != "ä¸æ˜" ]; then
              SELECTED_MUSIC="${ARTIST_NAME} - ${SONG_NAME}"
            elif [ "$SONG_NAME" != "ä¸æ˜" ]; then
              SELECTED_MUSIC="${SONG_NAME}"
            else
              SELECTED_MUSIC="$SELECTED_MUSIC_FILE"
            fi
          fi
          
          # PRãƒœãƒ‡ã‚£ã‚’ç›´æ¥ä½œæˆ
          gh pr create \
            --title "ğŸ™ï¸ ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ª - ${{ steps.date.outputs.date }}" \
            --body "## ğŸ™ï¸ ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªç”Ÿæˆå®Œäº†

          ### ğŸ“Š ç•ªçµ„æƒ…å ±
          - **æ”¾é€æ—¥**: ${{ steps.date.outputs.date }}
          - **æ™‚é–“**: 240ç§’ï¼ˆ4åˆ†ï¼‰
          - **éŸ³å£°å“è³ª**: -23 LUFS (æ”¾é€åŸºæº–)
          - **MC**: AIç”Ÿæˆï¼ˆ20ä»£å¥³æ€§ï¼‰
          - **ä½¿ç”¨éŸ³å£°ID**: ${VOICE_ID}
          - **ä½¿ç”¨æ¥½æ›²**: ${SELECTED_MUSIC}

          ### ğŸ“ ç”Ÿæˆã•ã‚ŒãŸå°æœ¬ï¼ˆåˆè¨ˆæ–‡å­—æ•°: ${TOTAL_COUNT}æ–‡å­—ï¼‰

          #### ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ï¼ˆ${OPENING_COUNT}æ–‡å­—ï¼‰
          ${OPENING_TEXT}

          #### ãƒ¡ã‚¤ãƒ³å‰åŠï¼ˆ${MAIN_COUNT}æ–‡å­—ï¼‰
          ${MAIN_TEXT}

          #### ã‚¸ãƒ³ã‚°ãƒ«ï¼ˆ${JINGLE_COUNT}æ–‡å­—ï¼‰
          ${JINGLE_TEXT}

          #### ãƒ¡ã‚¤ãƒ³å¾ŒåŠï¼ˆ${MAIN_PART2_COUNT}æ–‡å­—ï¼‰
          ${MAIN_PART2_TEXT}

          #### ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆ${ENDING_COUNT}æ–‡å­—ï¼‰
          ${ENDING_TEXT}

          ### ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
          - \`radio-output/final-radio.mp3\` - å®Œæˆã—ãŸãƒ©ã‚¸ã‚ªç•ªçµ„éŸ³å£°
          - \`radio-output/metadata.json\` - ç•ªçµ„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

          ### ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯
          - [ãƒªãƒªãƒ¼ã‚¹](https://github.com/${{ github.repository }}/releases/tag/radio-${{ github.run_id }})
          - [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### âœ… ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³
          - [ ] éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿç¢ºèª
          - [ ] éŸ³å£°å“è³ªã®ç¢ºèª (-23 LUFS)
          - [ ] ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ç¢ºèª
          - [ ] å°æœ¬ã®å†…å®¹ç¢ºèª

          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)"
        env:
          GH_TOKEN: ${{ github.token }}

  summary:
    needs: [planning, voice-opening, voice-main, voice-main-part2, voice-ending, voice-jingle, bgm-opening, bgm-main, bgm-main-part2, bgm-ending, bgm-jingle, audio-mixing-final, create-pr]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate workflow summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸ™ï¸ ãƒ©ã‚¸ã‚ªç•ªçµ„åˆ¶ä½œçµæœ
          
          | ã‚¹ãƒ†ãƒƒãƒ— | çŠ¶æ…‹ | çµæœ |
          |---------|------|-----|
          | å°æœ¬ç”Ÿæˆ | ${{ needs.planning.result }} | ${{ needs.planning.result == 'success' && 'âœ…' || 'âŒ' }} |
          | éŸ³å£°ç”Ÿæˆ(é–‹å§‹) | ${{ needs.voice-opening.result }} | ${{ needs.voice-opening.result == 'success' && 'âœ…' || needs.voice-opening.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | éŸ³å£°ç”Ÿæˆ(å‰åŠ) | ${{ needs.voice-main.result }} | ${{ needs.voice-main.result == 'success' && 'âœ…' || needs.voice-main.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | éŸ³å£°ç”Ÿæˆ(å¾ŒåŠ) | ${{ needs.voice-main-part2.result }} | ${{ needs.voice-main-part2.result == 'success' && 'âœ…' || needs.voice-main-part2.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | éŸ³å£°ç”Ÿæˆ(çµ‚äº†) | ${{ needs.voice-ending.result }} | ${{ needs.voice-ending.result == 'success' && 'âœ…' || needs.voice-ending.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | éŸ³å£°ç”Ÿæˆ(ã‚¸ãƒ³ã‚°ãƒ«) | ${{ needs.voice-jingle.result }} | ${{ needs.voice-jingle.result == 'success' && 'âœ…' || needs.voice-jingle.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | BGMç”Ÿæˆ(é–‹å§‹) | ${{ needs.bgm-opening.result }} | ${{ needs.bgm-opening.result == 'success' && 'âœ…' || needs.bgm-opening.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | BGMç”Ÿæˆ(å‰åŠ) | ${{ needs.bgm-main.result }} | ${{ needs.bgm-main.result == 'success' && 'âœ…' || needs.bgm-main.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | BGMç”Ÿæˆ(å¾ŒåŠ) | ${{ needs.bgm-main-part2.result }} | ${{ needs.bgm-main-part2.result == 'success' && 'âœ…' || needs.bgm-main-part2.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | BGMç”Ÿæˆ(çµ‚äº†) | ${{ needs.bgm-ending.result }} | ${{ needs.bgm-ending.result == 'success' && 'âœ…' || needs.bgm-ending.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | BGMç”Ÿæˆ(ã‚¸ãƒ³ã‚°ãƒ«) | ${{ needs.bgm-jingle.result }} | ${{ needs.bgm-jingle.result == 'success' && 'âœ…' || needs.bgm-jingle.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | éŸ³å£°åˆæˆ | ${{ needs.audio-mixing-final.result }} | ${{ needs.audio-mixing-final.result == 'success' && 'âœ…' || 'âŒ' }} |
          | ãƒªãƒªãƒ¼ã‚¹ä½œæˆ | ${{ needs.publish.result }} | ${{ needs.publish.result == 'success' && 'âœ…' || 'âŒ' }} |
          
          ### ğŸ“Š çµ±è¨ˆæƒ…å ±
          - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID: ${{ github.run_id }}
          - éŸ³å£°å“è³ª: -23 LUFS (æ”¾é€åŸºæº–)
          - ä¸¦åˆ—å‡¦ç†: 6ã¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åŒæ™‚å®Ÿè¡Œ
          EOF

  line-notification:
    needs: [api-check, input-processing, planning, voice-opening, voice-main, voice-main-part2, voice-ending, voice-jingle, bgm-opening, bgm-main, bgm-main-part2, bgm-ending, bgm-jingle, audio-mixing-final, create-pr, summary]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send LINE notification
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        run: |
          COMPLETION_TIME=$(date "+%Y/%m/%d %H:%M:%S")
          STATUS_EMOJI="âœ…"
          STATUS_TEXT="å®Œäº†"
          
          # å…¨ä½“ã®æˆåŠŸåˆ¤å®š
          if [[ "${{ needs.api-check.result }}" != "success" ]] || \
             [[ "${{ needs.planning.result }}" != "success" ]] || \
             [[ "${{ needs.voice-opening.result }}" != "success" ]] || \
             [[ "${{ needs.voice-main.result }}" != "success" ]] || \
             [[ "${{ needs.voice-main-part2.result }}" != "success" ]] || \
             [[ "${{ needs.voice-ending.result }}" != "success" ]] || \
             [[ "${{ needs.voice-jingle.result }}" != "success" ]] || \
             [[ "${{ needs.bgm-opening.result }}" != "success" ]] || \
             [[ "${{ needs.bgm-main.result }}" != "success" ]] || \
             [[ "${{ needs.bgm-main-part2.result }}" != "success" ]] || \
             [[ "${{ needs.bgm-ending.result }}" != "success" ]] || \
             [[ "${{ needs.bgm-jingle.result }}" != "success" ]] || \
             [[ "${{ needs.audio-mixing-final.result }}" != "success" ]] || \
             [[ "${{ needs.create-pr.result }}" != "success" ]]; then
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="å¤±æ•—"
          fi
          
          # å€‹åˆ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ•°ã®æº–å‚™
          API_STATUS="${{ needs.api-check.result == 'success' && 'âœ…' || 'âŒ èªè¨¼å¤±æ•—' }}"
          PLANNING_STATUS="${{ needs.planning.result == 'success' && 'âœ…' || 'âŒ Claude APIç•°å¸¸' }}"
          VOICE_OPENING_STATUS="${{ needs.voice-opening.result == 'success' && 'âœ…' || 'âŒ AIVIS APIå¤±æ•—' }}"
          VOICE_MAIN_STATUS="${{ needs.voice-main.result == 'success' && 'âœ…' || 'âŒ AIVIS APIå¤±æ•—' }}"
          VOICE_MAIN_PART2_STATUS="${{ needs.voice-main-part2.result == 'success' && 'âœ…' || 'âŒ AIVIS APIå¤±æ•—' }}"
          VOICE_ENDING_STATUS="${{ needs.voice-ending.result == 'success' && 'âœ…' || 'âŒ AIVIS APIå¤±æ•—' }}"
          VOICE_JINGLE_STATUS="${{ needs.voice-jingle.result == 'success' && 'âœ…' || 'âŒ AIVIS APIå¤±æ•—' }}"
          BGM_OPENING_STATUS="${{ needs.bgm-opening.result == 'success' && 'âœ…' || 'âŒ Google Lyriaå¤±æ•—' }}"
          BGM_MAIN_STATUS="${{ needs.bgm-main.result == 'success' && 'âœ…' || 'âŒ Google Lyriaå¤±æ•—' }}"
          BGM_MAIN_PART2_STATUS="${{ needs.bgm-main-part2.result == 'success' && 'âœ…' || 'âŒ Google Lyriaå¤±æ•—' }}"
          BGM_ENDING_STATUS="${{ needs.bgm-ending.result == 'success' && 'âœ…' || 'âŒ Google Lyriaå¤±æ•—' }}"
          BGM_JINGLE_STATUS="${{ needs.bgm-jingle.result == 'success' && 'âœ…' || 'âŒ ã‚¸ãƒ³ã‚°ãƒ«SEé¸æŠå¤±æ•—' }}"
          MIXING_STATUS="${{ needs.audio-mixing-final.result == 'success' && 'âœ…' || 'âŒ FFmpegå¤±æ•—' }}"
          PR_STATUS="${{ needs.create-pr.result == 'success' && 'âœ…' || 'âŒ GitHub APIå¤±æ•—' }}"
          
          # ã‚¨ãƒ©ãƒ¼è©³ç´°æƒ…å ±ã®æ§‹ç¯‰
          ERROR_DETAILS=""
          if [[ "${{ needs.api-check.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: AIVIS Cloud APIèªè¨¼å¤±æ•—"
          fi
          if [[ "${{ needs.planning.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« å°æœ¬ç”Ÿæˆã‚¨ãƒ©ãƒ¼: Claude APIå¿œç­”ç•°å¸¸"
          fi
          if [[ "${{ needs.voice-opening.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ç”Ÿæˆã‚¨ãƒ©ãƒ¼: AIVIS APIå¤±æ•—"
          fi
          if [[ "${{ needs.voice-main.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« ãƒ¡ã‚¤ãƒ³å‰åŠéŸ³å£°ç”Ÿæˆã‚¨ãƒ©ãƒ¼: AIVIS APIå¤±æ•—"
          fi
          if [[ "${{ needs.voice-main-part2.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« ãƒ¡ã‚¤ãƒ³å¾ŒåŠéŸ³å£°ç”Ÿæˆã‚¨ãƒ©ãƒ¼: AIVIS APIå¤±æ•—"
          fi
          if [[ "${{ needs.voice-ending.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°éŸ³å£°ç”Ÿæˆã‚¨ãƒ©ãƒ¼: AIVIS APIå¤±æ•—"
          fi
          if [[ "${{ needs.voice-jingle.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« ã‚¸ãƒ³ã‚°ãƒ«éŸ³å£°ç”Ÿæˆã‚¨ãƒ©ãƒ¼: AIVIS APIå¤±æ•—"
          fi
          if [[ "${{ needs.bgm-opening.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°BGMç”Ÿæˆã‚¨ãƒ©ãƒ¼: Google Lyria APIå¤±æ•—"
          fi
          if [[ "${{ needs.bgm-main.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« ãƒ¡ã‚¤ãƒ³å‰åŠBGMç”Ÿæˆã‚¨ãƒ©ãƒ¼: Google Lyria APIå¤±æ•—"
          fi
          if [[ "${{ needs.bgm-main-part2.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« ãƒ¡ã‚¤ãƒ³å¾ŒåŠBGMç”Ÿæˆã‚¨ãƒ©ãƒ¼: Google Lyria APIå¤±æ•—"
          fi
          if [[ "${{ needs.bgm-ending.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°BGMç”Ÿæˆã‚¨ãƒ©ãƒ¼: Google Lyria APIå¤±æ•—"
          fi
          if [[ "${{ needs.bgm-jingle.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« ã‚¸ãƒ³ã‚°ãƒ«BGMé¸æŠã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†å¤±æ•—"
          fi
          if [[ "${{ needs.audio-mixing-final.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« éŸ³å£°ãƒŸã‚­ã‚·ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: FFmpegå‡¦ç†å¤±æ•—"
          fi
          if [[ "${{ needs.create-pr.result }}" != "success" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}\nğŸš« ãƒ—ãƒ«ãƒªã‚¯ä½œæˆã‚¨ãƒ©ãƒ¼: GitHub APIå¤±æ•—"
          fi
          
          # LINE APIãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if [ -z "$LINE_CHANNEL_ACCESS_TOKEN" ] || [ -z "$LINE_USER_ID" ]; then
            echo "::warning::LINEé€šçŸ¥è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "LINE_CHANNEL_ACCESS_TOKEN ã¾ãŸã¯ LINE_USER_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 0
          fi
          
          curl -X POST https://api.line.me/v2/bot/message/push \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" \
            -d "{
              \"to\": \"${LINE_USER_ID}\",
              \"messages\": [
                {
                  \"type\": \"text\",
                  \"text\": \"${STATUS_EMOJI} ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªåˆ¶ä½œ${STATUS_TEXT}ï¼\n\nğŸ“» ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚\nâ° å®Œæˆæ™‚åˆ»: ${COMPLETION_TIME}\n\nğŸ” APIçŠ¶æ³:\nãƒ»AIVIS Cloud API: ${API_STATUS}\n\nğŸ“Š åˆ¶ä½œçµæœ:\nãƒ»å°æœ¬ç”Ÿæˆ: ${PLANNING_STATUS}\nãƒ»éŸ³å£°ç”Ÿæˆ(é–‹å§‹): ${VOICE_OPENING_STATUS}\nãƒ»éŸ³å£°ç”Ÿæˆ(å‰åŠ): ${VOICE_MAIN_STATUS}\nãƒ»éŸ³å£°ç”Ÿæˆ(å¾ŒåŠ): ${VOICE_MAIN_PART2_STATUS}\nãƒ»éŸ³å£°ç”Ÿæˆ(çµ‚äº†): ${VOICE_ENDING_STATUS}\nãƒ»éŸ³å£°ç”Ÿæˆ(ã‚¸ãƒ³ã‚°ãƒ«): ${VOICE_JINGLE_STATUS}\nãƒ»BGMç”Ÿæˆ(é–‹å§‹): ${BGM_OPENING_STATUS}\nãƒ»BGMç”Ÿæˆ(å‰åŠ): ${BGM_MAIN_STATUS}\nãƒ»BGMç”Ÿæˆ(å¾ŒåŠ): ${BGM_MAIN_PART2_STATUS}\nãƒ»BGMç”Ÿæˆ(çµ‚äº†): ${BGM_ENDING_STATUS}\nãƒ»BGMç”Ÿæˆ(ã‚¸ãƒ³ã‚°ãƒ«): ${BGM_JINGLE_STATUS}\nãƒ»éŸ³å£°ãƒŸã‚­ã‚·ãƒ³ã‚°: ${MIXING_STATUS}\nãƒ»ãƒ—ãƒ«ãƒªã‚¯ä½œæˆ: ${PR_STATUS}\n\nğŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID: ${{ github.run_id }}${ERROR_DETAILS}\"
                }
              ]
            }"