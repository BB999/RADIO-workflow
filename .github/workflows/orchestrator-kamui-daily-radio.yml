name: Kamui Daily Radio Production (Minimal)
on:
  workflow_dispatch:
    inputs:
      development-report:
        description: 'ç¥å¨ã‚¢ãƒ—ãƒªã®é–‹ç™ºé€²æ—ãƒ»æœ€æ–°æƒ…å ±'
        required: true
        type: string
      topic-focus:
        description: 'ç‰¹ã«å¼·èª¿ã—ãŸã„ãƒˆãƒ”ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰'
        required: false
        type: string

permissions:
  contents: write  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆã«å¿…è¦
  pull-requests: write  # PRä½œæˆã«å¿…è¦

jobs:
  planning:
    uses: ./.github/workflows/module-radio-planning.yml
    with:
      development-report: ${{ inputs.development-report }}
      topic-focus: ${{ inputs.topic-focus }}
    secrets: inherit

  voice-opening:
    needs: planning
    uses: ./.github/workflows/module-voice-generation-opening.yml
    with:
      script-text: ${{ needs.planning.outputs.script-opening }}
      voice-config: ${{ needs.planning.outputs.voice-config }}
    secrets: inherit

  voice-main:
    needs: planning
    uses: ./.github/workflows/module-voice-generation-main.yml
    with:
      script-text: ${{ needs.planning.outputs.script-main }}
      voice-config: ${{ needs.planning.outputs.voice-config }}
    secrets: inherit

  voice-ending:
    needs: planning
    uses: ./.github/workflows/module-voice-generation-ending.yml
    with:
      script-text: ${{ needs.planning.outputs.script-ending }}
      voice-config: ${{ needs.planning.outputs.voice-config }}
    secrets: inherit

  bgm-opening:
    needs: planning
    uses: ./.github/workflows/module-bgm-generation-opening.yml
    secrets: inherit

  bgm-main:
    needs: planning
    uses: ./.github/workflows/module-bgm-generation-main.yml
    secrets: inherit

  bgm-ending:
    needs: planning
    uses: ./.github/workflows/module-bgm-generation-ending.yml
    secrets: inherit

  audio-mixing:
    needs: [voice-opening, voice-main, voice-ending, bgm-opening, bgm-main, bgm-ending]
    if: success()  # å…¨ã¦ã®éŸ³å£°ãƒ»BGMç”ŸæˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ãƒŸã‚­ã‚·ãƒ³ã‚°å®Ÿè¡Œ
    uses: ./.github/workflows/module-audio-mixing.yml
    with:
      voice-opening: ${{ needs.voice-opening.outputs.audio-file }}
      voice-main: ${{ needs.voice-main.outputs.audio-file }}
      voice-ending: ${{ needs.voice-ending.outputs.audio-file }}
      bgm-opening: ${{ needs.bgm-opening.outputs.bgm-file }}
      bgm-main: ${{ needs.bgm-main.outputs.bgm-file }}
      bgm-ending: ${{ needs.bgm-ending.outputs.bgm-file }}
    secrets: inherit

  publish:
    needs: audio-mixing
    if: false  # ãƒªãƒªãƒ¼ã‚¹ç„¡åŠ¹åŒ–
    runs-on: ubuntu-latest
    steps:
      - name: Download final audio artifact
        uses: actions/download-artifact@v4
        with:
          name: final-audio
          path: release-files
      
      - name: List release files
        run: |
          echo "::group::ğŸ“ ãƒªãƒªãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«"
          ls -la release-files/
          echo "::endgroup::"
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: radio-${{ github.run_id }}
          name: ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ª - ${{ steps.date.outputs.date }}
          body: |
            ## ğŸ™ï¸ ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ª
            
            ### ç•ªçµ„æƒ…å ±
            - æ”¾é€æ—¥: ${{ steps.date.outputs.date }}
            - æ™‚é–“: 240ç§’ï¼ˆ4åˆ†ï¼‰
            - MC: AIç”Ÿæˆï¼ˆ20ä»£å¥³æ€§ï¼‰
            
            ### å†…å®¹
            ç¥å¨ã‚¢ãƒ—ãƒªã®æœ€æ–°é–‹ç™ºæƒ…å ±ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚
            
            **é–‹ç™ºé€²æ—**: ${{ inputs.development-report }}
            **å¼·èª¿ãƒã‚¤ãƒ³ãƒˆ**: ${{ inputs.topic-focus || 'ãªã—' }}
            
            ğŸµ Generated with [Claude Code](https://claude.ai/code)
          files: |
            release-files/final-radio.mp3
            release-files/metadata.json

  create-pr:
    needs: [planning, audio-mixing]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download final audio artifact
        uses: actions/download-artifact@v4
        with:
          name: final-audio
          path: radio-output
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Create feature branch
        run: |
          BRANCH_NAME="radio/daily-radio-${{ steps.date.outputs.date }}-${{ github.run_id }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        id: branch
      
      - name: Commit generated files
        run: |
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’radio-outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
          mkdir -p radio-output
          
          # Gitã«è¿½åŠ 
          git add radio-output/
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git commit -m "$(cat <<'EOF'
          ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªç”Ÿæˆ - ${{ steps.date.outputs.date }}
          
          - éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«: final-radio.mp3 (240ç§’ã€-23 LUFS)
          - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿: metadata.json
          - é–‹ç™ºé€²æ—: ${{ inputs.development-report }}
          - å¼·èª¿ãƒã‚¤ãƒ³ãƒˆ: ${{ inputs.topic-focus || 'ãªã—' }}
          
          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"
      
      - name: Push branch
        run: |
          git push origin "${{ steps.branch.outputs.branch_name }}"
      
      - name: Create Pull Request
        run: |
          gh pr create --title "ğŸ™ï¸ ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ª - ${{ steps.date.outputs.date }}" --body "$(cat <<'EOF'
          ## ğŸ™ï¸ ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªç”Ÿæˆå®Œäº†
          
          ### ğŸ“Š ç•ªçµ„æƒ…å ±
          - **æ”¾é€æ—¥**: ${{ steps.date.outputs.date }}
          - **æ™‚é–“**: 240ç§’ï¼ˆ4åˆ†ï¼‰
          - **éŸ³å£°å“è³ª**: -23 LUFS (æ”¾é€åŸºæº–)
          - **MC**: AIç”Ÿæˆï¼ˆ20ä»£å¥³æ€§ï¼‰
          
          ### ğŸ“ å†…å®¹
          **é–‹ç™ºé€²æ—**: ${{ inputs.development-report }}
          **å¼·èª¿ãƒã‚¤ãƒ³ãƒˆ**: ${{ inputs.topic-focus || 'ãªã—' }}
          
          ### ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
          - `radio-output/final-radio.mp3` - å®Œæˆã—ãŸãƒ©ã‚¸ã‚ªç•ªçµ„éŸ³å£°
          - `radio-output/metadata.json` - ç•ªçµ„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
          
          ### ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯
          - [ãƒªãƒªãƒ¼ã‚¹](https://github.com/${{ github.repository }}/releases/tag/radio-${{ github.run_id }})
          - [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### âœ… ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³
          - [ ] éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿç¢ºèª
          - [ ] éŸ³å£°å“è³ªã®ç¢ºèª (-23 LUFS)
          - [ ] ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ç¢ºèª
          
          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
          EOF
          )"
        env:
          GH_TOKEN: ${{ github.token }}

  summary:
    needs: [planning, voice-opening, voice-main, voice-ending, bgm-opening, bgm-main, bgm-ending, audio-mixing, create-pr]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate workflow summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸ™ï¸ ãƒ©ã‚¸ã‚ªç•ªçµ„åˆ¶ä½œçµæœ
          
          | ã‚¹ãƒ†ãƒƒãƒ— | çŠ¶æ…‹ | çµæœ |
          |---------|------|-----|
          | å°æœ¬ç”Ÿæˆ | ${{ needs.planning.result }} | ${{ needs.planning.result == 'success' && 'âœ…' || 'âŒ' }} |
          | éŸ³å£°ç”Ÿæˆ(é–‹å§‹) | ${{ needs.voice-opening.result }} | ${{ needs.voice-opening.result == 'success' && 'âœ…' || needs.voice-opening.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | éŸ³å£°ç”Ÿæˆ(æœ¬ç·¨) | ${{ needs.voice-main.result }} | ${{ needs.voice-main.result == 'success' && 'âœ…' || needs.voice-main.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | éŸ³å£°ç”Ÿæˆ(çµ‚äº†) | ${{ needs.voice-ending.result }} | ${{ needs.voice-ending.result == 'success' && 'âœ…' || needs.voice-ending.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | BGMç”Ÿæˆ(é–‹å§‹) | ${{ needs.bgm-opening.result }} | ${{ needs.bgm-opening.result == 'success' && 'âœ…' || needs.bgm-opening.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | BGMç”Ÿæˆ(æœ¬ç·¨) | ${{ needs.bgm-main.result }} | ${{ needs.bgm-main.result == 'success' && 'âœ…' || needs.bgm-main.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | BGMç”Ÿæˆ(çµ‚äº†) | ${{ needs.bgm-ending.result }} | ${{ needs.bgm-ending.result == 'success' && 'âœ…' || needs.bgm-ending.result == 'failure' && 'âŒ' || 'âš ï¸' }} |
          | éŸ³å£°åˆæˆ | ${{ needs.audio-mixing.result }} | ${{ needs.audio-mixing.result == 'success' && 'âœ…' || 'âŒ' }} |
          | ãƒªãƒªãƒ¼ã‚¹ä½œæˆ | ${{ needs.publish.result }} | ${{ needs.publish.result == 'success' && 'âœ…' || 'âŒ' }} |
          
          ### ğŸ“Š çµ±è¨ˆæƒ…å ±
          - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID: ${{ github.run_id }}
          - éŸ³å£°å“è³ª: -23 LUFS (æ”¾é€åŸºæº–)
          - ä¸¦åˆ—å‡¦ç†: 6ã¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åŒæ™‚å®Ÿè¡Œ
          EOF