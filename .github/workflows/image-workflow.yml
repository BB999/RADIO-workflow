name: Create Images from Prompt

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'ç”»åƒç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        required: true
        type: string

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      folder-name: ${{ steps.create-branch.outputs.folder-name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create branch for image generation
        id: create-branch
        run: |
          BRANCH_NAME="images/$(date +%Y%m%d)-${{ github.run_id }}"
          FOLDER_NAME="images-$(date +%Y%m%d)-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin $BRANCH_NAME
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"
          echo "Folder name: $FOLDER_NAME"

  planning:
    runs-on: ubuntu-latest
    needs: [setup-branch]
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.planning.outputs.completed }}
      image-prompts: ${{ steps.planning.outputs.image-prompts }}
      variation-concepts: ${{ steps.planning.outputs.variation-concepts }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ç”»åƒåˆ¶ä½œè¨ˆç”»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ“‹ Image Planning Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_PROMPT="${{ inputs.prompt }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          PLANNING_DIR="$FOLDER_NAME/planning"
          
          echo "User prompt: $USER_PROMPT"
          echo "Planning folder: $PLANNING_DIR"
          
          # è¨ˆç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$PLANNING_DIR" ]; then
            mkdir -p "$PLANNING_DIR"
            echo "ğŸ“ Created planning folder: $PLANNING_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT=$(cat <<'EOF'
ã‚ãªãŸã¯ç”»åƒåˆ¶ä½œã®å°‚é–€ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‹ã‚‰ã€ç•°ãªã‚‹ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã§3æšã®é­…åŠ›çš„ãªç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®è©³ç´°ãªè¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤º**: USER_PROMPT_PLACEHOLDER

**ã‚¿ã‚¹ã‚¯**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‚’åˆ†æã—ã€3ã¤ã®ç•°ãªã‚‹ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³/ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è€ƒæ¡ˆ
2. å„ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦é«˜å“è³ªãªç”»åƒç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
3. 3æšã®ç”»åƒãŒä¸€è²«æ€§ã‚’ä¿ã¡ãªãŒã‚‰ã‚‚ã€ãã‚Œãã‚Œç‹¬è‡ªã®é­…åŠ›ã‚’æŒã¤ã‚ˆã†ã«è¨ˆç”»
4. è¨ˆç”»æ›¸ã‚’ã€ŒPLANNING_DIR_PLACEHOLDER/image-plan.mdã€ã«ä¿å­˜
5. 3ã¤ã®ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€ŒPLANNING_DIR_PLACEHOLDER/image-prompts.jsonã€ã«ä¿å­˜
6. ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ã€ŒPLANNING_DIR_PLACEHOLDER/variation-concepts.mdã€ã«ä¿å­˜

**è¨ˆç”»ã®ãƒã‚¤ãƒ³ãƒˆ**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’æ­£ç¢ºã«ç†è§£
- 3ã¤ã®ç•°ãªã‚‹ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ™‚é–“å¸¯ã€å¤©å€™ã€è¦–ç‚¹ã€ã‚¹ã‚¿ã‚¤ãƒ«ç­‰ï¼‰ã‚’è¨­å®š
- å„ç”»åƒãŒç‹¬è‡ªæ€§ã‚’æŒã¡ãªãŒã‚‰ã€å…¨ä½“ã¨ã—ã¦çµ±ä¸€æ„Ÿã®ã‚ã‚‹ã‚»ãƒƒãƒˆ
- é­…åŠ›çš„ã§è¦–è¦šçš„ã«ç¾ã—ã„ç”»åƒã®æ§‹æƒ³
- æŠ€è¡“çš„åˆ¶ç´„ã‚’è€ƒæ…®ã—ãŸç¾å®Ÿçš„ãªè¨ˆç”»

**ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
- Imagen4 Ultraã«æœ€é©åŒ–ã•ã‚ŒãŸè©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
- å„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯50-100èªç¨‹åº¦
- è¦–è¦šçš„è¦ç´ ï¼ˆè‰²å½©ã€æ§‹å›³ã€ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã‚’æ˜ç¢ºã«æŒ‡å®š
- é«˜è§£åƒåº¦ãƒ»é«˜å“è³ªã‚’æ„è­˜ã—ãŸè¨˜è¿°

**JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**:
{
  "prompts": [
    {
      "id": 1,
      "concept": "æœã®å…‰æ™¯",
      "prompt": "è©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ..."
    },
    {
      "id": 2,
      "concept": "æ˜¼ã®å…‰æ™¯",
      "prompt": "è©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ..."
    },
    {
      "id": 3,
      "concept": "å¤œã®å…‰æ™¯",
      "prompt": "è©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ..."
    }
  ]
}

**é‡è¦**: 
1. å¿…ãšä»¥ä¸‹ã®3ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
   - PLANNING_DIR_PLACEHOLDER/image-plan.mdï¼ˆå…¨ä½“è¨ˆç”»æ›¸ï¼‰
   - PLANNING_DIR_PLACEHOLDER/image-prompts.jsonï¼ˆæ©Ÿæ¢°å‡¦ç†ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
   - PLANNING_DIR_PLACEHOLDER/variation-concepts.mdï¼ˆãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³èª¬æ˜ï¼‰
2. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯å…·ä½“çš„ã§è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„
3. 3ã¤ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯å¿…ãšç•°ãªã‚‹ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«åŸºã¥ã„ã¦ä½œæˆã—ã¦ãã ã•ã„
EOF
)
          
          # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›
          PROMPT="${PROMPT//USER_PROMPT_PLACEHOLDER/$USER_PROMPT}"
          PROMPT="${PROMPT//PLANNING_DIR_PLACEHOLDER/$PLANNING_DIR}"
          
          echo "ğŸš€ Starting Planning Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸè¨ˆç”»ã®ç¢ºèª
          echo ""
          echo "ğŸ“‹ Checking generated planning files..."
          
          # ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
          if [ -f "$PLANNING_DIR/image-prompts.json" ]; then
            IMAGE_PROMPTS=$(cat "$PLANNING_DIR/image-prompts.json" | jq -c)
            echo "::notice::âœ… Image prompts JSON generated"
            echo "Image prompts: $IMAGE_PROMPTS"
            echo "image-prompts=$IMAGE_PROMPTS" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Image prompts JSON file not found"
            exit 1
          fi
          
          # ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ç¢ºèª
          if [ -f "$PLANNING_DIR/variation-concepts.md" ]; then
            echo "::notice::âœ… Variation concepts generated"
            VARIATION_CONCEPTS=$(head -10 "$PLANNING_DIR/variation-concepts.md" | tr '\n' ' ')
            echo "Variation concepts: $VARIATION_CONCEPTS"
            echo "variation-concepts=$VARIATION_CONCEPTS" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Variation concepts file not found"
            exit 1
          fi
          
          # è¨ˆç”»æ›¸ã®ç¢ºèª
          if [ -f "$PLANNING_DIR/image-plan.md" ]; then
            echo "::notice::âœ… Image plan document generated"
            echo "First 10 lines of plan:"
            head -10 "$PLANNING_DIR/image-plan.md"
          else
            echo "::warning::âš ï¸ Image plan document not found"
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push planning
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No planning files to commit"
          else
            git commit -m "Add image planning: ${{ inputs.prompt }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  image-generation:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning]
    permissions:
      contents: write
    outputs:
      images-completed: ${{ steps.image.outputs.completed }}
      generated-images-count: ${{ steps.image.outputs.generated-images-count }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ç”»åƒç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Imagen4 Ultra)
        id: image
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ¨ Image Generation Agent Execution (Imagen4 Ultra)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_PROMPT="${{ inputs.prompt }}"
          IMAGE_PROMPTS=$(echo '${{ needs.planning.outputs.image-prompts }}' | jq -r '.' || echo '{}')
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          IMAGES_DIR="$FOLDER_NAME/images"
          
          echo "User prompt: $USER_PROMPT"
          echo "Image prompts: $IMAGE_PROMPTS"
          echo "Target folder: $IMAGES_DIR"
          
          # ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$IMAGES_DIR" ]; then
            mkdir -p "$IMAGES_DIR"
            echo "ğŸ“ Created images folder: $IMAGES_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "ğŸ“‹ MCP Configuration Check:"
          echo "Working directory: $(pwd)"
          echo "MCP config path: $MCP_CONFIG_PATH"
          echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
          echo "Allowed tools: mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result,Bash"
          
          # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            echo "âœ… MCP config file exists at: $MCP_CONFIG_ABS_PATH"
            echo "MCP servers configured:"
            jq -r '.mcpServers | keys[]' "$MCP_CONFIG_ABS_PATH" || true
          else
            echo "âŒ MCP config file not found at: $MCP_CONFIG_ABS_PATH"
            exit 1
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT=$(cat <<'EOF'
ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¦Imagen4 Ultraã§3æšã®é«˜å“è³ªãªç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

**å…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤º**: USER_PROMPT_PLACEHOLDER
**ç”Ÿæˆã™ã‚‹ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: IMAGE_PROMPTS_PLACEHOLDER

**å®Ÿè¡Œæ‰‹é †**:
1. æä¾›ã•ã‚ŒãŸJSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰3ã¤ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŠ½å‡º
2. å„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¯¾ã—ã¦Imagen4 Ultraã§ç”»åƒç”Ÿæˆã‚’å®Ÿè¡Œ
3. `mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit`ãƒ„ãƒ¼ãƒ«ã§å„ç”»åƒç”Ÿæˆã‚’é–‹å§‹
4. `mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
5. `mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result`ã§çµæœå–å¾—ã—ã¦Google URLã‚’å–å¾—
6. å„ç”»åƒã‚’ä»¥ä¸‹ã®åå‰ã§ä¿å­˜ï¼š
   - 1æšç›®: IMAGES_DIR_PLACEHOLDER/image-variation-1.png
   - 2æšç›®: IMAGES_DIR_PLACEHOLDER/image-variation-2.png
   - 3æšç›®: IMAGES_DIR_PLACEHOLDER/image-variation-3.png
7. å„ç”»åƒã®Google URLã‚‚ã€ŒIMAGES_DIR_PLACEHOLDER/image-urls.jsonã€ã«ä¿å­˜

**URLãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**:
{
  "urls": [
    {
      "id": 1,
      "concept": "ã‚³ãƒ³ã‚»ãƒ—ãƒˆå",
      "url": "Google URL",
      "filename": "image-variation-1.png"
    },
    ...
  ]
}

**é‡è¦ãªæ³¨æ„ç‚¹**:
- å¿…ãš3æšã®ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
- å„ç”»åƒã¯æä¾›ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¾“ã£ã¦ç”Ÿæˆ
- Google URLã®æœ‰åŠ¹æœŸé™ã¯ç´„1æ™‚é–“ã®ãŸã‚ã€ç”Ÿæˆå¾Œã™ãã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
- ãƒ•ã‚¡ã‚¤ãƒ«åã¯æŒ‡å®šã•ã‚ŒãŸå½¢å¼ï¼ˆimage-variation-N.pngï¼‰ã‚’ä½¿ç”¨
- ç”»åƒã¯å¿…ãšã€ŒIMAGES_DIR_PLACEHOLDERã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
- URLã®è¨˜éŒ²ã‚‚å¿˜ã‚Œãšã«å®Ÿè¡Œ

**å‡¦ç†ã®æµã‚Œ**:
1. 1æšç›®ã®ç”»åƒç”Ÿæˆ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜
2. 2æšç›®ã®ç”»åƒç”Ÿæˆ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜
3. 3æšç›®ã®ç”»åƒç”Ÿæˆ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜
4. ã™ã¹ã¦ã®URLã‚’è¨˜éŒ²ã—ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
EOF
)
          
          # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›
          PROMPT="${PROMPT//USER_PROMPT_PLACEHOLDER/$USER_PROMPT}"
          PROMPT="${PROMPT//IMAGE_PROMPTS_PLACEHOLDER/$IMAGE_PROMPTS}"
          PROMPT="${PROMPT//IMAGES_DIR_PLACEHOLDER/$IMAGES_DIR}"
          
          echo "ğŸš€ Starting Image Generation Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result,Bash,Write" \
            --max-turns 30 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®ç¢ºèª
          echo ""
          echo "ğŸ“¸ Checking generated images..."
          if [ -d "$IMAGES_DIR" ]; then
            IMAGE_COUNT=$(find "$IMAGES_DIR" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | wc -l)
            echo "::notice::ğŸ“¸ Generated $IMAGE_COUNT images"
            if [ "$IMAGE_COUNT" -gt 0 ]; then
              echo "Image files:"
              find "$IMAGES_DIR" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | sort
              
              # URLãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
              if [ -f "$IMAGES_DIR/image-urls.json" ]; then
                echo "::notice::âœ… Image URLs JSON file found"
                cat "$IMAGES_DIR/image-urls.json"
              else
                echo "::warning::âš ï¸ Image URLs JSON file not found"
              fi
              
              echo "generated-images-count=$IMAGE_COUNT" >> $GITHUB_OUTPUT
            else
              echo "::error::âŒ No images were generated"
              exit 1
            fi
          else
            echo "::error::âŒ Images directory not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push images
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No images to commit"
          else
            git commit -m "Add generated images: ${{ inputs.prompt }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  create-pr:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning, image-generation]
    permissions:
      contents: write
      pull-requests: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          BRANCH_NAME="${{ needs.setup-branch.outputs.branch-name }}"
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æœ€çµ‚æˆæœç‰©ã®ç¢ºèªã¨ã‚³ãƒŸãƒƒãƒˆ
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          echo "=== Final Image Generation Summary ==="
          echo "Image folder: $FOLDER_NAME"
          
          IMAGES_COUNT=0
          
          if [ -d "$FOLDER_NAME" ]; then
            echo "âœ… Image folder exists: $FOLDER_NAME"
            echo "Contents:"
            ls -la "$FOLDER_NAME"
            
            # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -d "$FOLDER_NAME/images" ]; then
              IMAGES_COUNT=$(find "$FOLDER_NAME/images" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | wc -l)
              echo "âœ… Images directory exists with $IMAGES_COUNT files"
              if [ "$IMAGES_COUNT" -gt 0 ]; then
                echo "Image files:"
                find "$FOLDER_NAME/images" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | sort
              fi
            else
              echo "âŒ Images directory not found"
            fi
          else
            echo "âŒ Image folder not found: $FOLDER_NAME"
          fi
          
          # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add "$FOLDER_NAME/" 2>/dev/null || true
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
          COMMIT_MESSAGE="Add new AI-generated images: ${{ inputs.prompt }}
          
          ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${{ inputs.prompt }}
          ç”Ÿæˆæ—¥æ™‚: $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC
          
          ğŸ“Š Generation Summary:
          - Images: $IMAGES_COUNT files (Imagen4 Ultra)
          - Variations: 3 different situations
          
          ğŸ¤– Generated with Claude Code SDK & kamuicode MCP
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          # ã‚³ãƒŸãƒƒãƒˆ
          if git diff --cached --quiet; then
            echo "Warning: No changes to commit"
            git commit --allow-empty -m "$COMMIT_MESSAGE"
          else
            git commit -m "$COMMIT_MESSAGE"
          fi
          
          # ãƒ—ãƒƒã‚·ãƒ¥
          git push origin $BRANCH_NAME
          
          # GitHub Actions Summaryã«çµæœã‚’å‡ºåŠ›
          echo "# ğŸ¨ AIç”»åƒç”Ÿæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ ç”Ÿæˆæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: ${{ inputs.prompt }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿæˆæ—¥æ™‚**: $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“Š ç”Ÿæˆçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¸ **ç”»åƒ**: $IMAGES_COUNT ãƒ•ã‚¡ã‚¤ãƒ« (Imagen4 Ultra)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¨ **ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³**: 3ã¤ã®ç•°ãªã‚‹ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ç”»åƒã‚’ã‚µãƒãƒªã«è¡¨ç¤º
          if [ -d "$FOLDER_NAME/images" ] && [ "$IMAGES_COUNT" -gt 0 ]; then
            echo "## ğŸ¨ ç”Ÿæˆã•ã‚ŒãŸç”»åƒ" >> $GITHUB_STEP_SUMMARY
            
            # å„ç”»åƒã‚’ã‚µãƒãƒªã«è¿½åŠ 
            for i in 1 2 3; do
              IMAGE_PATH="$FOLDER_NAME/images/image-variation-$i.png"
              if [ -f "$IMAGE_PATH" ]; then
                # GitHubã®ç”Ÿãƒ•ã‚¡ã‚¤ãƒ«URLæ§‹ç¯‰
                GITHUB_IMAGE_URL="https://github.com/${{ github.repository }}/raw/$BRANCH_NAME/$IMAGE_PATH"
                echo "### ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ $i" >> $GITHUB_STEP_SUMMARY
                echo "![Variation $i]($GITHUB_IMAGE_URL)" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
          
          echo "## ğŸ”— æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          echo "1. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å…¨ã¦ã®ç”»åƒã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "2. å¿…è¦ã«å¿œã˜ã¦ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ãƒœãƒ‡ã‚£ã‚’ä½œæˆ
          PR_BODY="ğŸ¤– Claude Code SDK & kamuicode MCPã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚»ãƒƒãƒˆã§ã™."
          PR_BODY="$PR_BODY"$'\n\n'"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${{ inputs.prompt }}"
          PR_BODY="$PR_BODY"$'\n\n'"ç”Ÿæˆãƒ•ãƒ­ãƒ¼:"
          PR_BODY="$PR_BODY"$'\n'"1. ğŸ¨ Imagen4 Ultra ã§3ã¤ã®ç•°ãªã‚‹ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã®é«˜å“è³ªç”»åƒã‚’ç”Ÿæˆ"
          PR_BODY="$PR_BODY"$'\n\n'"æˆæœç‰©:"
          PR_BODY="$PR_BODY"$'\n'"- ç”»åƒ: $IMAGES_COUNT ãƒ•ã‚¡ã‚¤ãƒ«"
          PR_BODY="$PR_BODY"$'\n'"- ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³: 3ã¤ã®ç•°ãªã‚‹ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³"
          
          # ç”»åƒã‚’ãƒ—ãƒ«ãƒªã‚¯ã«åŸ‹ã‚è¾¼ã¿
          if [ -d "$FOLDER_NAME/images" ] && [ "$IMAGES_COUNT" -gt 0 ]; then
            PR_BODY="$PR_BODY"$'\n\n'"## ğŸ¨ ç”Ÿæˆã•ã‚ŒãŸç”»åƒ"
            
            # å„ç”»åƒã‚’ãƒ—ãƒ«ãƒªã‚¯ã«è¿½åŠ 
            for i in 1 2 3; do
              IMAGE_PATH="$FOLDER_NAME/images/image-variation-$i.png"
              if [ -f "$IMAGE_PATH" ]; then
                # GitHubã®ç”Ÿãƒ•ã‚¡ã‚¤ãƒ«URLæ§‹ç¯‰
                GITHUB_IMAGE_URL="https://github.com/${{ github.repository }}/raw/$BRANCH_NAME/$IMAGE_PATH"
                PR_BODY="$PR_BODY"$'\n\n'"### ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ $i"
                PR_BODY="$PR_BODY"$'\n'"![Variation $i]($GITHUB_IMAGE_URL)"
              fi
            done
          fi
          
          PR_BODY="$PR_BODY

          ---
          ğŸ¤– Generated with [Claude Code SDK & kamuicode MCP](https://github.com/AI-Summoner/ai-summoner)"
          
          # PRä½œæˆ (GH_TOKENã‚’ä½¿ç”¨)
          gh pr create \
            --title "æ–°ã—ã„AIç”Ÿæˆç”»åƒã‚»ãƒƒãƒˆ: ${{ inputs.prompt }}" \
            --body "$PR_BODY" \
            --base main \
            --head $BRANCH_NAME