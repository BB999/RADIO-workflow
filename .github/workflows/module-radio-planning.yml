name: Radio Planning Module - Fine Split Version (Minimal)
on:
  workflow_call:
    inputs:
      development-report:
        required: false
        type: string
      processed-summary:
        description: 'Gemini CLIã§å‡¦ç†æ¸ˆã¿ã®æ§‹é€ åŒ–ã•ã‚ŒãŸã‚µãƒãƒªãƒ¼'
        required: false
        type: string
      use-processed-input:
        description: 'å‡¦ç†æ¸ˆã¿å…¥åŠ›ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã©ã†ã‹'
        required: false
        type: boolean
        default: false
      use-auto-collected:
        description: 'è‡ªå‹•åé›†ã•ã‚ŒãŸæ–‡å­—èµ·ã“ã—ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã©ã†ã‹'
        required: false
        type: boolean
        default: false
    outputs:
      script-opening:
        value: ${{ jobs.generate-opening.outputs.script-opening }}
      script-main:
        value: ${{ jobs.generate-main.outputs.script-main }}
      script-main-part2:
        value: ${{ jobs.generate-main-part2.outputs.script-main-part2 }}
      script-jingle:
        value: ${{ jobs.generate-jingle.outputs.script-jingle }}
      script-ending:
        value: ${{ jobs.generate-ending.outputs.script-ending }}
      voice-config:
        value: ${{ jobs.generate-opening.outputs.voice-config }}

jobs:
  generate-opening:
    runs-on: ubuntu-latest
    outputs:
      script-opening: ${{ steps.planning.outputs.script-opening }}
      voice-config: ${{ steps.planning.outputs.voice-config }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download auto-collected transcript
        if: ${{ inputs.use-auto-collected == true }}
        uses: actions/download-artifact@v4
        with:
          name: auto-collected-transcript
          path: ./transcript/
      
      - name: Setup transcript data
        run: |
          if [ "${{ inputs.use-auto-collected }}" == "true" ]; then
            if [ -f "./transcript/transcript.txt" ]; then
              cp "./transcript/transcript.txt" "./development-report.txt"
              echo "âœ… è‡ªå‹•åé›†ã•ã‚ŒãŸæ–‡å­—èµ·ã“ã—ã‚’ä½¿ç”¨ã—ã¾ã™"
              echo "æ–‡å­—æ•°: $(wc -c < ./development-report.txt)"
            else
              echo "::error::è‡ªå‹•åé›†ã•ã‚ŒãŸæ–‡å­—èµ·ã“ã—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              exit 1
            fi
          else
            echo '${{ inputs.development-report }}' > ./development-report.txt
            echo "âœ… æ‰‹å‹•å…¥åŠ›ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™"
            echo "æ–‡å­—æ•°: $(wc -c < ./development-report.txt)"
          fi
      
      - name: Setup music file selection
        run: |
          # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã¨UUIDç”Ÿæˆ
          echo "ğŸµ éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ"
          
          # radio-workflow/musicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰å®Ÿéš›ã®mp3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          if [ ! -d "radio-workflow/music" ]; then
            echo "::error::radio-workflow/musicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # .mp3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…åˆ—ã«å–å¾—
          declare -a MUSIC_FILES=()
          while IFS= read -r -d '' file; do
            filename=$(basename "$file")
            MUSIC_FILES+=("$filename")
            echo "  - ç™ºè¦‹: $filename"
          done < <(find radio-workflow/music -name "*.mp3" -print0)
          
          # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ ${#MUSIC_FILES[@]} -eq 0 ]; then
            echo "::error::éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # ãƒ©ãƒ³ãƒ€ãƒ ã«éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆæ™‚åˆ»ãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ¼ãƒ‰ä½¿ç”¨ï¼‰
          MUSIC_SEED=$(($(date +%s%N | cut -b10-19) + $$ + RANDOM))
          SELECTED_INDEX=$((MUSIC_SEED % ${#MUSIC_FILES[@]}))
          SELECTED_MUSIC_FILE="${MUSIC_FILES[$SELECTED_INDEX]}"
          echo "ğŸ¯ é¸æŠã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«: $SELECTED_MUSIC_FILE (ã‚·ãƒ¼ãƒ‰: $MUSIC_SEED)"
          
          # radio-workflow/UUID.mdã‹ã‚‰éŸ³å£°IDã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
          if [ -f "radio-workflow/UUID.md" ]; then
            echo "ğŸ” éŸ³å£°UUIDãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
            cat "radio-workflow/UUID.md"
            
            # ç©ºè¡Œã‚’é™¤ã„ã¦UUIDã‚’é…åˆ—ã«èª­ã¿è¾¼ã¿
            declare -a VOICE_UUIDS=()
            while IFS= read -r uuid; do
              if [[ -n "$uuid" ]]; then
                VOICE_UUIDS+=("$uuid")
              fi
            done < "radio-workflow/UUID.md"
            
            UUID_COUNT=${#VOICE_UUIDS[@]}
            
            echo "ğŸ“ éŸ³å£°UUIDä¸€è¦§:"
            for i in "${!VOICE_UUIDS[@]}"; do
              echo "  [$i] ${VOICE_UUIDS[$i]}"
            done
            
            # UUIDãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if [ $UUID_COUNT -eq 0 ]; then
              echo "::error::æœ‰åŠ¹ãªUUIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              exit 1
            fi
            
            # ã‚ˆã‚Šç¢ºå®Ÿãªãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆè¤‡æ•°ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ï¼‰
            CURRENT_TIME=$(date +%s)
            NANOSEC=$(date +%N)
            WORKFLOW_RUN_ID="${{ github.run_id }}"
            
            # è¤‡æ•°ã®å€¤ã‚’çµ„ã¿åˆã‚ã›ã¦ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’å‘ä¸Š
            RANDOM_SEED=$((CURRENT_TIME + NANOSEC + WORKFLOW_RUN_ID))
            RANDOM_INDEX=$((RANDOM_SEED % UUID_COUNT))
            
            # ã•ã‚‰ã«shufã‚’ä½¿ã£ã¦ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’å‘ä¸Š
            if command -v shuf >/dev/null 2>&1; then
              SELECTED_UUID=$(printf '%s\n' "${VOICE_UUIDS[@]}" | shuf -n 1)
              echo "ğŸ² shufã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ"
            else
              SELECTED_UUID="${VOICE_UUIDS[$RANDOM_INDEX]}"
              echo "ğŸ² è¨ˆç®—ãƒ™ãƒ¼ã‚¹ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ"
            fi
            
            DEFAULT_VOICE_ID="$SELECTED_UUID"
            echo "ğŸ¯ é¸æŠã•ã‚ŒãŸéŸ³å£°UUID: $DEFAULT_VOICE_ID"
            echo "ğŸ“Š åˆ©ç”¨å¯èƒ½UUIDæ•°: $UUID_COUNT"
            echo "ğŸ² ã‚·ãƒ¼ãƒ‰å€¤: $RANDOM_SEED, ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: $RANDOM_INDEX"
            echo "â° æ™‚åˆ»: $CURRENT_TIME, ãƒŠãƒç§’: $NANOSEC, Run ID: $WORKFLOW_RUN_ID"
          else
            echo "::error::UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # æ¥½æ›²åã¨ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’æŠ½å‡ºï¼ˆã€Œæ¥½æ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå.mp3ã€å½¢å¼ï¼‰
          FILENAME_WITHOUT_EXT="${SELECTED_MUSIC_FILE%.mp3}"
          if [[ "$FILENAME_WITHOUT_EXT" == *"ãƒ»"* ]]; then
            SONG_NAME="${FILENAME_WITHOUT_EXT%ãƒ»*}"
            ARTIST_NAME="${FILENAME_WITHOUT_EXT#*ãƒ»}"
            echo "ğŸ“ æ¥½æ›²æƒ…å ±ã‚’æŠ½å‡º: æ¥½æ›²å='$SONG_NAME', ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ='$ARTIST_NAME'"
          else
            SONG_NAME="$FILENAME_WITHOUT_EXT"
            ARTIST_NAME="ä¸æ˜"
            echo "ğŸ“ æ¥½æ›²æƒ…å ±: æ¥½æ›²å='$SONG_NAME' (ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåãªã—)"
          fi
          
          # USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          mkdir -p radio-workflow/temp
          cat > radio-workflow/temp/USE_UUID.md << EOF
          Voice UUID: $DEFAULT_VOICE_ID
          Selected Music File: $SELECTED_MUSIC_FILE
          Artist: $ARTIST_NAME
          Song: $SONG_NAME
          EOF
          
          echo "âœ… éŸ³æ¥½é¸æŠã¨UUIDè¨­å®šå®Œäº†"
      
      - name: Upload voice-uuid artifact
        uses: actions/upload-artifact@v4
        with:
          name: voice-uuid
          path: radio-workflow/temp/USE_UUID.md
          retention-days: 1
      
      - name: Generate opening script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ“‹ Opening Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿
          if [ -f "radio-workflow/radio-personality-data.md" ]; then
            PERSONALITY_DATA=$(cat radio-workflow/radio-personality-data.md)
            echo "âœ… ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
          else
            PERSONALITY_DATA=""
            echo "::warning::ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼
          cp radio-workflow/ssml_formatter.js $WORK_DIR/
          
          # æ¥½æ›²æƒ…å ±ã‚’å–å¾—
          SELECTED_MUSIC="ä¸æ˜"
          ARTIST_NAME="ä¸æ˜"
          SONG_NAME="ä¸æ˜"
          if [ -f "radio-workflow/temp/USE_UUID.md" ]; then
            SELECTED_MUSIC_FILE=$(grep "Selected Music File:" radio-workflow/temp/USE_UUID.md | cut -d' ' -f4- 2>/dev/null || echo "ä¸æ˜")
            ARTIST_NAME=$(grep "Artist:" radio-workflow/temp/USE_UUID.md | cut -d' ' -f2- 2>/dev/null || echo "ä¸æ˜")
            SONG_NAME=$(grep "Song:" radio-workflow/temp/USE_UUID.md | cut -d' ' -f2- 2>/dev/null || echo "ä¸æ˜")
            
            # æ¥½æ›²ç´¹ä»‹ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
            if [ "$ARTIST_NAME" != "ä¸æ˜" ] && [ "$SONG_NAME" != "ä¸æ˜" ] && [ "$SONG_NAME" != "ä¸æ˜2" ] && [ "$SONG_NAME" != "ä¸æ˜3" ]; then
              MUSIC_INTRO="ä»Šæ—¥ç´¹ä»‹ã™ã‚‹ã‚«ãƒ ã‚¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¥½æ›²ã¯ã€${ARTIST_NAME}ã•ã‚“ã®ã€Œ${SONG_NAME}ã€ã§ã™ã€‚"
            elif [ "$ARTIST_NAME" != "ä¸æ˜" ] && ([[ "$SONG_NAME" == "ä¸æ˜"* ]] || [ "$SONG_NAME" == "" ]); then
              MUSIC_INTRO="ä»Šæ—¥ç´¹ä»‹ã™ã‚‹ã‚«ãƒ ã‚¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¥½æ›²ã¯ã€${ARTIST_NAME}ã•ã‚“ã®æ¥½æ›²ã§ã™ã€‚"
            elif [ "$SONG_NAME" != "ä¸æ˜" ] && [[ ! "$SONG_NAME" == "ä¸æ˜"* ]]; then
              MUSIC_INTRO="ä»Šæ—¥ç´¹ä»‹ã™ã‚‹ã‚«ãƒ ã‚¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¥½æ›²ã¯ã€Œ${SONG_NAME}ã€ã§ã™ã€‚"
            else
              MUSIC_INTRO="ä»Šæ—¥ã‚‚ç´ æ•µãªæ¥½æ›²ã¨å…±ã«ãŠé€ã‚Šã—ã¾ã™ã€‚"
            fi
            echo "ğŸµ æ¥½æ›²ç´¹ä»‹: $MUSIC_INTRO"
          else
            MUSIC_INTRO="ä»Šæ—¥ã‚‚ç´ æ•µãªæ¥½æ›²ã¨å…±ã«ãŠé€ã‚Šã—ã¾ã™ã€‚"
            echo "::warning::æ¥½æ›²æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç´¹ä»‹æ–‡ã‚’ä½¿ç”¨"
          fi
          
          PROMPT="ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£: $PERSONALITY_DATA

          è¦ä»¶: 1åˆ†ï¼ˆ300-400æ–‡å­—ï¼‰
          æ§‹æˆ: æ˜ã‚‹ã„æŒ¨æ‹¶ â†’ ç•ªçµ„ç´¹ä»‹ â†’ æœ€å¾Œã«æ¥½æ›²ç´¹ä»‹(å¿…ãšçµ¶å¯¾ã«æœ€å¾Œã«å…¥ã‚Œã‚‹)
          æ¥½æ›²ç´¹ä»‹æ–‡ï¼ˆå¿…ãšçµ¶å¯¾æœ€å¾Œã«å…¥ã‚Œã‚‹ï¼‰: $MUSIC_INTRO
          
          ä»¥ä¸‹ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ opening.json ã¨ã—ã¦ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {\"opening\": \"å°æœ¬ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ¥½æ›²ç´¹ä»‹ã§çµ‚ã‚ã‚‹ï¼‰\"}
          
          **é‡è¦**: Writeãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"
          
          cd "$WORK_DIR" && npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 8 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          # å…ƒã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚‹
          cd - > /dev/null 2>&1 || cd /home/runner/work/kamuicode-workflow/kamuicode-workflow
          
          if [ -f "$WORK_DIR/opening.json" ]; then
            echo "ğŸ“„ opening.json ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨"
            
            # JSONã®æ¤œè¨¼
            if ! jq empty "$WORK_DIR/opening.json" 2>/dev/null; then
              echo "::error::opening.json ãŒç„¡åŠ¹ãªJSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã™"
              echo "::error::ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:"
              cat "$WORK_DIR/opening.json" | head -10
              exit 1
            fi
            
            OPENING_TEXT=$(jq -r '.opening' "$WORK_DIR/opening.json")
            
            if [ -z "$OPENING_TEXT" ] || [ "$OPENING_TEXT" = "null" ]; then
              echo "::error::opening.json ã« 'opening' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              echo "::error::JSONãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:"
              cat "$WORK_DIR/opening.json"
              exit 1
            fi
            
            echo "ğŸ“ å–å¾—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€åˆã®100æ–‡å­—ï¼‰: ${OPENING_TEXT:0:100}..."
            
            # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦å‡¦ç†
            echo "ğŸ›ï¸ SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‡¦ç†é–‹å§‹"
            
            if [ ! -f "radio-workflow/ssml_formatter.js" ]; then
              echo "::error::ssml_formatter.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              exit 1
            fi
            
            cp radio-workflow/ssml_formatter.js $WORK_DIR/
            
            # Node.jsã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
            node --version
            
            # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
            FORMATTED_TEXT=$(cd $WORK_DIR && node -e "
              try {
                const SSMLFormatter = require('./ssml_formatter.js');
                const formatter = new SSMLFormatter();
                const text = process.argv[1];
                if (!text) {
                  console.error('Error: Empty text provided');
                  process.exit(1);
                }
                const preset = formatter.getPreset ? formatter.getPreset('normal') : {};
                const formatted = formatter.formatWithBreaks(text, preset);
                console.log(formatted);
              } catch (e) {
                console.error('Error in SSML formatting:', e.message);
                process.exit(1);
              }
            " "$OPENING_TEXT" 2>&1) || {
              echo "::error::SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼"
              echo "::error::ã‚¨ãƒ©ãƒ¼å‡ºåŠ›: $FORMATTED_TEXT"
              exit 1
            }
            
            # å›ºæœ‰åè©ç½®ãæ›ãˆ
            FINAL_TEXT=$(echo "$FORMATTED_TEXT" | sed 's/ç¥å¨æ—¥å ±/ã‹ã‚€ã„ã«ã£ã½ã†/g' | sed 's/ç¥å¨/ã‚«ãƒ ã‚¤/g')
            
            echo "script-opening<<EOF" >> $GITHUB_OUTPUT
            echo "$FINAL_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "voice-config=default" >> $GITHUB_OUTPUT
            echo "âœ… Opening script generated successfully with SSML formatting"
          else
            echo "::error::Opening script generation failed - opening.json ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "::error::ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
            ls -la "$WORK_DIR/" || echo "ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            exit 1
          fi
          echo "::endgroup::"

  generate-main:
    runs-on: ubuntu-latest
    outputs:
      script-main: ${{ steps.planning.outputs.script-main }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate main part1 script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ“‹ Main Part1 Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿
          if [ -f "radio-workflow/radio-personality-data.md" ]; then
            PERSONALITY_DATA=$(cat radio-workflow/radio-personality-data.md)
            echo "âœ… ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
          else
            PERSONALITY_DATA=""
            echo "::warning::ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼
          cp radio-workflow/ssml_formatter.js $WORK_DIR/
          
          # çµ±ä¸€ã•ã‚ŒãŸæ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
          if [ -f "./development-report.txt" ]; then
            DEV_REPORT=$(cat ./development-report.txt)
          else
            DEV_REPORT='${{ inputs.development-report }}'
          fi
          
          # é–‹ç™ºé€²æ—æƒ…å ±ã‚’å‰åŠç”¨ã«åˆ†å‰²ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          HALF_LENGTH=$((${#DEV_REPORT} / 2))
          DEV_REPORT_PART1=$(echo "$DEV_REPORT" | cut -c1-$HALF_LENGTH)
          
          # é–‹ç™ºãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆå¼•æ•°åˆ¶é™å›é¿ï¼‰
          echo "$DEV_REPORT_PART1" > "$WORK_DIR/dev_report_part1.txt"
          echo "ğŸ“ é–‹ç™ºãƒ¬ãƒãƒ¼ãƒˆå‰åŠã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ (${#DEV_REPORT_PART1} bytes)"
          
          PROMPT="ãƒ¡ã‚¤ãƒ³å‰åŠå°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          ã¾ãšã€dev_report_part1.txt ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€ãã®å†…å®¹ã‚’é–‹ç™ºé€²æ—æƒ…å ±ã¨ã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

          ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£: $PERSONALITY_DATA

          è¦ä»¶: 3åˆ†ï¼ˆ900-1200æ–‡å­—ï¼‰ã€é–‹ç™ºé€²æ—ã®ä¸»è¦ãƒã‚¤ãƒ³ãƒˆè§£èª¬
          æ³¨æ„: æ¥½æ›²ç´¹ä»‹ã¯å«ã‚ãªã„ã§ãã ã•ã„ï¼ˆæ¥½æ›²ç´¹ä»‹ã¯ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã§æ—¢ã«è¡Œã£ã¦ã„ã¾ã™ï¼‰
          
          ä»¥ä¸‹ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ main.json ã¨ã—ã¦ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {\"main\": \"å°æœ¬ãƒ†ã‚­ã‚¹ãƒˆ\"}
          
          **é‡è¦**: Readãƒ„ãƒ¼ãƒ«ã§dev_report_part1.txtã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰ã€Writeãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"
          
          cd "$WORK_DIR" && npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 8 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          # å…ƒã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚‹
          cd - > /dev/null 2>&1 || cd /home/runner/work/kamuicode-workflow/kamuicode-workflow
          
          if [ -f "$WORK_DIR/main.json" ]; then
            echo "ğŸ“„ main.json ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨"
            
            # JSONã®æ¤œè¨¼
            if ! jq empty "$WORK_DIR/main.json" 2>/dev/null; then
              echo "::error::main.json ãŒç„¡åŠ¹ãªJSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã™"
              echo "::error::ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:"
              cat "$WORK_DIR/main.json" | head -10
              exit 1
            fi
            
            MAIN_TEXT=$(jq -r '.main' "$WORK_DIR/main.json")
            
            if [ -z "$MAIN_TEXT" ] || [ "$MAIN_TEXT" = "null" ]; then
              echo "::error::main.json ã« 'main' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              echo "::error::JSONãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:"
              cat "$WORK_DIR/main.json"
              exit 1
            fi
            
            echo "ğŸ“ å–å¾—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€åˆã®100æ–‡å­—ï¼‰: ${MAIN_TEXT:0:100}..."
            
            # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦å‡¦ç†
            echo "ğŸ›ï¸ SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‡¦ç†é–‹å§‹"
            cp radio-workflow/ssml_formatter.js $WORK_DIR/
            
            # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
            FORMATTED_TEXT=$(cd $WORK_DIR && node -e "
              try {
                const SSMLFormatter = require('./ssml_formatter.js');
                const formatter = new SSMLFormatter();
                const text = process.argv[1];
                if (!text) {
                  console.error('Error: Empty text provided');
                  process.exit(1);
                }
                const preset = formatter.getPreset ? formatter.getPreset('normal') : {};
                const formatted = formatter.formatWithBreaks(text, preset);
                console.log(formatted);
              } catch (e) {
                console.error('Error in SSML formatting:', e.message);
                process.exit(1);
              }
            " "$MAIN_TEXT" 2>&1) || {
              echo "::error::SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼"
              echo "::error::ã‚¨ãƒ©ãƒ¼å‡ºåŠ›: $FORMATTED_TEXT"
              exit 1
            }
            
            # å›ºæœ‰åè©ç½®ãæ›ãˆ
            FINAL_TEXT=$(echo "$FORMATTED_TEXT" | sed 's/ç¥å¨æ—¥å ±/ã‹ã‚€ã„ã«ã£ã½ã†/g' | sed 's/ç¥å¨/ã‚«ãƒ ã‚¤/g')
            
            echo "script-main<<EOF" >> $GITHUB_OUTPUT
            echo "$FINAL_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "âœ… Main part1 script generated successfully with SSML formatting"
          else
            echo "::error::Main part1 script generation failed - main.json ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "::error::ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
            ls -la "$WORK_DIR/" || echo "ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            exit 1
          fi
          echo "::endgroup::"

  generate-main-part2:
    runs-on: ubuntu-latest
    outputs:
      script-main-part2: ${{ steps.planning.outputs.script-main-part2 }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download auto-collected transcript
        if: ${{ inputs.use-auto-collected == true }}
        uses: actions/download-artifact@v4
        with:
          name: auto-collected-transcript
          path: ./transcript/
      
      - name: Setup transcript data
        run: |
          if [ "${{ inputs.use-auto-collected }}" == "true" ]; then
            if [ -f "./transcript/transcript.txt" ]; then
              cp "./transcript/transcript.txt" "./development-report.txt"
              echo "âœ… è‡ªå‹•åé›†ã•ã‚ŒãŸæ–‡å­—èµ·ã“ã—ã‚’ä½¿ç”¨ã—ã¾ã™"
              echo "æ–‡å­—æ•°: $(wc -c < ./development-report.txt)"
            else
              echo "::error::è‡ªå‹•åé›†ã•ã‚ŒãŸæ–‡å­—èµ·ã“ã—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              exit 1
            fi
          else
            echo '${{ inputs.development-report }}' > ./development-report.txt
            echo "âœ… æ‰‹å‹•å…¥åŠ›ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™"
            echo "æ–‡å­—æ•°: $(wc -c < ./development-report.txt)"
          fi
      
      - name: Generate main part2 script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ“‹ Main Part2 Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿
          if [ -f "radio-workflow/radio-personality-data.md" ]; then
            PERSONALITY_DATA=$(cat radio-workflow/radio-personality-data.md)
            echo "âœ… ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
          else
            PERSONALITY_DATA=""
            echo "::warning::ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼
          cp radio-workflow/ssml_formatter.js $WORK_DIR/
          
          # çµ±ä¸€ã•ã‚ŒãŸæ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
          if [ -f "./development-report.txt" ]; then
            DEV_REPORT=$(cat ./development-report.txt)
          else
            DEV_REPORT='${{ inputs.development-report }}'
          fi
          
          # é–‹ç™ºé€²æ—æƒ…å ±ã‚’å¾ŒåŠç”¨ã«åˆ†å‰²ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          REPORT_LENGTH=${#DEV_REPORT}
          HALF_LENGTH=$((REPORT_LENGTH / 2))
          
          echo "ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
          echo "  - ãƒ¬ãƒãƒ¼ãƒˆå…¨ä½“é•·: ${REPORT_LENGTH} bytes"
          echo "  - åŠåˆ†ã®ä½ç½®: ${HALF_LENGTH}"
          echo "  - ãƒ¬ãƒãƒ¼ãƒˆã®å…ˆé ­100æ–‡å­—: ${DEV_REPORT:0:100}"
          
          # bashã®éƒ¨åˆ†æ–‡å­—åˆ—å–å¾—æ§‹æ–‡ã‚’ä½¿ç”¨ï¼ˆã‚ˆã‚Šç¢ºå®Ÿï¼‰
          DEV_REPORT_PART2="${DEV_REPORT:$HALF_LENGTH}"
          
          echo "  - å¾ŒåŠéƒ¨åˆ†ã®é•·ã•: ${#DEV_REPORT_PART2} bytes"
          echo "  - å¾ŒåŠéƒ¨åˆ†ã®å…ˆé ­100æ–‡å­—: ${DEV_REPORT_PART2:0:100}"
          
          # é–‹ç™ºãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆå¼•æ•°åˆ¶é™å›é¿ï¼‰
          echo "$DEV_REPORT_PART2" > "$WORK_DIR/dev_report_part2.txt"
          echo "ğŸ“ é–‹ç™ºãƒ¬ãƒãƒ¼ãƒˆå¾ŒåŠã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ (${#DEV_REPORT_PART2} bytes)"
          
          PROMPT="ãƒ¡ã‚¤ãƒ³å¾ŒåŠå°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          ã¾ãšã€dev_report_part2.txt ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€ãã®å†…å®¹ã‚’é–‹ç™ºé€²æ—æƒ…å ±ã¨ã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

          ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£: $PERSONALITY_DATA

          è¦ä»¶: 3åˆ†ï¼ˆ900-1200æ–‡å­—ï¼‰ã€æ™‚äº‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚„è¿½åŠ æƒ…å ±ã€ãƒªã‚¹ãƒŠãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          
          ä»¥ä¸‹ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ main_part2.json ã¨ã—ã¦ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {\"main_part2\": \"å°æœ¬ãƒ†ã‚­ã‚¹ãƒˆ\"}
          
          **é‡è¦**: Readãƒ„ãƒ¼ãƒ«ã§dev_report_part2.txtã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰ã€Writeãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"
          
          cd "$WORK_DIR" && npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 8 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          # å…ƒã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚‹
          cd - > /dev/null 2>&1 || cd /home/runner/work/kamuicode-workflow/kamuicode-workflow
          
          if [ -f "$WORK_DIR/main_part2.json" ]; then
            echo "ğŸ“„ main_part2.json ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨"
            
            # JSONã®æ¤œè¨¼
            if ! jq empty "$WORK_DIR/main_part2.json" 2>/dev/null; then
              echo "::error::main_part2.json ãŒç„¡åŠ¹ãªJSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã™"
              echo "::error::ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:"
              cat "$WORK_DIR/main_part2.json" | head -10
              exit 1
            fi
            
            MAIN_PART2_TEXT=$(jq -r '.main_part2' "$WORK_DIR/main_part2.json")
            
            if [ -z "$MAIN_PART2_TEXT" ] || [ "$MAIN_PART2_TEXT" = "null" ]; then
              echo "::error::main_part2.json ã« 'main_part2' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              echo "::error::JSONãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:"
              cat "$WORK_DIR/main_part2.json"
              exit 1
            fi
            
            echo "ğŸ“ å–å¾—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€åˆã®100æ–‡å­—ï¼‰: ${MAIN_PART2_TEXT:0:100}..."
            
            # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦å‡¦ç†
            echo "ğŸ›ï¸ SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‡¦ç†é–‹å§‹"
            cp radio-workflow/ssml_formatter.js $WORK_DIR/
            
            # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
            FORMATTED_TEXT=$(cd $WORK_DIR && node -e "
              try {
                const SSMLFormatter = require('./ssml_formatter.js');
                const formatter = new SSMLFormatter();
                const text = process.argv[1];
                if (!text) {
                  console.error('Error: Empty text provided');
                  process.exit(1);
                }
                const preset = formatter.getPreset ? formatter.getPreset('normal') : {};
                const formatted = formatter.formatWithBreaks(text, preset);
                console.log(formatted);
              } catch (e) {
                console.error('Error in SSML formatting:', e.message);
                process.exit(1);
              }
            " "$MAIN_PART2_TEXT" 2>&1) || {
              echo "::error::SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼"
              echo "::error::ã‚¨ãƒ©ãƒ¼å‡ºåŠ›: $FORMATTED_TEXT"
              exit 1
            }
            
            # å›ºæœ‰åè©ç½®ãæ›ãˆ
            FINAL_TEXT=$(echo "$FORMATTED_TEXT" | sed 's/ç¥å¨æ—¥å ±/ã‹ã‚€ã„ã«ã£ã½ã†/g' | sed 's/ç¥å¨/ã‚«ãƒ ã‚¤/g')
            
            echo "script-main-part2<<EOF" >> $GITHUB_OUTPUT
            echo "$FINAL_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "âœ… Main part2 script generated successfully with SSML formatting"
          else
            echo "::error::Main part2 script generation failed - main_part2.json ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "::error::ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
            ls -la "$WORK_DIR/" || echo "ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            exit 1
          fi
          echo "::endgroup::"

  generate-jingle:
    runs-on: ubuntu-latest
    outputs:
      script-jingle: ${{ steps.planning.outputs.script-jingle }}
    steps:
      - name: Generate jingle script
        id: planning
        run: |
          echo "::group::ğŸ“‹ Jingle Script Generation"
          
          echo "script-jingle<<EOF" >> $GITHUB_OUTPUT
          echo "ã‹ã‚€ã‚‰ã˜" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Jingle script generated successfully"
          echo "::endgroup::"

  generate-ending:
    runs-on: ubuntu-latest
    outputs:
      script-ending: ${{ steps.planning.outputs.script-ending }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate ending script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ“‹ Ending Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿
          if [ -f "radio-workflow/radio-personality-data.md" ]; then
            PERSONALITY_DATA=$(cat radio-workflow/radio-personality-data.md)
            echo "âœ… ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
          else
            PERSONALITY_DATA=""
            echo "::warning::ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          PROMPT="ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£: $PERSONALITY_DATA

          è¦ä»¶: 1åˆ†ï¼ˆ300-400æ–‡å­—ï¼‰ã€ã¾ã¨ã‚ã¨æ¬¡å›äºˆå‘Š
          
          ä»¥ä¸‹ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ ending.json ã¨ã—ã¦ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {\"ending\": \"å°æœ¬ãƒ†ã‚­ã‚¹ãƒˆ\"}
          
          **é‡è¦**: Writeãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"
          
          echo "ğŸ” Claude Codeå®Ÿè¡Œå‰ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
          echo "  ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
          echo "  WORK_DIR: $WORK_DIR"
          echo "  WORK_DIRã®å­˜åœ¨ç¢ºèª: $(ls -ld "$WORK_DIR" 2>/dev/null || echo "å­˜åœ¨ã—ã¾ã›ã‚“")"
          echo "  WORK_DIRå†…ã®å†…å®¹: $(ls -la "$WORK_DIR" 2>/dev/null || echo "ç©ºã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯")"
          
          cd "$WORK_DIR" && echo "âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•æˆåŠŸ: $(pwd)" && npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 8 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          echo "ğŸ” Claude Codeå®Ÿè¡Œå¾Œã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
          echo "  ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
          echo "  WORK_DIRã®å­˜åœ¨ç¢ºèª: $(ls -ld "$WORK_DIR" 2>/dev/null || echo "å­˜åœ¨ã—ã¾ã›ã‚“")"
          echo "  WORK_DIRå†…ã®å†…å®¹: $(ls -la "$WORK_DIR" 2>/dev/null || echo "ç©ºã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯")"
          echo "  ending.jsonã®æ¤œç´¢: $(find . -name "ending.json" 2>/dev/null || echo "è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")"
          
          # å…ƒã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚‹
          cd - > /dev/null 2>&1 || cd /home/runner/work/kamuicode-workflow/kamuicode-workflow
          echo "  å…ƒã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚Šã¾ã—ãŸ: $(pwd)"
          
          if [ -f "$WORK_DIR/ending.json" ]; then
            echo "ğŸ“„ ending.json ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨"
            
            # JSONã®æ¤œè¨¼
            if ! jq empty "$WORK_DIR/ending.json" 2>/dev/null; then
              echo "::error::ending.json ãŒç„¡åŠ¹ãªJSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã™"
              echo "::error::ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:"
              cat "$WORK_DIR/ending.json" | head -10
              exit 1
            fi
            
            ENDING_TEXT=$(jq -r '.ending' "$WORK_DIR/ending.json")
            
            if [ -z "$ENDING_TEXT" ] || [ "$ENDING_TEXT" = "null" ]; then
              echo "::error::ending.json ã« 'ending' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              echo "::error::JSONãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:"
              cat "$WORK_DIR/ending.json"
              exit 1
            fi
            
            echo "ğŸ“ å–å¾—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€åˆã®100æ–‡å­—ï¼‰: ${ENDING_TEXT:0:100}..."
            
            # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦å‡¦ç†
            echo "ğŸ›ï¸ SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‡¦ç†é–‹å§‹"
            cp radio-workflow/ssml_formatter.js $WORK_DIR/
            
            # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
            FORMATTED_TEXT=$(cd $WORK_DIR && node -e "
              try {
                const SSMLFormatter = require('./ssml_formatter.js');
                const formatter = new SSMLFormatter();
                const text = process.argv[1];
                if (!text) {
                  console.error('Error: Empty text provided');
                  process.exit(1);
                }
                const preset = formatter.getPreset ? formatter.getPreset('normal') : {};
                const formatted = formatter.formatWithBreaks(text, preset);
                console.log(formatted);
              } catch (e) {
                console.error('Error in SSML formatting:', e.message);
                process.exit(1);
              }
            " "$ENDING_TEXT" 2>&1) || {
              echo "::error::SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼"
              echo "::error::ã‚¨ãƒ©ãƒ¼å‡ºåŠ›: $FORMATTED_TEXT"
              exit 1
            }
            
            # å›ºæœ‰åè©ç½®ãæ›ãˆ
            FINAL_TEXT=$(echo "$FORMATTED_TEXT" | sed 's/ç¥å¨æ—¥å ±/ã‹ã‚€ã„ã«ã£ã½ã†/g' | sed 's/ç¥å¨/ã‚«ãƒ ã‚¤/g')
            
            echo "script-ending<<EOF" >> $GITHUB_OUTPUT
            echo "$FINAL_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "âœ… Ending script generated successfully with SSML formatting"
          else
            echo "::error::Ending script generation failed - ending.json ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "::error::ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
            ls -la "$WORK_DIR/" || echo "ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            exit 1
          fi
          echo "::endgroup::"