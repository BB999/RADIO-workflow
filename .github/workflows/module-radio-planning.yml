name: Radio Planning Module - Split Jobs
on:
  workflow_call:
    inputs:
      development-report:
        required: true
        type: string
      tech-news:
        required: true
        type: string
      evening-report:
        required: true
        type: string
      topic-focus:
        required: false
        type: string
    outputs:
      script-opening:
        value: ${{ jobs.script-opening.outputs.script-text }}
      script-main:
        value: ${{ jobs.script-main.outputs.script-text }}
      script-main2:
        value: ${{ jobs.script-main2.outputs.script-text }}
      script-main3:
        value: ${{ jobs.script-main3.outputs.script-text }}
      script-ending:
        value: ${{ jobs.script-ending.outputs.script-text }}
      voice-config:
        value: ${{ jobs.planning-setup.outputs.voice-config }}

jobs:
  planning-setup:
    runs-on: ubuntu-latest
    outputs:
      personality-data: ${{ steps.setup.outputs.personality-data }}
      voice-config: ${{ steps.setup.outputs.voice-config }}
      voice-id: ${{ steps.setup.outputs.voice-id }}
      selected-music: ${{ steps.setup.outputs.selected-music }}
      artist-name: ${{ steps.setup.outputs.artist-name }}
      song-name: ${{ steps.setup.outputs.song-name }}
      news-content: ${{ steps.setup.outputs.news-content }}
      random-element: ${{ steps.setup.outputs.random-element }}
      opening-pattern: ${{ steps.setup.outputs.opening-pattern }}
      ending-pattern: ${{ steps.setup.outputs.ending-pattern }}
      character-mode: ${{ steps.setup.outputs.character-mode }}
      music-info: ${{ steps.setup.outputs.music-info }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Setup basic radio production data
        id: setup
        run: |
          echo "üìã Radio Production Setup"
          
          # „Éë„Éº„ÇΩ„Éä„É™„ÉÜ„Ç£„Éá„Éº„Çø„Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„ÇíË™≠„ÅøËæº„Åø
          if [ -f "radio-workflow/radio-personality-data.md" ]; then
            PERSONALITY_DATA=$(cat radio-workflow/radio-personality-data.md)
            echo "personality-data<<EOF" >> $GITHUB_OUTPUT
            echo "$PERSONALITY_DATA" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "personality-data=" >> $GITHUB_OUTPUT
          fi
          
          # Èü≥Ê•Ω„Éï„Ç°„Ç§„É´„Çí„É©„É≥„ÉÄ„É†ÈÅ∏Êäû
          if [ -d "radio-workflow/music" ]; then
            SELECTED_MUSIC_FILE=$(ls radio-workflow/music/*.mp3 | shuf -n 1 | xargs basename)
            if [[ "$SELECTED_MUSIC_FILE" =~ ^(.+)„Éª(.+)\.mp3$ ]]; then
              SONG_NAME="${BASH_REMATCH[1]}"
              ARTIST_NAME="${BASH_REMATCH[2]}"
            else
              SONG_NAME=""
              ARTIST_NAME=""
            fi
          else
            SELECTED_MUSIC_FILE="unknown.mp3"
            SONG_NAME=""
            ARTIST_NAME=""
          fi
          
          # Á∞°Êòì„Éã„É•„Éº„Çπ„Ç≥„É≥„ÉÜ„É≥„ÉÑ
          NEWS_CONTENT="„ÄêÂ§©Ê∞ó‰∫àÂ†±„ÄëÊù±‰∫¨„ÅÆÂ§©Ê∞ó: Êô¥„Çå ÊúÄÈ´òÊ∞óÊ∏©: 20‚ÑÉ„ÄêÊúÄËøë„ÅÆË©±È°å„ÄëAIÊäÄË°ì„ÅÆÈÄ≤Âåñ„ÅåË©±È°å"
          
          # „É©„É≥„ÉÄ„É†Ë¶ÅÁ¥†„ÅÆÁîüÊàê
          RANDOM_ELEMENTS=("‰ªäÊó•„ÅÆ„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞„ÅÇ„Çã„ÅÇ„ÇãË©±" "ÈñãÁô∫ËÄÖ„ÅÆÂ§â„Å™Áôñ„Ç®„Éî„ÇΩ„Éº„Éâ" "„Éê„Ç∞„Å®„ÅÆÊ†ºÈóòË®ò")
          RANDOM_ELEMENT_INDEX=$((RANDOM % ${#RANDOM_ELEMENTS[@]}))
          SELECTED_RANDOM_ELEMENT="${RANDOM_ELEMENTS[$RANDOM_ELEMENT_INDEX]}"
          
          OPENING_PATTERNS=("ÂÖÉÊ∞ó„ÅÑ„Å£„Å±„ÅÑ„Éè„Ç§„ÉÜ„É≥„Ç∑„Éß„É≥" "„Å°„Çá„Å£„Å®Áú†„Åù„ÅÜ„Å™ÊÑü„Åò„Åã„ÇâÂæê„ÄÖ„Å´„ÉÜ„É≥„Ç∑„Éß„É≥‰∏ä„Åå„Çã" "Ë¨é„ÅÆ„ÉÜ„É≥„Ç∑„Éß„É≥„ÅßÂßã„Åæ„Çã")
          OPENING_PATTERN_INDEX=$((RANDOM % ${#OPENING_PATTERNS[@]}))
          SELECTED_OPENING_PATTERN="${OPENING_PATTERNS[$OPENING_PATTERN_INDEX]}"
          
          ENDING_PATTERNS=("ÊÑüÂãïÁöÑ„Å´Á∑†„ÇÅ„ÇãÔºà„Åß„ÇÇ„Å°„Çá„Å£„Å®„Ç∫„É¨„Å¶„ÇãÔºâ" "ÊÄ•„Å´„ÉÜ„É≥„Ç∑„Éß„É≥‰∏ã„Åå„Å£„Å¶Á∑†„ÇÅ„Çã" "ÊúÄÂæå„Å´„ÉÄ„Ç∏„É£„É¨„ÅßÁ∑†„ÇÅ„Çã")
          ENDING_PATTERN_INDEX=$((RANDOM % ${#ENDING_PATTERNS[@]}))
          SELECTED_ENDING_PATTERN="${ENDING_PATTERNS[$ENDING_PATTERN_INDEX]}"
          
          CHARACTER_MODES=("„ÅÑ„Å§„ÇÇÈÄö„Çä" "„Å°„Çá„Å£„Å®Èñ¢Ë•øÂºÅÊ∑∑„Åò„Çä" "„ÇÑ„Åü„Çâ‰æã„ÅàË©±„ÅåÂ§ö„ÅÑ")
          CHARACTER_MODE_INDEX=$((RANDOM % ${#CHARACTER_MODES[@]}))
          SELECTED_CHARACTER_MODE="${CHARACTER_MODES[$CHARACTER_MODE_INDEX]}"
          
          # Ê•ΩÊõ≤ÊÉÖÂ†±„ÅÆË®≠ÂÆö
          if [ -n "$ARTIST_NAME" ] && [ -n "$SONG_NAME" ]; then
            MUSIC_INFO="- „Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà: $ARTIST_NAME - Ê•ΩÊõ≤Âêç: $SONG_NAME"
          else
            MUSIC_INFO="- Ê•ΩÊõ≤: $SELECTED_MUSIC_FILEÔºàË©≥Á¥∞‰∏çÊòéÔºâ"
          fi
          
          # ÂÖ®„Çª„ÇØ„Ç∑„Éß„É≥„ÇíGitHub Outputs„Å´Ë®≠ÂÆö
          echo "selected-music=$SELECTED_MUSIC_FILE" >> $GITHUB_OUTPUT
          echo "artist-name=$ARTIST_NAME" >> $GITHUB_OUTPUT
          echo "song-name=$SONG_NAME" >> $GITHUB_OUTPUT
          echo "news-content=$NEWS_CONTENT" >> $GITHUB_OUTPUT
          echo "random-element=$SELECTED_RANDOM_ELEMENT" >> $GITHUB_OUTPUT
          echo "opening-pattern=$SELECTED_OPENING_PATTERN" >> $GITHUB_OUTPUT
          echo "ending-pattern=$SELECTED_ENDING_PATTERN" >> $GITHUB_OUTPUT
          echo "character-mode=$SELECTED_CHARACTER_MODE" >> $GITHUB_OUTPUT
          echo "music-info=$MUSIC_INFO" >> $GITHUB_OUTPUT
          
          echo 'voice-config={"gender":"female","age":"20s"}' >> $GITHUB_OUTPUT
          
          # Èü≥Â£∞IDÈÅ∏Êäû„Å®USE_UUID.md„Éï„Ç°„Ç§„É´‰ΩúÊàê
          echo "::group::üé≤ Èü≥Â£∞IDÈÅ∏Êäû"
          
          # UUID.md„Éï„Ç°„Ç§„É´„Åã„ÇâÈü≥Â£∞ID„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„Åø
          if [ -f "radio-workflow/UUID.md" ]; then
            echo "‚úÖ UUID.md„Éï„Ç°„Ç§„É´„Åã„ÇâÈü≥Â£∞ID„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô"
            # Á©∫Ë°å„ÇíÈô§„ÅÑ„Å¶ÈÖçÂàó„Å´Ë™≠„ÅøËæº„Åø
            readarray -t VOICE_IDS < <(grep -v '^$' radio-workflow/UUID.md)
            echo "üìù Ë™≠„ÅøËæº„Åæ„Çå„ÅüÈü≥Â£∞IDÊï∞: ${#VOICE_IDS[@]}"
            for i in "${!VOICE_IDS[@]}"; do
              echo "  [$i] ${VOICE_IDS[$i]}"
            done
          else
            echo "::error::‚ùå UUID.md„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
            exit 1
          fi
          
          # „É©„É≥„ÉÄ„É†„Å´Èü≥Â£∞ID„ÇíÈÅ∏Êäû
          if [ ${#VOICE_IDS[@]} -eq 0 ]; then
            echo "::error::‚ùå Èü≥Â£∞ID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
            exit 1
          fi
          RANDOM_INDEX=$((RANDOM % ${#VOICE_IDS[@]}))
          SELECTED_VOICE_ID="${VOICE_IDS[$RANDOM_INDEX]}"
          
          echo "::endgroup::"
          
          # ÁèæÂú®„ÅÆÊó•‰ªò„ÇíÂèñÂæó
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          echo "üéØ ÈÅ∏Êäû„Åï„Çå„ÅüÈü≥Â£∞ID: $SELECTED_VOICE_ID"
          echo "üìÖ Êó•‰ªò: $CURRENT_DATE"
          
          # USE_UUID.md„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
          mkdir -p radio-workflow/temp
          echo "# Selected Voice ID and Music for Radio Production" > radio-workflow/temp/USE_UUID.md
          echo "" >> radio-workflow/temp/USE_UUID.md
          echo "Date: $CURRENT_DATE" >> radio-workflow/temp/USE_UUID.md
          echo "Voice UUID: $SELECTED_VOICE_ID" >> radio-workflow/temp/USE_UUID.md
          echo "Selected Music File: $SELECTED_MUSIC_FILE" >> radio-workflow/temp/USE_UUID.md
          echo "Artist: $ARTIST_NAME" >> radio-workflow/temp/USE_UUID.md
          echo "Song: $SONG_NAME" >> radio-workflow/temp/USE_UUID.md
          
          echo "voice-id=$SELECTED_VOICE_ID" >> $GITHUB_OUTPUT
          
          echo "‚úÖ USE_UUID.md„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü"
          cat radio-workflow/temp/USE_UUID.md
      
      - name: Upload voice UUID file
        uses: actions/upload-artifact@v4
        with:
          name: voice-uuid
          path: radio-workflow/temp/USE_UUID.md
          retention-days: 1

  preprocess-all-inputs:
    needs: planning-setup
    runs-on: ubuntu-latest
    outputs:
      processed-development-report: ${{ steps.process.outputs.processed-development-report }}
      processed-tech-news: ${{ steps.process.outputs.processed-tech-news }}
      processed-evening-report: ${{ steps.process.outputs.processed-evening-report }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Process all inputs in stages
        id: process
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "üîÑ ÂÖ®ÂÖ•Âäõ„Éá„Éº„Çø„ÅÆÊÆµÈöéÁöÑÂá¶ÁêÜÈñãÂßã"
          
          # Development Report „ÅÆÂá¶ÁêÜ
          echo "üìù Development ReportÂá¶ÁêÜÈñãÂßã"
          INPUT_TEXT="${{ inputs.development-report }}"
          INPUT_LENGTH=$(echo "$INPUT_TEXT" | wc -c)
          echo "üìè ÈñãÁô∫ÈÄ≤Êçó„Éá„Éº„ÇøÈï∑: ${INPUT_LENGTH}ÊñáÂ≠ó"
          
          if [ "$INPUT_LENGTH" -le 1000 ]; then
            echo "‚úÖ ÈñãÁô∫ÈÄ≤Êçó: Áü≠„ÅÑ„Éá„Éº„Çø„ÅÆ„Åü„ÇÅÁõ¥Êé•‰ΩøÁî®"
            PROCESSED_DEVELOPMENT_REPORT="$INPUT_TEXT"
          else
            echo "‚ö° ÈñãÁô∫ÈÄ≤Êçó: ÊÆµÈöéÁöÑÂá¶ÁêÜÂÆüË°å"
            echo "$INPUT_TEXT" > temp_dev_full.txt
            TOTAL_LINES=$(wc -l < temp_dev_full.txt)
            HALF_LINES=$((TOTAL_LINES / 2))
            
            head -n "$HALF_LINES" temp_dev_full.txt > temp_dev_part1.txt
            tail -n +"$((HALF_LINES + 1))" temp_dev_full.txt > temp_dev_part2.txt
            
            cat > dev_part1_prompt.txt << 'PROMPT_EOF'
          ‰ª•‰∏ã„ÅÆÁ•ûÂ®Å„Ç¢„Éó„É™ÈñãÁô∫ÈÄ≤ÊçóÊÉÖÂ†±„Çí„ÄÅ„É©„Ç∏„Ç™Âè∞Êú¨Áî®„Å´1000ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          ÈáçË¶Å„Å™Ê©üËÉΩËøΩÂä†„ÄÅ„Éê„Ç∞‰øÆÊ≠£„ÄÅÊäÄË°ìÂÆüË£Ö„ÅÆË¶ÅÁÇπ„ÅÆ„Åø„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          PROMPT_EOF
            cat temp_dev_part1.txt >> dev_part1_prompt.txt
            
            SUMMARY1=$(npx @anthropic-ai/claude-code \
              --allowedTools "none" \
              --max-turns 2 \
              < dev_part1_prompt.txt) || {
              echo "::error::ÈñãÁô∫ÈÄ≤Êçó„Éë„Éº„Éà1Ë¶ÅÁ¥Ñ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü"
              exit 1
            }
            
            cat > dev_part2_prompt.txt << 'PROMPT_EOF'
          ‰ª•‰∏ã„ÅÆÁ•ûÂ®Å„Ç¢„Éó„É™ÈñãÁô∫ÈÄ≤ÊçóÊÉÖÂ†±„Çí„ÄÅ„É©„Ç∏„Ç™Âè∞Êú¨Áî®„Å´1000ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          ÈáçË¶Å„Å™Ê©üËÉΩËøΩÂä†„ÄÅ„Éê„Ç∞‰øÆÊ≠£„ÄÅÊäÄË°ìÂÆüË£Ö„ÅÆË¶ÅÁÇπ„ÅÆ„Åø„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          PROMPT_EOF
            cat temp_dev_part2.txt >> dev_part2_prompt.txt
            
            SUMMARY2=$(npx @anthropic-ai/claude-code \
              --allowedTools "none" \
              --max-turns 2 \
              < dev_part2_prompt.txt) || {
              echo "::error::ÈñãÁô∫ÈÄ≤Êçó„Éë„Éº„Éà2Ë¶ÅÁ¥Ñ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü"
              exit 1
            }
            
            cat > dev_merge_prompt.txt << 'PROMPT_EOF'
          ‰ª•‰∏ã2„Å§„ÅÆÁ•ûÂ®Å„Ç¢„Éó„É™ÈñãÁô∫ÈÄ≤ÊçóË¶ÅÁ¥Ñ„Çí„ÄÅ„É©„Ç∏„Ç™Âè∞Êú¨Áî®„Å´1000ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÁµ±Âêà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          ÈáçË§á„ÇíÈÅø„Åë„ÄÅÊúÄ„ÇÇÈáçË¶Å„Å™„Éù„Ç§„É≥„Éà„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          „ÄêË¶ÅÁ¥Ñ1„Äë
          PROMPT_EOF
            echo "$SUMMARY1" >> dev_merge_prompt.txt
            echo "" >> dev_merge_prompt.txt
            echo "„ÄêË¶ÅÁ¥Ñ2„Äë" >> dev_merge_prompt.txt
            echo "$SUMMARY2" >> dev_merge_prompt.txt
            
            PROCESSED_DEVELOPMENT_REPORT=$(npx @anthropic-ai/claude-code \
              --allowedTools "none" \
              --max-turns 2 \
              < dev_merge_prompt.txt) || {
              echo "::error::ÈñãÁô∫ÈÄ≤ÊçóË¶ÅÁ¥ÑÁµ±Âêà„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü"
              exit 1
            }
            
            rm -f temp_dev_*.txt dev_*_prompt.txt
          fi
          
          echo "‚úÖ ÈñãÁô∫ÈÄ≤ÊçóÂá¶ÁêÜÂÆå‰∫Ü ($(echo "$PROCESSED_DEVELOPMENT_REPORT" | wc -c)ÊñáÂ≠ó)"
          
          # Tech News „ÅÆÂá¶ÁêÜ
          echo "üì∞ Tech NewsÂá¶ÁêÜÈñãÂßã"
          INPUT_TEXT="${{ inputs.tech-news }}"
          INPUT_LENGTH=$(echo "$INPUT_TEXT" | wc -c)
          echo "üìè „ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„Çπ„Éá„Éº„ÇøÈï∑: ${INPUT_LENGTH}ÊñáÂ≠ó"
          
          if [ "$INPUT_LENGTH" -le 1000 ]; then
            echo "‚úÖ „ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„Çπ: Áü≠„ÅÑ„Éá„Éº„Çø„ÅÆ„Åü„ÇÅÁõ¥Êé•‰ΩøÁî®"
            PROCESSED_TECH_NEWS="$INPUT_TEXT"
          else
            echo "‚ö° „ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„Çπ: ÊÆµÈöéÁöÑÂá¶ÁêÜÂÆüË°å"
            echo "$INPUT_TEXT" > temp_tech_full.txt
            TOTAL_LINES=$(wc -l < temp_tech_full.txt)
            HALF_LINES=$((TOTAL_LINES / 2))
            
            head -n "$HALF_LINES" temp_tech_full.txt > temp_tech_part1.txt
            tail -n +"$((HALF_LINES + 1))" temp_tech_full.txt > temp_tech_part2.txt
            
            cat > tech_part1_prompt.txt << 'PROMPT_EOF'
          ‰ª•‰∏ã„ÅÆ„ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„ÇπÊÉÖÂ†±„Çí„ÄÅ„É©„Ç∏„Ç™Âè∞Êú¨Áî®„Å´1000ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          ÈáçË¶Å„Å™„Éã„É•„Éº„Çπ„ÄÅÊäÄË°ìÂãïÂêë„ÄÅÊ•≠ÁïåÊÉÖÂ†±„ÅÆË¶ÅÁÇπ„ÅÆ„Åø„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          PROMPT_EOF
            cat temp_tech_part1.txt >> tech_part1_prompt.txt
            
            SUMMARY1=$(npx @anthropic-ai/claude-code \
              --allowedTools "none" \
              --max-turns 2 \
              < tech_part1_prompt.txt) || {
              echo "::error::„ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„Çπ„Éë„Éº„Éà1Ë¶ÅÁ¥Ñ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü"
              exit 1
            }
            
            cat > tech_part2_prompt.txt << 'PROMPT_EOF'
          ‰ª•‰∏ã„ÅÆ„ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„ÇπÊÉÖÂ†±„Çí„ÄÅ„É©„Ç∏„Ç™Âè∞Êú¨Áî®„Å´1000ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          ÈáçË¶Å„Å™„Éã„É•„Éº„Çπ„ÄÅÊäÄË°ìÂãïÂêë„ÄÅÊ•≠ÁïåÊÉÖÂ†±„ÅÆË¶ÅÁÇπ„ÅÆ„Åø„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          PROMPT_EOF
            cat temp_tech_part2.txt >> tech_part2_prompt.txt
            
            SUMMARY2=$(npx @anthropic-ai/claude-code \
              --allowedTools "none" \
              --max-turns 2 \
              < tech_part2_prompt.txt) || {
              echo "::error::„ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„Çπ„Éë„Éº„Éà2Ë¶ÅÁ¥Ñ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü"
              exit 1
            }
            
            cat > tech_merge_prompt.txt << 'PROMPT_EOF'
          ‰ª•‰∏ã2„Å§„ÅÆ„ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„ÇπË¶ÅÁ¥Ñ„Çí„ÄÅ„É©„Ç∏„Ç™Âè∞Êú¨Áî®„Å´1000ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÁµ±Âêà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          ÈáçË§á„ÇíÈÅø„Åë„ÄÅÊúÄ„ÇÇÈáçË¶Å„Å™„Éù„Ç§„É≥„Éà„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          „ÄêË¶ÅÁ¥Ñ1„Äë
          PROMPT_EOF
            echo "$SUMMARY1" >> tech_merge_prompt.txt
            echo "" >> tech_merge_prompt.txt
            echo "„ÄêË¶ÅÁ¥Ñ2„Äë" >> tech_merge_prompt.txt
            echo "$SUMMARY2" >> tech_merge_prompt.txt
            
            PROCESSED_TECH_NEWS=$(npx @anthropic-ai/claude-code \
              --allowedTools "none" \
              --max-turns 2 \
              < tech_merge_prompt.txt) || {
              echo "::error::„ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„ÇπË¶ÅÁ¥ÑÁµ±Âêà„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü"
              exit 1
            }
            
            rm -f temp_tech_*.txt tech_*_prompt.txt
          fi
          
          echo "‚úÖ „ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„ÇπÂá¶ÁêÜÂÆå‰∫Ü ($(echo "$PROCESSED_TECH_NEWS" | wc -c)ÊñáÂ≠ó)"
          
          # Evening Report „ÅÆÂá¶ÁêÜ
          echo "üåô Evening ReportÂá¶ÁêÜÈñãÂßã"
          INPUT_TEXT="${{ inputs.evening-report }}"
          INPUT_LENGTH=$(echo "$INPUT_TEXT" | wc -c)
          echo "üìè Â§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±„Éá„Éº„ÇøÈï∑: ${INPUT_LENGTH}ÊñáÂ≠ó"
          
          if [ "$INPUT_LENGTH" -le 1000 ]; then
            echo "‚úÖ Â§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±: Áü≠„ÅÑ„Éá„Éº„Çø„ÅÆ„Åü„ÇÅÁõ¥Êé•‰ΩøÁî®"
            PROCESSED_EVENING_REPORT="$INPUT_TEXT"
          else
            echo "‚ö° Â§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±: ÊÆµÈöéÁöÑÂá¶ÁêÜÂÆüË°å"
            echo "$INPUT_TEXT" > temp_evening_full.txt
            TOTAL_LINES=$(wc -l < temp_evening_full.txt)
            HALF_LINES=$((TOTAL_LINES / 2))
            
            head -n "$HALF_LINES" temp_evening_full.txt > temp_evening_part1.txt
            tail -n +"$((HALF_LINES + 1))" temp_evening_full.txt > temp_evening_part2.txt
            
            cat > evening_part1_prompt.txt << 'PROMPT_EOF'
          ‰ª•‰∏ã„ÅÆÂ§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±ÊÉÖÂ†±„Çí„ÄÅ„É©„Ç∏„Ç™Âè∞Êú¨Áî®„Å´1000ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          ÈáçË¶Å„Å™ÈñãÁô∫ÈÄ≤Êçó„ÄÅÂÆüË£ÖË©≥Á¥∞„ÄÅÊäÄË°ìÁöÑ„Å™Ê∞ó„Å•„Åç„ÅÆË¶ÅÁÇπ„ÅÆ„Åø„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          PROMPT_EOF
            cat temp_evening_part1.txt >> evening_part1_prompt.txt
            
            SUMMARY1=$(npx @anthropic-ai/claude-code \
              --allowedTools "none" \
              --max-turns 2 \
              < evening_part1_prompt.txt) || {
              echo "::error::Â§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±„Éë„Éº„Éà1Ë¶ÅÁ¥Ñ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü"
              exit 1
            }
            
            cat > evening_part2_prompt.txt << 'PROMPT_EOF'
          ‰ª•‰∏ã„ÅÆÂ§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±ÊÉÖÂ†±„Çí„ÄÅ„É©„Ç∏„Ç™Âè∞Êú¨Áî®„Å´1000ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          ÈáçË¶Å„Å™ÈñãÁô∫ÈÄ≤Êçó„ÄÅÂÆüË£ÖË©≥Á¥∞„ÄÅÊäÄË°ìÁöÑ„Å™Ê∞ó„Å•„Åç„ÅÆË¶ÅÁÇπ„ÅÆ„Åø„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          PROMPT_EOF
            cat temp_evening_part2.txt >> evening_part2_prompt.txt
            
            SUMMARY2=$(npx @anthropic-ai/claude-code \
              --allowedTools "none" \
              --max-turns 2 \
              < evening_part2_prompt.txt) || {
              echo "::error::Â§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±„Éë„Éº„Éà2Ë¶ÅÁ¥Ñ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü"
              exit 1
            }
            
            cat > evening_merge_prompt.txt << 'PROMPT_EOF'
          ‰ª•‰∏ã2„Å§„ÅÆÂ§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±Ë¶ÅÁ¥Ñ„Çí„ÄÅ„É©„Ç∏„Ç™Âè∞Êú¨Áî®„Å´1000ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÁµ±Âêà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          ÈáçË§á„ÇíÈÅø„Åë„ÄÅÊúÄ„ÇÇÈáçË¶Å„Å™„Éù„Ç§„É≥„Éà„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          „ÄêË¶ÅÁ¥Ñ1„Äë
          PROMPT_EOF
            echo "$SUMMARY1" >> evening_merge_prompt.txt
            echo "" >> evening_merge_prompt.txt
            echo "„ÄêË¶ÅÁ¥Ñ2„Äë" >> evening_merge_prompt.txt
            echo "$SUMMARY2" >> evening_merge_prompt.txt
            
            PROCESSED_EVENING_REPORT=$(npx @anthropic-ai/claude-code \
              --allowedTools "none" \
              --max-turns 2 \
              < evening_merge_prompt.txt) || {
              echo "::error::Â§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±Ë¶ÅÁ¥ÑÁµ±Âêà„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü"
              exit 1
            }
            
            rm -f temp_evening_*.txt evening_*_prompt.txt
          fi
          
          echo "‚úÖ Â§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±Âá¶ÁêÜÂÆå‰∫Ü ($(echo "$PROCESSED_EVENING_REPORT" | wc -c)ÊñáÂ≠ó)"
          
          # ÂÖ®ÁµêÊûú„ÇíGitHub Outputs„Å´Ë®≠ÂÆö
          {
            echo "processed-development-report<<EOF"
            echo "$PROCESSED_DEVELOPMENT_REPORT"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          {
            echo "processed-tech-news<<EOF"
            echo "$PROCESSED_TECH_NEWS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          {
            echo "processed-evening-report<<EOF"
            echo "$PROCESSED_EVENING_REPORT"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "üéØ ÂÖ®„Å¶„ÅÆÂÖ•Âäõ„Éá„Éº„ÇøÂâçÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü"

  script-opening:
    needs: [planning-setup, preprocess-all-inputs]
    runs-on: ubuntu-latest
    outputs:
      script-text: ${{ steps.generate.outputs.script-text }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate opening script
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "üé¨ „Ç™„Éº„Éó„Éã„É≥„Ç∞Âè∞Êú¨ÁîüÊàêÈñãÂßã"
          
          # „Éó„É≠„É≥„Éó„Éà„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
          cat > opening_prompt.txt << 'EOF'
          ‰ª•‰∏ã„ÅÆË®≠ÂÆö„Åß„É©„Ç∏„Ç™„ÅÆ„Ç™„Éº„Éó„Éã„É≥„Ç∞Âè∞Êú¨„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

          „Äê„Éë„Éº„ÇΩ„Éä„É™„ÉÜ„Ç£Ë®≠ÂÆö„Äë
          ${{ needs.planning-setup.outputs.personality-data }}

          „Äê‰ªäÊó•„ÅÆ„É©„É≥„ÉÄ„É†Ë¶ÅÁ¥†„Äë
          - „Ç™„Éº„Éó„Éã„É≥„Ç∞„Çπ„Çø„Ç§„É´: ${{ needs.planning-setup.outputs.opening-pattern }}
          - „Ç≠„É£„É©„ÇØ„Çø„Éº„É¢„Éº„Éâ: ${{ needs.planning-setup.outputs.character-mode }}
          - ÁâπÂà•„Éà„Éº„ÇØË¶ÅÁ¥†: ${{ needs.planning-setup.outputs.random-element }}

          „ÄêÊ•ΩÊõ≤ÊÉÖÂ†±„Äë
          ${{ needs.planning-setup.outputs.music-info }}

          „Äê‰ªäÊó•„ÅÆÂÜÖÂÆπÊ¶ÇË¶ÅÔºàÂèÇËÄÉÁî®Ôºâ„Äë
          - ÈñãÁô∫ÈÄ≤Êçó: ${{ needs.preprocess-all-inputs.outputs.processed-development-report }}
          - „ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„Çπ: ${{ needs.preprocess-all-inputs.outputs.processed-tech-news }}
          - Â§ú„ÅÆÊåØ„ÇäËøî„Çä: ${{ needs.preprocess-all-inputs.outputs.processed-evening-report }}

          „ÄêË¶Å‰ª∂„Äë
          - ÊôÇÈñì: 30ÁßíÔºàÁ¥Ñ200-250ÊñáÂ≠óÔºâ
          - ÂÜÖÂÆπ: Êòé„Çã„ÅÑÊå®Êã∂„ÄÅ‰ªäÊó•„ÅÆÊó•‰ªò„Å®Áï™ÁµÑÂêç„ÇíÁ¥π‰ªã„ÄÅÊ•ΩÊõ≤Á¥π‰ªã„ÇíÂê´„ÇÅ„Çã
          - „Éë„Éº„ÇΩ„Éä„É™„ÉÜ„Ç£„ÅÆÂè£Ë™ø„ÇÑÁâπÂæ¥„ÇíÂèçÊò†
          - ‰∏Ä‰∫∫Áß∞„ÅØ„ÄåÂÉï„Äç„Çí‰ΩøÁî®

          ÈáçË¶Å: ÁîüÊàê„Åó„Åü„Ç™„Éº„Éó„Éã„É≥„Ç∞Âè∞Êú¨„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàJSONÂΩ¢Âºè„Åß„ÅØ„Å™„Åè„ÄÅ„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„ÉàÔºâ„ÄÇ
          EOF

          # Claude CodeÂÆüË°åÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
          echo "üìù „Ç™„Éº„Éó„Éã„É≥„Ç∞Âè∞Êú¨ÁîüÊàê„ÇíÈñãÂßã„Åó„Åæ„Åô..."
          OPENING_SCRIPT=$(npx @anthropic-ai/claude-code \
            --allowedTools "none" \
            --max-turns 3 \
            < opening_prompt.txt 2>&1) || {
            echo "::error::„Ç™„Éº„Éó„Éã„É≥„Ç∞Âè∞Êú¨ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
            echo "::error::„Ç®„É©„ÉºÂÜÖÂÆπ: $OPENING_SCRIPT"
            exit 1
          }
          
          # Á©∫„ÉÅ„Çß„ÉÉ„ÇØ
          if [ -z "$OPENING_SCRIPT" ] || [[ "$OPENING_SCRIPT" == *"Error:"* ]] || [[ "$OPENING_SCRIPT" == *"Reached max turns"* ]]; then
            echo "::error::Âè∞Êú¨„ÅåÁ©∫„Åæ„Åü„ÅØ„Ç®„É©„Éº„ÇíÂê´„Çì„Åß„ÅÑ„Åæ„Åô"
            echo "::error::ÁîüÊàê„Åï„Çå„ÅüÂÜÖÂÆπ: $OPENING_SCRIPT"
            exit 1
          fi
          
          echo "‚úÖ „Ç™„Éº„Éó„Éã„É≥„Ç∞Âè∞Êú¨ÁîüÊàêÂÆå‰∫Ü ($(echo "$OPENING_SCRIPT" | wc -c)ÊñáÂ≠ó)"

          # SSMLÂá¶ÁêÜ
          if [ -f "radio-workflow/ssml_formatter.js" ]; then
            OPENING_SSML=$(echo "$OPENING_SCRIPT" | node -e "
              const SSMLFormatter = require('./radio-workflow/ssml_formatter.js');
              const formatter = new SSMLFormatter();
              let text = '';
              process.stdin.on('data', chunk => text += chunk);
              process.stdin.on('end', () => {
                const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                console.log(result);
              });
            ")
          else
            OPENING_SSML="$OPENING_SCRIPT"
          fi

          {
            echo "script-text<<EOF"
            echo "$OPENING_SSML"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  script-main:
    needs: [planning-setup, preprocess-all-inputs]
    runs-on: ubuntu-latest
    outputs:
      script-text: ${{ steps.generate.outputs.script-text }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate main script
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "üé¨ „É°„Ç§„É≥1Âè∞Êú¨ÁîüÊàêÈñãÂßã"
          
          # „Éó„É≠„É≥„Éó„Éà„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
          cat > main_prompt.txt << 'EOF'
          ‰ª•‰∏ã„ÅÆË®≠ÂÆö„Åß„É©„Ç∏„Ç™„ÅÆ„É°„Ç§„É≥1ÔºàÊòº„ÅÆÁ•ûÂ®ÅÊó•Â†±ÔºâÂè∞Êú¨„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

          „Äê„Éë„Éº„ÇΩ„Éä„É™„ÉÜ„Ç£Ë®≠ÂÆö„Äë
          ${{ needs.planning-setup.outputs.personality-data }}

          „Äê„Çª„ÇØ„Ç∑„Éß„É≥ÂÜÖÂÆπ„Äë
          ${{ needs.preprocess-all-inputs.outputs.processed-development-report }}

          „ÄêÂº∑Ë™ø„Éù„Ç§„É≥„Éà„Äë
          ${{ inputs.topic-focus || '„Å™„Åó' }}

          „Äê‰ªäÊó•„ÅÆ„É©„É≥„ÉÄ„É†Ë¶ÅÁ¥†„Äë
          - „Ç≠„É£„É©„ÇØ„Çø„Éº„É¢„Éº„Éâ: ${{ needs.planning-setup.outputs.character-mode }}
          - ÁâπÂà•„Éà„Éº„ÇØË¶ÅÁ¥†: ${{ needs.planning-setup.outputs.random-element }}

          „ÄêË¶Å‰ª∂„Äë
          - ÊôÇÈñì: 50ÁßíÔºàÁ¥Ñ300-350ÊñáÂ≠óÔºâ
          - ÂÜÖÂÆπ: Êòº„ÅÆÁ•ûÂ®ÅÊó•Â†±„ÅÆË¶ÅÁÇπ„Åæ„Å®„ÇÅ
          - „Éë„Éº„ÇΩ„Éä„É™„ÉÜ„Ç£„ÅÆÂè£Ë™ø„ÇÑÁâπÂæ¥„ÇíÂèçÊò†
          - ‰∏Ä‰∫∫Áß∞„ÅØ„ÄåÂÉï„Äç„Çí‰ΩøÁî®

          ÈáçË¶Å: ÁîüÊàê„Åó„Åü„É°„Ç§„É≥Âè∞Êú¨„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàJSONÂΩ¢Âºè„Åß„ÅØ„Å™„Åè„ÄÅ„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„ÉàÔºâ„ÄÇ
          EOF

          # Claude CodeÂÆüË°åÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
          echo "üìù Âè∞Êú¨ÁîüÊàê„ÇíÈñãÂßã„Åó„Åæ„Åô..."
          MAIN_SCRIPT=$(npx @anthropic-ai/claude-code \
            --allowedTools "none" \
            --max-turns 3 \
            < main_prompt.txt 2>&1) || {
            echo "::error::„É°„Ç§„É≥1Âè∞Êú¨ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
            echo "::error::„Ç®„É©„ÉºÂÜÖÂÆπ: $MAIN_SCRIPT"
            exit 1
          }
          
          # Á©∫„ÉÅ„Çß„ÉÉ„ÇØ
          if [ -z "$MAIN_SCRIPT" ] || [[ "$MAIN_SCRIPT" == *"Error:"* ]] || [[ "$MAIN_SCRIPT" == *"Reached max turns"* ]]; then
            echo "::error::Âè∞Êú¨„ÅåÁ©∫„Åæ„Åü„ÅØ„Ç®„É©„Éº„ÇíÂê´„Çì„Åß„ÅÑ„Åæ„Åô"
            echo "::error::ÁîüÊàê„Åï„Çå„ÅüÂÜÖÂÆπ: $MAIN_SCRIPT"
            exit 1
          fi
          
          echo "‚úÖ „É°„Ç§„É≥1Âè∞Êú¨ÁîüÊàêÂÆå‰∫Ü ($(echo "$MAIN_SCRIPT" | wc -c)ÊñáÂ≠ó)"

          # SSMLÂá¶ÁêÜ
          if [ -f "radio-workflow/ssml_formatter.js" ]; then
            MAIN_SSML=$(echo "$MAIN_SCRIPT" | node -e "
              const SSMLFormatter = require('./radio-workflow/ssml_formatter.js');
              const formatter = new SSMLFormatter();
              let text = '';
              process.stdin.on('data', chunk => text += chunk);
              process.stdin.on('end', () => {
                const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                console.log(result);
              });
            ")
          else
            MAIN_SSML="$MAIN_SCRIPT"
          fi

          {
            echo "script-text<<EOF"
            echo "$MAIN_SSML"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  script-main2:
    needs: [planning-setup, preprocess-all-inputs]
    runs-on: ubuntu-latest
    outputs:
      script-text: ${{ steps.generate.outputs.script-text }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate main2 script
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "üé¨ „É°„Ç§„É≥2Âè∞Êú¨ÁîüÊàêÈñãÂßã"
          
          # „Éó„É≠„É≥„Éó„Éà„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
          cat > main2_prompt.txt << 'EOF'
          ‰ª•‰∏ã„ÅÆË®≠ÂÆö„Åß„É©„Ç∏„Ç™„ÅÆ„É°„Ç§„É≥2Ôºà„ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„ÇπÔºâÂè∞Êú¨„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

          „Äê„Éë„Éº„ÇΩ„Éä„É™„ÉÜ„Ç£Ë®≠ÂÆö„Äë
          ${{ needs.planning-setup.outputs.personality-data }}

          „Äê„Çª„ÇØ„Ç∑„Éß„É≥ÂÜÖÂÆπ„Äë
          ${{ needs.preprocess-all-inputs.outputs.processed-tech-news }}

          „Äê‰ªäÊó•„ÅÆ„É©„É≥„ÉÄ„É†Ë¶ÅÁ¥†„Äë
          - „Ç≠„É£„É©„ÇØ„Çø„Éº„É¢„Éº„Éâ: ${{ needs.planning-setup.outputs.character-mode }}
          - ÁâπÂà•„Éà„Éº„ÇØË¶ÅÁ¥†: ${{ needs.planning-setup.outputs.random-element }}

          „ÄêË¶Å‰ª∂„Äë
          - ÊôÇÈñì: 50ÁßíÔºàÁ¥Ñ300-350ÊñáÂ≠óÔºâ
          - ÂÜÖÂÆπ: ÂÖÉÊú®„Åï„ÇìÂé≥ÈÅ∏„ÅÆ„ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„Çπ„ÇíÈÄüÂ†±Áï™ÁµÑ„ÅÆ„Çà„ÅÜ„Å´Á¥π‰ªã
          - „Éã„É•„Éº„Ç≠„É£„Çπ„Çø„Éº„ÅÆ„Çà„ÅÜ„Å™„Éû„Ç∏„Éû„Å™Âè£Ë™øÔºàÂé≥ÂÆàÔºâ
          - ‰∏Ä‰∫∫Áß∞„ÅØ„ÄåÂÉï„Äç„Çí‰ΩøÁî®

          ÈáçË¶Å: ÁîüÊàê„Åó„Åü„É°„Ç§„É≥2Âè∞Êú¨„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàJSONÂΩ¢Âºè„Åß„ÅØ„Å™„Åè„ÄÅ„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„ÉàÔºâ„ÄÇ
          EOF

          # Claude CodeÂÆüË°åÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
          echo "üìù „ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„ÇπÂè∞Êú¨ÁîüÊàê„ÇíÈñãÂßã„Åó„Åæ„Åô..."
          MAIN2_SCRIPT=$(npx @anthropic-ai/claude-code \
            --allowedTools "none" \
            --max-turns 3 \
            < main2_prompt.txt 2>&1) || {
            echo "::error::„É°„Ç§„É≥2Âè∞Êú¨ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
            echo "::error::„Ç®„É©„ÉºÂÜÖÂÆπ: $MAIN2_SCRIPT"
            exit 1
          }
          
          # Á©∫„ÉÅ„Çß„ÉÉ„ÇØ
          if [ -z "$MAIN2_SCRIPT" ] || [[ "$MAIN2_SCRIPT" == *"Error:"* ]] || [[ "$MAIN2_SCRIPT" == *"Reached max turns"* ]]; then
            echo "::error::Âè∞Êú¨„ÅåÁ©∫„Åæ„Åü„ÅØ„Ç®„É©„Éº„ÇíÂê´„Çì„Åß„ÅÑ„Åæ„Åô"
            echo "::error::ÁîüÊàê„Åï„Çå„ÅüÂÜÖÂÆπ: $MAIN2_SCRIPT"
            exit 1
          fi
          
          echo "‚úÖ „É°„Ç§„É≥2Âè∞Êú¨ÁîüÊàêÂÆå‰∫Ü ($(echo "$MAIN2_SCRIPT" | wc -c)ÊñáÂ≠ó)"

          # SSMLÂá¶ÁêÜ
          if [ -f "radio-workflow/ssml_formatter.js" ]; then
            MAIN2_SSML=$(echo "$MAIN2_SCRIPT" | node -e "
              const SSMLFormatter = require('./radio-workflow/ssml_formatter.js');
              const formatter = new SSMLFormatter();
              let text = '';
              process.stdin.on('data', chunk => text += chunk);
              process.stdin.on('end', () => {
                const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                console.log(result);
              });
            ")
          else
            MAIN2_SSML="$MAIN2_SCRIPT"
          fi

          {
            echo "script-text<<EOF"
            echo "$MAIN2_SSML"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  script-main3:
    needs: [planning-setup, preprocess-all-inputs]
    runs-on: ubuntu-latest
    outputs:
      script-text: ${{ steps.generate.outputs.script-text }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate main3 script
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "üé¨ „É°„Ç§„É≥3Âè∞Êú¨ÁîüÊàêÈñãÂßã"
          
          # „Éó„É≠„É≥„Éó„Éà„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
          cat > main3_prompt.txt << 'EOF'
          ‰ª•‰∏ã„ÅÆË®≠ÂÆö„Åß„É©„Ç∏„Ç™„ÅÆ„É°„Ç§„É≥3ÔºàÂ§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±ÔºâÂè∞Êú¨„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

          „Äê„Éë„Éº„ÇΩ„Éä„É™„ÉÜ„Ç£Ë®≠ÂÆö„Äë
          ${{ needs.planning-setup.outputs.personality-data }}

          „Äê„Çª„ÇØ„Ç∑„Éß„É≥ÂÜÖÂÆπ„Äë
          ${{ needs.preprocess-all-inputs.outputs.processed-evening-report }}

          „Äê‰ªäÊó•„ÅÆ„É©„É≥„ÉÄ„É†Ë¶ÅÁ¥†„Äë
          - „Ç≠„É£„É©„ÇØ„Çø„Éº„É¢„Éº„Éâ: ${{ needs.planning-setup.outputs.character-mode }}
          - ÁâπÂà•„Éà„Éº„ÇØË¶ÅÁ¥†: ${{ needs.planning-setup.outputs.random-element }}

          „ÄêË¶Å‰ª∂„Äë
          - ÊôÇÈñì: 50ÁßíÔºàÁ¥Ñ300-350ÊñáÂ≠óÔºâ
          - ÂÜÖÂÆπ: Â§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±„ÅÆË¶ÅÁÇπ„Åæ„Å®„ÇÅ
          - „Éë„Éº„ÇΩ„Éä„É™„ÉÜ„Ç£„ÅÆÂè£Ë™ø„ÇÑÁâπÂæ¥„ÇíÂèçÊò†
          - ‰∏Ä‰∫∫Áß∞„ÅØ„ÄåÂÉï„Äç„Çí‰ΩøÁî®

          ÈáçË¶Å: ÁîüÊàê„Åó„Åü„É°„Ç§„É≥3Âè∞Êú¨„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàJSONÂΩ¢Âºè„Åß„ÅØ„Å™„Åè„ÄÅ„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„ÉàÔºâ„ÄÇ
          EOF

          # Claude CodeÂÆüË°åÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
          echo "üìù Â§ú„ÅÆÁ•ûÂ®ÅÊó•Â†±Âè∞Êú¨ÁîüÊàê„ÇíÈñãÂßã„Åó„Åæ„Åô..."
          MAIN3_SCRIPT=$(npx @anthropic-ai/claude-code \
            --allowedTools "none" \
            --max-turns 3 \
            < main3_prompt.txt 2>&1) || {
            echo "::error::„É°„Ç§„É≥3Âè∞Êú¨ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
            echo "::error::„Ç®„É©„ÉºÂÜÖÂÆπ: $MAIN3_SCRIPT"
            exit 1
          }
          
          # Á©∫„ÉÅ„Çß„ÉÉ„ÇØ
          if [ -z "$MAIN3_SCRIPT" ] || [[ "$MAIN3_SCRIPT" == *"Error:"* ]] || [[ "$MAIN3_SCRIPT" == *"Reached max turns"* ]]; then
            echo "::error::Âè∞Êú¨„ÅåÁ©∫„Åæ„Åü„ÅØ„Ç®„É©„Éº„ÇíÂê´„Çì„Åß„ÅÑ„Åæ„Åô"
            echo "::error::ÁîüÊàê„Åï„Çå„ÅüÂÜÖÂÆπ: $MAIN3_SCRIPT"
            exit 1
          fi
          
          echo "‚úÖ „É°„Ç§„É≥3Âè∞Êú¨ÁîüÊàêÂÆå‰∫Ü ($(echo "$MAIN3_SCRIPT" | wc -c)ÊñáÂ≠ó)"

          # SSMLÂá¶ÁêÜ
          if [ -f "radio-workflow/ssml_formatter.js" ]; then
            MAIN3_SSML=$(echo "$MAIN3_SCRIPT" | node -e "
              const SSMLFormatter = require('./radio-workflow/ssml_formatter.js');
              const formatter = new SSMLFormatter();
              let text = '';
              process.stdin.on('data', chunk => text += chunk);
              process.stdin.on('end', () => {
                const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                console.log(result);
              });
            ")
          else
            MAIN3_SSML="$MAIN3_SCRIPT"
          fi

          {
            echo "script-text<<EOF"
            echo "$MAIN3_SSML"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  script-ending:
    needs: [planning-setup, preprocess-all-inputs]
    runs-on: ubuntu-latest
    outputs:
      script-text: ${{ steps.generate.outputs.script-text }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate ending script
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "üé¨ „Ç®„É≥„Éá„Ç£„É≥„Ç∞Âè∞Êú¨ÁîüÊàêÈñãÂßã"
          
          # „Éó„É≠„É≥„Éó„Éà„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
          cat > ending_prompt.txt << 'EOF'
          ‰ª•‰∏ã„ÅÆË®≠ÂÆö„Åß„É©„Ç∏„Ç™„ÅÆ„Ç®„É≥„Éá„Ç£„É≥„Ç∞Âè∞Êú¨„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

          „Äê„Éë„Éº„ÇΩ„Éä„É™„ÉÜ„Ç£Ë®≠ÂÆö„Äë
          ${{ needs.planning-setup.outputs.personality-data }}

          „Äê‰ªäÊó•„ÅÆ„É©„É≥„ÉÄ„É†Ë¶ÅÁ¥†„Äë
          - „Ç®„É≥„Éá„Ç£„É≥„Ç∞„Çπ„Çø„Ç§„É´: ${{ needs.planning-setup.outputs.ending-pattern }}
          - „Ç≠„É£„É©„ÇØ„Çø„Éº„É¢„Éº„Éâ: ${{ needs.planning-setup.outputs.character-mode }}

          „Äê‰ªäÊó•„ÅÆÂÜÖÂÆπÊ¶ÇË¶ÅÔºàÂèÇËÄÉÁî®Ôºâ„Äë
          - ÈñãÁô∫ÈÄ≤Êçó: ${{ needs.preprocess-all-inputs.outputs.processed-development-report }}
          - „ÉÜ„ÉÉ„ÇØ„Éã„É•„Éº„Çπ: ${{ needs.preprocess-all-inputs.outputs.processed-tech-news }}
          - Â§ú„ÅÆÊåØ„ÇäËøî„Çä: ${{ needs.preprocess-all-inputs.outputs.processed-evening-report }}

          „ÄêË¶Å‰ª∂„Äë
          - ÊôÇÈñì: 30ÁßíÔºàÁ¥Ñ200-250ÊñáÂ≠óÔºâ
          - ÂÜÖÂÆπ: „Åæ„Å®„ÇÅ„Å®Ê¨°Âõû‰∫àÂëä
          - „Éë„Éº„ÇΩ„Éä„É™„ÉÜ„Ç£„ÅÆÂè£Ë™ø„ÇÑÁâπÂæ¥„ÇíÂèçÊò†
          - ‰∏Ä‰∫∫Áß∞„ÅØ„ÄåÂÉï„Äç„Çí‰ΩøÁî®

          ÈáçË¶Å: ÁîüÊàê„Åó„Åü„Ç®„É≥„Éá„Ç£„É≥„Ç∞Âè∞Êú¨„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàJSONÂΩ¢Âºè„Åß„ÅØ„Å™„Åè„ÄÅ„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„ÉàÔºâ„ÄÇ
          EOF

          # Claude CodeÂÆüË°åÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
          echo "üìù „Ç®„É≥„Éá„Ç£„É≥„Ç∞Âè∞Êú¨ÁîüÊàê„ÇíÈñãÂßã„Åó„Åæ„Åô..."
          ENDING_SCRIPT=$(npx @anthropic-ai/claude-code \
            --allowedTools "none" \
            --max-turns 3 \
            < ending_prompt.txt 2>&1) || {
            echo "::error::„Ç®„É≥„Éá„Ç£„É≥„Ç∞Âè∞Êú¨ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
            echo "::error::„Ç®„É©„ÉºÂÜÖÂÆπ: $ENDING_SCRIPT"
            exit 1
          }
          
          # Á©∫„ÉÅ„Çß„ÉÉ„ÇØ
          if [ -z "$ENDING_SCRIPT" ] || [[ "$ENDING_SCRIPT" == *"Error:"* ]] || [[ "$ENDING_SCRIPT" == *"Reached max turns"* ]]; then
            echo "::error::Âè∞Êú¨„ÅåÁ©∫„Åæ„Åü„ÅØ„Ç®„É©„Éº„ÇíÂê´„Çì„Åß„ÅÑ„Åæ„Åô"
            echo "::error::ÁîüÊàê„Åï„Çå„ÅüÂÜÖÂÆπ: $ENDING_SCRIPT"
            exit 1
          fi
          
          echo "‚úÖ „Ç®„É≥„Éá„Ç£„É≥„Ç∞Âè∞Êú¨ÁîüÊàêÂÆå‰∫Ü ($(echo "$ENDING_SCRIPT" | wc -c)ÊñáÂ≠ó)"

          # SSMLÂá¶ÁêÜ
          if [ -f "radio-workflow/ssml_formatter.js" ]; then
            ENDING_SSML=$(echo "$ENDING_SCRIPT" | node -e "
              const SSMLFormatter = require('./radio-workflow/ssml_formatter.js');
              const formatter = new SSMLFormatter();
              let text = '';
              process.stdin.on('data', chunk => text += chunk);
              process.stdin.on('end', () => {
                const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                console.log(result);
              });
            ")
          else
            ENDING_SSML="$ENDING_SCRIPT"
          fi

          {
            echo "script-text<<EOF"
            echo "$ENDING_SSML"
            echo "EOF"
          } >> $GITHUB_OUTPUT