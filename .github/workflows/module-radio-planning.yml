name: Radio Planning Module (Minimal)
on:
  workflow_call:
    inputs:
      development-report:
        required: true
        type: string
      topic-focus:
        required: false
        type: string
    outputs:
      script-opening:
        value: ${{ jobs.generate.outputs.script-opening }}
      script-main:
        value: ${{ jobs.generate.outputs.script-main }}
      script-ending:
        value: ${{ jobs.generate.outputs.script-ending }}
      voice-config:
        value: ${{ jobs.generate.outputs.voice-config }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      script-opening: ${{ steps.planning.outputs.script-opening }}
      script-main: ${{ steps.planning.outputs.script-main }}
      script-ending: ${{ steps.planning.outputs.script-ending }}
      voice-config: ${{ steps.planning.outputs.voice-config }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Copy SSML formatter
        run: |
          # SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
          cp radio-workflow/ssml_formatter.js ./ssml_formatter.js
          echo "âœ… SSML formatter copied to working directory"
      
      - name: Generate radio scripts with Claude
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ“‹ Radio Script Generation"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿
          if [ -f "radio-workflow/radio-personality-data.md" ]; then
            PERSONALITY_DATA=$(cat radio-workflow/radio-personality-data.md)
            echo "âœ… ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
          else
            PERSONALITY_DATA=""
            echo "::warning::ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
          echo "::group::ğŸµ éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ"
          
          # radio-workflow/musicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰å®Ÿéš›ã®mp3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          echo "ğŸ“ musicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­..."
          if [ ! -d "radio-workflow/music" ]; then
            echo "::error::radio-workflow/musicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # .mp3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…åˆ—ã«å–å¾—
          declare -a MUSIC_FILES=()
          while IFS= read -r -d '' file; do
            filename=$(basename "$file")
            MUSIC_FILES+=("$filename")
            echo "  - ç™ºè¦‹: $filename"
          done < <(find radio-workflow/music -name "*.mp3" -print0)
          
          # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ ${#MUSIC_FILES[@]} -eq 0 ]; then
            echo "::error::musicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«.mp3ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          echo "ğŸ“Š åˆè¨ˆ ${#MUSIC_FILES[@]} å€‹ã®éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          
          # ãƒ©ãƒ³ãƒ€ãƒ ã«éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆæ—¥æ™‚ãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ¼ãƒ‰ï¼‰
          SEED=$(date +%s%N | cut -b10-19)
          MUSIC_RANDOM_INDEX=$((SEED % ${#MUSIC_FILES[@]}))
          SELECTED_MUSIC_FILE="${MUSIC_FILES[$MUSIC_RANDOM_INDEX]}"
          echo "  ã‚·ãƒ¼ãƒ‰å€¤: $SEED, ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: $MUSIC_RANDOM_INDEX"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ¨æ¸¬ã§ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã¨æ›²åã‚’æŠ½å‡ºï¼ˆãƒ»ã§åŒºåˆ‡ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
          if [[ "$SELECTED_MUSIC_FILE" =~ ^(.+)ãƒ»(.+)\.mp3$ ]]; then
            SONG_NAME="${BASH_REMATCH[1]}"
            ARTIST_NAME="${BASH_REMATCH[2]}"
          else
            # ãƒ»ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿
            SONG_NAME=""
            ARTIST_NAME=""
          fi
          
          echo "ğŸ¯ é¸æŠã•ã‚ŒãŸéŸ³æ¥½: $SELECTED_MUSIC_FILE"
          echo "ğŸ¤ ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ: ${ARTIST_NAME:-'ä¸æ˜'}"
          echo "ğŸµ æ¥½æ›²å: ${SONG_NAME:-'ä¸æ˜'}"
          
          echo "::endgroup::"
          
          # æ™‚äº‹ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—
          echo "::group::ğŸ“° æ™‚äº‹ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—"
          echo "æœ€æ–°ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—ä¸­..."
          
          # å®‰å…¨ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ã¿ä½¿ç”¨
          NEWS_TOPICS="ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ AI ã‚¬ã‚¸ã‚§ãƒƒãƒˆ ã‚²ãƒ¼ãƒ  ã‚¢ãƒ‹ãƒ¡ ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆ ç§‘å­¦ å®‡å®™ æ–°å•†å“"
          
          # Claude Code CLIã§æ™‚äº‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨å¤©æ°—æƒ…å ±å–å¾—ï¼ˆWebSearchãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
          NEWS_PROMPT="ä»Šæ—¥ã®æ—¥æœ¬ã®æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’3ã¤ã¨ã€æ±äº¬ã®ä»Šæ—¥ã®å¤©æ°—äºˆå ±ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚

          ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€‘
          - ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã€AIã€ITé–¢é€£
          - ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆã€èŠ¸èƒ½
          - ç§‘å­¦ã€å®‡å®™
          - ã‚²ãƒ¼ãƒ ã€ã‚¢ãƒ‹ãƒ¡
          - æ–°å•†å“ã€ã‚¬ã‚¸ã‚§ãƒƒãƒˆ
          
          **é‡è¦**: æ”¿æ²»ã€å®—æ•™ã€å·®åˆ¥ã€èª¹è¬—ä¸­å‚·ã€ç‚ä¸Šç³»ã®è©±é¡Œã¯çµ¶å¯¾ã«é¿ã‘ã¦ãã ã•ã„ã€‚
          æ˜ã‚‹ãæ¥½ã—ã„è©±é¡Œã®ã¿ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
          
          ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
          
          ã€å¤©æ°—äºˆå ±ã€‘
          æ±äº¬ã®å¤©æ°—: æ™´ã‚Œ/æ›‡ã‚Š/é›¨ãªã©
          æœ€é«˜æ°—æ¸©: XXâ„ƒ
          æœ€ä½æ°—æ¸©: XXâ„ƒ
          
          ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘
          1. [ã‚«ãƒ†ã‚´ãƒªãƒ¼] ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ« - ç°¡å˜ãªèª¬æ˜
          2. [ã‚«ãƒ†ã‚´ãƒªãƒ¼] ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ« - ç°¡å˜ãªèª¬æ˜
          3. [ã‚«ãƒ†ã‚´ãƒªãƒ¼] ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ« - ç°¡å˜ãªèª¬æ˜"
          
          NEWS_RESULT=$(npx @anthropic-ai/claude-code \
            --allowedTools "WebSearch" \
            --max-turns 3 \
            --print \
            "$NEWS_PROMPT" 2>/dev/null || echo "ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—å¤±æ•—")
          
          # ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—çµæœã‚’æ•´å½¢
          if [ -z "$NEWS_RESULT" ] || [ "$NEWS_RESULT" = "ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—å¤±æ•—" ]; then
            echo "::warning::æ™‚äº‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
            NEWS_CONTENT="
          ã€å¤©æ°—äºˆå ±ã€‘
          æ±äº¬ã®å¤©æ°—: æ™´ã‚Œ
          æœ€é«˜æ°—æ¸©: 20â„ƒ
          æœ€ä½æ°—æ¸©: 12â„ƒ
          
          ã€æœ€è¿‘ã®è©±é¡Œã€‘
          - AIæŠ€è¡“ã®é€²åŒ–ãŒè©±é¡Œ
          - æ–°ã—ã„ã‚²ãƒ¼ãƒ æ©Ÿã®ç™ºè¡¨
          - å®‡å®™é–‹ç™ºã®æœ€æ–°æƒ…å ±"
          else
            NEWS_CONTENT="$NEWS_RESULT"
            echo "âœ… æ™‚äº‹ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—æˆåŠŸ"
            echo "$NEWS_CONTENT"
          fi
          
          echo "::endgroup::"
          
          # ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã®ç”Ÿæˆ
          echo "::group::ğŸ² ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ç”Ÿæˆ"
          
          # ãƒ©ãƒ³ãƒ€ãƒ ãªãƒˆãƒ¼ã‚¯è¦ç´ 
          RANDOM_ELEMENTS=()
          RANDOM_ELEMENTS+=("ä»Šæ—¥ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚ã‚‹ã‚ã‚‹è©±")
          RANDOM_ELEMENTS+=("é–‹ç™ºè€…ã®å¤‰ãªç™–ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰")
          RANDOM_ELEMENTS+=("ãƒã‚°ã¨ã®æ ¼é—˜è¨˜")
          RANDOM_ELEMENTS+=("æ·±å¤œã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®æ€ã„å‡º")
          RANDOM_ELEMENTS+=("ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ã®æˆ¦ã„")
          RANDOM_ELEMENTS+=("ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è£è©±")
          RANDOM_ELEMENTS+=("æ–°æ©Ÿèƒ½ã®ã‚¢ã‚¤ãƒ‡ã‚¢å¦„æƒ³")
          RANDOM_ELEMENTS+=("é–‹ç™ºç’°å¢ƒãƒˆãƒ©ãƒ–ãƒ«ä½“é¨“è«‡")
          RANDOM_ELEMENTS+=("ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®äº‹ä»¶")
          RANDOM_ELEMENTS+=("ãƒ‡ãƒ—ãƒ­ã‚¤å‰å¤œã®ä¸å®‰è©±")
          
          # ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸æŠ
          RANDOM_ELEMENT_INDEX=$((RANDOM % ${#RANDOM_ELEMENTS[@]}))
          SELECTED_RANDOM_ELEMENT="${RANDOM_ELEMENTS[$RANDOM_ELEMENT_INDEX]}"
          
          # ãƒ©ãƒ³ãƒ€ãƒ ãªã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³
          OPENING_PATTERNS=()
          OPENING_PATTERNS+=("å…ƒæ°—ã„ã£ã±ã„ãƒã‚¤ãƒ†ãƒ³ã‚·ãƒ§ãƒ³")
          OPENING_PATTERNS+=("ã¡ã‚‡ã£ã¨çœ ãã†ãªæ„Ÿã˜ã‹ã‚‰å¾ã€…ã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸ŠãŒã‚‹")
          OPENING_PATTERNS+=("è¬ã®ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã§å§‹ã¾ã‚‹")
          OPENING_PATTERNS+=("ã„ããªã‚Šãƒœã‚±ã‹ã‚‰å…¥ã‚‹")
          OPENING_PATTERNS+=("è‡ªåˆ†ã«ãƒ„ãƒƒã‚³ãƒŸãªãŒã‚‰æŒ¨æ‹¶")
          
          OPENING_PATTERN_INDEX=$((RANDOM % ${#OPENING_PATTERNS[@]}))
          SELECTED_OPENING_PATTERN="${OPENING_PATTERNS[$OPENING_PATTERN_INDEX]}"
          
          # ãƒ©ãƒ³ãƒ€ãƒ ãªç· ã‚ãƒ‘ã‚¿ãƒ¼ãƒ³
          ENDING_PATTERNS=()
          ENDING_PATTERNS+=("æ„Ÿå‹•çš„ã«ç· ã‚ã‚‹ï¼ˆã§ã‚‚ã¡ã‚‡ã£ã¨ã‚ºãƒ¬ã¦ã‚‹ï¼‰")
          ENDING_PATTERNS+=("æ€¥ã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸‹ãŒã£ã¦ç· ã‚ã‚‹")
          ENDING_PATTERNS+=("æœ€å¾Œã«ãƒ€ã‚¸ãƒ£ãƒ¬ã§ç· ã‚ã‚‹")
          ENDING_PATTERNS+=("ãƒªã‚¹ãƒŠãƒ¼ã«ç„¡èŒ¶æŒ¯ã‚Šã—ã¦ç· ã‚ã‚‹")
          ENDING_PATTERNS+=("è¬ã®æ±ºæ„è¡¨æ˜ã§ç· ã‚ã‚‹")
          
          ENDING_PATTERN_INDEX=$((RANDOM % ${#ENDING_PATTERNS[@]}))
          SELECTED_ENDING_PATTERN="${ENDING_PATTERNS[$ENDING_PATTERN_INDEX]}"
          
          # ä»Šæ—¥ã®ç‰¹åˆ¥ãªã‚­ãƒ£ãƒ©è¨­å®š
          CHARACTER_MODES=()
          CHARACTER_MODES+=("ã„ã¤ã‚‚é€šã‚Š")
          CHARACTER_MODES+=("ã¡ã‚‡ã£ã¨é–¢è¥¿å¼æ··ã˜ã‚Š")
          CHARACTER_MODES+=("ã‚„ãŸã‚‰ä¾‹ãˆè©±ãŒå¤šã„")
          CHARACTER_MODES+=("å£°çœŸä¼¼ã‚’å¤šç”¨")
          CHARACTER_MODES+=("åŠ¹æœéŸ³ã‚’å£ã§è¨€ã„ã¾ãã‚Š")
          CHARACTER_MODES+=("ä¸€äººäºŒå½¹ã§ä¼šè©±")
          
          CHARACTER_MODE_INDEX=$((RANDOM % ${#CHARACTER_MODES[@]}))
          SELECTED_CHARACTER_MODE="${CHARACTER_MODES[$CHARACTER_MODE_INDEX]}"
          
          echo "ğŸ¯ ä»Šæ—¥ã®ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ :"
          echo "  ãƒˆãƒ¼ã‚¯è¦ç´ : $SELECTED_RANDOM_ELEMENT"
          echo "  ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«: $SELECTED_OPENING_PATTERN"
          echo "  ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«: $SELECTED_ENDING_PATTERN"
          echo "  ã‚­ãƒ£ãƒ©ãƒ¢ãƒ¼ãƒ‰: $SELECTED_CHARACTER_MODE"
          
          echo "::endgroup::"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰ï¼ˆéŸ³æ¥½é¸æŠå¾Œã«å®Ÿè¡Œï¼‰
          PROMPT="ä»¥ä¸‹ã®å†…å®¹ã§ãƒ©ã‚¸ã‚ªç•ªçµ„å°æœ¬ã‚’ç”Ÿæˆã—ã€JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š

          ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£è¨­å®šã€‘
          $PERSONALITY_DATA

          ã€é–‹ç™ºé€²æ—ãƒ»æœ€æ–°æƒ…å ±ã€‘
          ${{ inputs.development-report }}

          ã€å¼·èª¿ãƒã‚¤ãƒ³ãƒˆã€‘
          ${{ inputs.topic-focus || 'ãªã—' }}

          ã€ä»Šæ—¥ã®å¤©æ°—ã¨æ™‚äº‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘
          $NEWS_CONTENT

          ã€ä»Šæ—¥ã®ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã€‘
          - ç‰¹åˆ¥ãƒˆãƒ¼ã‚¯è¦ç´ : $SELECTED_RANDOM_ELEMENT
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«: $SELECTED_OPENING_PATTERN
          - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«: $SELECTED_ENDING_PATTERN
          - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰: $SELECTED_CHARACTER_MODE

          ã€ä»Šæ—¥ã®æ¥½æ›²ã€‘$(
            if [ -n "$ARTIST_NAME" ] && [ -n "$SONG_NAME" ]; then
              echo "
          - ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ: $ARTIST_NAME
          - æ¥½æ›²å: $SONG_NAME"
            elif [ -n "$ARTIST_NAME" ]; then
              echo "
          - ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ: $ARTIST_NAME
          - æ¥½æ›²: $SELECTED_MUSIC_FILEï¼ˆæ¥½æ›²åä¸æ˜ï¼‰"
            else
              echo "
          - æ¥½æ›²: $SELECTED_MUSIC_FILEï¼ˆè©³ç´°ä¸æ˜ï¼‰"
            fi
          )

          ã€è¦ä»¶ã€‘$(
            if [ -n "$ARTIST_NAME" ] && [ -n "$SONG_NAME" ]; then
              echo "
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: 1åˆ†ï¼ˆæ˜ã‚‹ã„æŒ¨æ‹¶ã€å¿…ãšä»Šæ—¥ã®æ—¥ä»˜ã¨ç•ªçµ„åã‚’ç´¹ä»‹ã€æœ€å¾Œã«ä»Šæ—¥ã®æ¥½æ›²ã€Œ$SONG_NAMEã€by $ARTIST_NAME ã®ç´¹ä»‹ã‚’å«ã‚ã‚‹ï¼‰ç´„300-400æ–‡å­—"
            elif [ -n "$ARTIST_NAME" ]; then
              echo "
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: 1åˆ†ï¼ˆæ˜ã‚‹ã„æŒ¨æ‹¶ã€å¿…ãšä»Šæ—¥ã®æ—¥ä»˜ã¨ç•ªçµ„åã‚’ç´¹ä»‹ã€æœ€å¾Œã«$ARTIST_NAME ã®æ¥½æ›²ã®ç´¹ä»‹ã‚’å«ã‚ã‚‹ï¼‰ç´„300-400æ–‡å­—"
            else
              echo "
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: 1åˆ†ï¼ˆæ˜ã‚‹ã„æŒ¨æ‹¶ã€å¿…ãšä»Šæ—¥ã®æ—¥ä»˜ã¨ç•ªçµ„åã‚’ç´¹ä»‹ã€æ¥½æ›²ã«ã¤ã„ã¦ã¯è©³ç´°ã‚’è¨€ã‚ãšã«ã€Œä»Šæ—¥ã®æ¥½æ›²ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€ç¨‹åº¦ã§ç´¹ä»‹ï¼‰ç´„300-400æ–‡å­—"
            fi
          )
          - ãƒ¡ã‚¤ãƒ³: 2åˆ†ï¼ˆå†…å®¹ã‚’åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã€æ™‚äº‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚‚ç¹”ã‚Šäº¤ãœã‚‹ï¼‰ç´„600-800æ–‡å­—  
          - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: 1åˆ†ï¼ˆã¾ã¨ã‚ã¨æ¬¡å›äºˆå‘Šï¼‰ç´„300-400æ–‡å­—
          - ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£: radio-personality-data.mdã®è¨­å®šã«å¾“ã†
          - ä¸€äººç§°ã¯ã€Œåƒ•ã€ã€å£ç™–ã‚„è©±ã—æ–¹ã®ç‰¹å¾´ã‚’å¿…ãšåæ˜ 
          - **æ™‚äº‹ãƒ‹ãƒ¥ãƒ¼ã‚¹**: ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒ¼ãƒˆã§1ã€œ2å€‹ã®æ™‚äº‹ãƒã‚¿ã«è§¦ã‚Œã¦ã€é–‹ç™ºã®è©±ã¨çµ¡ã‚ã‚‹
          - **ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ **: æŒ‡å®šã•ã‚ŒãŸãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚’å¿…ãšå–ã‚Šå…¥ã‚Œã‚‹ï¼ˆç‰¹åˆ¥ãƒˆãƒ¼ã‚¯è¦ç´ ã€ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ãƒ»ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰
          - **ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³**: æ¯å›é•ã†é›°å›²æ°—ã®ç•ªçµ„ã«ãªã‚‹ã‚ˆã†ã€ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚’æ´»ã‹ã—ã¦å€‹æ€§ã‚’å‡ºã™
          - **é‡è¦**: ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ãƒ»ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¯1åˆ†ï¼ˆ300-400æ–‡å­—ï¼‰ã€ãƒ¡ã‚¤ãƒ³ã¯2åˆ†ï¼ˆ600-800æ–‡å­—ï¼‰ã§ç”Ÿæˆã—ã€APIåˆ¶é™ã®3000æ–‡å­—ä»¥å†…ã«åã‚ã¦ãã ã•ã„$(
            if [ -n "$ARTIST_NAME" ] && [ -n "$SONG_NAME" ]; then
              echo "
          - **ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°æ›²ç´¹ä»‹**: ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã®æœ€å¾Œã§ã€Œãã‚Œã§ã¯ä»Šæ—¥ã®æ¥½æ›²ã€$ARTIST_NAME ã•ã‚“ã®ã€$SONG_NAMEã€ã‚’ãŠè´ããã ã•ã„ã€ã®ã‚ˆã†ãªå½¢ã§è‡ªç„¶ã«æ¥½æ›²ç´¹ä»‹ã‚’å…¥ã‚Œã¦ãã ã•ã„"
            elif [ -n "$ARTIST_NAME" ]; then
              echo "
          - **ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°æ›²ç´¹ä»‹**: ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã®æœ€å¾Œã§ã€Œãã‚Œã§ã¯ä»Šæ—¥ã®æ¥½æ›²ã€$ARTIST_NAME ã•ã‚“ã®ä½œå“ã‚’ãŠè´ããã ã•ã„ã€ã®ã‚ˆã†ãªå½¢ã§è‡ªç„¶ã«æ¥½æ›²ç´¹ä»‹ã‚’å…¥ã‚Œã¦ãã ã•ã„"
            else
              echo "
          - **ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°æ›²ç´¹ä»‹**: ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã®æœ€å¾Œã§ã€Œãã‚Œã§ã¯ä»Šæ—¥ã®æ¥½æ›²ã‚’ãŠè´ããã ã•ã„ã€ã®ã‚ˆã†ãªå½¢ã§æ¥½æ›²ç´¹ä»‹ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼ˆè©³ç´°ã¯è¨€ã‚ãªã„ï¼‰"
            fi
          )

          **é‡è¦**: ä»¥ä¸‹ã®JSONã‚’ \"$WORK_DIR/scripts.json\" ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {
            \"opening\": \"ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ï¼ˆ300-400æ–‡å­—ç¨‹åº¦ï¼‰\",
            \"main\": \"ãƒ¡ã‚¤ãƒ³å°æœ¬ï¼ˆ600-800æ–‡å­—ç¨‹åº¦ï¼‰\", 
            \"ending\": \"ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬ï¼ˆ300-400æ–‡å­—ç¨‹åº¦ï¼‰\"
          }"
          
          echo "ğŸš€ Starting Radio Script Generation..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãæ–‡å­—æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼‰
          for attempt in {1..5}; do
            echo "ğŸ¯ Claude Code CLIå®Ÿè¡Œä¸­ï¼ˆè©¦è¡Œ $attempt/5ï¼‰..."
            
            if npx @anthropic-ai/claude-code \
              --allowedTools "Write,Edit" \
              --max-turns 10 \
              --verbose \
              --permission-mode "acceptEdits" \
              -p "$PROMPT"; then
              
              # ç”Ÿæˆã•ã‚ŒãŸå°æœ¬ã®æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯
              if [ -f "$WORK_DIR/scripts.json" ] && jq empty "$WORK_DIR/scripts.json" 2>/dev/null; then
                echo "âœ… JSONãƒ•ã‚¡ã‚¤ãƒ«ç”ŸæˆæˆåŠŸ"
                
                # å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯
                OPENING_LENGTH=$(jq -r '.opening' "$WORK_DIR/scripts.json" | wc -c)
                MAIN_LENGTH=$(jq -r '.main' "$WORK_DIR/scripts.json" | wc -c)
                ENDING_LENGTH=$(jq -r '.ending' "$WORK_DIR/scripts.json" | wc -c)
                
                echo "ğŸ“ æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯: opening=$OPENING_LENGTH, main=$MAIN_LENGTH, ending=$ENDING_LENGTH"
                
                if [ $OPENING_LENGTH -le 3000 ] && [ $MAIN_LENGTH -le 3000 ] && [ $ENDING_LENGTH -le 3000 ]; then
                  echo "âœ… å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒ3000æ–‡å­—ä»¥å†…ã§ã™"
                  break
                else
                  echo "::warning::âš ï¸ ä¸€éƒ¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒ3000æ–‡å­—ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼ˆè©¦è¡Œ $attempt/5ï¼‰"
                  PROMPT="å‰å›ç”Ÿæˆã—ãŸå°æœ¬ãŒé•·ã™ãã¾ã—ãŸã€‚å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’3000æ–‡å­—ä»¥å†…ã§çŸ­ãç”Ÿæˆã—ç›´ã—ã¦ãã ã•ã„ã€‚JSONã‚’ $WORK_DIR/scripts.json ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"
                fi
              else
                echo "::warning::âš ï¸ JSONãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå¤±æ•—ï¼ˆè©¦è¡Œ $attempt/5ï¼‰"
              fi
            else
              echo "::warning::âš ï¸ Claude Codeå®Ÿè¡Œå¤±æ•—ï¼ˆè©¦è¡Œ $attempt/5ï¼‰"
            fi
            
            if [ $attempt -eq 5 ]; then
              echo "::error::âŒ 5å›è©¦è¡Œã—ã¦ã‚‚é©åˆ‡ãªå°æœ¬ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"
              exit 1
            fi
            
            sleep 5
          done
          
          # ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªã¨èª­ã¿è¾¼ã¿
          if [ -f "$WORK_DIR/scripts.json" ]; then
            echo "âœ… Scripts JSON file generated"
            cat "$WORK_DIR/scripts.json"
            
            # JSONã‹ã‚‰å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
            if jq empty "$WORK_DIR/scripts.json" 2>/dev/null; then
              echo "âœ… Valid JSON response received"
              
              # SSMLå‡¦ç†ã‚’è¿½åŠ 
              echo "::group::ğŸµ SSML Processing"
              echo "ğŸ”„ Applying SSML formatting to all scripts..."
              
              # å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨
              OPENING_TEXT=$(jq -r '.opening' "$WORK_DIR/scripts.json")
              MAIN_TEXT=$(jq -r '.main' "$WORK_DIR/scripts.json")
              ENDING_TEXT=$(jq -r '.ending' "$WORK_DIR/scripts.json")
              
              # å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ã‹ã‚‰å‡¦ç†ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå•é¡Œã‚’å›é¿ï¼‰
              echo "$OPENING_TEXT" > temp_opening.txt
              echo "$MAIN_TEXT" > temp_main.txt
              echo "$ENDING_TEXT" > temp_ending.txt
              
              # Node.jsã§SSMLãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’å®Ÿè¡Œï¼ˆstdinä½¿ç”¨ã§ã‚¯ã‚©ãƒ¼ãƒˆå•é¡Œã‚’å›é¿ï¼‰
              OPENING_SSML=$(cat temp_opening.txt | node -e "
                const SSMLFormatter = require('./ssml_formatter.js');
                const formatter = new SSMLFormatter();
                let text = '';
                process.stdin.on('data', chunk => text += chunk);
                process.stdin.on('end', () => {
                  const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                  console.log(result);
                });
              ")
              
              MAIN_SSML=$(cat temp_main.txt | node -e "
                const SSMLFormatter = require('./ssml_formatter.js');
                const formatter = new SSMLFormatter();
                let text = '';
                process.stdin.on('data', chunk => text += chunk);
                process.stdin.on('end', () => {
                  const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                  console.log(result);
                });
              ")
              
              ENDING_SSML=$(cat temp_ending.txt | node -e "
                const SSMLFormatter = require('./ssml_formatter.js');
                const formatter = new SSMLFormatter();
                let text = '';
                process.stdin.on('data', chunk => text += chunk);
                process.stdin.on('end', () => {
                  const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                  console.log(result);
                });
              ")
              
              # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
              rm -f temp_opening.txt temp_main.txt temp_ending.txt
              
              echo "âœ… SSML formatting completed"
              echo "ğŸ“ Opening SSML length: ${#OPENING_SSML}"
              echo "ğŸ“ Main SSML length: ${#MAIN_SSML}"  
              echo "ğŸ“ Ending SSML length: ${#ENDING_SSML}"
              echo "::endgroup::"
              
              # SSMLç‰ˆã‚’GitHub Outputsã«è¨­å®šï¼ˆãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
              {
                echo "script-opening<<EOF"
                echo "$OPENING_SSML"
                echo "EOF"
              } >> $GITHUB_OUTPUT
              
              {
                echo "script-main<<EOF"
                echo "$MAIN_SSML"
                echo "EOF"
              } >> $GITHUB_OUTPUT
              
              {
                echo "script-ending<<EOF"
                echo "$ENDING_SSML"
                echo "EOF"
              } >> $GITHUB_OUTPUT
            else
              echo "::warning::Invalid JSON format, using fallback scripts"
              echo "script-opening=ã“ã‚“ã«ã¡ã¯ã€ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªã§ã™ã€‚ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" >> $GITHUB_OUTPUT
              echo "script-main=å°æœ¬ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ã«ä¸å…·åˆãŒèµ·ãã¦ãŠã‚Šã€æœ¬æ—¥ã®æ”¾é€ã‚’ãŠå±Šã‘ã§ãã¾ã›ã‚“ã€‚ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã¦å¤§å¤‰ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãé–“ã‚’ãŠã„ã¦ã‹ã‚‰ã€ã¾ãŸèãã«æ¥ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚" >> $GITHUB_OUTPUT
              echo "script-ending=å¾©æ—§ä½œæ¥­ã‚’é€²ã‚ã¦ãŠã‚Šã¾ã™ã®ã§ã€ä»Šå¾Œã¨ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªã§ã—ãŸã€‚" >> $GITHUB_OUTPUT
            fi
          else
            echo "::warning::Scripts JSON file not found, using fallback scripts"
            echo "script-opening=ã“ã‚“ã«ã¡ã¯ã€ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªã§ã™ã€‚ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" >> $GITHUB_OUTPUT
            echo "script-main=å°æœ¬ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ã«ä¸å…·åˆãŒèµ·ãã¦ãŠã‚Šã€æœ¬æ—¥ã®æ”¾é€ã‚’ãŠå±Šã‘ã§ãã¾ã›ã‚“ã€‚ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã¦å¤§å¤‰ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãé–“ã‚’ãŠã„ã¦ã‹ã‚‰ã€ã¾ãŸèãã«æ¥ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚" >> $GITHUB_OUTPUT
            echo "script-ending=å¾©æ—§ä½œæ¥­ã‚’é€²ã‚ã¦ãŠã‚Šã¾ã™ã®ã§ã€ä»Šå¾Œã¨ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªã§ã—ãŸã€‚" >> $GITHUB_OUTPUT
          fi
          
          echo 'voice-config={"gender":"female","age":"20s"}' >> $GITHUB_OUTPUT
          
          # éŸ³å£°IDé¸æŠã¨USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          echo "::group::ğŸ² éŸ³å£°IDé¸æŠ"
          
          # UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰éŸ³å£°IDãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
          if [ -f "radio-workflow/UUID.md" ]; then
            echo "âœ… UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰éŸ³å£°IDã‚’èª­ã¿è¾¼ã¿ã¾ã™"
            # ç©ºè¡Œã‚’é™¤ã„ã¦é…åˆ—ã«èª­ã¿è¾¼ã¿
            readarray -t VOICE_IDS < <(grep -v '^$' radio-workflow/UUID.md)
            echo "ğŸ“ èª­ã¿è¾¼ã¾ã‚ŒãŸéŸ³å£°IDæ•°: ${#VOICE_IDS[@]}"
            for i in "${!VOICE_IDS[@]}"; do
              echo "  [$i] ${VOICE_IDS[$i]}"
            done
          else
            echo "::error::âŒ UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # ãƒ©ãƒ³ãƒ€ãƒ ã«éŸ³å£°IDã‚’é¸æŠ
          if [ ${#VOICE_IDS[@]} -eq 0 ]; then
            echo "::error::âŒ éŸ³å£°IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          RANDOM_INDEX=$((RANDOM % ${#VOICE_IDS[@]}))
          SELECTED_VOICE_ID="${VOICE_IDS[$RANDOM_INDEX]}"
          
          echo "::endgroup::"
          
          # ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          echo "ğŸ¯ é¸æŠã•ã‚ŒãŸéŸ³å£°ID: $SELECTED_VOICE_ID"
          echo "ğŸ“… æ—¥ä»˜: $CURRENT_DATE"
          
          # USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          mkdir -p radio-workflow/temp
          echo "# Selected Voice ID and Music for Radio Production" > radio-workflow/temp/USE_UUID.md
          echo "" >> radio-workflow/temp/USE_UUID.md
          echo "Date: $CURRENT_DATE" >> radio-workflow/temp/USE_UUID.md
          echo "Voice UUID: $SELECTED_VOICE_ID" >> radio-workflow/temp/USE_UUID.md
          echo "Selected Music File: $SELECTED_MUSIC_FILE" >> radio-workflow/temp/USE_UUID.md
          echo "Artist: $ARTIST_NAME" >> radio-workflow/temp/USE_UUID.md
          echo "Song: $SONG_NAME" >> radio-workflow/temp/USE_UUID.md
          
          echo "âœ… USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          cat radio-workflow/temp/USE_UUID.md
      
      - name: Upload voice UUID file
        uses: actions/upload-artifact@v4
        with:
          name: voice-uuid
          path: radio-workflow/temp/USE_UUID.md
          retention-days: 1