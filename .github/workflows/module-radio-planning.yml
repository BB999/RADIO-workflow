name: Radio Planning Module (Minimal)
on:
  workflow_call:
    inputs:
      development-report:
        required: true
        type: string
      topic-focus:
        required: false
        type: string
    outputs:
      script-opening:
        value: ${{ jobs.generate.outputs.script-opening }}
      script-main:
        value: ${{ jobs.generate.outputs.script-main }}
      script-ending:
        value: ${{ jobs.generate.outputs.script-ending }}
      voice-config:
        value: ${{ jobs.generate.outputs.voice-config }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      script-opening: ${{ steps.planning.outputs.script-opening }}
      script-main: ${{ steps.planning.outputs.script-main }}
      script-ending: ${{ steps.planning.outputs.script-ending }}
      voice-config: ${{ steps.planning.outputs.voice-config }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate radio scripts with Claude
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::📋 Radio Script Generation"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # 作業ディレクトリ作成
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # プロンプトの構築
          PROMPT="以下の内容でラジオ番組台本を生成し、JSONファイルに保存してください：

          【開発進捗・最新情報】
          ${{ inputs.development-report }}

          【強調ポイント】
          ${{ inputs.topic-focus || 'なし' }}

          【要件】
          - オープニング: 30秒（明るい挨拶と今日のトピック紹介）
          - メイン: 30秒（内容を分かりやすく解説）  
          - エンディング: 30秒（まとめと次回予告）
          - MC: 20代女性、明るく親しみやすい口調
          - ターゲット: 20-30代の技術に興味がある層
          - **重要**: 各セクションは音声生成API制限のため、必ず3000文字以内で生成してください

          **重要**: 以下のJSONを \"$WORK_DIR/scripts.json\" ファイルに保存してください：
          {
            \"opening\": \"オープニング台本（3000文字以内）\",
            \"main\": \"メイン台本（3000文字以内）\", 
            \"ending\": \"エンディング台本（3000文字以内）\"
          }"
          
          echo "🚀 Starting Radio Script Generation..."
          echo "📝 Prompt length: ${#PROMPT}"
          
          # Claude Code CLIの実行（リトライ付き文字数制限チェック）
          for attempt in {1..5}; do
            echo "🎯 Claude Code CLI実行中（試行 $attempt/5）..."
            
            if npx @anthropic-ai/claude-code \
              --allowedTools "Write,Edit" \
              --max-turns 10 \
              --verbose \
              --permission-mode "acceptEdits" \
              -p "$PROMPT"; then
              
              # 生成された台本の文字数チェック
              if [ -f "$WORK_DIR/scripts.json" ] && jq empty "$WORK_DIR/scripts.json" 2>/dev/null; then
                echo "✅ JSONファイル生成成功"
                
                # 各セクションの文字数チェック
                OPENING_LENGTH=$(jq -r '.opening' "$WORK_DIR/scripts.json" | wc -c)
                MAIN_LENGTH=$(jq -r '.main' "$WORK_DIR/scripts.json" | wc -c)
                ENDING_LENGTH=$(jq -r '.ending' "$WORK_DIR/scripts.json" | wc -c)
                
                echo "📏 文字数チェック: opening=$OPENING_LENGTH, main=$MAIN_LENGTH, ending=$ENDING_LENGTH"
                
                if [ $OPENING_LENGTH -le 3000 ] && [ $MAIN_LENGTH -le 3000 ] && [ $ENDING_LENGTH -le 3000 ]; then
                  echo "✅ 全セクションが3000文字以内です"
                  break
                else
                  echo "::warning::⚠️ 一部セクションが3000文字を超えています（試行 $attempt/5）"
                  PROMPT="前回生成した台本が長すぎました。各セクションを3000文字以内で短く生成し直してください。JSONを $WORK_DIR/scripts.json に保存してください。"
                fi
              else
                echo "::warning::⚠️ JSONファイル生成失敗（試行 $attempt/5）"
              fi
            else
              echo "::warning::⚠️ Claude Code実行失敗（試行 $attempt/5）"
            fi
            
            if [ $attempt -eq 5 ]; then
              echo "::error::❌ 5回試行しても適切な台本を生成できませんでした"
              exit 1
            fi
            
            sleep 5
          done
          
          # 生成されたJSONファイルの確認と読み込み
          if [ -f "$WORK_DIR/scripts.json" ]; then
            echo "✅ Scripts JSON file generated"
            cat "$WORK_DIR/scripts.json"
            
            # JSONから各セクションを抽出
            if jq empty "$WORK_DIR/scripts.json" 2>/dev/null; then
              echo "✅ Valid JSON response received"
              jq -r '.opening' "$WORK_DIR/scripts.json" | sed 's/^/script-opening=/' >> $GITHUB_OUTPUT
              jq -r '.main' "$WORK_DIR/scripts.json" | sed 's/^/script-main=/' >> $GITHUB_OUTPUT  
              jq -r '.ending' "$WORK_DIR/scripts.json" | sed 's/^/script-ending=/' >> $GITHUB_OUTPUT
            else
              echo "::warning::Invalid JSON format, using fallback scripts"
              echo "script-opening=こんにちは、神威日報ラジオです。本日は神威アプリの最新開発情報をお届けします。" >> $GITHUB_OUTPUT
              echo "script-main=今日は神威アプリの開発進捗についてお話します。新機能の実装が順調に進んでおり、ユーザー体験がさらに向上します。" >> $GITHUB_OUTPUT
              echo "script-ending=以上、神威日報ラジオでした。また明日お会いしましょう。" >> $GITHUB_OUTPUT
            fi
          else
            echo "::warning::Scripts JSON file not found, using fallback scripts"
            echo "script-opening=こんにちは、神威日報ラジオです。本日は神威アプリの最新開発情報をお届けします。" >> $GITHUB_OUTPUT
            echo "script-main=今日は神威アプリの開発進捗についてお話します。新機能の実装が順調に進んでおり、ユーザー体験がさらに向上します。" >> $GITHUB_OUTPUT
            echo "script-ending=以上、神威日報ラジオでした。また明日お会いしましょう。" >> $GITHUB_OUTPUT
          fi
          
          echo 'voice-config={"gender":"female","age":"20s"}' >> $GITHUB_OUTPUT
          
          # 音声ID選択とUSE_UUID.mdファイル作成
          echo "::group::🎲 音声ID選択"
          
          # UUID.mdファイルから音声IDリストを読み込み
          if [ -f "radio-workflow/UUID.md" ]; then
            echo "✅ UUID.mdファイルから音声IDを読み込みます"
            # 空行を除いて配列に読み込み
            readarray -t VOICE_IDS < <(grep -v '^$' radio-workflow/UUID.md)
            echo "📝 読み込まれた音声ID数: ${#VOICE_IDS[@]}"
            for i in "${!VOICE_IDS[@]}"; do
              echo "  [$i] ${VOICE_IDS[$i]}"
            done
          else
            echo "::error::❌ UUID.mdファイルが見つかりません"
            exit 1
          fi
          
          # ランダムに音声IDを選択
          if [ ${#VOICE_IDS[@]} -eq 0 ]; then
            echo "::error::❌ 音声IDが見つかりません"
            exit 1
          fi
          RANDOM_INDEX=$((RANDOM % ${#VOICE_IDS[@]}))
          SELECTED_VOICE_ID="${VOICE_IDS[$RANDOM_INDEX]}"
          
          # 現在の日付を取得
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          echo "🎯 選択された音声ID: $SELECTED_VOICE_ID"
          echo "📅 日付: $CURRENT_DATE"
          
          # USE_UUID.mdファイルを作成
          mkdir -p radio-workflow/temp
          echo "# Selected Voice ID for Radio Production" > radio-workflow/temp/USE_UUID.md
          echo "" >> radio-workflow/temp/USE_UUID.md
          echo "Date: $CURRENT_DATE" >> radio-workflow/temp/USE_UUID.md
          echo "Voice UUID: $SELECTED_VOICE_ID" >> radio-workflow/temp/USE_UUID.md
          
          echo "✅ USE_UUID.mdファイルを作成しました"
          cat radio-workflow/temp/USE_UUID.md
          
          echo "::endgroup::"
      
      - name: Upload voice UUID file
        uses: actions/upload-artifact@v4
        with:
          name: voice-uuid
          path: radio-workflow/temp/USE_UUID.md
          retention-days: 1