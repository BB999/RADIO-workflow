name: Radio Planning Module - Split Version (Minimal)
on:
  workflow_call:
    inputs:
      development-report:
        required: false
        type: string
      topic-focus:
        required: false
        type: string
      processed-summary:
        description: 'Gemini CLIã§å‡¦ç†æ¸ˆã¿ã®æ§‹é€ åŒ–ã•ã‚ŒãŸã‚µãƒžãƒªãƒ¼'
        required: false
        type: string
      use-processed-input:
        description: 'å‡¦ç†æ¸ˆã¿å…¥åŠ›ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã©ã†ã‹'
        required: false
        type: boolean
        default: false
    outputs:
      script-opening:
        value: ${{ jobs.generate-part1.outputs.script-opening }}
      script-main:
        value: ${{ jobs.generate-part1.outputs.script-main }}
      script-main-part2:
        value: ${{ jobs.generate-part2.outputs.script-main-part2 }}
      script-jingle:
        value: ${{ jobs.generate-part1.outputs.script-jingle }}
      script-ending:
        value: ${{ jobs.generate-part2.outputs.script-ending }}
      voice-config:
        value: ${{ jobs.generate-part1.outputs.voice-config }}

jobs:
  generate-part1:
    runs-on: ubuntu-latest
    outputs:
      script-opening: ${{ steps.planning-part1.outputs.script-opening }}
      script-main: ${{ steps.planning-part1.outputs.script-main }}
      script-jingle: ${{ steps.planning-part1.outputs.script-jingle }}
      voice-config: ${{ steps.planning-part1.outputs.voice-config }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate radio scripts part 1 with Claude
        id: planning-part1
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ðŸ“‹ Radio Script Generation Part 1"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # é–‹ç™ºé€²æ—æƒ…å ±ã‚’å‰åŠç”¨ã«åˆ†å‰²
          DEV_REPORT='${{ inputs.development-report }}'
          HALF_LENGTH=$((${#DEV_REPORT} / 2))
          DEV_REPORT_PART1=$(echo "$DEV_REPORT" | cut -c1-$HALF_LENGTH)
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
          PROMPT="ãƒ©ã‚¸ã‚ªç•ªçµ„å°æœ¬ã®ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã€ãƒ¡ã‚¤ãƒ³å‰åŠã€ã‚¸ãƒ³ã‚°ãƒ«ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          é–‹ç™ºé€²æ—æƒ…å ±: $DEV_REPORT_PART1
          å¼·èª¿ãƒã‚¤ãƒ³ãƒˆ: ${{ inputs.topic-focus }}

          è¦ä»¶:
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: 1åˆ†ï¼ˆ300-400æ–‡å­—ï¼‰æ˜Žã‚‹ã„æŒ¨æ‹¶ã¨ç•ªçµ„ç´¹ä»‹
          - ãƒ¡ã‚¤ãƒ³å‰åŠ: 3åˆ†ï¼ˆ900-1200æ–‡å­—ï¼‰é–‹ç™ºé€²æ—ã®ä¸»è¦ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬
          - ã‚¸ãƒ³ã‚°ãƒ«: ã€Œã‹ã‚€ã‚‰ã˜ã€ã®ã¿
          
          ä»¥ä¸‹ã®JSONã‚’ $WORK_DIR/part1.json ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {
            \"opening\": \"ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬\",
            \"main\": \"ãƒ¡ã‚¤ãƒ³å‰åŠå°æœ¬\", 
            \"jingle\": \"ã‹ã‚€ã‚‰ã˜\"
          }"
          
          # Claude Codeå®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Write,Edit" \
            --max-turns 5 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          # çµæžœã‚’å‡ºåŠ›ã«è¨­å®š
          if [ -f "$WORK_DIR/part1.json" ] && jq empty "$WORK_DIR/part1.json" 2>/dev/null; then
            OPENING_TEXT=$(jq -r '.opening' "$WORK_DIR/part1.json")
            MAIN_TEXT=$(jq -r '.main' "$WORK_DIR/part1.json") 
            JINGLE_TEXT=$(jq -r '.jingle' "$WORK_DIR/part1.json")
            
            echo "script-opening<<EOF" >> $GITHUB_OUTPUT
            echo "$OPENING_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "script-main<<EOF" >> $GITHUB_OUTPUT
            echo "$MAIN_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "script-jingle<<EOF" >> $GITHUB_OUTPUT
            echo "$JINGLE_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "voice-config=default" >> $GITHUB_OUTPUT
            echo "âœ… Part 1 scripts generated successfully"
          else
            echo "::error::Part 1 script generation failed"
            exit 1
          fi
          echo "::endgroup::"
      
      - name: Upload part1 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: radio-scripts-part1
          path: radio-scripts/part1.json
          retention-days: 1

  generate-part2:
    runs-on: ubuntu-latest
    outputs:
      script-main-part2: ${{ steps.planning-part2.outputs.script-main-part2 }}
      script-ending: ${{ steps.planning-part2.outputs.script-ending }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate radio scripts part 2 with Claude
        id: planning-part2
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ðŸ“‹ Radio Script Generation Part 2"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # é–‹ç™ºé€²æ—æƒ…å ±ã‚’å¾ŒåŠç”¨ã«åˆ†å‰²
          DEV_REPORT='${{ inputs.development-report }}'
          HALF_LENGTH=$((${#DEV_REPORT} / 2))
          DEV_REPORT_PART2=$(echo "$DEV_REPORT" | cut -c$((HALF_LENGTH + 1))-)
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
          PROMPT="ãƒ©ã‚¸ã‚ªç•ªçµ„å°æœ¬ã®ãƒ¡ã‚¤ãƒ³å¾ŒåŠã¨ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          é–‹ç™ºé€²æ—æƒ…å ±: $DEV_REPORT_PART2
          å¼·èª¿ãƒã‚¤ãƒ³ãƒˆ: ${{ inputs.topic-focus }}

          è¦ä»¶:
          - ãƒ¡ã‚¤ãƒ³å¾ŒåŠ: 3åˆ†ï¼ˆ900-1200æ–‡å­—ï¼‰æ™‚äº‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚„è¿½åŠ æƒ…å ±ã€ãƒªã‚¹ãƒŠãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: 1åˆ†ï¼ˆ300-400æ–‡å­—ï¼‰ã¾ã¨ã‚ã¨æ¬¡å›žäºˆå‘Š
          
          ä»¥ä¸‹ã®JSONã‚’ $WORK_DIR/part2.json ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {
            \"main_part2\": \"ãƒ¡ã‚¤ãƒ³å¾ŒåŠå°æœ¬\",
            \"ending\": \"ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬\"
          }"
          
          # Claude Codeå®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Write,Edit" \
            --max-turns 5 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          # çµæžœã‚’å‡ºåŠ›ã«è¨­å®š
          if [ -f "$WORK_DIR/part2.json" ] && jq empty "$WORK_DIR/part2.json" 2>/dev/null; then
            MAIN_PART2_TEXT=$(jq -r '.main_part2' "$WORK_DIR/part2.json")
            ENDING_TEXT=$(jq -r '.ending' "$WORK_DIR/part2.json")
            
            echo "script-main-part2<<EOF" >> $GITHUB_OUTPUT
            echo "$MAIN_PART2_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "script-ending<<EOF" >> $GITHUB_OUTPUT
            echo "$ENDING_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "âœ… Part 2 scripts generated successfully"
          else
            echo "::error::Part 2 script generation failed"
            exit 1
          fi
          echo "::endgroup::"
      
      - name: Upload part2 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: radio-scripts-part2
          path: radio-scripts/part2.json
          retention-days: 1