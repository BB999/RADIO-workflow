name: Radio Planning Module (Minimal)
on:
  workflow_call:
    inputs:
      development-report:
        required: true
        type: string
      topic-focus:
        required: false
        type: string
    outputs:
      script-opening:
        value: ${{ jobs.generate.outputs.script-opening }}
      script-main:
        value: ${{ jobs.generate.outputs.script-main }}
      script-ending:
        value: ${{ jobs.generate.outputs.script-ending }}
      voice-config:
        value: ${{ jobs.generate.outputs.voice-config }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      script-opening: ${{ steps.planning.outputs.script-opening }}
      script-main: ${{ steps.planning.outputs.script-main }}
      script-ending: ${{ steps.planning.outputs.script-ending }}
      voice-config: ${{ steps.planning.outputs.voice-config }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate radio scripts with Claude
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ“‹ Radio Script Generation"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ä»¥ä¸‹ã®å†…å®¹ã§ãƒ©ã‚¸ã‚ªç•ªçµ„å°æœ¬ã‚’ç”Ÿæˆã—ã€JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š

          ã€é–‹ç™ºé€²æ—ãƒ»æœ€æ–°æƒ…å ±ã€‘
          ${{ inputs.development-report }}

          ã€å¼·èª¿ãƒã‚¤ãƒ³ãƒˆã€‘
          ${{ inputs.topic-focus || 'ãªã—' }}

          ã€è¦ä»¶ã€‘
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: 30ç§’ï¼ˆæ˜ã‚‹ã„æŒ¨æ‹¶ã¨ä»Šæ—¥ã®ãƒˆãƒ”ãƒƒã‚¯ç´¹ä»‹ï¼‰
          - ãƒ¡ã‚¤ãƒ³: 30ç§’ï¼ˆå†…å®¹ã‚’åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ï¼‰  
          - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: 30ç§’ï¼ˆã¾ã¨ã‚ã¨æ¬¡å›äºˆå‘Šï¼‰
          - MC: 20ä»£å¥³æ€§ã€æ˜ã‚‹ãè¦ªã—ã¿ã‚„ã™ã„å£èª¿
          - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: 20-30ä»£ã®æŠ€è¡“ã«èˆˆå‘³ãŒã‚ã‚‹å±¤
          - **é‡è¦**: å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯éŸ³å£°ç”ŸæˆAPIåˆ¶é™ã®ãŸã‚ã€å¿…ãš3000æ–‡å­—ä»¥å†…ã§ç”Ÿæˆã—ã¦ãã ã•ã„

          **é‡è¦**: ä»¥ä¸‹ã®JSONã‚’ \"$WORK_DIR/scripts.json\" ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {
            \"opening\": \"ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ï¼ˆ3000æ–‡å­—ä»¥å†…ï¼‰\",
            \"main\": \"ãƒ¡ã‚¤ãƒ³å°æœ¬ï¼ˆ3000æ–‡å­—ä»¥å†…ï¼‰\", 
            \"ending\": \"ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬ï¼ˆ3000æ–‡å­—ä»¥å†…ï¼‰\"
          }"
          
          echo "ğŸš€ Starting Radio Script Generation..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãæ–‡å­—æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼‰
          for attempt in {1..5}; do
            echo "ğŸ¯ Claude Code CLIå®Ÿè¡Œä¸­ï¼ˆè©¦è¡Œ $attempt/5ï¼‰..."
            
            if npx @anthropic-ai/claude-code \
              --allowedTools "Write,Edit" \
              --max-turns 10 \
              --verbose \
              --permission-mode "acceptEdits" \
              -p "$PROMPT"; then
              
              # ç”Ÿæˆã•ã‚ŒãŸå°æœ¬ã®æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯
              if [ -f "$WORK_DIR/scripts.json" ] && jq empty "$WORK_DIR/scripts.json" 2>/dev/null; then
                echo "âœ… JSONãƒ•ã‚¡ã‚¤ãƒ«ç”ŸæˆæˆåŠŸ"
                
                # å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯
                OPENING_LENGTH=$(jq -r '.opening' "$WORK_DIR/scripts.json" | wc -c)
                MAIN_LENGTH=$(jq -r '.main' "$WORK_DIR/scripts.json" | wc -c)
                ENDING_LENGTH=$(jq -r '.ending' "$WORK_DIR/scripts.json" | wc -c)
                
                echo "ğŸ“ æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯: opening=$OPENING_LENGTH, main=$MAIN_LENGTH, ending=$ENDING_LENGTH"
                
                if [ $OPENING_LENGTH -le 3000 ] && [ $MAIN_LENGTH -le 3000 ] && [ $ENDING_LENGTH -le 3000 ]; then
                  echo "âœ… å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒ3000æ–‡å­—ä»¥å†…ã§ã™"
                  break
                else
                  echo "::warning::âš ï¸ ä¸€éƒ¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒ3000æ–‡å­—ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼ˆè©¦è¡Œ $attempt/5ï¼‰"
                  PROMPT="å‰å›ç”Ÿæˆã—ãŸå°æœ¬ãŒé•·ã™ãã¾ã—ãŸã€‚å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’3000æ–‡å­—ä»¥å†…ã§çŸ­ãç”Ÿæˆã—ç›´ã—ã¦ãã ã•ã„ã€‚JSONã‚’ $WORK_DIR/scripts.json ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"
                fi
              else
                echo "::warning::âš ï¸ JSONãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå¤±æ•—ï¼ˆè©¦è¡Œ $attempt/5ï¼‰"
              fi
            else
              echo "::warning::âš ï¸ Claude Codeå®Ÿè¡Œå¤±æ•—ï¼ˆè©¦è¡Œ $attempt/5ï¼‰"
            fi
            
            if [ $attempt -eq 5 ]; then
              echo "::error::âŒ 5å›è©¦è¡Œã—ã¦ã‚‚é©åˆ‡ãªå°æœ¬ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"
              exit 1
            fi
            
            sleep 5
          done
          
          # ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªã¨èª­ã¿è¾¼ã¿
          if [ -f "$WORK_DIR/scripts.json" ]; then
            echo "âœ… Scripts JSON file generated"
            cat "$WORK_DIR/scripts.json"
            
            # JSONã‹ã‚‰å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
            if jq empty "$WORK_DIR/scripts.json" 2>/dev/null; then
              echo "âœ… Valid JSON response received"
              jq -r '.opening' "$WORK_DIR/scripts.json" | sed 's/^/script-opening=/' >> $GITHUB_OUTPUT
              jq -r '.main' "$WORK_DIR/scripts.json" | sed 's/^/script-main=/' >> $GITHUB_OUTPUT  
              jq -r '.ending' "$WORK_DIR/scripts.json" | sed 's/^/script-ending=/' >> $GITHUB_OUTPUT
            else
              echo "::warning::Invalid JSON format, using fallback scripts"
              echo "script-opening=ã“ã‚“ã«ã¡ã¯ã€ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªã§ã™ã€‚æœ¬æ—¥ã¯ç¥å¨ã‚¢ãƒ—ãƒªã®æœ€æ–°é–‹ç™ºæƒ…å ±ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚" >> $GITHUB_OUTPUT
              echo "script-main=ä»Šæ—¥ã¯ç¥å¨ã‚¢ãƒ—ãƒªã®é–‹ç™ºé€²æ—ã«ã¤ã„ã¦ãŠè©±ã—ã¾ã™ã€‚æ–°æ©Ÿèƒ½ã®å®Ÿè£…ãŒé †èª¿ã«é€²ã‚“ã§ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒã•ã‚‰ã«å‘ä¸Šã—ã¾ã™ã€‚" >> $GITHUB_OUTPUT
              echo "script-ending=ä»¥ä¸Šã€ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªã§ã—ãŸã€‚ã¾ãŸæ˜æ—¥ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚" >> $GITHUB_OUTPUT
            fi
          else
            echo "::warning::Scripts JSON file not found, using fallback scripts"
            echo "script-opening=ã“ã‚“ã«ã¡ã¯ã€ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªã§ã™ã€‚æœ¬æ—¥ã¯ç¥å¨ã‚¢ãƒ—ãƒªã®æœ€æ–°é–‹ç™ºæƒ…å ±ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚" >> $GITHUB_OUTPUT
            echo "script-main=ä»Šæ—¥ã¯ç¥å¨ã‚¢ãƒ—ãƒªã®é–‹ç™ºé€²æ—ã«ã¤ã„ã¦ãŠè©±ã—ã¾ã™ã€‚æ–°æ©Ÿèƒ½ã®å®Ÿè£…ãŒé †èª¿ã«é€²ã‚“ã§ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒã•ã‚‰ã«å‘ä¸Šã—ã¾ã™ã€‚" >> $GITHUB_OUTPUT
            echo "script-ending=ä»¥ä¸Šã€ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªã§ã—ãŸã€‚ã¾ãŸæ˜æ—¥ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚" >> $GITHUB_OUTPUT
          fi
          
          echo 'voice-config={"gender":"female","age":"20s"}' >> $GITHUB_OUTPUT
          
          # éŸ³å£°IDé¸æŠã¨USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          echo "::group::ğŸ² éŸ³å£°IDé¸æŠ"
          
          # UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰éŸ³å£°IDãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
          if [ -f "radio-workflow/UUID.md" ]; then
            echo "âœ… UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰éŸ³å£°IDã‚’èª­ã¿è¾¼ã¿ã¾ã™"
            # ç©ºè¡Œã‚’é™¤ã„ã¦é…åˆ—ã«èª­ã¿è¾¼ã¿
            readarray -t VOICE_IDS < <(grep -v '^$' radio-workflow/UUID.md)
            echo "ğŸ“ èª­ã¿è¾¼ã¾ã‚ŒãŸéŸ³å£°IDæ•°: ${#VOICE_IDS[@]}"
            for i in "${!VOICE_IDS[@]}"; do
              echo "  [$i] ${VOICE_IDS[$i]}"
            done
          else
            echo "::error::âŒ UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # ãƒ©ãƒ³ãƒ€ãƒ ã«éŸ³å£°IDã‚’é¸æŠ
          if [ ${#VOICE_IDS[@]} -eq 0 ]; then
            echo "::error::âŒ éŸ³å£°IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          RANDOM_INDEX=$((RANDOM % ${#VOICE_IDS[@]}))
          SELECTED_VOICE_ID="${VOICE_IDS[$RANDOM_INDEX]}"
          
          # ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          echo "ğŸ¯ é¸æŠã•ã‚ŒãŸéŸ³å£°ID: $SELECTED_VOICE_ID"
          echo "ğŸ“… æ—¥ä»˜: $CURRENT_DATE"
          
          # USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          mkdir -p radio-workflow/temp
          echo "# Selected Voice ID for Radio Production" > radio-workflow/temp/USE_UUID.md
          echo "" >> radio-workflow/temp/USE_UUID.md
          echo "Date: $CURRENT_DATE" >> radio-workflow/temp/USE_UUID.md
          echo "Voice UUID: $SELECTED_VOICE_ID" >> radio-workflow/temp/USE_UUID.md
          
          echo "âœ… USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          cat radio-workflow/temp/USE_UUID.md
          
          echo "::endgroup::"
      
      - name: Upload voice UUID file
        uses: actions/upload-artifact@v4
        with:
          name: voice-uuid
          path: radio-workflow/temp/USE_UUID.md
          retention-days: 1