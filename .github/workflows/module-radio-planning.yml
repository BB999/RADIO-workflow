name: Radio Planning Module (Minimal)
on:
  workflow_call:
    inputs:
      development-report:
        required: true
        type: string
      topic-focus:
        required: false
        type: string
    outputs:
      script-opening:
        value: ${{ jobs.generate.outputs.script-opening }}
      script-main:
        value: ${{ jobs.generate.outputs.script-main }}
      script-ending:
        value: ${{ jobs.generate.outputs.script-ending }}
      voice-config:
        value: ${{ jobs.generate.outputs.voice-config }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      script-opening: ${{ steps.planning.outputs.script-opening }}
      script-main: ${{ steps.planning.outputs.script-main }}
      script-ending: ${{ steps.planning.outputs.script-ending }}
      voice-config: ${{ steps.planning.outputs.voice-config }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code
      
      - name: Generate radio scripts with Claude
        id: planning
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          # Claude Codeを使った台本生成
          SCRIPT_RESULT=$(npx @anthropic-ai/claude-code -c "
          以下の内容で90秒のラジオ番組台本を生成してください：
          
          【開発進捗・最新情報】
          ${{ inputs.development-report }}
          
          【強調ポイント】
          ${{ inputs.topic-focus || 'なし' }}
          
          【要件】
          - オープニング: 30秒（明るい挨拶と今日のトピック紹介）
          - メイン: 30秒（内容を分かりやすく解説）
          - エンディング: 30秒（まとめと次回予告）
          - MC: 20代女性、明るく親しみやすい口調
          - ターゲット: 20-30代の技術に興味がある層
          
          JSON形式で以下のように出力してください：
          {
            \"opening\": \"オープニング台本\",
            \"main\": \"メイン台本\", 
            \"ending\": \"エンディング台本\"
          }
          ")
          
          # JSONから各セクションを抽出
          echo "$SCRIPT_RESULT" | jq -r '.opening' | sed 's/^/script-opening=/' >> $GITHUB_OUTPUT
          echo "$SCRIPT_RESULT" | jq -r '.main' | sed 's/^/script-main=/' >> $GITHUB_OUTPUT
          echo "$SCRIPT_RESULT" | jq -r '.ending' | sed 's/^/script-ending=/' >> $GITHUB_OUTPUT
          echo 'voice-config={"gender":"female","age":"20s"}' >> $GITHUB_OUTPUT