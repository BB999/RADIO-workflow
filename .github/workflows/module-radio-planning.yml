name: Radio Planning Module - Fine Split Version (Minimal)
on:
  workflow_call:
    inputs:
      development-report:
        required: false
        type: string
      topic-focus:
        required: false
        type: string
      processed-summary:
        description: 'Gemini CLIで処理済みの構造化されたサマリー'
        required: false
        type: string
      use-processed-input:
        description: '処理済み入力を使用するかどうか'
        required: false
        type: boolean
        default: false
    outputs:
      script-opening:
        value: ${{ jobs.generate-opening.outputs.script-opening }}
      script-main:
        value: ${{ jobs.generate-main.outputs.script-main }}
      script-main-part2:
        value: ${{ jobs.generate-main-part2.outputs.script-main-part2 }}
      script-jingle:
        value: ${{ jobs.generate-jingle.outputs.script-jingle }}
      script-ending:
        value: ${{ jobs.generate-ending.outputs.script-ending }}
      voice-config:
        value: ${{ jobs.generate-opening.outputs.voice-config }}

jobs:
  generate-opening:
    runs-on: ubuntu-latest
    outputs:
      script-opening: ${{ steps.planning.outputs.script-opening }}
      voice-config: ${{ steps.planning.outputs.voice-config }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate opening script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::📋 Opening Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          PROMPT="ラジオ番組のオープニング台本を生成してください。

          要件:
          - 時間: 1分（300-400文字）
          - 内容: 明るい挨拶と番組紹介
          
          以下のJSONを $WORK_DIR/opening.json に保存してください：
          {
            \"opening\": \"オープニング台本\"
          }"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 5 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          if [ -f "$WORK_DIR/opening.json" ] && jq empty "$WORK_DIR/opening.json" 2>/dev/null; then
            OPENING_TEXT=$(jq -r '.opening' "$WORK_DIR/opening.json")
            
            echo "script-opening<<EOF" >> $GITHUB_OUTPUT
            echo "$OPENING_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "voice-config=default" >> $GITHUB_OUTPUT
            echo "✅ Opening script generated successfully"
          else
            echo "::error::Opening script generation failed"
            exit 1
          fi
          echo "::endgroup::"

  generate-main:
    runs-on: ubuntu-latest
    outputs:
      script-main: ${{ steps.planning.outputs.script-main }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate main part1 script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::📋 Main Part1 Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # 開発進捗情報を前半用に分割
          DEV_REPORT='${{ inputs.development-report }}'
          HALF_LENGTH=$((${#DEV_REPORT} / 2))
          DEV_REPORT_PART1=$(echo "$DEV_REPORT" | cut -c1-$HALF_LENGTH)
          
          PROMPT="ラジオ番組のメイン前半台本を生成してください。

          開発進捗情報: $DEV_REPORT_PART1
          強調ポイント: ${{ inputs.topic-focus }}

          要件:
          - 時間: 3分（900-1200文字）
          - 内容: 開発進捗の主要ポイントを解説
          
          以下のJSONを $WORK_DIR/main.json に保存してください：
          {
            \"main\": \"メイン前半台本\"
          }"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 8 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          if [ -f "$WORK_DIR/main.json" ] && jq empty "$WORK_DIR/main.json" 2>/dev/null; then
            MAIN_TEXT=$(jq -r '.main' "$WORK_DIR/main.json")
            
            echo "script-main<<EOF" >> $GITHUB_OUTPUT
            echo "$MAIN_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "✅ Main part1 script generated successfully"
          else
            echo "::error::Main part1 script generation failed"
            exit 1
          fi
          echo "::endgroup::"

  generate-main-part2:
    runs-on: ubuntu-latest
    outputs:
      script-main-part2: ${{ steps.planning.outputs.script-main-part2 }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate main part2 script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::📋 Main Part2 Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # 開発進捗情報を後半用に分割
          DEV_REPORT='${{ inputs.development-report }}'
          HALF_LENGTH=$((${#DEV_REPORT} / 2))
          DEV_REPORT_PART2=$(echo "$DEV_REPORT" | cut -c$((HALF_LENGTH + 1))-)
          
          PROMPT="ラジオ番組のメイン後半台本を生成してください。

          開発進捗情報: $DEV_REPORT_PART2
          強調ポイント: ${{ inputs.topic-focus }}

          要件:
          - 時間: 3分（900-1200文字）
          - 内容: 時事ニュースや追加情報、リスナーへのメッセージ
          
          以下のJSONを $WORK_DIR/main_part2.json に保存してください：
          {
            \"main_part2\": \"メイン後半台本\"
          }"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 8 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          if [ -f "$WORK_DIR/main_part2.json" ] && jq empty "$WORK_DIR/main_part2.json" 2>/dev/null; then
            MAIN_PART2_TEXT=$(jq -r '.main_part2' "$WORK_DIR/main_part2.json")
            
            echo "script-main-part2<<EOF" >> $GITHUB_OUTPUT
            echo "$MAIN_PART2_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "✅ Main part2 script generated successfully"
          else
            echo "::error::Main part2 script generation failed"
            exit 1
          fi
          echo "::endgroup::"

  generate-jingle:
    runs-on: ubuntu-latest
    outputs:
      script-jingle: ${{ steps.planning.outputs.script-jingle }}
    steps:
      - name: Generate jingle script
        id: planning
        run: |
          echo "::group::📋 Jingle Script Generation"
          
          echo "script-jingle<<EOF" >> $GITHUB_OUTPUT
          echo "かむらじ" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "✅ Jingle script generated successfully"
          echo "::endgroup::"

  generate-ending:
    runs-on: ubuntu-latest
    outputs:
      script-ending: ${{ steps.planning.outputs.script-ending }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate ending script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::📋 Ending Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          PROMPT="ラジオ番組のエンディング台本を生成してください。

          要件:
          - 時間: 1分（300-400文字）
          - 内容: まとめと次回予告
          
          以下のJSONを $WORK_DIR/ending.json に保存してください：
          {
            \"ending\": \"エンディング台本\"
          }"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 5 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          if [ -f "$WORK_DIR/ending.json" ] && jq empty "$WORK_DIR/ending.json" 2>/dev/null; then
            ENDING_TEXT=$(jq -r '.ending' "$WORK_DIR/ending.json")
            
            echo "script-ending<<EOF" >> $GITHUB_OUTPUT
            echo "$ENDING_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "✅ Ending script generated successfully"
          else
            echo "::error::Ending script generation failed"
            exit 1
          fi
          echo "::endgroup::"