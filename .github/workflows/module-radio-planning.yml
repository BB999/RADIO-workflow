name: Radio Planning Module - Split Jobs
on:
  workflow_call:
    inputs:
      development-report:
        required: true
        type: string
      tech-news:
        required: true
        type: string
      evening-report:
        required: true
        type: string
      topic-focus:
        required: false
        type: string
    outputs:
      script-opening:
        value: ${{ jobs.script-opening.outputs.script-text }}
      script-main:
        value: ${{ jobs.script-main.outputs.script-text }}
      script-main2:
        value: ${{ jobs.script-main2.outputs.script-text }}
      script-main3:
        value: ${{ jobs.script-main3.outputs.script-text }}
      script-ending:
        value: ${{ jobs.script-ending.outputs.script-text }}
      voice-config:
        value: ${{ jobs.planning-setup.outputs.voice-config }}

jobs:
  planning-setup:
    runs-on: ubuntu-latest
    outputs:
      personality-data: ${{ steps.setup.outputs.personality-data }}
      voice-config: ${{ steps.setup.outputs.voice-config }}
      voice-id: ${{ steps.setup.outputs.voice-id }}
      selected-music: ${{ steps.setup.outputs.selected-music }}
      artist-name: ${{ steps.setup.outputs.artist-name }}
      song-name: ${{ steps.setup.outputs.song-name }}
      news-content: ${{ steps.setup.outputs.news-content }}
      random-element: ${{ steps.setup.outputs.random-element }}
      opening-pattern: ${{ steps.setup.outputs.opening-pattern }}
      ending-pattern: ${{ steps.setup.outputs.ending-pattern }}
      character-mode: ${{ steps.setup.outputs.character-mode }}
      music-info: ${{ steps.setup.outputs.music-info }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Setup basic radio production data
        id: setup
        run: |
          echo "ğŸ“‹ Radio Production Setup"
          
          # ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿
          if [ -f "radio-workflow/radio-personality-data.md" ]; then
            PERSONALITY_DATA=$(cat radio-workflow/radio-personality-data.md)
            echo "personality-data<<EOF" >> $GITHUB_OUTPUT
            echo "$PERSONALITY_DATA" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "personality-data=" >> $GITHUB_OUTPUT
          fi
          
          # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
          if [ -d "radio-workflow/music" ]; then
            SELECTED_MUSIC_FILE=$(ls radio-workflow/music/*.mp3 | shuf -n 1 | xargs basename)
            if [[ "$SELECTED_MUSIC_FILE" =~ ^(.+)ãƒ»(.+)\.mp3$ ]]; then
              SONG_NAME="${BASH_REMATCH[1]}"
              ARTIST_NAME="${BASH_REMATCH[2]}"
            else
              SONG_NAME=""
              ARTIST_NAME=""
            fi
          else
            SELECTED_MUSIC_FILE="unknown.mp3"
            SONG_NAME=""
            ARTIST_NAME=""
          fi
          
          # ç°¡æ˜“ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
          NEWS_CONTENT="ã€å¤©æ°—äºˆå ±ã€‘æ±äº¬ã®å¤©æ°—: æ™´ã‚Œ æœ€é«˜æ°—æ¸©: 20â„ƒã€æœ€è¿‘ã®è©±é¡Œã€‘AIæŠ€è¡“ã®é€²åŒ–ãŒè©±é¡Œ"
          
          # ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã®ç”Ÿæˆ
          RANDOM_ELEMENTS=("ä»Šæ—¥ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚ã‚‹ã‚ã‚‹è©±" "é–‹ç™ºè€…ã®å¤‰ãªç™–ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰" "ãƒã‚°ã¨ã®æ ¼é—˜è¨˜")
          RANDOM_ELEMENT_INDEX=$((RANDOM % ${#RANDOM_ELEMENTS[@]}))
          SELECTED_RANDOM_ELEMENT="${RANDOM_ELEMENTS[$RANDOM_ELEMENT_INDEX]}"
          
          OPENING_PATTERNS=("å…ƒæ°—ã„ã£ã±ã„ãƒã‚¤ãƒ†ãƒ³ã‚·ãƒ§ãƒ³" "ã¡ã‚‡ã£ã¨çœ ãã†ãªæ„Ÿã˜ã‹ã‚‰å¾ã€…ã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸ŠãŒã‚‹" "è¬ã®ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã§å§‹ã¾ã‚‹")
          OPENING_PATTERN_INDEX=$((RANDOM % ${#OPENING_PATTERNS[@]}))
          SELECTED_OPENING_PATTERN="${OPENING_PATTERNS[$OPENING_PATTERN_INDEX]}"
          
          ENDING_PATTERNS=("æ„Ÿå‹•çš„ã«ç· ã‚ã‚‹ï¼ˆã§ã‚‚ã¡ã‚‡ã£ã¨ã‚ºãƒ¬ã¦ã‚‹ï¼‰" "æ€¥ã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸‹ãŒã£ã¦ç· ã‚ã‚‹" "æœ€å¾Œã«ãƒ€ã‚¸ãƒ£ãƒ¬ã§ç· ã‚ã‚‹")
          ENDING_PATTERN_INDEX=$((RANDOM % ${#ENDING_PATTERNS[@]}))
          SELECTED_ENDING_PATTERN="${ENDING_PATTERNS[$ENDING_PATTERN_INDEX]}"
          
          CHARACTER_MODES=("ã„ã¤ã‚‚é€šã‚Š" "ã¡ã‚‡ã£ã¨é–¢è¥¿å¼æ··ã˜ã‚Š" "ã‚„ãŸã‚‰ä¾‹ãˆè©±ãŒå¤šã„")
          CHARACTER_MODE_INDEX=$((RANDOM % ${#CHARACTER_MODES[@]}))
          SELECTED_CHARACTER_MODE="${CHARACTER_MODES[$CHARACTER_MODE_INDEX]}"
          
          # æ¥½æ›²æƒ…å ±ã®è¨­å®š
          if [ -n "$ARTIST_NAME" ] && [ -n "$SONG_NAME" ]; then
            MUSIC_INFO="- ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ: $ARTIST_NAME - æ¥½æ›²å: $SONG_NAME"
          else
            MUSIC_INFO="- æ¥½æ›²: $SELECTED_MUSIC_FILEï¼ˆè©³ç´°ä¸æ˜ï¼‰"
          fi
          
          # å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’GitHub Outputsã«è¨­å®š
          echo "selected-music=$SELECTED_MUSIC_FILE" >> $GITHUB_OUTPUT
          echo "artist-name=$ARTIST_NAME" >> $GITHUB_OUTPUT
          echo "song-name=$SONG_NAME" >> $GITHUB_OUTPUT
          echo "news-content=$NEWS_CONTENT" >> $GITHUB_OUTPUT
          echo "random-element=$SELECTED_RANDOM_ELEMENT" >> $GITHUB_OUTPUT
          echo "opening-pattern=$SELECTED_OPENING_PATTERN" >> $GITHUB_OUTPUT
          echo "ending-pattern=$SELECTED_ENDING_PATTERN" >> $GITHUB_OUTPUT
          echo "character-mode=$SELECTED_CHARACTER_MODE" >> $GITHUB_OUTPUT
          echo "music-info=$MUSIC_INFO" >> $GITHUB_OUTPUT
          
          echo 'voice-config={"gender":"female","age":"20s"}' >> $GITHUB_OUTPUT
          
          # éŸ³å£°IDé¸æŠã¨USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          echo "::group::ğŸ² éŸ³å£°IDé¸æŠ"
          
          # UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰éŸ³å£°IDãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
          if [ -f "radio-workflow/UUID.md" ]; then
            echo "âœ… UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰éŸ³å£°IDã‚’èª­ã¿è¾¼ã¿ã¾ã™"
            # ç©ºè¡Œã‚’é™¤ã„ã¦é…åˆ—ã«èª­ã¿è¾¼ã¿
            readarray -t VOICE_IDS < <(grep -v '^$' radio-workflow/UUID.md)
            echo "ğŸ“ èª­ã¿è¾¼ã¾ã‚ŒãŸéŸ³å£°IDæ•°: ${#VOICE_IDS[@]}"
            for i in "${!VOICE_IDS[@]}"; do
              echo "  [$i] ${VOICE_IDS[$i]}"
            done
          else
            echo "::error::âŒ UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # ãƒ©ãƒ³ãƒ€ãƒ ã«éŸ³å£°IDã‚’é¸æŠ
          if [ ${#VOICE_IDS[@]} -eq 0 ]; then
            echo "::error::âŒ éŸ³å£°IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          RANDOM_INDEX=$((RANDOM % ${#VOICE_IDS[@]}))
          SELECTED_VOICE_ID="${VOICE_IDS[$RANDOM_INDEX]}"
          
          echo "::endgroup::"
          
          # ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          echo "ğŸ¯ é¸æŠã•ã‚ŒãŸéŸ³å£°ID: $SELECTED_VOICE_ID"
          echo "ğŸ“… æ—¥ä»˜: $CURRENT_DATE"
          
          # USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          mkdir -p radio-workflow/temp
          echo "# Selected Voice ID and Music for Radio Production" > radio-workflow/temp/USE_UUID.md
          echo "" >> radio-workflow/temp/USE_UUID.md
          echo "Date: $CURRENT_DATE" >> radio-workflow/temp/USE_UUID.md
          echo "Voice UUID: $SELECTED_VOICE_ID" >> radio-workflow/temp/USE_UUID.md
          echo "Selected Music File: $SELECTED_MUSIC_FILE" >> radio-workflow/temp/USE_UUID.md
          echo "Artist: $ARTIST_NAME" >> radio-workflow/temp/USE_UUID.md
          echo "Song: $SONG_NAME" >> radio-workflow/temp/USE_UUID.md
          
          echo "voice-id=$SELECTED_VOICE_ID" >> $GITHUB_OUTPUT
          
          echo "âœ… USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          cat radio-workflow/temp/USE_UUID.md
      
      - name: Upload voice UUID file
        uses: actions/upload-artifact@v4
        with:
          name: voice-uuid
          path: radio-workflow/temp/USE_UUID.md
          retention-days: 1

  script-opening:
    needs: planning-setup
    runs-on: ubuntu-latest
    outputs:
      script-text: ${{ steps.generate.outputs.script-text }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate opening script
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ğŸ¬ ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ç”Ÿæˆé–‹å§‹"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          cat > opening_prompt.txt << 'EOF'
          ä»¥ä¸‹ã®è¨­å®šã§ãƒ©ã‚¸ã‚ªã®ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£è¨­å®šã€‘
          ${{ needs.planning-setup.outputs.personality-data }}

          ã€ä»Šæ—¥ã®ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã€‘
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«: ${{ needs.planning-setup.outputs.opening-pattern }}
          - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰: ${{ needs.planning-setup.outputs.character-mode }}
          - ç‰¹åˆ¥ãƒˆãƒ¼ã‚¯è¦ç´ : ${{ needs.planning-setup.outputs.random-element }}

          ã€æ¥½æ›²æƒ…å ±ã€‘
          ${{ needs.planning-setup.outputs.music-info }}

          ã€è¦ä»¶ã€‘
          - æ™‚é–“: 30ç§’ï¼ˆç´„200-250æ–‡å­—ï¼‰
          - å†…å®¹: æ˜ã‚‹ã„æŒ¨æ‹¶ã€ä»Šæ—¥ã®æ—¥ä»˜ã¨ç•ªçµ„åã‚’ç´¹ä»‹ã€æ¥½æ›²ç´¹ä»‹ã‚’å«ã‚ã‚‹
          - ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ã®å£èª¿ã‚„ç‰¹å¾´ã‚’åæ˜ 
          - ä¸€äººç§°ã¯ã€Œåƒ•ã€ã‚’ä½¿ç”¨

          é‡è¦: ç”Ÿæˆã—ãŸã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆJSONå½¢å¼ã§ã¯ãªãã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€‚
          EOF

          # Claude Codeå®Ÿè¡Œ
          OPENING_SCRIPT=$(npx @anthropic-ai/claude-code \
            --allowedTools "none" \
            --max-turns 3 \
            --quiet \
            < opening_prompt.txt)

          # SSMLå‡¦ç†
          if [ -f "ssml_formatter.js" ]; then
            OPENING_SSML=$(echo "$OPENING_SCRIPT" | node -e "
              const SSMLFormatter = require('./ssml_formatter.js');
              const formatter = new SSMLFormatter();
              let text = '';
              process.stdin.on('data', chunk => text += chunk);
              process.stdin.on('end', () => {
                const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                console.log(result);
              });
            ")
          else
            OPENING_SSML="$OPENING_SCRIPT"
          fi

          {
            echo "script-text<<EOF"
            echo "$OPENING_SSML"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  script-main:
    needs: planning-setup
    runs-on: ubuntu-latest
    outputs:
      script-text: ${{ steps.generate.outputs.script-text }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate main script
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ğŸ¬ ãƒ¡ã‚¤ãƒ³1å°æœ¬ç”Ÿæˆé–‹å§‹"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          cat > main_prompt.txt << 'EOF'
          ä»¥ä¸‹ã®è¨­å®šã§ãƒ©ã‚¸ã‚ªã®ãƒ¡ã‚¤ãƒ³1ï¼ˆæ˜¼ã®ç¥å¨æ—¥å ±ï¼‰å°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£è¨­å®šã€‘
          ${{ needs.planning-setup.outputs.personality-data }}

          ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…å®¹ã€‘
          ${{ inputs.development-report }}

          ã€å¼·èª¿ãƒã‚¤ãƒ³ãƒˆã€‘
          ${{ inputs.topic-focus || 'ãªã—' }}

          ã€ä»Šæ—¥ã®ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã€‘
          - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰: ${{ needs.planning-setup.outputs.character-mode }}
          - ç‰¹åˆ¥ãƒˆãƒ¼ã‚¯è¦ç´ : ${{ needs.planning-setup.outputs.random-element }}

          ã€è¦ä»¶ã€‘
          - æ™‚é–“: 50ç§’ï¼ˆç´„300-350æ–‡å­—ï¼‰
          - å†…å®¹: é–‹ç™ºé€²æ—ã‚’æ¥½ã—ãè§£èª¬
          - ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ã®å£èª¿ã‚„ç‰¹å¾´ã‚’åæ˜ 
          - ä¸€äººç§°ã¯ã€Œåƒ•ã€ã‚’ä½¿ç”¨

          é‡è¦: ç”Ÿæˆã—ãŸãƒ¡ã‚¤ãƒ³å°æœ¬ã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆJSONå½¢å¼ã§ã¯ãªãã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€‚
          EOF

          # Claude Codeå®Ÿè¡Œ
          MAIN_SCRIPT=$(npx @anthropic-ai/claude-code \
            --allowedTools "none" \
            --max-turns 3 \
            --quiet \
            < main_prompt.txt)

          # SSMLå‡¦ç†
          if [ -f "ssml_formatter.js" ]; then
            MAIN_SSML=$(echo "$MAIN_SCRIPT" | node -e "
              const SSMLFormatter = require('./ssml_formatter.js');
              const formatter = new SSMLFormatter();
              let text = '';
              process.stdin.on('data', chunk => text += chunk);
              process.stdin.on('end', () => {
                const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                console.log(result);
              });
            ")
          else
            MAIN_SSML="$MAIN_SCRIPT"
          fi

          {
            echo "script-text<<EOF"
            echo "$MAIN_SSML"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  script-main2:
    needs: planning-setup
    runs-on: ubuntu-latest
    outputs:
      script-text: ${{ steps.generate.outputs.script-text }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate main2 script
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ğŸ¬ ãƒ¡ã‚¤ãƒ³2å°æœ¬ç”Ÿæˆé–‹å§‹"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          cat > main2_prompt.txt << 'EOF'
          ä»¥ä¸‹ã®è¨­å®šã§ãƒ©ã‚¸ã‚ªã®ãƒ¡ã‚¤ãƒ³2ï¼ˆãƒ†ãƒƒã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼‰å°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£è¨­å®šã€‘
          ${{ needs.planning-setup.outputs.personality-data }}

          ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…å®¹ã€‘
          ${{ inputs.tech-news }}

          ã€ä»Šæ—¥ã®ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã€‘
          - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰: ${{ needs.planning-setup.outputs.character-mode }}
          - ç‰¹åˆ¥ãƒˆãƒ¼ã‚¯è¦ç´ : ${{ needs.planning-setup.outputs.random-element }}

          ã€è¦ä»¶ã€‘
          - æ™‚é–“: 50ç§’ï¼ˆç´„300-350æ–‡å­—ï¼‰
          - å†…å®¹: ãƒ†ãƒƒã‚¯æƒ…å ±ã‚’é¢ç™½ãŠã‹ã—ãç´¹ä»‹
          - ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ã®å£èª¿ã‚„ç‰¹å¾´ã‚’åæ˜ 
          - ä¸€äººç§°ã¯ã€Œåƒ•ã€ã‚’ä½¿ç”¨

          é‡è¦: ç”Ÿæˆã—ãŸãƒ¡ã‚¤ãƒ³2å°æœ¬ã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆJSONå½¢å¼ã§ã¯ãªãã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€‚
          EOF

          # Claude Codeå®Ÿè¡Œ
          MAIN2_SCRIPT=$(npx @anthropic-ai/claude-code \
            --allowedTools "none" \
            --max-turns 3 \
            --quiet \
            < main2_prompt.txt)

          # SSMLå‡¦ç†
          if [ -f "ssml_formatter.js" ]; then
            MAIN2_SSML=$(echo "$MAIN2_SCRIPT" | node -e "
              const SSMLFormatter = require('./ssml_formatter.js');
              const formatter = new SSMLFormatter();
              let text = '';
              process.stdin.on('data', chunk => text += chunk);
              process.stdin.on('end', () => {
                const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                console.log(result);
              });
            ")
          else
            MAIN2_SSML="$MAIN2_SCRIPT"
          fi

          {
            echo "script-text<<EOF"
            echo "$MAIN2_SSML"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  script-main3:
    needs: planning-setup
    runs-on: ubuntu-latest
    outputs:
      script-text: ${{ steps.generate.outputs.script-text }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate main3 script
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ğŸ¬ ãƒ¡ã‚¤ãƒ³3å°æœ¬ç”Ÿæˆé–‹å§‹"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          cat > main3_prompt.txt << 'EOF'
          ä»¥ä¸‹ã®è¨­å®šã§ãƒ©ã‚¸ã‚ªã®ãƒ¡ã‚¤ãƒ³3ï¼ˆå¤œã®ç¥å¨æ—¥å ±ï¼‰å°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£è¨­å®šã€‘
          ${{ needs.planning-setup.outputs.personality-data }}

          ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…å®¹ã€‘
          ${{ inputs.evening-report }}

          ã€ä»Šæ—¥ã®ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã€‘
          - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰: ${{ needs.planning-setup.outputs.character-mode }}
          - ç‰¹åˆ¥ãƒˆãƒ¼ã‚¯è¦ç´ : ${{ needs.planning-setup.outputs.random-element }}

          ã€è¦ä»¶ã€‘
          - æ™‚é–“: 50ç§’ï¼ˆç´„300-350æ–‡å­—ï¼‰
          - å†…å®¹: 1æ—¥ã®ç· ã‚ããã‚Šã®å ±å‘Š
          - ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ã®å£èª¿ã‚„ç‰¹å¾´ã‚’åæ˜ 
          - ä¸€äººç§°ã¯ã€Œåƒ•ã€ã‚’ä½¿ç”¨

          é‡è¦: ç”Ÿæˆã—ãŸãƒ¡ã‚¤ãƒ³3å°æœ¬ã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆJSONå½¢å¼ã§ã¯ãªãã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€‚
          EOF

          # Claude Codeå®Ÿè¡Œ
          MAIN3_SCRIPT=$(npx @anthropic-ai/claude-code \
            --allowedTools "none" \
            --max-turns 3 \
            --quiet \
            < main3_prompt.txt)

          # SSMLå‡¦ç†
          if [ -f "ssml_formatter.js" ]; then
            MAIN3_SSML=$(echo "$MAIN3_SCRIPT" | node -e "
              const SSMLFormatter = require('./ssml_formatter.js');
              const formatter = new SSMLFormatter();
              let text = '';
              process.stdin.on('data', chunk => text += chunk);
              process.stdin.on('end', () => {
                const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                console.log(result);
              });
            ")
          else
            MAIN3_SSML="$MAIN3_SCRIPT"
          fi

          {
            echo "script-text<<EOF"
            echo "$MAIN3_SSML"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  script-ending:
    needs: planning-setup
    runs-on: ubuntu-latest
    outputs:
      script-text: ${{ steps.generate.outputs.script-text }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate ending script
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ğŸ¬ ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬ç”Ÿæˆé–‹å§‹"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          cat > ending_prompt.txt << 'EOF'
          ä»¥ä¸‹ã®è¨­å®šã§ãƒ©ã‚¸ã‚ªã®ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£è¨­å®šã€‘
          ${{ needs.planning-setup.outputs.personality-data }}

          ã€ä»Šæ—¥ã®ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã€‘
          - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«: ${{ needs.planning-setup.outputs.ending-pattern }}
          - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰: ${{ needs.planning-setup.outputs.character-mode }}

          ã€è¦ä»¶ã€‘
          - æ™‚é–“: 30ç§’ï¼ˆç´„200-250æ–‡å­—ï¼‰
          - å†…å®¹: ã¾ã¨ã‚ã¨æ¬¡å›äºˆå‘Š
          - ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ã®å£èª¿ã‚„ç‰¹å¾´ã‚’åæ˜ 
          - ä¸€äººç§°ã¯ã€Œåƒ•ã€ã‚’ä½¿ç”¨

          é‡è¦: ç”Ÿæˆã—ãŸã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬ã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆJSONå½¢å¼ã§ã¯ãªãã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€‚
          EOF

          # Claude Codeå®Ÿè¡Œ
          ENDING_SCRIPT=$(npx @anthropic-ai/claude-code \
            --allowedTools "none" \
            --max-turns 3 \
            --quiet \
            < ending_prompt.txt)

          # SSMLå‡¦ç†
          if [ -f "ssml_formatter.js" ]; then
            ENDING_SSML=$(echo "$ENDING_SCRIPT" | node -e "
              const SSMLFormatter = require('./ssml_formatter.js');
              const formatter = new SSMLFormatter();
              let text = '';
              process.stdin.on('data', chunk => text += chunk);
              process.stdin.on('end', () => {
                const result = formatter.formatWithBreaks(text.trim(), formatter.getPreset('normal'));
                console.log(result);
              });
            ")
          else
            ENDING_SSML="$ENDING_SCRIPT"
          fi

          {
            echo "script-text<<EOF"
            echo "$ENDING_SSML"
            echo "EOF"
          } >> $GITHUB_OUTPUT