name: Radio Planning Module - Fine Split Version (Minimal)
on:
  workflow_call:
    inputs:
      development-report:
        required: false
        type: string
      topic-focus:
        required: false
        type: string
      processed-summary:
        description: 'Gemini CLIã§å‡¦ç†æ¸ˆã¿ã®æ§‹é€ åŒ–ã•ã‚ŒãŸã‚µãƒžãƒªãƒ¼'
        required: false
        type: string
      use-processed-input:
        description: 'å‡¦ç†æ¸ˆã¿å…¥åŠ›ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã©ã†ã‹'
        required: false
        type: boolean
        default: false
    outputs:
      script-opening:
        value: ${{ jobs.generate-opening.outputs.script-opening }}
      script-main:
        value: ${{ jobs.generate-main.outputs.script-main }}
      script-main-part2:
        value: ${{ jobs.generate-main-part2.outputs.script-main-part2 }}
      script-jingle:
        value: ${{ jobs.generate-jingle.outputs.script-jingle }}
      script-ending:
        value: ${{ jobs.generate-ending.outputs.script-ending }}
      voice-config:
        value: ${{ jobs.generate-opening.outputs.voice-config }}

jobs:
  generate-opening:
    runs-on: ubuntu-latest
    outputs:
      script-opening: ${{ steps.planning.outputs.script-opening }}
      voice-config: ${{ steps.planning.outputs.voice-config }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate opening script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ðŸ“‹ Opening Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          PROMPT="ãƒ©ã‚¸ã‚ªç•ªçµ„ã®ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          è¦ä»¶:
          - æ™‚é–“: 1åˆ†ï¼ˆ300-400æ–‡å­—ï¼‰
          - å†…å®¹: æ˜Žã‚‹ã„æŒ¨æ‹¶ã¨ç•ªçµ„ç´¹ä»‹
          
          ä»¥ä¸‹ã®JSONã‚’ $WORK_DIR/opening.json ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {
            \"opening\": \"ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬\"
          }"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 5 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          if [ -f "$WORK_DIR/opening.json" ] && jq empty "$WORK_DIR/opening.json" 2>/dev/null; then
            OPENING_TEXT=$(jq -r '.opening' "$WORK_DIR/opening.json")
            
            echo "script-opening<<EOF" >> $GITHUB_OUTPUT
            echo "$OPENING_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "voice-config=default" >> $GITHUB_OUTPUT
            echo "âœ… Opening script generated successfully"
          else
            echo "::error::Opening script generation failed"
            exit 1
          fi
          echo "::endgroup::"

  generate-main:
    runs-on: ubuntu-latest
    outputs:
      script-main: ${{ steps.planning.outputs.script-main }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate main part1 script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ðŸ“‹ Main Part1 Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # é–‹ç™ºé€²æ—æƒ…å ±ã‚’å‰åŠç”¨ã«åˆ†å‰²
          DEV_REPORT='${{ inputs.development-report }}'
          HALF_LENGTH=$((${#DEV_REPORT} / 2))
          DEV_REPORT_PART1=$(echo "$DEV_REPORT" | cut -c1-$HALF_LENGTH)
          
          PROMPT="ãƒ©ã‚¸ã‚ªç•ªçµ„ã®ãƒ¡ã‚¤ãƒ³å‰åŠå°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          é–‹ç™ºé€²æ—æƒ…å ±: $DEV_REPORT_PART1
          å¼·èª¿ãƒã‚¤ãƒ³ãƒˆ: ${{ inputs.topic-focus }}

          è¦ä»¶:
          - æ™‚é–“: 3åˆ†ï¼ˆ900-1200æ–‡å­—ï¼‰
          - å†…å®¹: é–‹ç™ºé€²æ—ã®ä¸»è¦ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬
          
          ä»¥ä¸‹ã®JSONã‚’ $WORK_DIR/main.json ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {
            \"main\": \"ãƒ¡ã‚¤ãƒ³å‰åŠå°æœ¬\"
          }"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 8 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          if [ -f "$WORK_DIR/main.json" ] && jq empty "$WORK_DIR/main.json" 2>/dev/null; then
            MAIN_TEXT=$(jq -r '.main' "$WORK_DIR/main.json")
            
            echo "script-main<<EOF" >> $GITHUB_OUTPUT
            echo "$MAIN_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "âœ… Main part1 script generated successfully"
          else
            echo "::error::Main part1 script generation failed"
            exit 1
          fi
          echo "::endgroup::"

  generate-main-part2:
    runs-on: ubuntu-latest
    outputs:
      script-main-part2: ${{ steps.planning.outputs.script-main-part2 }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate main part2 script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ðŸ“‹ Main Part2 Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          # é–‹ç™ºé€²æ—æƒ…å ±ã‚’å¾ŒåŠç”¨ã«åˆ†å‰²
          DEV_REPORT='${{ inputs.development-report }}'
          HALF_LENGTH=$((${#DEV_REPORT} / 2))
          DEV_REPORT_PART2=$(echo "$DEV_REPORT" | cut -c$((HALF_LENGTH + 1))-)
          
          PROMPT="ãƒ©ã‚¸ã‚ªç•ªçµ„ã®ãƒ¡ã‚¤ãƒ³å¾ŒåŠå°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          é–‹ç™ºé€²æ—æƒ…å ±: $DEV_REPORT_PART2
          å¼·èª¿ãƒã‚¤ãƒ³ãƒˆ: ${{ inputs.topic-focus }}

          è¦ä»¶:
          - æ™‚é–“: 3åˆ†ï¼ˆ900-1200æ–‡å­—ï¼‰
          - å†…å®¹: æ™‚äº‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚„è¿½åŠ æƒ…å ±ã€ãƒªã‚¹ãƒŠãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          
          ä»¥ä¸‹ã®JSONã‚’ $WORK_DIR/main_part2.json ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {
            \"main_part2\": \"ãƒ¡ã‚¤ãƒ³å¾ŒåŠå°æœ¬\"
          }"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 8 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          if [ -f "$WORK_DIR/main_part2.json" ] && jq empty "$WORK_DIR/main_part2.json" 2>/dev/null; then
            MAIN_PART2_TEXT=$(jq -r '.main_part2' "$WORK_DIR/main_part2.json")
            
            echo "script-main-part2<<EOF" >> $GITHUB_OUTPUT
            echo "$MAIN_PART2_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "âœ… Main part2 script generated successfully"
          else
            echo "::error::Main part2 script generation failed"
            exit 1
          fi
          echo "::endgroup::"

  generate-jingle:
    runs-on: ubuntu-latest
    outputs:
      script-jingle: ${{ steps.planning.outputs.script-jingle }}
    steps:
      - name: Generate jingle script
        id: planning
        run: |
          echo "::group::ðŸ“‹ Jingle Script Generation"
          
          echo "script-jingle<<EOF" >> $GITHUB_OUTPUT
          echo "ã‹ã‚€ã‚‰ã˜" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Jingle script generated successfully"
          echo "::endgroup::"

  generate-ending:
    runs-on: ubuntu-latest
    outputs:
      script-ending: ${{ steps.planning.outputs.script-ending }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate ending script
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ðŸ“‹ Ending Script Generation"
          
          WORK_DIR="radio-scripts"
          mkdir -p "$WORK_DIR"
          
          PROMPT="ãƒ©ã‚¸ã‚ªç•ªçµ„ã®ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          è¦ä»¶:
          - æ™‚é–“: 1åˆ†ï¼ˆ300-400æ–‡å­—ï¼‰
          - å†…å®¹: ã¾ã¨ã‚ã¨æ¬¡å›žäºˆå‘Š
          
          ä»¥ä¸‹ã®JSONã‚’ $WORK_DIR/ending.json ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          {
            \"ending\": \"ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬\"
          }"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Write" \
            --max-turns 5 \
            --permission-mode "acceptEdits" \
            -p "$PROMPT"
          
          if [ -f "$WORK_DIR/ending.json" ] && jq empty "$WORK_DIR/ending.json" 2>/dev/null; then
            ENDING_TEXT=$(jq -r '.ending' "$WORK_DIR/ending.json")
            
            echo "script-ending<<EOF" >> $GITHUB_OUTPUT
            echo "$ENDING_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "âœ… Ending script generated successfully"
          else
            echo "::error::Ending script generation failed"
            exit 1
          fi
          echo "::endgroup::"