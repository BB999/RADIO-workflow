name: Radio Planning Module (Minimal)
on:
  workflow_call:
    inputs:
      development-report:
        required: true
        type: string
      topic-focus:
        required: false
        type: string
    outputs:
      script-opening:
        value: ${{ jobs.generate.outputs.script-opening }}
      script-main:
        value: ${{ jobs.generate.outputs.script-main }}
      script-ending:
        value: ${{ jobs.generate.outputs.script-ending }}
      voice-config:
        value: ${{ jobs.generate.outputs.voice-config }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      script-opening: ${{ steps.planning.outputs.script-opening }}
      script-main: ${{ steps.planning.outputs.script-main }}
      script-ending: ${{ steps.planning.outputs.script-ending }}
      voice-config: ${{ steps.planning.outputs.voice-config }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate radio scripts with Claude
        id: planning
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ðŸ“‹ Radio Script Generation"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ä»¥ä¸‹ã®å†…å®¹ã§90ç§’ã®ãƒ©ã‚¸ã‚ªç•ªçµ„å°æœ¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          ã€é–‹ç™ºé€²æ—ãƒ»æœ€æ–°æƒ…å ±ã€‘
          ${{ inputs.development-report }}

          ã€å¼·èª¿ãƒã‚¤ãƒ³ãƒˆã€‘
          ${{ inputs.topic-focus || 'ãªã—' }}

          ã€è¦ä»¶ã€‘
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: 30ç§’ï¼ˆæ˜Žã‚‹ã„æŒ¨æ‹¶ã¨ä»Šæ—¥ã®ãƒˆãƒ”ãƒƒã‚¯ç´¹ä»‹ï¼‰
          - ãƒ¡ã‚¤ãƒ³: 30ç§’ï¼ˆå†…å®¹ã‚’åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ï¼‰
          - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: 30ç§’ï¼ˆã¾ã¨ã‚ã¨æ¬¡å›žäºˆå‘Šï¼‰
          - MC: 20ä»£å¥³æ€§ã€æ˜Žã‚‹ãè¦ªã—ã¿ã‚„ã™ã„å£èª¿
          - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: 20-30ä»£ã®æŠ€è¡“ã«èˆˆå‘³ãŒã‚ã‚‹å±¤

          JSONå½¢å¼ã§ä»¥ä¸‹ã®ã‚ˆã†ã«å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
          {
            \"opening\": \"ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬\",
            \"main\": \"ãƒ¡ã‚¤ãƒ³å°æœ¬\", 
            \"ending\": \"ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬\"
          }"
          
          echo "ðŸš€ Starting Radio Script Generation..."
          echo "ðŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          SCRIPT_RESULT=$(npx @anthropic-ai/claude-code \
            --max-turns 10 \
            --verbose \
            -c "$PROMPT") || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          echo "ðŸ“ Script generation result:"
          echo "$SCRIPT_RESULT"
          
          # JSONã‹ã‚‰å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡ºï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          if echo "$SCRIPT_RESULT" | jq empty 2>/dev/null; then
            echo "âœ… Valid JSON response received"
            echo "$SCRIPT_RESULT" | jq -r '.opening' | sed 's/^/script-opening=/' >> $GITHUB_OUTPUT
            echo "$SCRIPT_RESULT" | jq -r '.main' | sed 's/^/script-main=/' >> $GITHUB_OUTPUT  
            echo "$SCRIPT_RESULT" | jq -r '.ending' | sed 's/^/script-ending=/' >> $GITHUB_OUTPUT
          else
            echo "::warning::Claude Codeã®å‡ºåŠ›ãŒJSONã§ã¯ãªã„ãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å°æœ¬ã‚’ä½¿ç”¨"
            echo "script-opening=ã“ã‚“ã«ã¡ã¯ã€ç¥žå¨æ—¥å ±ãƒ©ã‚¸ã‚ªã§ã™ã€‚æœ¬æ—¥ã¯${{ inputs.development-report }}ã«ã¤ã„ã¦ãŠä¼ãˆã—ã¾ã™ã€‚" >> $GITHUB_OUTPUT
            echo "script-main=${{ inputs.development-report }}ã®è©³ç´°ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚${{ inputs.topic-focus || '' }}" >> $GITHUB_OUTPUT
            echo "script-ending=ä»¥ä¸Šã€ç¥žå¨æ—¥å ±ãƒ©ã‚¸ã‚ªã§ã—ãŸã€‚ã¾ãŸæ˜Žæ—¥ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚" >> $GITHUB_OUTPUT
          fi
          
          echo 'voice-config={"gender":"female","age":"20s"}' >> $GITHUB_OUTPUT
          echo "::endgroup::"