name: Audio Mixing Module - Main3
on:
  workflow_call:
    inputs:
      voice-main3:
        required: true
        type: string
      bgm-main3:
        required: true
        type: string
    outputs:
      mixed-audio:
        value: ${{ jobs.mix-main.outputs.audio-file }}

jobs:
  mix-main:
    runs-on: ubuntu-latest
    outputs:
      audio-file: ${{ steps.mixing.outputs.main-file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download voice-main3 artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-main3
          path: artifacts/voice-main3
      
      - name: Download bgm-main3 artifact
        uses: actions/download-artifact@v4
        with:
          name: bgm-main3
          path: artifacts/bgm-main3
      
      - name: List downloaded artifacts
        run: |
          echo "::group::ðŸ“ ãƒ¡ã‚¤ãƒ³ç”¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ"
          echo "=== artifacts/ ==="
          ls -la artifacts/ || echo "artifactsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo ""
          echo "=== å„ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®å†…å®¹ ==="
          for dir in artifacts/*/; do
            if [ -d "$dir" ]; then
              echo "--- $dir ---"
              ls -la "$dir" || echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã§ã™"
              echo ""
            fi
          done
          echo "::endgroup::"
      
      - name: Install FFmpeg
        run: |
          # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨3å›žãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãFFmpegã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          install_ffmpeg() {
            local attempt=1
            local max_attempts=3
            
            while [ $attempt -le $max_attempts ]; do
              echo "ðŸ“¦ FFmpegã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è©¦è¡Œ $attempt/$max_attempts"
              
              # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãapt-get updateå®Ÿè¡Œï¼ˆ5åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
              if timeout 300 sudo apt-get update; then
                echo "âœ… apt-get update æˆåŠŸ"
                if sudo apt-get install -y ffmpeg; then
                  echo "âœ… FFmpegã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æˆåŠŸ"
                  return 0
                else
                  echo "::warning::FFmpegã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ï¼ˆè©¦è¡Œ $attempt/$max_attemptsï¼‰"
                fi
              else
                echo "::warning::apt-get update ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯å¤±æ•—ï¼ˆè©¦è¡Œ $attempt/$max_attemptsï¼‰"
                
                # Microsoft ãƒªãƒã‚¸ãƒˆãƒªãŒåŽŸå› ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã—ã¦å†è©¦è¡Œ
                if [ $attempt -eq 2 ]; then
                  echo "ðŸ”§ å•é¡Œã®ã‚ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒªãƒˆãƒ©ã‚¤"
                  sudo rm -f /etc/apt/sources.list.d/microsoft* || true
                  sudo rm -f /etc/apt/sources.list.d/azure* || true
                fi
              fi
              
              attempt=$((attempt + 1))
              if [ $attempt -le $max_attempts ]; then
                echo "â³ 10ç§’å¾…æ©Ÿã—ã¦ãƒªãƒˆãƒ©ã‚¤..."
                sleep 10
              fi
            done
            
            echo "::error::âŒ FFmpegã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ$max_attempts å›žè©¦è¡Œï¼‰"
            return 1
          }
          
          install_ffmpeg
      
      - name: Mix main3 audio with BGM
        id: mixing
        run: |
          # ãƒ¡ã‚¤ãƒ³3ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¤œã®ç¥žå¨æ—¥å ±ï¼‰: éŸ³å£° + BGMã®ãƒŸãƒƒã‚¯ã‚¹
          
          # éŸ³å£°ã®é•·ã•ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          get_duration() {
            local file="$1"
            if [ ! -f "$file" ]; then
              echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $fileã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤30ç§’ã‚’ä½¿ç”¨"
              echo "30"
              return 0
            fi
            local duration=$(ffprobe -v quiet -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)
            if [ -z "$duration" ] || [ "$duration" = "N/A" ]; then
              echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’å–å¾—ã§ãã¾ã›ã‚“: $fileã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤30ç§’ã‚’ä½¿ç”¨"
              echo "30"
              return 0
            fi
            echo "$duration"
          }
          
          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãFFmpegå®Ÿè¡Œ
          safe_ffmpeg() {
            local TEMP_LOG="ffmpeg_$(date +%s).log"
            if ! ffmpeg "$@" 2>"$TEMP_LOG"; then
              echo "::error::FFmpegå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: $*"
              echo "::error::FFmpegã‚¨ãƒ©ãƒ¼å‡ºåŠ›:"
              cat "$TEMP_LOG" | head -20
              rm -f "$TEMP_LOG"
              return 1
            fi
            rm -f "$TEMP_LOG"
            return 0
          }
          
          # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          echo "ðŸ“‚ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼"
          if [ -f "artifacts/voice-main3/${{ inputs.voice-main3 }}" ]; then
            cp "artifacts/voice-main3/${{ inputs.voice-main3 }}" voice-main3.wav
            echo "âœ… voice-main3.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/voice-main3/${{ inputs.voice-main3 }}"
            safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 30 -ar 44100 -ac 2 -c:a pcm_s16le voice-main3.wav || exit 1
          fi
          
          echo "ðŸ“‚ BGMãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼"
          if [ -f "artifacts/bgm-main3/${{ inputs.bgm-main3 }}" ]; then
            cp "artifacts/bgm-main3/${{ inputs.bgm-main3 }}" bgm-main3-30s.wav
            echo "âœ… bgm-main3-30s.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::warning::BGMãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/bgm-main3/${{ inputs.bgm-main3 }}"
            safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 30 -ar 44100 -ac 2 -c:a pcm_s16le bgm-main3-30s.wav || exit 1
          fi
          
          # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’å–å¾—
          echo "ðŸ“ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’æ¸¬å®šä¸­..."
          VOICE_MAIN_DURATION=$(get_duration voice-main3.wav)
          echo "  ãƒ¡ã‚¤ãƒ³éŸ³å£°: ${VOICE_MAIN_DURATION}ç§’"
          
          # å¿…è¦ãªBGMã®é•·ã•ã‚’è¨ˆç®—
          BGM_MAIN_NEEDED=$(awk "BEGIN {print int($VOICE_MAIN_DURATION + 9)}")         # 4ç§’ã‚¤ãƒ³ãƒˆãƒ­ + éŸ³å£° + 5ç§’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          
          echo "ðŸŽµ å¿…è¦ãªBGMã®é•·ã•:"
          echo "  ãƒ¡ã‚¤ãƒ³: ${BGM_MAIN_NEEDED}ç§’"
          
          # BGMã‚’å¿…è¦ãªé•·ã•ã«ãƒ«ãƒ¼ãƒ—æ‹¡å¼µï¼ˆã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã§ã‚¹ãƒ ãƒ¼ã‚ºãªãƒ«ãƒ¼ãƒ—ï¼‰
          if [ $BGM_MAIN_NEEDED -gt 30 ]; then
            echo "ðŸ”„ ãƒ¡ã‚¤ãƒ³BGMã‚’${BGM_MAIN_NEEDED}ç§’ã«æ‹¡å¼µ"
            # å‰å‡¦ç†ï¼šBGMã®å§‹ã¾ã‚Šã¨çµ‚ã‚ã‚Šã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ãƒ—ãƒãƒ•ãƒªã‚’é˜²æ­¢
            safe_ffmpeg -i bgm-main3-30s.wav -filter_complex \
              "[0:a]afade=t=in:ss=0:d=0.1,afade=t=out:st=29.9:d=0.1[clean]" \
              -map "[clean]" -ar 44100 -ac 2 -c:a pcm_s16le bgm-clean.wav -y || exit 1
            
            # 2ç§’ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã§ã‚¹ãƒ ãƒ¼ã‚ºãªãƒ«ãƒ¼ãƒ—
            LOOPS_NEEDED=$(awk "BEGIN {print int($BGM_MAIN_NEEDED / 28) + 1}")
            safe_ffmpeg -i bgm-clean.wav -filter_complex \
              "[0:a]atrim=0:28[part];
               [part]aloop=loop=$LOOPS_NEEDED:size=44100*28[base];
               [0:a][base]acrossfade=d=2:c1=tri:c2=tri,atrim=0:$BGM_MAIN_NEEDED[looped]" \
              -map "[looped]" -ar 44100 -ac 2 -c:a pcm_s16le bgm-main3-extended.wav -y || exit 1
            mv bgm-main3-extended.wav bgm-main3-30s.wav
            rm -f bgm-clean.wav
          else
            # 30ç§’ä»¥ä¸‹ã§ã‚‚å§‹ã¾ã‚Šã®ãƒ—ãƒãƒ•ãƒªã‚’é˜²æ­¢
            safe_ffmpeg -i bgm-main3-30s.wav -filter_complex \
              "[0:a]afade=t=in:ss=0:d=0.1[clean]" \
              -map "[clean]" -ar 44100 -ac 2 -c:a pcm_s16le bgm-temp.wav -y || exit 1
            mv bgm-temp.wav bgm-main3-30s.wav
          fi
          
          # ãƒ¡ã‚¤ãƒ³: BGM4ç§’ã‚¤ãƒ³ãƒˆãƒ­ï¼ˆæœ€å¤§éŸ³é‡ï¼‰â†’éŸ³å£°é–‹å§‹æ™‚50%â†’éŸ³å£°çµ‚äº†å¾ŒBGMãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆ5ç§’ï¼‰
          VOICE_MAIN_END_WITH_DELAY=$(awk "BEGIN {print $VOICE_MAIN_DURATION + 4}")
          FADE_START_MAIN=$(awk "BEGIN {print $VOICE_MAIN_END_WITH_DELAY}")
          TOTAL_MAIN_DURATION=$(awk "BEGIN {print $VOICE_MAIN_DURATION + 9}")
          
          echo "ðŸŽµ ãƒ¡ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒŸã‚­ã‚·ãƒ³ã‚°é–‹å§‹"
          # ãƒ¡ã‚¤ãƒ³ç”¨ã®ç·©ã‚„ã‹ãªéŸ³é‡å¤‰åŒ–
          MAIN_FADE_DOWN_START=4
          MAIN_FADE_DOWN_END=4.5
          
          echo "  éŸ³å£°çµ‚äº†ï¼ˆé…å»¶è€ƒæ…®ï¼‰: ${VOICE_MAIN_END_WITH_DELAY}ç§’"
          echo "  ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹: ${FADE_START_MAIN}ç§’"
          
          safe_ffmpeg -i voice-main3.wav \
                      -i bgm-main3-30s.wav \
                      -filter_complex "[0]aresample=44100,adelay=4s:all=1[voice_delayed];
                                      [1]aresample=44100,volume='if(lt(t,$MAIN_FADE_DOWN_START),1,if(lt(t,$MAIN_FADE_DOWN_END),1-0.5*(t-$MAIN_FADE_DOWN_START)/0.5,0.5))':eval=frame,
                                      afade=t=out:st=${FADE_START_MAIN}:d=5[bgm2];
                                      [voice_delayed][bgm2]amix=inputs=2[main]" \
                      -map "[main]" \
                      -t ${TOTAL_MAIN_DURATION} \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      main3-mixed.wav || exit 1
          
          if [ -f "main3-mixed.wav" ]; then
            echo "âœ… main3-mixed.wav ç”ŸæˆæˆåŠŸ ($(stat -c%s main3-mixed.wav) bytes)"
          else
            echo "::error::âŒ main3-mixed.wav ã®ç”Ÿæˆã«å¤±æ•—"
            exit 1
          fi
          
          echo "main-file=main3-mixed.wav" >> $GITHUB_OUTPUT
      
      - name: Upload main3 mixed audio artifact
        uses: actions/upload-artifact@v4
        with:
          name: main3-mixed-audio
          path: main3-mixed.wav
          retention-days: 7