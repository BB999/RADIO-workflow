name: Create Radio Audio with Music

on:
  workflow_dispatch:
    inputs:
      script_content:
        description: 'ãƒ©ã‚¸ã‚ªã®åŸç¨¿ï¼ˆãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ï¼‰'
        required: true
        type: string
      music_mood:
        description: 'éŸ³æ¥½ã®é›°å›²æ°—ï¼ˆä¾‹ï¼šãƒªãƒ©ãƒƒã‚¯ã‚¹ã€ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã€ã‚¸ãƒ£ã‚ºé¢¨ï¼‰'
        required: true
        type: string

jobs:
  check-api-status:
    runs-on: ubuntu-latest
    outputs:
      all-apis-healthy: ${{ steps.api-check.outputs.all-healthy }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: APIç¨¼åƒçŠ¶æ³ãƒã‚§ãƒƒã‚¯
        id: api-check
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          AIVIS_API_KEY: ${{ secrets.AIVIS_API_KEY }}
        run: |
          echo "::group::ğŸ” API Status Check"
          echo "Starting API health checks at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # APIç¨¼åƒçŠ¶æ³ãƒ•ãƒ©ã‚°
          ALL_HEALTHY=true
          
          # 1. aivis-api ãƒã‚§ãƒƒã‚¯
          echo "ğŸ“¡ Checking aivis-api status..."
          HTTP_CODE=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $AIVIS_API_KEY" \
             -H "Content-Type: application/json" \
             -X POST "https://api.aivis-project.com/v1/tts/synthesize" \
             -d '{"text":"test","model_uuid":"a59cb814-0083-4369-8542-f51a29e72af7","output_format":"wav"}' \
             --max-time 10 -o /dev/null)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… aivis-api: Healthy (HTTP $HTTP_CODE)"
          else
            echo "âŒ aivis-api: Unhealthy (HTTP $HTTP_CODE)"
            ALL_HEALTHY=false
          fi
          
          # 2. Claude Code OAuth Token ãƒã‚§ãƒƒã‚¯
          echo "ğŸ“¡ Checking Claude Code OAuth Token..."
          if [ -n "$CLAUDE_CODE_OAUTH_TOKEN" ] && [ "$CLAUDE_CODE_OAUTH_TOKEN" != "" ]; then
            echo "âœ… Claude Code OAuth Token: Present"
          else
            echo "âŒ Claude Code OAuth Token: Missing or empty"
            ALL_HEALTHY=false
          fi
          
          # 3. kamuicode MCPæ¥ç¶šãƒã‚§ãƒƒã‚¯ï¼ˆéŸ³æ¥½ç”Ÿæˆç”¨ï¼‰
          echo "ğŸ“¡ Checking kamuicode MCP availability..."
          # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f ".claude/mcp-kamuicode.json" ]; then
            echo "âœ… kamuicode MCP config: Found"
          else
            echo "âŒ kamuicode MCP config: Missing"
            ALL_HEALTHY=false
          fi
          
          # çµæœã®åˆ¤å®š
          if [ "$ALL_HEALTHY" = "true" ]; then
            echo "ğŸ‰ All APIs are healthy - proceeding with workflow"
            echo "all-healthy=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸš¨ One or more APIs are unhealthy - workflow will be terminated"
            echo "all-healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "::endgroup::"

  setup-branch:
    runs-on: ubuntu-latest
    needs: [check-api-status]
    permissions:
      contents: write
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      folder-name: ${{ steps.create-branch.outputs.folder-name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create branch for radio audio generation
        id: create-branch
        run: |
          BRANCH_NAME="radio-audio/$(date +%Y%m%d)-${{ github.run_id }}"
          FOLDER_NAME="radio-audio-$(date +%Y%m%d)-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin $BRANCH_NAME
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"
          echo "Folder name: $FOLDER_NAME"

  script-planning:
    runs-on: ubuntu-latest
    needs: [setup-branch]
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.planning.outputs.completed }}
      radio-script: ${{ steps.planning.outputs.radio-script }}
      voice-style: ${{ steps.planning.outputs.voice-style }}
      music-prompt: ${{ steps.planning.outputs.music-prompt }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # Claude Code CLIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ä¸è¦ï¼ˆnpxã§ç›´æ¥å®Ÿè¡Œï¼‰
      
      - name: ãƒ©ã‚¸ã‚ªå°æœ¬ä½œæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ™ï¸ Radio Script Planning Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          SCRIPT_CONTENT="${{ inputs.script_content }}"
          MUSIC_MOOD="${{ inputs.music_mood }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          PLANNING_DIR="$FOLDER_NAME/planning"
          
          echo "Script content: $SCRIPT_CONTENT"
          echo "Music mood: $MUSIC_MOOD"
          echo "Planning folder: $PLANNING_DIR"
          
          # è¨ˆç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$PLANNING_DIR" ]; then
            mkdir -p "$PLANNING_DIR"
            echo "ğŸ“ Created planning folder: $PLANNING_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯ãƒ©ã‚¸ã‚ªç•ªçµ„åˆ¶ä½œã®å°‚é–€å®¶ã§ã™ã€‚åŸç¨¿ã‹ã‚‰1åˆ†ç¨‹åº¦ã®ãƒ©ã‚¸ã‚ªå°æœ¬ã‚’ä½œæˆã—ã€éŸ³æ¥½ã¨åˆæˆã™ã‚‹ãŸã‚ã®æˆ¦ç•¥ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

          **åŸç¨¿å†…å®¹**: $SCRIPT_CONTENT
          **éŸ³æ¥½ã®é›°å›²æ°—**: $MUSIC_MOOD

          **ã‚¿ã‚¹ã‚¯**:
          1. åŸç¨¿ã‚’åˆ†æã—ã€1åˆ†ç¨‹åº¦ï¼ˆç´„150-200æ–‡å­—ï¼‰ã®ãƒ©ã‚¸ã‚ªå°æœ¬ã«ã¾ã¨ã‚ã‚‹
          2. ã‚«ãƒ ã‚¤æ—¥å ±ã®è©±è€…ã®å£èª¿ãƒ»ç‰¹å¾´ã‚’åæ˜ ã—ãŸå°æœ¬ã«èª¿æ•´
          3. éŸ³æ¥½ã®é›°å›²æ°—ã«åˆã‚ã›ãŸè©±ã—æ–¹ãƒ»ãƒˆãƒ¼ãƒ³ã‚’è¨­å®š
          4. aivis-apiç”¨ã®éŸ³å£°ç”Ÿæˆè¨­å®šã‚’è¨ˆç”»
          5. éŸ³æ¥½ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          6. éŸ³å£°ã¨éŸ³æ¥½ã®åˆæˆæˆ¦ç•¥ã‚’ç­–å®š
          7. ãƒ©ã‚¸ã‚ªå°æœ¬ã‚’ã€Œ$PLANNING_DIR/radio-script.txtã€ã«ä¿å­˜
          8. éŸ³å£°ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šã‚’ã€Œ$PLANNING_DIR/voice-style.jsonã€ã«ä¿å­˜
          9. éŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/music-prompt.txtã€ã«ä¿å­˜
          10. åˆ¶ä½œæˆ¦ç•¥æ›¸ã‚’ã€Œ$PLANNING_DIR/radio-strategy.mdã€ã«ä¿å­˜

          **ã‚«ãƒ ã‚¤æ—¥å ±è©±è€…ã®ç‰¹å¾´**ï¼ˆvoice_analysis.txtã‹ã‚‰ï¼‰:
          - ã€Œãˆã£ã¨ã€ã€Œã§ã™ã­ã€ã€Œã¡ã‚‡ã£ã¨ã€ã‚’å¤šç”¨
          - ã€Œã€œã¿ãŸã„ãªæ„Ÿã˜ã€ã€Œã€œã£ã¦ã„ã†æ„Ÿã˜ã€ã§èª¬æ˜
          - æŠ€è¡“çš„ãªå†…å®¹ã‚’è¦ªã—ã¿ã‚„ã™ãè§£èª¬
          - ã€Œã™ã”ã„ã€ã€Œã‚„ã°ã„ã€ãªã©ã®æ„Ÿå˜†è©ã‚’ä½¿ç”¨
          - ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã ãŒä¸å¯§ãªèªèª¿

          **éŸ³å£°ç”Ÿæˆè¨­å®šä¾‹**:
          - model_uuid: a59cb814-0083-4369-8542-f51a29e72af7
          - speaking_rate: 1.0-1.2ï¼ˆãƒ†ãƒ³ãƒã«å¿œã˜ã¦èª¿æ•´ï¼‰
          - emotional_intensity: éŸ³æ¥½ã®é›°å›²æ°—ã«åˆã‚ã›ã¦èª¿æ•´
          - output_format: wavï¼ˆé«˜éŸ³è³ªåˆæˆç”¨ï¼‰

          ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€æˆ¦ç•¥ã‚’è¨ˆç”»ã—ã¦ãã ã•ã„ã€‚"

          # Claude Codeã‚’å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "bypassPermissions" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # å‡ºåŠ›ã®ç¢ºèª
          if [ -f "$PLANNING_DIR/radio-script.txt" ]; then
            echo "âœ… Radio script created"
            RADIO_SCRIPT=$(cat "$PLANNING_DIR/radio-script.txt")
            echo "radio-script<<EOF" >> $GITHUB_OUTPUT
            echo "$RADIO_SCRIPT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âŒ Radio script not found"
            exit 1
          fi

          if [ -f "$PLANNING_DIR/voice-style.json" ]; then
            echo "âœ… Voice style settings created"
            VOICE_STYLE=$(cat "$PLANNING_DIR/voice-style.json")
            echo "voice-style<<EOF" >> $GITHUB_OUTPUT
            echo "$VOICE_STYLE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âŒ Voice style not found"
            exit 1
          fi

          if [ -f "$PLANNING_DIR/music-prompt.txt" ]; then
            echo "âœ… Music prompt created"
            MUSIC_PROMPT=$(cat "$PLANNING_DIR/music-prompt.txt")
            echo "music-prompt<<EOF" >> $GITHUB_OUTPUT
            echo "$MUSIC_PROMPT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âŒ Music prompt not found"
            exit 1
          fi

          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
          git add "$PLANNING_DIR"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Add planning files for radio audio generation" || echo "No changes to commit"
          git push origin ${{ needs.setup-branch.outputs.branch-name }}
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"

  generate-voice:
    runs-on: ubuntu-latest
    needs: [setup-branch, script-planning]
    permissions:
      contents: write
    outputs:
      voice-generated: ${{ steps.voice-generation.outputs.voice-generated }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # Claude Code CLIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ä¸è¦ï¼ˆnpxã§ç›´æ¥å®Ÿè¡Œï¼‰
      
      # éŸ³å£°ç”Ÿæˆï¼ˆaivis-apiä½¿ç”¨ï¼‰
      - name: éŸ³å£°ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: voice-generation
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          AIVIS_API_KEY: ${{ secrets.AIVIS_API_KEY }}
        run: |
          echo "::group::ğŸ¤ Voice Generation Agent Execution"
          
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          AUDIO_DIR="$FOLDER_NAME/audio"
          
          # éŸ³å£°ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$AUDIO_DIR"
          
          PLANNING_DIR="${{ needs.setup-branch.outputs.folder-name }}/planning"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          echo "ğŸ“ Checking planning files..."
          ls -la "$PLANNING_DIR" || echo "Planning directory not found"
          
          if [ ! -f "$PLANNING_DIR/radio-script.txt" ]; then
            echo "âŒ radio-script.txt not found in $PLANNING_DIR"
            exit 1
          fi
          
          if [ ! -f "$PLANNING_DIR/voice-style.json" ]; then
            echo "âŒ voice-style.json not found in $PLANNING_DIR"
            exit 1
          fi
          
          PROMPT="aivis-apiã‚’ä½¿ç”¨ã—ã¦ãƒ©ã‚¸ã‚ªéŸ³å£°ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **å°æœ¬ãƒ•ã‚¡ã‚¤ãƒ«**: $PLANNING_DIR/radio-script.txt
          **éŸ³å£°è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: $PLANNING_DIR/voice-style.json
          **API Key**: ç’°å¢ƒå¤‰æ•°AIVIS_API_KEYã‹ã‚‰å–å¾—

          **ã‚¿ã‚¹ã‚¯**:
          1. å°æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã¨voice-style.jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆReadãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
          2. aivis-apiï¼ˆhttps://api.aivis-project.com/v1/tts/synthesizeï¼‰ã‚’ä½¿ã£ã¦éŸ³å£°ç”Ÿæˆ
          3. é«˜éŸ³è³ªWAVå½¢å¼ã§å‡ºåŠ›
          4. ç”Ÿæˆã—ãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œ$AUDIO_DIR/radio-voice.wavã€ã«ä¿å­˜
          5. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’å‡ºåŠ›

          aivis-apiã®ä½¿ç”¨æ–¹æ³•:
          - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: POST https://api.aivis-project.com/v1/tts/synthesize
          - Authorization: Bearer \$AIVIS_API_KEY
          - model_uuid: a59cb814-0083-4369-8542-f51a29e72af7
          - output_format: wav
          - å°æœ¬ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šã‚’ä½¿ç”¨

          éŸ³å£°ã‚’ç”Ÿæˆã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"

          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "bypassPermissions" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "$AUDIO_DIR/radio-voice.wav" ]; then
            echo "âœ… Voice generated successfully"
            echo "voice-generated=true" >> $GITHUB_OUTPUT
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
            git add "$AUDIO_DIR"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Add generated voice file" || echo "No changes to commit"
            git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase || echo "No remote changes to pull"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          else
            echo "âŒ Voice generation failed"
            exit 1
          fi
          
          echo "::endgroup::"

  generate-music:
    runs-on: ubuntu-latest
    needs: [setup-branch, script-planning]
    permissions:
      contents: write
    outputs:
      music-generated: ${{ steps.music-generation.outputs.music-generated }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # Claude Code CLIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ä¸è¦ï¼ˆnpxã§ç›´æ¥å®Ÿè¡Œï¼‰
      
      # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
      - name: Check MCP configuration
        run: |
          echo "ğŸ“‹ Checking MCP configuration..."
          if [ -f ".claude/mcp-kamuicode.json" ]; then
            echo "âœ… MCP configuration file found"
            echo "ğŸ“„ Configuration content:"
            cat .claude/mcp-kamuicode.json | jq '.' 2>/dev/null || cat .claude/mcp-kamuicode.json
          else
            echo "âŒ MCP configuration file not found"
          fi
      
      - name: éŸ³æ¥½ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: music-generation
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸµ Music Generation Agent Execution"
          
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          MUSIC_DIR="$FOLDER_NAME/music"
          
          # éŸ³æ¥½ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$MUSIC_DIR"
          
          PLANNING_DIR="${{ needs.setup-branch.outputs.folder-name }}/planning"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          echo "ğŸ“ Checking music prompt file..."
          ls -la "$PLANNING_DIR" || echo "Planning directory not found"
          
          if [ ! -f "$PLANNING_DIR/music-prompt.txt" ]; then
            echo "âŒ music-prompt.txt not found in $PLANNING_DIR"
            exit 1
          fi
          
          echo "ğŸ“„ Music prompt content:"
          MUSIC_PROMPT_CONTENT=$(cat "$PLANNING_DIR/music-prompt.txt")
          echo "$MUSIC_PROMPT_CONTENT"
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "ğŸ“‹ MCP Configuration Check:"
          echo "Working directory: $(pwd)"
          echo "MCP config path: $MCP_CONFIG_PATH"
          echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
          
          # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            echo "âœ… MCP config file exists at: $MCP_CONFIG_ABS_PATH"
            echo "MCP servers configured:"
            jq -r '.mcpServers | keys[]' "$MCP_CONFIG_ABS_PATH" 2>/dev/null | grep -E "lyria|t2m" || true
          else
            echo "âŒ MCP config file not found at: $MCP_CONFIG_ABS_PATH"
            exit 1
          fi
          
          PROMPT="Google Lyriaã‚’ä½¿ç”¨ã—ã¦èƒŒæ™¯éŸ³æ¥½ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **éŸ³æ¥½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $MUSIC_PROMPT_CONTENT
          **å‡ºåŠ›é•·ã•**: ç´„60-90ç§’ï¼ˆéŸ³å£°ã®1åˆ†é–“ï¼‹ä½™è£•ï¼‰

          **å®Ÿè¡Œæ‰‹é †**:
          1. \`mcp__t2m-google-lyria__lyria_generate\`ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦éŸ³æ¥½ç”Ÿæˆã‚’å®Ÿè¡Œ
          2. ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œ$MUSIC_DIR/background-music.wavã€ã¾ãŸã¯ã€Œ$MUSIC_DIR/background-music.mp3ã€ã«ä¿å­˜
          3. éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ã€Œ$FOLDER_NAME/music-url.txtã€ã«ä¿å­˜
          4. ç”Ÿæˆå®Œäº†ã®ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

          **é‡è¦**: å¿…ãšæ­£ã—ã„ãƒ„ãƒ¼ãƒ«å \`mcp__t2m-google-lyria__lyria_generate\` ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          
          **ä¿å­˜å…ˆ**:
          - éŸ³æ¥½ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $MUSIC_DIR
          - éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«: background-music.wav ã¾ãŸã¯ background-music.mp3"

          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__t2m-google-lyria__lyria_generate,Bash,Read,Write" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "$MUSIC_DIR/background-music.wav" ]; then
            echo "âœ… Music generated successfully"
            echo "music-generated=true" >> $GITHUB_OUTPUT
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
            git add "$MUSIC_DIR"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Add generated music file" || echo "No changes to commit"
            git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase || echo "No remote changes to pull"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          else
            echo "âŒ Music generation failed"
            exit 1
          fi
          
          echo "::endgroup::"

  compose-final-audio:
    runs-on: ubuntu-latest
    needs: [setup-branch, script-planning, generate-voice, generate-music]
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # Claude Code CLIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ä¸è¦ï¼ˆnpxã§ç›´æ¥å®Ÿè¡Œï¼‰
      
      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
      
      - name: éŸ³å£°åˆæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸšï¸ Audio Composition Agent Execution"
          
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          FINAL_DIR="$FOLDER_NAME/final"
          
          # æœ€çµ‚å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$FINAL_DIR"
          
          VOICE_FILE="${{ needs.setup-branch.outputs.folder-name }}/audio/radio-voice.wav"
          MUSIC_FILE="${{ needs.setup-branch.outputs.folder-name }}/music/background-music.wav"
          
          PROMPT="FFmpegã‚’ä½¿ç”¨ã—ã¦éŸ³å£°ã¨éŸ³æ¥½ã‚’åˆæˆã—ã€æœ€çµ‚çš„ãªãƒ©ã‚¸ã‚ªéŸ³å£°ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«**: $VOICE_FILE
          **éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«**: $MUSIC_FILE
          **å‡ºåŠ›å…ˆ**: $FINAL_DIR/final-radio-audio.wav

          **åˆæˆè¦ä»¶**:
          1. èƒŒæ™¯éŸ³æ¥½ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’éŸ³å£°ã®60%ã«èª¿æ•´ï¼ˆã‚ˆã‚Šè´ãå–ã‚Šã‚„ã™ã„ãƒãƒ©ãƒ³ã‚¹ï¼‰
          2. éŸ³å£°ã‚’ãƒ¡ã‚¤ãƒ³ã«ã€éŸ³æ¥½ã‚’èƒŒæ™¯ã¨ã—ã¦é…ç½®
          3. ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚’é©ç”¨
          4. éŸ³å£°ã®é•·ã•ã«åˆã‚ã›ã¦éŸ³æ¥½ã‚’ãƒ«ãƒ¼ãƒ—ã¾ãŸã¯ãƒˆãƒªãƒŸãƒ³ã‚°
          5. æœ€çµ‚çš„ãªéŸ³è³ªã¯é«˜å“è³ªã‚’ç¶­æŒ
          6. éŸ³å£°ã¨éŸ³æ¥½ã®ãƒãƒ©ãƒ³ã‚¹ã‚’æœ€é©åŒ–ï¼ˆéŸ³å£°ãŒèã“ãˆã¥ã‚‰ããªã‚‰ãªã„ç¯„å›²ã§éŸ³æ¥½ã‚’å¼·èª¿ï¼‰

          **FFmpegã‚³ãƒãƒ³ãƒ‰ä¾‹**:
          - éŸ³æ¥½ãƒœãƒªãƒ¥ãƒ¼ãƒ èª¿æ•´: -filter:a \"volume=0.6\"
          - éŸ³å£°ã¨éŸ³æ¥½ã®åˆæˆ: -filter_complex \"[1:a]volume=0.6[bg];[0:a][bg]amix=inputs=2:duration=first[out]\"
          - ãƒ•ã‚§ãƒ¼ãƒ‰åŠ¹æœ: afade=in:st=0:d=2,afade=out:st=(duration-2):d=2

          éŸ³å£°ã¨éŸ³æ¥½ã‚’åˆæˆã—ã€é«˜å“è³ªãªãƒ©ã‚¸ã‚ªéŸ³å£°ã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚"

          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "bypassPermissions" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # æœ€çµ‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "$FINAL_DIR/final-radio-audio.wav" ]; then
            echo "âœ… Final radio audio created successfully"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
            echo "ğŸ“Š File information:"
            ls -lh "$FINAL_DIR/final-radio-audio.wav"
            
            # éŸ³å£°æ™‚é–“ã‚’è¡¨ç¤º
            DURATION=$(ffprobe -v quiet -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$FINAL_DIR/final-radio-audio.wav" 2>/dev/null || echo "Unknown")
            echo "â±ï¸ Duration: ${DURATION}s"
          else
            echo "âŒ Final audio composition failed"
            exit 1
          fi
          
          echo "::endgroup::"

      - name: Commit and push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          # æœ€åˆã®30æ–‡å­—ã ã‘ã‚’ä½¿ã£ã¦ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
          COMMIT_MSG="Add generated radio audio: $(echo '${{ inputs.script_content }}' | head -c 30)..."
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
          git push origin ${{ needs.setup-branch.outputs.branch-name }}

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          gh pr create \
            --title "Add new AI-generated radio audio" \
            --body "## ç”Ÿæˆã•ã‚ŒãŸãƒ©ã‚¸ã‚ªéŸ³å£°

          **åŸç¨¿**: ${{ inputs.script_content }}
          **éŸ³æ¥½ã®é›°å›²æ°—**: ${{ inputs.music_mood }}

          ### ğŸ“ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
          \`\`\`
          ${{ needs.setup-branch.outputs.folder-name }}/
          â”œâ”€â”€ planning/
          â”‚   â”œâ”€â”€ radio-script.txt        # ç”Ÿæˆã•ã‚ŒãŸå°æœ¬
          â”‚   â”œâ”€â”€ voice-style.json        # éŸ³å£°ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
          â”‚   â”œâ”€â”€ music-prompt.txt        # éŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          â”‚   â””â”€â”€ radio-strategy.md       # åˆ¶ä½œæˆ¦ç•¥
          â”œâ”€â”€ audio/
          â”‚   â””â”€â”€ radio-voice.wav         # ç”Ÿæˆã•ã‚ŒãŸéŸ³å£°
          â”œâ”€â”€ music/
          â”‚   â””â”€â”€ background-music.wav    # ç”Ÿæˆã•ã‚ŒãŸéŸ³æ¥½
          â””â”€â”€ final/
              â””â”€â”€ final-radio-audio.wav   # æœ€çµ‚åˆæˆéŸ³å£°
          \`\`\`

          ğŸ¤– Generated with [Claude Code](https://claude.ai/code) & [kamuicode MCP](https://www.kamui.ai/ja)

          Co-Authored-By: Claude <noreply@anthropic.com>" \
            --head ${{ needs.setup-branch.outputs.branch-name }} \
            --base main