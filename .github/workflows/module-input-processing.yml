name: Input Processing with Gemini CLI
on:
  workflow_call:
    inputs:
      development-report:
        required: true
        type: string
      topic-focus:
        required: false
        type: string
    outputs:
      processed-summary:
        value: ${{ jobs.process.outputs.summary }}
      structured-content:
        value: ${{ jobs.process.outputs.content }}
      metadata:
        value: ${{ jobs.process.outputs.metadata }}

jobs:
  process:
    runs-on: ubuntu-latest
    outputs:
      summary: ${{ steps.gemini.outputs.summary }}
      content: ${{ steps.gemini.outputs.structured-content }}
      metadata: ${{ steps.gemini.outputs.metadata }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Gemini CLI
        run: |
          echo "ğŸ“¦ Gemini CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
          npm install -g @google-ai/generativelanguage-cli
      
      - name: Process large input with Gemini CLI
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API }}
        run: |
          echo "::group::ğŸ§  å¤§å®¹é‡å…¥åŠ›å‡¦ç†é–‹å§‹ with Gemini"
          echo "é–‹å§‹æ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # å…¥åŠ›ã‚µã‚¤ã‚ºã®ç¢ºèª
          INPUT_LENGTH=$(echo "${{ inputs.development-report }}" | wc -c)
          echo "ğŸ“ å…¥åŠ›æ–‡å­—æ•°: $INPUT_LENGTH æ–‡å­—"
          
          # Gemini API ã‚­ãƒ¼ã®ç¢ºèª
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "::error::GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… Gemini API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          DEVELOPMENT_REPORT="${{ inputs.development-report }}"
          TOPIC_FOCUS="${{ inputs.topic-focus }}"
          
          cat << 'PROMPT_EOF' > input-processing-prompt.txt
ã‚ãªãŸã¯æ—¥æœ¬ã®ãƒ©ã‚¸ã‚ªç•ªçµ„ã®æ§‹æˆä½œå®¶ã§ã™ã€‚ä»¥ä¸‹ã®å¤§å®¹é‡ã®é–‹ç™ºé€²æ—ãƒ¬ãƒãƒ¼ãƒˆã‚’åˆ†æã—ã€4åˆ†é–“ã®ãƒ©ã‚¸ã‚ªç•ªçµ„ã«é©ã—ãŸå†…å®¹ã«æ§‹é€ åŒ–ã—ã¦ãã ã•ã„ã€‚

ã€å…¥åŠ›æƒ…å ±ã€‘
é–‹ç™ºé€²æ—: ${DEVELOPMENT_REPORT}
å¼·èª¿ãƒã‚¤ãƒ³ãƒˆ: ${TOPIC_FOCUS}

ã€å‡ºåŠ›è¦ä»¶ã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

```json
{
  "summary": "å…¨ä½“ã®è¦ç´„ï¼ˆ200æ–‡å­—ä»¥å†…ï¼‰",
  "main_highlights": [
    "é‡è¦ãªé€²æ—1ï¼ˆ50æ–‡å­—ä»¥å†…ï¼‰",
    "é‡è¦ãªé€²æ—2ï¼ˆ50æ–‡å­—ä»¥å†…ï¼‰", 
    "é‡è¦ãªé€²æ—3ï¼ˆ50æ–‡å­—ä»¥å†…ï¼‰"
  ],
  "technical_focus": "æŠ€è¡“çš„ãªãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆ100æ–‡å­—ä»¥å†…ï¼‰",
  "user_impact": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ï¼ˆ100æ–‡å­—ä»¥å†…ï¼‰",
  "next_preview": "æ¬¡å›äºˆå‘Šã§ãã‚‹å†…å®¹ï¼ˆ80æ–‡å­—ä»¥å†…ï¼‰",
  "radio_hooks": [
    "ãƒªã‚¹ãƒŠãƒ¼ã®é–¢å¿ƒã‚’å¼•ãè¦ç´ 1",
    "ãƒªã‚¹ãƒŠãƒ¼ã®é–¢å¿ƒã‚’å¼•ãè¦ç´ 2"
  ],
  "tone": "bright|serious|exciting|informative",
  "estimated_talk_time": "ç§’æ•°ï¼ˆæ•°å­—ã®ã¿ï¼‰"
}
```

ã€é‡è¦ãªæŒ‡ç¤ºã€‘
1. ãƒ©ã‚¸ã‚ªãƒªã‚¹ãƒŠãƒ¼ãŒç†è§£ã—ã‚„ã™ã„å¹³æ˜“ãªæ—¥æœ¬èªã‚’ä½¿ç”¨
2. æŠ€è¡“çš„ã™ãã‚‹å†…å®¹ã¯ä¸€èˆ¬å‘ã‘ã«ç¿»è¨³
3. 4åˆ†é–“ã®ç•ªçµ„ã«åã¾ã‚‹æƒ…å ±é‡ã«èª¿æ•´
4. èãæ‰‹ã®èˆˆå‘³ã‚’å¼•ãã€Œãƒ•ãƒƒã‚¯ã€ã‚’å¿…ãšå«ã‚ã‚‹
5. JSONå½¢å¼ä»¥å¤–ã¯å‡ºåŠ›ã—ãªã„

å‡¦ç†ã—ã¦ãã ã•ã„ã€‚
PROMPT_EOF
          
          # å¤‰æ•°ã‚’ç½®æ›ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
          sed -i "s|\${DEVELOPMENT_REPORT}|$DEVELOPMENT_REPORT|g" input-processing-prompt.txt
          sed -i "s|\${TOPIC_FOCUS}|${TOPIC_FOCUS:-ãªã—}|g" input-processing-prompt.txt

          echo "ğŸš€ Gemini CLI ã§å¤§å®¹é‡å…¥åŠ›ã‚’å‡¦ç†ä¸­..."
          echo "ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé•·: $(cat input-processing-prompt.txt | wc -c) æ–‡å­—"
          
          # Gemini API ãƒªãƒˆãƒ©ã‚¤ãƒ«ãƒ¼ãƒ— (æœ€å¤§3å›)
          SUCCESS=false
          for RETRY_COUNT in {1..3}; do
            echo "ğŸ”„ Gemini API å‘¼ã³å‡ºã—è©¦è¡Œ $RETRY_COUNT/3"
            
            # Gemini CLIå®Ÿè¡Œ
            GEMINI_RESULT=$(curl -s -X POST \
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=$GEMINI_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"contents\": [{
                  \"parts\": [{
                    \"text\": \"$(cat input-processing-prompt.txt | sed 's/"/\\"/g' | tr -d '\n')\"
                  }]
                }],
                \"generationConfig\": {
                  \"temperature\": 0.7,
                  \"maxOutputTokens\": 2048
                }
              }" 2>&1)
            
            # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if [ $? -eq 0 ] && [ -n "$GEMINI_RESULT" ]; then
              # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
              PROCESSED_CONTENT=$(echo "$GEMINI_RESULT" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null || echo "")
              
              if [ -n "$PROCESSED_CONTENT" ] && [ "$PROCESSED_CONTENT" != "null" ]; then
                echo "âœ… Gemini API æˆåŠŸ (è©¦è¡Œ $RETRY_COUNT/3)"
                SUCCESS=true
                break
              else
                echo "::warning::âš ï¸ Gemini API ã‹ã‚‰ç©ºã®å¿œç­” (è©¦è¡Œ $RETRY_COUNT/3)"
              fi
            else
              echo "::warning::âš ï¸ Gemini API å‘¼ã³å‡ºã—å¤±æ•— (è©¦è¡Œ $RETRY_COUNT/3)"
              echo "ã‚¨ãƒ©ãƒ¼è©³ç´°: $GEMINI_RESULT" | head -20
            fi
            
            # ãƒªãƒˆãƒ©ã‚¤å‰ã®å¾…æ©Ÿ
            if [ $RETRY_COUNT -lt 3 ]; then
              echo "â³ 10ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™..."
              sleep 10
            fi
          done
          
          # æœ€çµ‚çš„ãªæˆåŠŸãƒã‚§ãƒƒã‚¯
          if [ "$SUCCESS" != "true" ]; then
            echo "::error::âŒ Gemini API ãŒ3å›ã®è©¦è¡Œå¾Œã‚‚å¤±æ•—ã—ã¾ã—ãŸ"
            echo "::error::æœ€å¾Œã®ã‚¨ãƒ©ãƒ¼è©³ç´°:"
            echo "$GEMINI_RESULT" | head -50
            exit 1
          fi
          
          echo "ğŸ¯ Gemini å‡¦ç†çµæœï¼ˆæœ€åˆã®1000æ–‡å­—ï¼‰:"
          echo "$PROCESSED_CONTENT" | head -c 1000
          echo ""
          
          echo "âœ… æ§‹é€ åŒ–ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—"
          echo "ğŸ“„ å‡¦ç†çµæœã®é•·ã•: $(echo "$PROCESSED_CONTENT" | wc -c) æ–‡å­—"
          
          # JSONã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
          if echo "$PROCESSED_CONTENT" | jq . > /dev/null 2>&1; then
            echo "âœ… æœ‰åŠ¹ãªJSONå½¢å¼ã‚’ç¢ºèª"
            
            # å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŠ½å‡º
            SUMMARY=$(echo "$PROCESSED_CONTENT" | jq -r '.summary // "è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—"')
            MAIN_HIGHLIGHTS=$(echo "$PROCESSED_CONTENT" | jq -r '.main_highlights // []' | jq -c .)
            TECHNICAL_FOCUS=$(echo "$PROCESSED_CONTENT" | jq -r '.technical_focus // "æŠ€è¡“æƒ…å ±ãªã—"')
            USER_IMPACT=$(echo "$PROCESSED_CONTENT" | jq -r '.user_impact // "å½±éŸ¿æƒ…å ±ãªã—"')
            NEXT_PREVIEW=$(echo "$PROCESSED_CONTENT" | jq -r '.next_preview // "æ¬¡å›äºˆå‘Šãªã—"')
            RADIO_HOOKS=$(echo "$PROCESSED_CONTENT" | jq -r '.radio_hooks // []' | jq -c .)
            TONE=$(echo "$PROCESSED_CONTENT" | jq -r '.tone // "informative"')
            TALK_TIME=$(echo "$PROCESSED_CONTENT" | jq -r '.estimated_talk_time // "60"')
            
            echo "ğŸ“Š æŠ½å‡ºã—ãŸæƒ…å ±:"
            echo "  è¦ç´„: $SUMMARY"
            echo "  ãƒˆãƒ¼ãƒ³: $TONE"
            echo "  æ¨å®šæ™‚é–“: ${TALK_TIME}ç§’"
            
          else
            echo "::error::âŒ Gemini APIã‹ã‚‰æœ‰åŠ¹ãªJSONå½¢å¼ã®å¿œç­”ã‚’å—ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            echo "::error::å¿œç­”å†…å®¹ã®å…ˆé ­500æ–‡å­—:"
            echo "$PROCESSED_CONTENT" | head -c 500
            exit 1
          fi
          
          # çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          cat << EOF > processed-input.json
{
  "summary": "$SUMMARY",
  "main_highlights": $MAIN_HIGHLIGHTS,
  "technical_focus": "$TECHNICAL_FOCUS", 
  "user_impact": "$USER_IMPACT",
  "next_preview": "$NEXT_PREVIEW",
  "radio_hooks": $RADIO_HOOKS,
  "tone": "$TONE",
  "estimated_talk_time": "$TALK_TIME",
  "processing_info": {
    "original_length": $INPUT_LENGTH,
    "processed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "processing_model": "gemini-2.0-flash-exp"
  }
}
EOF
          
          # å°æœ¬ç”Ÿæˆç”¨ã®çµ±åˆã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
          RADIO_SUMMARY="ã€è¦ç´„ã€‘$SUMMARY

ã€ä¸»è¦é€²æ—ã€‘
$(echo "$MAIN_HIGHLIGHTS" | jq -r '.[]' | sed 's/^/- /')

ã€æŠ€è¡“ãƒã‚¤ãƒ©ã‚¤ãƒˆã€‘$TECHNICAL_FOCUS

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ã€‘$USER_IMPACT

ã€æ¬¡å›äºˆå‘Šã€‘$NEXT_PREVIEW

ã€æ¨å¥¨ãƒˆãƒ¼ãƒ³ã€‘$TONEï¼ˆæ¨å®š${TALK_TIME}ç§’ï¼‰"
          
          # GitHub Outputsã«è¨­å®š
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$RADIO_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "structured-content<<EOF" >> $GITHUB_OUTPUT
          cat processed-input.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "metadata={\"original_length\": $INPUT_LENGTH, \"processed_length\": $(echo \"$RADIO_SUMMARY\" | wc -c), \"model\": \"gemini-2.0-flash-exp\"}" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"
          echo "âœ… å…¥åŠ›å‡¦ç†å®Œäº†ï¼"
      
      - name: Upload processed content artifact
        uses: actions/upload-artifact@v4
        with:
          name: processed-input
          path: |
            processed-input.json
            input-processing-prompt.txt
          retention-days: 7