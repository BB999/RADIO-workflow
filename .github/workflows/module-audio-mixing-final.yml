name: Audio Mixing Module - Final
on:
  workflow_call:
    inputs:
      opening-audio:
        required: true
        type: string
      main-audio:
        required: true
        type: string
      main2-audio:
        required: true
        type: string
      main3-audio:
        required: true
        type: string
      ending-audio:
        required: true
        type: string
    outputs:
      final-audio:
        value: ${{ jobs.mix-final.outputs.url }}
      metadata:
        value: ${{ jobs.mix-final.outputs.metadata }}

jobs:
  mix-final:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.mixing.outputs.final-file }}
      metadata: ${{ steps.mixing.outputs.metadata }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download opening mixed audio artifact
        uses: actions/download-artifact@v4
        with:
          name: opening-mixed-audio
          path: artifacts/opening-mixed-audio
      
      - name: Download main mixed audio artifact
        uses: actions/download-artifact@v4
        with:
          name: main-mixed-audio
          path: artifacts/main-mixed-audio
      
      - name: Download main2 mixed audio artifact
        uses: actions/download-artifact@v4
        with:
          name: main2-mixed-audio
          path: artifacts/main2-mixed-audio
      
      - name: Download main3 mixed audio artifact
        uses: actions/download-artifact@v4
        with:
          name: main3-mixed-audio
          path: artifacts/main3-mixed-audio
      
      - name: Download ending mixed audio artifact
        uses: actions/download-artifact@v4
        with:
          name: ending-mixed-audio
          path: artifacts/ending-mixed-audio
      
      - name: Download voice-uuid artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-uuid
          path: artifacts/voice-uuid
      
      - name: List downloaded artifacts
        run: |
          echo "::group::ðŸ“ æœ€çµ‚çµ±åˆç”¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ"
          echo "=== artifacts/ ==="
          ls -la artifacts/ || echo "artifactsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo ""
          echo "=== å„ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®å†…å®¹ ==="
          for dir in artifacts/*/; do
            if [ -d "$dir" ]; then
              echo "--- $dir ---"
              ls -la "$dir" || echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã§ã™"
              echo ""
            fi
          done
          echo "::endgroup::"
      
      - name: Install FFmpeg
        run: |
          # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨3å›žãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãFFmpegã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          install_ffmpeg() {
            local attempt=1
            local max_attempts=3
            
            while [ $attempt -le $max_attempts ]; do
              echo "ðŸ“¦ FFmpegã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è©¦è¡Œ $attempt/$max_attempts"
              
              # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãapt-get updateå®Ÿè¡Œï¼ˆ5åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
              if timeout 300 sudo apt-get update; then
                echo "âœ… apt-get update æˆåŠŸ"
                if sudo apt-get install -y ffmpeg; then
                  echo "âœ… FFmpegã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æˆåŠŸ"
                  return 0
                else
                  echo "::warning::FFmpegã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ï¼ˆè©¦è¡Œ $attempt/$max_attemptsï¼‰"
                fi
              else
                echo "::warning::apt-get update ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯å¤±æ•—ï¼ˆè©¦è¡Œ $attempt/$max_attemptsï¼‰"
                
                # Microsoft ãƒªãƒã‚¸ãƒˆãƒªãŒåŽŸå› ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã—ã¦å†è©¦è¡Œ
                if [ $attempt -eq 2 ]; then
                  echo "ðŸ”§ å•é¡Œã®ã‚ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒªãƒˆãƒ©ã‚¤"
                  sudo rm -f /etc/apt/sources.list.d/microsoft* || true
                  sudo rm -f /etc/apt/sources.list.d/azure* || true
                fi
              fi
              
              attempt=$((attempt + 1))
              if [ $attempt -le $max_attempts ]; then
                echo "â³ 10ç§’å¾…æ©Ÿã—ã¦ãƒªãƒˆãƒ©ã‚¤..."
                sleep 10
              fi
            done
            
            echo "::error::âŒ FFmpegã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ$max_attempts å›žè©¦è¡Œï¼‰"
            return 1
          }
          
          install_ffmpeg
      
      - name: Combine all sections into final audio
        id: mixing
        run: |
          # 5ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ™‚ç³»åˆ—ã§çµåˆã—ã€æœ€çµ‚èª¿æ•´
          
          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãFFmpegå®Ÿè¡Œ
          safe_ffmpeg() {
            local TEMP_LOG="ffmpeg_$(date +%s).log"
            if ! ffmpeg "$@" 2>"$TEMP_LOG"; then
              echo "::error::FFmpegå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: $*"
              echo "::error::FFmpegã‚¨ãƒ©ãƒ¼å‡ºåŠ›:"
              cat "$TEMP_LOG" | head -20
              rm -f "$TEMP_LOG"
              return 1
            fi
            rm -f "$TEMP_LOG"
            return 0
          }
          
          # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          echo "ðŸ“‚ ãƒŸãƒƒã‚¯ã‚¹æ¸ˆã¿éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼"
          
          if [ -f "artifacts/opening-mixed-audio/${{ inputs.opening-audio }}" ]; then
            cp "artifacts/opening-mixed-audio/${{ inputs.opening-audio }}" opening-final.wav
            echo "âœ… opening-final.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::error::ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/opening-mixed-audio/${{ inputs.opening-audio }}"
            exit 1
          fi
          
          if [ -f "artifacts/main-mixed-audio/${{ inputs.main-audio }}" ]; then
            cp "artifacts/main-mixed-audio/${{ inputs.main-audio }}" main-final.wav
            echo "âœ… main-final.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::error::ãƒ¡ã‚¤ãƒ³éŸ³å£°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/main-mixed-audio/${{ inputs.main-audio }}"
            exit 1
          fi
          
          if [ -f "artifacts/main2-mixed-audio/${{ inputs.main2-audio }}" ]; then
            cp "artifacts/main2-mixed-audio/${{ inputs.main2-audio }}" main2-final.wav
            echo "âœ… main2-final.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::error::ãƒ¡ã‚¤ãƒ³2éŸ³å£°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/main2-mixed-audio/${{ inputs.main2-audio }}"
            exit 1
          fi
          
          if [ -f "artifacts/main3-mixed-audio/${{ inputs.main3-audio }}" ]; then
            cp "artifacts/main3-mixed-audio/${{ inputs.main3-audio }}" main3-final.wav
            echo "âœ… main3-final.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::error::ãƒ¡ã‚¤ãƒ³3éŸ³å£°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/main3-mixed-audio/${{ inputs.main3-audio }}"
            exit 1
          fi
          
          if [ -f "artifacts/ending-mixed-audio/${{ inputs.ending-audio }}" ]; then
            cp "artifacts/ending-mixed-audio/${{ inputs.ending-audio }}" ending-final.wav
            echo "âœ… ending-final.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::error::ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°éŸ³å£°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/ending-mixed-audio/${{ inputs.ending-audio }}"
            exit 1
          fi
          
          # ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ç”¨ã®ç„¡éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆ1ã€œ2ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
          echo "ðŸ”‡ ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ç„¡éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ"
          
          # 1ã¤ç›®ã®ç„¡éŸ³åŒºé–“ï¼ˆ1ã€œ2ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
          SILENCE_1=$(awk "BEGIN {srand(); print 1 + rand()}")
          echo "  1ã¤ç›®ã®ç„¡éŸ³: ${SILENCE_1}ç§’"
          safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t $SILENCE_1 -ar 44100 -ac 2 -c:a pcm_s16le section-break-1.wav || exit 1
          
          # 2ã¤ç›®ã®ç„¡éŸ³åŒºé–“ï¼ˆ1ã€œ2ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
          SILENCE_2=$(awk "BEGIN {srand(); print 1 + rand()}")
          echo "  2ã¤ç›®ã®ç„¡éŸ³: ${SILENCE_2}ç§’"
          safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t $SILENCE_2 -ar 44100 -ac 2 -c:a pcm_s16le section-break-2.wav || exit 1
          
          # 3ã¤ç›®ã®ç„¡éŸ³åŒºé–“ï¼ˆ1ã€œ2ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
          SILENCE_3=$(awk "BEGIN {srand(); print 1 + rand()}")
          echo "  3ã¤ç›®ã®ç„¡éŸ³: ${SILENCE_3}ç§’"
          safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t $SILENCE_3 -ar 44100 -ac 2 -c:a pcm_s16le section-break-3.wav || exit 1
          
          # 4ã¤ç›®ã®ç„¡éŸ³åŒºé–“ï¼ˆ1ã€œ2ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
          SILENCE_4=$(awk "BEGIN {srand(); print 1 + rand()}")
          echo "  4ã¤ç›®ã®ç„¡éŸ³: ${SILENCE_4}ç§’"
          safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t $SILENCE_4 -ar 44100 -ac 2 -c:a pcm_s16le section-break-4.wav || exit 1
          
          # 5ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç„¡éŸ³åŒºé–“ä»˜ãã§é€£çµã—ã€æœ€çµ‚èª¿æ•´
          echo "ðŸŽµ æœ€çµ‚ãƒŸãƒƒã‚¯ã‚¹é–‹å§‹ï¼ˆ5ã‚»ã‚¯ã‚·ãƒ§ãƒ³ + ãƒ©ãƒ³ãƒ€ãƒ ç„¡éŸ³åŒºé–“çµåˆï¼‰"
          echo "ðŸ“ é€£çµã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la opening-final.wav section-break-1.wav main-final.wav section-break-2.wav main2-final.wav section-break-3.wav main3-final.wav section-break-4.wav ending-final.wav
          
          # 5ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ™‚ç³»åˆ—é †ã«é€£çµï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã«ãƒ©ãƒ³ãƒ€ãƒ ç„¡éŸ³ã‚’æŒ¿å…¥ï¼‰ã—ã€æ”¾é€åŸºæº–ã«æ­£è¦åŒ–
          safe_ffmpeg -i opening-final.wav \
                      -i section-break-1.wav \
                      -i main-final.wav \
                      -i section-break-2.wav \
                      -i main2-final.wav \
                      -i section-break-3.wav \
                      -i main3-final.wav \
                      -i section-break-4.wav \
                      -i ending-final.wav \
                      -filter_complex "[0][1][2][3][4][5][6][7][8]concat=n=9:v=0:a=1[combined];
                                      [combined]loudnorm=I=-23:LRA=7:TP=-1[normalized]" \
                      -map "[normalized]" \
                      -c:a mp3 \
                      -b:a 320k \
                      final-radio.mp3 || exit 1
          
          if [ -f "final-radio.mp3" ]; then
            echo "âœ… final-radio.mp3 ç”ŸæˆæˆåŠŸ ($(stat -c%s final-radio.mp3) bytes)"
          else
            echo "::error::âŒ final-radio.mp3 ã®ç”Ÿæˆã«å¤±æ•—"
            exit 1
          fi
          
          # é¸æŠžã•ã‚ŒãŸéŸ³æ¥½æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«å«ã‚ã‚‹
          SELECTED_MUSIC_INFO="unknown"
          if [ -f "artifacts/voice-uuid/USE_UUID.md" ]; then
            SELECTED_MUSIC_INFO=$(grep "Selected Music File:" artifacts/voice-uuid/USE_UUID.md | cut -d' ' -f4- || echo "unknown")
          fi
          
          # æœ€çµ‚éŸ³å£°ã®é•·ã•ã‚’å–å¾—
          FINAL_DURATION=$(ffprobe -v quiet -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "final-radio.mp3" 2>/dev/null || echo "unknown")
          
          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
          echo "{
            \"duration\": \"${FINAL_DURATION}s\",
            \"selected_music\": \"$SELECTED_MUSIC_INFO\",
            \"sections\": [
              {\"name\": \"opening\", \"description\": \"éŸ³å£°+BGM+é¸æŠžæ¥½æ›²ï¼ˆã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ï¼‰\", \"bgm\": \"upbeat\", \"bgm_volume\": \"100%â†’50%â†’0\", \"intro\": \"6s\", \"crossfade\": \"æ¥½æ›²ã¨ã®5ç§’ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰\"},
              {\"name\": \"main\", \"description\": \"éŸ³å£°+BGMï¼ˆæ˜¼ã®ç¥žå¨æ—¥å ±ï¼‰\", \"bgm\": \"talk-friendly\", \"bgm_volume\": \"100%â†’50%\", \"intro\": \"4s\", \"fade_out\": \"5s\"},
              {\"name\": \"main2\", \"description\": \"éŸ³å£°+BGMï¼ˆãƒ†ãƒƒã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼‰\", \"bgm\": \"tech-digital\", \"bgm_volume\": \"100%â†’50%\", \"intro\": \"4s\", \"fade_out\": \"5s\"},
              {\"name\": \"main3\", \"description\": \"éŸ³å£°+BGMï¼ˆå¤œã®ç¥žå¨æ—¥å ±ï¼‰\", \"bgm\": \"night-chill\", \"bgm_volume\": \"100%â†’50%\", \"intro\": \"4s\", \"fade_out\": \"5s\"},
              {\"name\": \"ending\", \"description\": \"éŸ³å£°+BGM\", \"bgm\": \"warm-outro\", \"bgm_volume\": \"100%â†’50%â†’100%\", \"intro\": \"4s\", \"fade_out\": \"7s\"}
            ],
            \"processing\": {
              \"workflow\": \"åˆ†å‰²å‡¦ç†å¾Œçµ±åˆ\",
              \"opening_job\": \"audio-mixing-opening\",
              \"main_job\": \"audio-mixing-main\",
              \"main2_job\": \"audio-mixing-main2\",
              \"main3_job\": \"audio-mixing-main3\",
              \"ending_job\": \"audio-mixing-ending\",
              \"final_job\": \"audio-mixing-final\"
            },
            \"audio_standard\": \"-23 LUFS\",
            \"format\": \"MP3 320kbps\"
          }" > metadata.json
          
          echo "final-file=final-radio.mp3" >> $GITHUB_OUTPUT
          echo "metadata=metadata.json" >> $GITHUB_OUTPUT
      
      - name: Upload final audio artifact
        uses: actions/upload-artifact@v4
        with:
          name: final-audio
          path: |
            final-radio.mp3
            metadata.json
          retention-days: 7