name: BGM Generation Jingle
on:
  workflow_call:
    outputs:
      bgm-url:
        value: ${{ jobs.generate.outputs.url }}
      bgm-file:
        value: ${{ jobs.generate.outputs.file }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.bgm.outputs.music-url }}
      file: ${{ steps.bgm.outputs.music-file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Select and process random jingle BGM
        id: bgm
        run: |
          echo "::group::ðŸŽµ ã‚¸ãƒ³ã‚°ãƒ«BGMé¸æŠžãƒ»éŸ³é‡èª¿æ•´"
          echo "ðŸš€ é–‹å§‹æ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # Jingle SEãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«mp3ã‚’é¸æŠž
          JINGLE_DIR="radio-workflow/Jingle SE"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
          if [ ! -d "$JINGLE_DIR" ]; then
            echo "::error::âŒ ã‚¸ãƒ³ã‚°ãƒ«SEãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $JINGLE_DIR"
            exit 1
          fi
          
          # MP3ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—ã¨ãƒ•ã‚¡ã‚¤ãƒ«æ•°ç¢ºèª
          echo "ðŸ” ã‚¸ãƒ³ã‚°ãƒ«SEãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          ls -la "$JINGLE_DIR"/*.mp3 2>/dev/null || {
            echo "::error::âŒ ã‚¸ãƒ³ã‚°ãƒ«SEãƒ•ã‚©ãƒ«ãƒ€ã«MP3ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          }
          
          JINGLE_FILES=("$JINGLE_DIR"/*.mp3)
          FILE_COUNT=${#JINGLE_FILES[@]}
          
          echo "ðŸ“ ã‚¸ãƒ³ã‚°ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
          for i in "${!JINGLE_FILES[@]}"; do
            echo "  [$i] $(basename "${JINGLE_FILES[$i]}")"
          done
          
          if [ $FILE_COUNT -eq 0 ]; then
            echo "::error::âŒ ã‚¸ãƒ³ã‚°ãƒ«SEãƒ•ã‚©ãƒ«ãƒ€ã«MP3ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # ã‚ˆã‚Šç¢ºå®Ÿãªãƒ©ãƒ³ãƒ€ãƒ é¸æŠžï¼ˆè¤‡æ•°ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ï¼‰
          CURRENT_TIME=$(date +%s)
          NANOSEC=$(date +%N)
          WORKFLOW_RUN_ID="${{ github.run_id }}"
          
          # è¤‡æ•°ã®å€¤ã‚’çµ„ã¿åˆã‚ã›ã¦ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’å‘ä¸Š
          RANDOM_SEED=$((CURRENT_TIME + NANOSEC + WORKFLOW_RUN_ID))
          RANDOM_INDEX=$((RANDOM_SEED % FILE_COUNT))
          
          # ã•ã‚‰ã«shufã‚’ä½¿ã£ã¦ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’å‘ä¸Š
          if command -v shuf >/dev/null 2>&1; then
            SELECTED_FILE=$(printf '%s\n' "${JINGLE_FILES[@]}" | shuf -n 1)
            echo "ðŸŽ² shufã‚³ãƒžãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ é¸æŠž"
          else
            SELECTED_FILE="${JINGLE_FILES[$RANDOM_INDEX]}"
            echo "ðŸŽ² è¨ˆç®—ãƒ™ãƒ¼ã‚¹ãƒ©ãƒ³ãƒ€ãƒ é¸æŠž"
          fi
          
          SELECTED_JINGLE="$SELECTED_FILE"
          
          echo "ðŸŽ¯ é¸æŠžã•ã‚ŒãŸã‚¸ãƒ³ã‚°ãƒ«BGM: $(basename "$SELECTED_JINGLE")"
          echo "ðŸ“Š åˆ©ç”¨å¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $FILE_COUNT"
          echo "ðŸŽ² ã‚·ãƒ¼ãƒ‰å€¤: $RANDOM_SEED, ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: $RANDOM_INDEX"
          echo "â° æ™‚åˆ»: $CURRENT_TIME, ãƒŠãƒŽç§’: $NANOSEC, Run ID: $WORKFLOW_RUN_ID"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
          ls -la "$SELECTED_JINGLE"
          file "$SELECTED_JINGLE"
          
          # éŸ³å£°æƒ…å ±ã‚’å–å¾—
          echo "ðŸ” éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°æƒ…å ±:"
          ffprobe -v quiet -print_format json -show_format -show_streams "$SELECTED_JINGLE" || true
          
          # éŸ³é‡æ­£è¦åŒ–ã¨ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆçµ±ä¸€
          echo "ðŸ”Š éŸ³é‡æ­£è¦åŒ–ãƒ»ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆçµ±ä¸€å‡¦ç†"
          
          # æœ€åˆã«åŸºæœ¬çš„ãªæƒ…å ±ã‚’å–å¾—
          DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 "$SELECTED_JINGLE" 2>/dev/null || echo "unknown")
          echo "â±ï¸ å…ƒãƒ•ã‚¡ã‚¤ãƒ«é•·ã•: ${DURATION}ç§’"
          
          # æ­£è¦åŒ–å‡¦ç†ï¼ˆãƒ©ã‚¦ãƒ‰ãƒã‚¹åŸºæº–-20 LUFSã€BGMç”¨ã«èª¿æ•´ï¼‰
          ffmpeg -i "$SELECTED_JINGLE" \
                 -filter_complex "
                   [0:a]loudnorm=I=-20:LRA=7:TP=-1:linear=true:dual_mono=true[normalized]
                 " \
                 -map "[normalized]" \
                 -ar 44100 -ac 2 -c:a pcm_s16le \
                 bgm-jingle.wav -y
          
          # æ­£è¦åŒ–å¾Œã®ç¢ºèª
          if [ -f bgm-jingle.wav ]; then
            NORMALIZED_SIZE=$(stat -c%s bgm-jingle.wav)
            echo "âœ… æ­£è¦åŒ–å®Œäº†"
            echo "ðŸ“ æ­£è¦åŒ–å¾Œãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${NORMALIZED_SIZE} bytes"
            
            # æ­£è¦åŒ–å¾Œã®éŸ³å£°æƒ…å ±
            NEW_DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 bgm-jingle.wav 2>/dev/null || echo "unknown")
            echo "â±ï¸ æ­£è¦åŒ–å¾Œé•·ã•: ${NEW_DURATION}ç§’"
            
            # WAVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ç¢ºèª
            if file bgm-jingle.wav | grep -q "WAVE"; then
              echo "âœ… WAVå½¢å¼ç¢ºèªæ¸ˆã¿"
            else
              echo "::warning::âš ï¸ WAVå½¢å¼ã§ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
              file bgm-jingle.wav
            fi
            
            # USE_UUID.mdã«é¸æŠžã•ã‚ŒãŸæ¥½æ›²æƒ…å ±ã‚’è¨˜éŒ²
            JINGLE_BASENAME=$(basename "$SELECTED_JINGLE")
            echo "Selected Jingle BGM File: $JINGLE_BASENAME" >> radio-workflow/temp/USE_UUID.md || true
            echo "Original Jingle Path: $SELECTED_JINGLE" >> radio-workflow/temp/USE_UUID.md || true
            
          else
            echo "::error::âŒ BGMæ­£è¦åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
          
          echo "music-url=file://$(pwd)/bgm-jingle.wav" >> $GITHUB_OUTPUT
          echo "music-file=bgm-jingle.wav" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Upload jingle BGM artifact
        uses: actions/upload-artifact@v4
        with:
          name: bgm-jingle
          path: bgm-jingle.wav
          retention-days: 1