name: Audio Mixing Module (Minimal)
on:
  workflow_call:
    inputs:
      voice-opening:
        required: true
        type: string
      voice-main:
        required: true
        type: string
      voice-ending:
        required: true
        type: string
      bgm-opening:
        required: true
        type: string
      bgm-main:
        required: true
        type: string
      bgm-ending:
        required: true
        type: string
    outputs:
      final-audio:
        value: ${{ jobs.mix.outputs.url }}
      metadata:
        value: ${{ jobs.mix.outputs.metadata }}

jobs:
  mix:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.mixing.outputs.final-file }}
      metadata: ${{ steps.mixing.outputs.metadata }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download voice-opening artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-opening
          path: artifacts/voice-opening
      
      - name: Download voice-main artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-main
          path: artifacts/voice-main
      
      - name: Download voice-ending artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-ending
          path: artifacts/voice-ending
      
      - name: Download bgm-opening artifact
        uses: actions/download-artifact@v4
        with:
          name: bgm-opening
          path: artifacts/bgm-opening
      
      - name: Download bgm-main artifact
        uses: actions/download-artifact@v4
        with:
          name: bgm-main
          path: artifacts/bgm-main
      
      - name: Download bgm-ending artifact
        uses: actions/download-artifact@v4
        with:
          name: bgm-ending
          path: artifacts/bgm-ending
      
      - name: Download voice-uuid artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-uuid
          path: artifacts/voice-uuid
      
      - name: List downloaded artifacts
        run: |
          echo "::group::ðŸ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ"
          echo "=== artifacts/ ==="
          ls -la artifacts/ || echo "artifactsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo ""
          echo "=== å„ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®å†…å®¹ ==="
          for dir in artifacts/*/; do
            if [ -d "$dir" ]; then
              echo "--- $dir ---"
              ls -la "$dir" || echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã§ã™"
              echo ""
            fi
          done
          echo "::endgroup::"
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Mix audio files with section-specific BGMs
        id: mixing
        run: |
          # å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§éŸ³å£°ã¨BGMã‚’å€‹åˆ¥ã«ãƒŸãƒƒã‚¯ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‹æ”¹å–„ç‰ˆï¼‰
          
          # éŸ³å£°ã®é•·ã•ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          get_duration() {
            local file="$1"
            if [ ! -f "$file" ]; then
              echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $fileã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤30ç§’ã‚’ä½¿ç”¨"
              echo "30"
              return 0
            fi
            local duration=$(ffprobe -v quiet -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)
            if [ -z "$duration" ] || [ "$duration" = "N/A" ]; then
              echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’å–å¾—ã§ãã¾ã›ã‚“: $fileã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤30ç§’ã‚’ä½¿ç”¨"
              echo "30"
              return 0
            fi
            echo "$duration"
          }
          
          # é¸æŠžã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦ã‚³ãƒ”ãƒ¼
          echo "ðŸŽµ é¸æŠžã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ä¸­..."
          
          # voice-uuidã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰éŸ³æ¥½æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
          if [ -f "artifacts/voice-uuid/USE_UUID.md" ]; then
            echo "âœ… USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            
            # é¸æŠžã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
            SELECTED_MUSIC=$(grep "Selected Music File:" artifacts/voice-uuid/USE_UUID.md | cut -d' ' -f4-)
            
            echo "ðŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
            echo "  é¸æŠžã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«: '$SELECTED_MUSIC'"
            echo "  ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
            echo "  radio-workflowãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª:"
            ls -la radio-workflow/ || echo "radio-workflowãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "  musicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª:"
            ls -la radio-workflow/music/ || echo "musicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "  æœŸå¾…ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: radio-workflow/music/$SELECTED_MUSIC"
            echo "  ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª:"
            ls -la "radio-workflow/music/$SELECTED_MUSIC" || echo "ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            
            if [ -n "$SELECTED_MUSIC" ] && [ -f "radio-workflow/music/$SELECTED_MUSIC" ]; then
              echo "ðŸŽ¯ é¸æŠžã•ã‚ŒãŸéŸ³æ¥½: $SELECTED_MUSIC"
              cp "radio-workflow/music/$SELECTED_MUSIC" selected-music.mp3
              echo "âœ… selected-music.mp3 ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
            else
              echo "::error::é¸æŠžã•ã‚ŒãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $SELECTED_MUSIC"
              echo "::error::éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…ãšå­˜åœ¨ã™ã¹ãã§ã™ã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åœæ­¢ã—ã¾ã™ã€‚"
              exit 1
            fi
          else
            echo "::error::USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "::error::éŸ³æ¥½é¸æŠžæƒ…å ±ãŒå¿…è¦ã§ã™ã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åœæ­¢ã—ã¾ã™ã€‚"
            exit 1
          fi
          
          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãFFmpegå®Ÿè¡Œ
          safe_ffmpeg() {
            local TEMP_LOG="ffmpeg_$(date +%s).log"
            if ! ffmpeg "$@" 2>"$TEMP_LOG"; then
              echo "::error::FFmpegå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: $*"
              echo "::error::FFmpegã‚¨ãƒ©ãƒ¼å‡ºåŠ›:"
              cat "$TEMP_LOG" | head -20
              rm -f "$TEMP_LOG"
              return 1
            fi
            rm -f "$TEMP_LOG"
            return 0
          }
          
          # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆãƒ‘ã‚¹ã‚’æ˜Žç¢ºã«æŒ‡å®šï¼‰
          echo "ðŸ“‚ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼"
          if [ -f "artifacts/voice-opening/${{ inputs.voice-opening }}" ]; then
            cp "artifacts/voice-opening/${{ inputs.voice-opening }}" voice-opening.wav
            echo "âœ… voice-opening.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/voice-opening/${{ inputs.voice-opening }}"
          fi
          
          if [ -f "artifacts/voice-main/${{ inputs.voice-main }}" ]; then
            cp "artifacts/voice-main/${{ inputs.voice-main }}" voice-main.wav
            echo "âœ… voice-main.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/voice-main/${{ inputs.voice-main }}"
          fi
          
          if [ -f "artifacts/voice-ending/${{ inputs.voice-ending }}" ]; then
            cp "artifacts/voice-ending/${{ inputs.voice-ending }}" voice-ending.wav
            echo "âœ… voice-ending.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/voice-ending/${{ inputs.voice-ending }}"
          fi
          
          echo "ðŸ“‚ BGMãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼"
          if [ -f "artifacts/bgm-opening/${{ inputs.bgm-opening }}" ]; then
            cp "artifacts/bgm-opening/${{ inputs.bgm-opening }}" bgm-opening-30s.wav
            echo "âœ… bgm-opening-30s.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::warning::BGMãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/bgm-opening/${{ inputs.bgm-opening }}"
          fi
          
          if [ -f "artifacts/bgm-main/${{ inputs.bgm-main }}" ]; then
            cp "artifacts/bgm-main/${{ inputs.bgm-main }}" bgm-main-30s.wav
            echo "âœ… bgm-main-30s.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::warning::BGMãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/bgm-main/${{ inputs.bgm-main }}"
          fi
          
          if [ -f "artifacts/bgm-ending/${{ inputs.bgm-ending }}" ]; then
            cp "artifacts/bgm-ending/${{ inputs.bgm-ending }}" bgm-ending-30s.wav
            echo "âœ… bgm-ending-30s.wav ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "::warning::BGMãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: artifacts/bgm-ending/${{ inputs.bgm-ending }}"
          fi
          
          # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨ãƒ€ãƒŸãƒ¼ä½œæˆ
          for voice_file in voice-opening.wav voice-main.wav voice-ending.wav; do
            if [ ! -f "$voice_file" ]; then
              echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« $voice_file ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ç„¡éŸ³ã§ä»£æ›¿"
              safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 30 -ar 44100 -ac 2 -c:a pcm_s16le "$voice_file" || exit 1
            fi
          done
          
          # BGMãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨ãƒ€ãƒŸãƒ¼ä½œæˆ
          for bgm_file in bgm-opening-30s.wav bgm-main-30s.wav bgm-ending-30s.wav; do
            if [ ! -f "$bgm_file" ]; then
              echo "::warning::BGMãƒ•ã‚¡ã‚¤ãƒ« $bgm_file ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ç„¡éŸ³ã§ä»£æ›¿"
              safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 30 -ar 44100 -ac 2 -c:a pcm_s16le "$bgm_file" || exit 1
            fi
          done
          
          # å„éŸ³å£°ã®é•·ã•ã‚’å–å¾—ã—ã¦ã€å¿…è¦ãªBGMã®é•·ã•ã‚’è¨ˆç®—
          echo "ðŸ“ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’æ¸¬å®šä¸­..."
          VOICE_OPENING_DURATION=$(get_duration voice-opening.wav)
          VOICE_MAIN_DURATION=$(get_duration voice-main.wav)
          VOICE_ENDING_DURATION=$(get_duration voice-ending.wav)
          
          echo "  ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°: ${VOICE_OPENING_DURATION}ç§’"
          echo "  ãƒ¡ã‚¤ãƒ³éŸ³å£°: ${VOICE_MAIN_DURATION}ç§’"
          echo "  ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°éŸ³å£°: ${VOICE_ENDING_DURATION}ç§’"
          
          # å¿…è¦ãªBGMã®é•·ã•ã‚’è¨ˆç®—ï¼ˆéŸ³å£°ã®é•·ã• + å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å¿…è¦ãªä½™è£•æ™‚é–“ï¼‰
          BGM_OPENING_NEEDED=$(awk "BEGIN {print int($VOICE_OPENING_DURATION + 14)}")  # 6ç§’ã‚¤ãƒ³ãƒˆãƒ­ + éŸ³å£° + 3ç§’ãƒ•ãƒ« + 5ç§’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          BGM_MAIN_NEEDED=$(awk "BEGIN {print int($VOICE_MAIN_DURATION + 9)}")         # 4ç§’ã‚¤ãƒ³ãƒˆãƒ­ + éŸ³å£° + 5ç§’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          BGM_ENDING_NEEDED=$(awk "BEGIN {print int($VOICE_ENDING_DURATION + 11)}")    # 4ç§’ã‚¤ãƒ³ãƒˆãƒ­ + éŸ³å£° + 7ç§’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          
          echo "ðŸŽµ å¿…è¦ãªBGMã®é•·ã•:"
          echo "  ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: ${BGM_OPENING_NEEDED}ç§’"
          echo "  ãƒ¡ã‚¤ãƒ³: ${BGM_MAIN_NEEDED}ç§’"
          echo "  ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: ${BGM_ENDING_NEEDED}ç§’"
          
          # BGMã‚’å¿…è¦ãªé•·ã•ã«ãƒ«ãƒ¼ãƒ—æ‹¡å¼µï¼ˆã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ä»˜ãï¼‰
          if [ $BGM_OPENING_NEEDED -gt 30 ]; then
            echo "ðŸ”„ ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°BGMã‚’${BGM_OPENING_NEEDED}ç§’ã«æ‹¡å¼µï¼ˆã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ä»˜ãï¼‰"
            # æœ€å¾Œã®1ç§’ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã€æœ€åˆã®1ç§’ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã—ã¦ãƒ«ãƒ¼ãƒ—
            safe_ffmpeg -i bgm-opening-30s.wav -filter_complex \
              "[0:a]afade=t=out:st=29:d=1,afade=t=in:st=0:d=1,aloop=loop=-1:size=44100*30,atrim=0:$BGM_OPENING_NEEDED[looped]" \
              -map "[looped]" -ar 44100 -ac 2 -c:a pcm_s16le bgm-opening-extended.wav -y || exit 1
            mv bgm-opening-extended.wav bgm-opening-30s.wav
          fi
          
          if [ $BGM_MAIN_NEEDED -gt 30 ]; then
            echo "ðŸ”„ ãƒ¡ã‚¤ãƒ³BGMã‚’${BGM_MAIN_NEEDED}ç§’ã«æ‹¡å¼µï¼ˆã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ä»˜ãï¼‰"
            # æœ€å¾Œã®1ç§’ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã€æœ€åˆã®1ç§’ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã—ã¦ãƒ«ãƒ¼ãƒ—
            safe_ffmpeg -i bgm-main-30s.wav -filter_complex \
              "[0:a]afade=t=out:st=29:d=1,afade=t=in:st=0:d=1,aloop=loop=-1:size=44100*30,atrim=0:$BGM_MAIN_NEEDED[looped]" \
              -map "[looped]" -ar 44100 -ac 2 -c:a pcm_s16le bgm-main-extended.wav -y || exit 1
            mv bgm-main-extended.wav bgm-main-30s.wav
          fi
          
          if [ $BGM_ENDING_NEEDED -gt 30 ]; then
            echo "ðŸ”„ ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°BGMã‚’${BGM_ENDING_NEEDED}ç§’ã«æ‹¡å¼µï¼ˆã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ä»˜ãï¼‰"
            # æœ€å¾Œã®1ç§’ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã€æœ€åˆã®1ç§’ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã—ã¦ãƒ«ãƒ¼ãƒ—
            safe_ffmpeg -i bgm-ending-30s.wav -filter_complex \
              "[0:a]afade=t=out:st=29:d=1,afade=t=in:st=0:d=1,aloop=loop=-1:size=44100*30,atrim=0:$BGM_ENDING_NEEDED[looped]" \
              -map "[looped]" -ar 44100 -ac 2 -c:a pcm_s16le bgm-ending-extended.wav -y || exit 1
            mv bgm-ending-extended.wav bgm-ending-30s.wav
          fi
          
          # ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³: BGM6ç§’â†’éŸ³å£°+BGMâ†’éŸ³å£°çµ‚äº†å¾Œ5ç§’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          echo "ðŸŽµ ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä½œæˆï¼ˆæ¥½æ›²ã¯åˆ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰"
          
          # ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨ˆç®—ï¼ˆæ¥½æ›²ãªã—ç‰ˆï¼‰
          VOICE_START=6  # ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°é–‹å§‹
          VOICE_END=$(awk "BEGIN {print $VOICE_OPENING_DURATION + 6}")  # ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°çµ‚äº†
          FADE_START_OPENING=$(awk "BEGIN {print $VOICE_END}")  # éŸ³å£°çµ‚äº†æ™‚ã‹ã‚‰BGMãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹
          TOTAL_OPENING_DURATION=$(awk "BEGIN {print $VOICE_OPENING_DURATION + 9}")  # 6ç§’ã‚¤ãƒ³ãƒˆãƒ­ + éŸ³å£° + 3ç§’BGMãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          
          echo "  éŸ³å£°é–‹å§‹: ${VOICE_START}ç§’"
          echo "  éŸ³å£°çµ‚äº†: ${VOICE_END}ç§’" 
          echo "  ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹: ${FADE_START_OPENING}ç§’"
          echo "  ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ç·æ™‚é–“: ${TOTAL_OPENING_DURATION}ç§’"
          
          # ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³: éŸ³å£°+BGMã®ã¿
          safe_ffmpeg -i voice-opening.wav \
                      -i bgm-opening-30s.wav \
                      -filter_complex "[0]aresample=44100,adelay=${VOICE_START}s:all=1[voice_delayed];
                                      [1]aresample=44100,volume='if(lt(t,6),1,if(lt(t,6.5),1-0.5*(t-6)/0.5,0.5))':eval=frame,
                                      afade=t=out:st=${FADE_START_OPENING}:d=3[bgm_opening];
                                      [voice_delayed][bgm_opening]amix=inputs=2[opening]" \
                      -map "[opening]" \
                      -t ${TOTAL_OPENING_DURATION} \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      opening-mixed.wav || exit 1
          
          if [ -f "opening-mixed.wav" ]; then
            echo "âœ… opening-mixed.wav ç”ŸæˆæˆåŠŸ ($(stat -c%s opening-mixed.wav) bytes)"
          else
            echo "::error::âŒ opening-mixed.wav ã®ç”Ÿæˆã«å¤±æ•—"
            exit 1
          fi
          
          # ãƒ¡ã‚¤ãƒ³: BGM4ç§’ã‚¤ãƒ³ãƒˆãƒ­ï¼ˆæœ€å¤§éŸ³é‡ï¼‰â†’éŸ³å£°é–‹å§‹æ™‚50%â†’éŸ³å£°çµ‚äº†å¾ŒBGMãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆ5ç§’ï¼‰
          VOICE_MAIN_END_WITH_DELAY=$(awk "BEGIN {print $VOICE_MAIN_DURATION + 4}")
          FADE_START_MAIN=$(awk "BEGIN {print $VOICE_MAIN_END_WITH_DELAY}")
          TOTAL_MAIN_DURATION=$(awk "BEGIN {print $VOICE_MAIN_DURATION + 9}")
          
          echo "ðŸŽµ ãƒ¡ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒŸã‚­ã‚·ãƒ³ã‚°é–‹å§‹"
          # ãƒ¡ã‚¤ãƒ³ç”¨ã®ç·©ã‚„ã‹ãªéŸ³é‡å¤‰åŒ–
          MAIN_FADE_DOWN_START=4
          MAIN_FADE_DOWN_END=4.5
          
          echo "  éŸ³å£°çµ‚äº†ï¼ˆé…å»¶è€ƒæ…®ï¼‰: ${VOICE_MAIN_END_WITH_DELAY}ç§’"
          echo "  ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹: ${FADE_START_MAIN}ç§’"
          
          safe_ffmpeg -i voice-main.wav \
                      -i bgm-main-30s.wav \
                      -filter_complex "[0]aresample=44100,adelay=4s:all=1[voice_delayed];
                                      [1]aresample=44100,volume='if(lt(t,$MAIN_FADE_DOWN_START),1,if(lt(t,$MAIN_FADE_DOWN_END),1-0.5*(t-$MAIN_FADE_DOWN_START)/0.5,0.5))':eval=frame,
                                      afade=t=out:st=${FADE_START_MAIN}:d=5[bgm2];
                                      [voice_delayed][bgm2]amix=inputs=2[main]" \
                      -map "[main]" \
                      -t ${TOTAL_MAIN_DURATION} \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      main-mixed.wav || exit 1
          
          if [ -f "main-mixed.wav" ]; then
            echo "âœ… main-mixed.wav ç”ŸæˆæˆåŠŸ ($(stat -c%s main-mixed.wav) bytes)"
          else
            echo "::error::âŒ main-mixed.wav ã®ç”Ÿæˆã«å¤±æ•—"
            exit 1
          fi
          
          # ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: BGM4ç§’ã‚¤ãƒ³ãƒˆãƒ­ï¼ˆæœ€å¤§éŸ³é‡ï¼‰â†’éŸ³å£°é–‹å§‹æ™‚50%â†’éŸ³å£°çµ‚äº†å¾Œæœ€å¤§éŸ³é‡â†’7ç§’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          VOICE_ENDING_END_WITH_DELAY=$(awk "BEGIN {print $VOICE_ENDING_DURATION + 4}")
          FADE_START_ENDING=$(awk "BEGIN {print $VOICE_ENDING_END_WITH_DELAY}")
          TOTAL_ENDING_DURATION=$(awk "BEGIN {print $VOICE_ENDING_DURATION + 11}")
          
          echo "ðŸŽµ ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒŸã‚­ã‚·ãƒ³ã‚°é–‹å§‹"
          # ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”¨ã®ç·©ã‚„ã‹ãªéŸ³é‡å¤‰åŒ–
          ENDING_FADE_DOWN_START=4
          ENDING_FADE_DOWN_END=4.5
          ENDING_FADE_UP_START=$(awk "BEGIN {print $VOICE_ENDING_END_WITH_DELAY}")
          ENDING_FADE_UP_END=$(awk "BEGIN {print $VOICE_ENDING_END_WITH_DELAY + 0.5}")
          
          echo "  éŸ³å£°çµ‚äº†ï¼ˆé…å»¶è€ƒæ…®ï¼‰: ${VOICE_ENDING_END_WITH_DELAY}ç§’"
          echo "  ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹: ${FADE_START_ENDING}ç§’"
          
          safe_ffmpeg -i voice-ending.wav \
                      -i bgm-ending-30s.wav \
                      -filter_complex "[0]aresample=44100,adelay=4s:all=1[voice_delayed];
                                      [1]aresample=44100,volume='if(lt(t,$ENDING_FADE_DOWN_START),1,if(lt(t,$ENDING_FADE_DOWN_END),1-0.5*(t-$ENDING_FADE_DOWN_START)/0.5,if(lt(t,$ENDING_FADE_UP_START),0.5,if(lt(t,$ENDING_FADE_UP_END),0.5+0.5*(t-$ENDING_FADE_UP_START)/0.5,1))))':eval=frame,
                                      afade=t=out:st=${FADE_START_ENDING}:d=7[bgm3];
                                      [voice_delayed][bgm3]amix=inputs=2[ending]" \
                      -map "[ending]" \
                      -t ${TOTAL_ENDING_DURATION} \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      ending-mixed.wav || exit 1
          
          if [ -f "ending-mixed.wav" ]; then
            echo "âœ… ending-mixed.wav ç”ŸæˆæˆåŠŸ ($(stat -c%s ending-mixed.wav) bytes)"
          else
            echo "::error::âŒ ending-mixed.wav ã®ç”Ÿæˆã«å¤±æ•—"
            exit 1
          fi
          
          # æ¥½æ›²ã‚»ã‚¯ã‚·ãƒ§ãƒ³: é¸æŠžæ¥½æ›²ã‚’ç‹¬ç«‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦ä½œæˆ
          echo "ðŸŽµ æ¥½æ›²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä½œæˆ"
          
          # æ¥½æ›²ã®é•·ã•ã‚’å–å¾—
          MUSIC_DURATION=$(get_duration selected-music.mp3)
          echo "  æ¥½æ›²ã®é•·ã•: ${MUSIC_DURATION}ç§’"
          
          # æœ€å¤§40ç§’ã«åˆ¶é™
          if [ $(awk "BEGIN {print ($MUSIC_DURATION > 40)}") -eq 1 ]; then
            MUSIC_TOTAL_DURATION=40
            MUSIC_FADEOUT_START=37  # 40ç§’ - 3ç§’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
            echo "  æ¥½æ›²ã‚’40ç§’ã«åˆ¶é™ã—ã¾ã™"
          else
            MUSIC_TOTAL_DURATION=$MUSIC_DURATION
            if [ $(awk "BEGIN {print ($MUSIC_DURATION > 4)}") -eq 1 ]; then
              MUSIC_FADEOUT_START=$(awk "BEGIN {print $MUSIC_DURATION - 3}")
            else
              MUSIC_FADEOUT_START=$MUSIC_DURATION
            fi
            echo "  æ¥½æ›²ã‚’ãƒ•ãƒ«é•·ã•ï¼ˆ${MUSIC_TOTAL_DURATION}ç§’ï¼‰ã§ä½¿ç”¨"
          fi
          
          # æ¥½æ›²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä½œæˆï¼ˆ0ç§’ã‹ã‚‰ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã€ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ç”¨ï¼‰
          if [ $(awk "BEGIN {print ($MUSIC_DURATION > 4)}") -eq 1 ]; then
            # æ¥½æ›²ãŒ4ç§’ä»¥ä¸Šã®å ´åˆï¼š0ç§’ã‹ã‚‰ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚ã‚Š
            safe_ffmpeg -i selected-music.mp3 \
                        -filter_complex "[0]aresample=44100,afade=t=in:st=0:d=3,afade=t=out:st=${MUSIC_FADEOUT_START}:d=3[music_faded]" \
                        -map "[music_faded]" \
                        -t ${MUSIC_TOTAL_DURATION} \
                        -ar 44100 -ac 2 -c:a pcm_s16le \
                        music-mixed.wav || exit 1
          else
            # æ¥½æ›²ãŒ4ç§’ä»¥ä¸‹ã®å ´åˆï¼šãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆãªã—
            safe_ffmpeg -i selected-music.mp3 \
                        -filter_complex "[0]aresample=44100[music]" \
                        -map "[music]" \
                        -t ${MUSIC_TOTAL_DURATION} \
                        -ar 44100 -ac 2 -c:a pcm_s16le \
                        music-mixed.wav || exit 1
          fi
          
          if [ -f "music-mixed.wav" ]; then
            echo "âœ… music-mixed.wav ç”ŸæˆæˆåŠŸ ($(stat -c%s music-mixed.wav) bytes)"
          else
            echo "::error::âŒ music-mixed.wav ã®ç”Ÿæˆã«å¤±æ•—"
            exit 1
          fi
          
          # 1ç§’ã®ç„¡éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          echo "ðŸ”‡ ç„¡éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ"
          safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 1 -ar 44100 -ac 2 -c:a pcm_s16le silence-1s.wav || exit 1
          
          # 4ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€£çµã—ã€æœ€çµ‚èª¿æ•´ï¼ˆã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°â†’æ¥½æ›²â†’ãƒ¡ã‚¤ãƒ³â†’ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
          echo "ðŸŽµ æœ€çµ‚ãƒŸãƒƒã‚¯ã‚¹é–‹å§‹ï¼ˆã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°â†’æ¥½æ›²â†’ãƒ¡ã‚¤ãƒ³â†’ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼‰"
          echo "ðŸ“ é€£çµã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la opening-mixed.wav music-mixed.wav main-mixed.wav ending-mixed.wav
          
          safe_ffmpeg -i opening-mixed.wav \
                      -i music-mixed.wav \
                      -i main-mixed.wav \
                      -i ending-mixed.wav \
                      -filter_complex "[0][1]acrossfade=d=5:c1=tri:c2=tri[opening_music];
                                      [opening_music][2][3]concat=n=3:v=0:a=1[combined];
                                      [combined]loudnorm=I=-23:LRA=7:TP=-1[normalized]" \
                      -map "[normalized]" \
                      -c:a mp3 \
                      -b:a 320k \
                      final-radio.mp3 || exit 1
          
          if [ -f "final-radio.mp3" ]; then
            echo "âœ… final-radio.mp3 ç”ŸæˆæˆåŠŸ ($(stat -c%s final-radio.mp3) bytes)"
          else
            echo "::error::âŒ final-radio.mp3 ã®ç”Ÿæˆã«å¤±æ•—"
            exit 1
          fi
          
          # é¸æŠžã•ã‚ŒãŸéŸ³æ¥½æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«å«ã‚ã‚‹
          SELECTED_MUSIC_INFO="unknown"
          if [ -f "artifacts/voice-uuid/USE_UUID.md" ]; then
            SELECTED_MUSIC_INFO=$(grep "Selected Music File:" artifacts/voice-uuid/USE_UUID.md | cut -d' ' -f4- || echo "unknown")
          fi
          
          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
          echo "{
            \"duration\": \"variable\",
            \"selected_music\": \"$SELECTED_MUSIC_INFO\",
            \"sections\": [
              {\"name\": \"opening\", \"duration\": \"6s intro + voice (bgm fades 3s before end)\", \"bgm\": \"upbeat\", \"bgm_volume\": \"100%â†’50%â†’0\", \"intro\": \"6s\", \"fade_out\": \"3s before voice end\"},
              {\"name\": \"music\", \"duration\": \"max 40s with crossfade\", \"content\": \"$SELECTED_MUSIC_INFO\", \"fade_in\": \"3s (crossfade)\", \"fade_out\": \"3s\"},
              {\"name\": \"main\", \"duration\": \"4s intro + voice + 5s fade\", \"bgm\": \"talk-friendly\", \"bgm_volume\": \"100%â†’50%\", \"intro\": \"4s\", \"fade_out\": \"5s\"},
              {\"name\": \"ending\", \"duration\": \"4s intro + voice + 7s fade\", \"bgm\": \"warm-outro\", \"bgm_volume\": \"100%â†’50%â†’100%\", \"intro\": \"4s\", \"fade_out\": \"7s\"}
            ],
            \"audio_standard\": \"-23 LUFS\",
            \"format\": \"MP3 320kbps\"
          }" > metadata.json
          
          echo "final-file=final-radio.mp3" >> $GITHUB_OUTPUT
          echo "metadata=metadata.json" >> $GITHUB_OUTPUT
      
      - name: Upload final audio artifact
        uses: actions/upload-artifact@v4
        with:
          name: final-audio
          path: |
            final-radio.mp3
            metadata.json
          retention-days: 7