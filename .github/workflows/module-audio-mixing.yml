name: Audio Mixing Module (Minimal)
on:
  workflow_call:
    inputs:
      voice-opening:
        required: true
        type: string
      voice-main:
        required: true
        type: string
      voice-ending:
        required: true
        type: string
      bgm-opening:
        required: true
        type: string
      bgm-main:
        required: true
        type: string
      bgm-ending:
        required: true
        type: string
    outputs:
      final-audio:
        value: ${{ jobs.mix.outputs.url }}
      metadata:
        value: ${{ jobs.mix.outputs.metadata }}

jobs:
  mix:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.mixing.outputs.final-file }}
      metadata: ${{ steps.mixing.outputs.metadata }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: List downloaded artifacts
        run: |
          echo "::group::ðŸ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ"
          ls -la artifacts/
          ls -la artifacts/*/ || true
          echo "::endgroup::"
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Mix audio files with section-specific BGMs
        id: mixing
        run: |
          # å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§éŸ³å£°ã¨BGMã‚’å€‹åˆ¥ã«ãƒŸãƒƒã‚¯ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‹æ”¹å–„ç‰ˆï¼‰
          
          # éŸ³å£°ã®é•·ã•ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          get_duration() {
            local file="$1"
            if [ ! -f "$file" ]; then
              echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $fileã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤30ç§’ã‚’ä½¿ç”¨"
              echo "30"
              return 0
            fi
            local duration=$(ffprobe -v quiet -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)
            if [ -z "$duration" ] || [ "$duration" = "N/A" ]; then
              echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’å–å¾—ã§ãã¾ã›ã‚“: $fileã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤30ç§’ã‚’ä½¿ç”¨"
              echo "30"
              return 0
            fi
            echo "$duration"
          }
          
          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãFFmpegå®Ÿè¡Œ
          safe_ffmpeg() {
            if ! ffmpeg "$@" 2>/dev/null; then
              echo "::error::FFmpegå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: $*"
              return 1
            fi
          }
          
          # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          cp artifacts/voice-opening/voice-opening.wav . || echo "::warning::voice-opening.wavãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          cp artifacts/voice-main/voice-main.wav . || echo "::warning::voice-main.wavãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          cp artifacts/voice-ending/voice-ending.wav . || echo "::warning::voice-ending.wavãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          cp artifacts/bgm-opening/bgm-opening-30s.wav . || echo "::warning::bgm-opening-30s.wavãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          cp artifacts/bgm-main/bgm-main-30s.wav . || echo "::warning::bgm-main-30s.wavãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          cp artifacts/bgm-ending/bgm-ending-30s.wav . || echo "::warning::bgm-ending-30s.wavãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          
          # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨ãƒ€ãƒŸãƒ¼ä½œæˆ
          for voice_file in voice-opening.wav voice-main.wav voice-ending.wav; do
            if [ ! -f "$voice_file" ]; then
              echo "::warning::éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« $voice_file ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ç„¡éŸ³ã§ä»£æ›¿"
              safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 30 -c:a pcm_s16le "$voice_file" || exit 1
            fi
          done
          
          # BGMãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨ãƒ€ãƒŸãƒ¼ä½œæˆ
          for bgm_file in bgm-opening-30s.wav bgm-main-30s.wav bgm-ending-30s.wav; do
            if [ ! -f "$bgm_file" ]; then
              echo "::warning::BGMãƒ•ã‚¡ã‚¤ãƒ« $bgm_file ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ç„¡éŸ³ã§ä»£æ›¿"
              safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 30 -c:a pcm_s16le "$bgm_file" || exit 1
            fi
          done
          
          # ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°: BGM4ç§’ã‚¤ãƒ³ãƒˆãƒ­â†’éŸ³å£°é–‹å§‹â†’éŸ³å£°çµ‚äº†å¾ŒBGMãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆ2ç§’ï¼‰
          VOICE_OPENING_DURATION=$(get_duration voice-opening.wav)
          FADE_START_OPENING=$(awk "BEGIN {print $VOICE_OPENING_DURATION + 4.5}")
          TOTAL_OPENING_DURATION=$(awk "BEGIN {print $VOICE_OPENING_DURATION + 6.5}")
          
          safe_ffmpeg -i voice-opening.wav \
                      -i bgm-opening-30s.wav \
                      -filter_complex "[0]adelay=4s:all=1[voice_delayed];
                                      [1]volume=0.5,afade=t=out:st=${FADE_START_OPENING}:d=2[bgm1];
                                      [voice_delayed][bgm1]amix=inputs=2[opening]" \
                      -map "[opening]" \
                      -t $TOTAL_OPENING_DURATION \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      opening-mixed.wav || exit 1
          
          # ãƒ¡ã‚¤ãƒ³: BGM4ç§’ã‚¤ãƒ³ãƒˆãƒ­â†’éŸ³å£°é–‹å§‹â†’éŸ³å£°çµ‚äº†å¾ŒBGMãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆ2ç§’ï¼‰
          VOICE_MAIN_DURATION=$(get_duration voice-main.wav)
          FADE_START_MAIN=$(awk "BEGIN {print $VOICE_MAIN_DURATION + 4.5}")
          TOTAL_MAIN_DURATION=$(awk "BEGIN {print $VOICE_MAIN_DURATION + 6.5}")
          
          safe_ffmpeg -i voice-main.wav \
                      -i bgm-main-30s.wav \
                      -filter_complex "[0]adelay=4s:all=1[voice_delayed];
                                      [1]volume=0.5,afade=t=out:st=${FADE_START_MAIN}:d=2[bgm2];
                                      [voice_delayed][bgm2]amix=inputs=2[main]" \
                      -map "[main]" \
                      -t $TOTAL_MAIN_DURATION \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      main-mixed.wav || exit 1
          
          # ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°: BGM4ç§’ã‚¤ãƒ³ãƒˆãƒ­â†’éŸ³å£°é–‹å§‹â†’éŸ³å£°çµ‚äº†å¾ŒBGMãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆ3ç§’ï¼‰
          VOICE_ENDING_DURATION=$(get_duration voice-ending.wav)
          FADE_START_ENDING=$(awk "BEGIN {print $VOICE_ENDING_DURATION + 4.5}")
          TOTAL_ENDING_DURATION=$(awk "BEGIN {print $VOICE_ENDING_DURATION + 7.5}")
          
          safe_ffmpeg -i voice-ending.wav \
                      -i bgm-ending-30s.wav \
                      -filter_complex "[0]adelay=4s:all=1[voice_delayed];
                                      [1]volume=0.5,afade=t=out:st=${FADE_START_ENDING}:d=3[bgm3];
                                      [voice_delayed][bgm3]amix=inputs=2[ending]" \
                      -map "[ending]" \
                      -t $TOTAL_ENDING_DURATION \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      ending-mixed.wav || exit 1
          
          # 3ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€£çµã—ã€æœ€çµ‚èª¿æ•´ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          safe_ffmpeg -i opening-mixed.wav \
                      -i main-mixed.wav \
                      -i ending-mixed.wav \
                      -filter_complex "[0][1][2]concat=n=3:v=0:a=1[combined]" \
                      -map "[combined]" \
                      -af "loudnorm=I=-23:LRA=7:TP=-1" \
                      -c:a mp3 \
                      -b:a 320k \
                      final-radio.mp3 || exit 1
          
          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
          echo "{
            \"duration\": \"90s\",
            \"sections\": [
              {\"name\": \"opening\", \"duration\": \"4s intro + voice + 2.5s fade\", \"bgm\": \"upbeat\", \"bgm_volume\": \"50%\", \"intro\": \"4s\", \"fade_out\": \"2s\"},
              {\"name\": \"main\", \"duration\": \"4s intro + voice + 2.5s fade\", \"bgm\": \"talk-friendly\", \"bgm_volume\": \"50%\", \"intro\": \"4s\", \"fade_out\": \"2s\"},
              {\"name\": \"ending\", \"duration\": \"4s intro + voice + 3.5s fade\", \"bgm\": \"warm-outro\", \"bgm_volume\": \"50%\", \"intro\": \"4s\", \"fade_out\": \"3s\"}
            ],
            \"audio_standard\": \"-23 LUFS\",
            \"format\": \"MP3 320kbps\"
          }" > metadata.json
          
          echo "final-file=final-radio.mp3" >> $GITHUB_OUTPUT
          echo "metadata=metadata.json" >> $GITHUB_OUTPUT
      
      - name: Upload final audio artifact
        uses: actions/upload-artifact@v4
        with:
          name: final-audio
          path: |
            final-radio.mp3
            metadata.json
          retention-days: 7