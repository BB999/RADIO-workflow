name: Audio Mixing Module (Minimal)
on:
  workflow_call:
    inputs:
      voice-opening:
        required: true
        type: string
      voice-main:
        required: true
        type: string
      voice-ending:
        required: true
        type: string
      bgm-opening:
        required: true
        type: string
      bgm-main:
        required: true
        type: string
      bgm-ending:
        required: true
        type: string
    outputs:
      final-audio:
        value: ${{ jobs.mix.outputs.url }}
      metadata:
        value: ${{ jobs.mix.outputs.metadata }}

jobs:
  mix:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.mixing.outputs.final-file }}
      metadata: ${{ steps.mixing.outputs.metadata }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download voice-opening artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-opening
          path: artifacts/voice-opening
      
      - name: Download voice-main artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-main
          path: artifacts/voice-main
      
      - name: Download voice-ending artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-ending
          path: artifacts/voice-ending
      
      - name: Download bgm-opening artifact
        uses: actions/download-artifact@v4
        with:
          name: bgm-opening
          path: artifacts/bgm-opening
      
      - name: Download bgm-main artifact
        uses: actions/download-artifact@v4
        with:
          name: bgm-main
          path: artifacts/bgm-main
      
      - name: Download bgm-ending artifact
        uses: actions/download-artifact@v4
        with:
          name: bgm-ending
          path: artifacts/bgm-ending
      
      - name: Download voice-uuid artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-uuid
          path: artifacts/voice-uuid
      
      - name: List downloaded artifacts
        run: |
          echo "::group::📁 ダウンロードされたアーティファクト"
          echo "=== artifacts/ ==="
          ls -la artifacts/ || echo "artifactsディレクトリが見つかりません"
          echo ""
          echo "=== 各アーティファクトの内容 ==="
          for dir in artifacts/*/; do
            if [ -d "$dir" ]; then
              echo "--- $dir ---"
              ls -la "$dir" || echo "ディレクトリが空です"
              echo ""
            fi
          done
          echo "::endgroup::"
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Mix audio files with section-specific BGMs
        id: mixing
        run: |
          # 各セクションで音声とBGMを個別にミックス（エラーハンドリング＋改善版）
          
          # 音声の長さを取得する関数（エラーハンドリング付き）
          get_duration() {
            local file="$1"
            if [ ! -f "$file" ]; then
              echo "::warning::音声ファイルが見つかりません: $file、デフォルト値30秒を使用"
              echo "30"
              return 0
            fi
            local duration=$(ffprobe -v quiet -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)
            if [ -z "$duration" ] || [ "$duration" = "N/A" ]; then
              echo "::warning::音声ファイルの長さを取得できません: $file、デフォルト値30秒を使用"
              echo "30"
              return 0
            fi
            echo "$duration"
          }
          
          # 選択された音楽ファイルを取得してコピー
          echo "🎵 選択された音楽ファイルを取得中..."
          
          # voice-uuidアーティファクトから音楽情報を読み込み
          if [ -f "artifacts/voice-uuid/USE_UUID.md" ]; then
            echo "✅ USE_UUID.mdファイルが見つかりました"
            
            # 選択された音楽ファイル名を取得
            SELECTED_MUSIC=$(grep "Selected Music File:" artifacts/voice-uuid/USE_UUID.md | cut -d' ' -f4-)
            
            echo "🔍 デバッグ情報:"
            echo "  選択された音楽ファイル: '$SELECTED_MUSIC'"
            echo "  現在のディレクトリ: $(pwd)"
            echo "  radio-workflowディレクトリの存在確認:"
            ls -la radio-workflow/ || echo "radio-workflowディレクトリが見つかりません"
            echo "  musicディレクトリの存在確認:"
            ls -la radio-workflow/music/ || echo "musicディレクトリが見つかりません"
            echo "  期待するファイルパス: radio-workflow/music/$SELECTED_MUSIC"
            echo "  ファイルの存在確認:"
            ls -la "radio-workflow/music/$SELECTED_MUSIC" || echo "ファイルが見つかりません"
            
            if [ -n "$SELECTED_MUSIC" ] && [ -f "radio-workflow/music/$SELECTED_MUSIC" ]; then
              echo "🎯 選択された音楽: $SELECTED_MUSIC"
              cp "radio-workflow/music/$SELECTED_MUSIC" selected-music.mp3
              echo "✅ selected-music.mp3 をコピーしました"
            else
              echo "::error::選択された音楽ファイルが見つかりません: $SELECTED_MUSIC"
              echo "::error::音楽ファイルは必ず存在すべきです。ワークフローを停止します。"
              exit 1
            fi
          else
            echo "::error::USE_UUID.mdファイルが見つかりません"
            echo "::error::音楽選択情報が必要です。ワークフローを停止します。"
            exit 1
          fi
          
          # エラーハンドリング付きFFmpeg実行
          safe_ffmpeg() {
            local TEMP_LOG="ffmpeg_$(date +%s).log"
            if ! ffmpeg "$@" 2>"$TEMP_LOG"; then
              echo "::error::FFmpeg処理に失敗しました: $*"
              echo "::error::FFmpegエラー出力:"
              cat "$TEMP_LOG" | head -20
              rm -f "$TEMP_LOG"
              return 1
            fi
            rm -f "$TEMP_LOG"
            return 0
          }
          
          # アーティファクトからファイルをコピー（パスを明確に指定）
          echo "📂 音声ファイルのコピー"
          if [ -f "artifacts/voice-opening/${{ inputs.voice-opening }}" ]; then
            cp "artifacts/voice-opening/${{ inputs.voice-opening }}" voice-opening.wav
            echo "✅ voice-opening.wav をコピーしました"
          else
            echo "::warning::音声ファイルが見つかりません: artifacts/voice-opening/${{ inputs.voice-opening }}"
          fi
          
          if [ -f "artifacts/voice-main/${{ inputs.voice-main }}" ]; then
            cp "artifacts/voice-main/${{ inputs.voice-main }}" voice-main.wav
            echo "✅ voice-main.wav をコピーしました"
          else
            echo "::warning::音声ファイルが見つかりません: artifacts/voice-main/${{ inputs.voice-main }}"
          fi
          
          if [ -f "artifacts/voice-ending/${{ inputs.voice-ending }}" ]; then
            cp "artifacts/voice-ending/${{ inputs.voice-ending }}" voice-ending.wav
            echo "✅ voice-ending.wav をコピーしました"
          else
            echo "::warning::音声ファイルが見つかりません: artifacts/voice-ending/${{ inputs.voice-ending }}"
          fi
          
          echo "📂 BGMファイルのコピー"
          if [ -f "artifacts/bgm-opening/${{ inputs.bgm-opening }}" ]; then
            cp "artifacts/bgm-opening/${{ inputs.bgm-opening }}" bgm-opening-30s.wav
            echo "✅ bgm-opening-30s.wav をコピーしました"
          else
            echo "::warning::BGMファイルが見つかりません: artifacts/bgm-opening/${{ inputs.bgm-opening }}"
          fi
          
          if [ -f "artifacts/bgm-main/${{ inputs.bgm-main }}" ]; then
            cp "artifacts/bgm-main/${{ inputs.bgm-main }}" bgm-main-30s.wav
            echo "✅ bgm-main-30s.wav をコピーしました"
          else
            echo "::warning::BGMファイルが見つかりません: artifacts/bgm-main/${{ inputs.bgm-main }}"
          fi
          
          if [ -f "artifacts/bgm-ending/${{ inputs.bgm-ending }}" ]; then
            cp "artifacts/bgm-ending/${{ inputs.bgm-ending }}" bgm-ending-30s.wav
            echo "✅ bgm-ending-30s.wav をコピーしました"
          else
            echo "::warning::BGMファイルが見つかりません: artifacts/bgm-ending/${{ inputs.bgm-ending }}"
          fi
          
          # 音声ファイルの存在確認とダミー作成
          for voice_file in voice-opening.wav voice-main.wav voice-ending.wav; do
            if [ ! -f "$voice_file" ]; then
              echo "::warning::音声ファイル $voice_file が見つかりません、無音で代替"
              safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 30 -ar 44100 -ac 2 -c:a pcm_s16le "$voice_file" || exit 1
            fi
          done
          
          # BGMファイルの存在確認とダミー作成
          for bgm_file in bgm-opening-30s.wav bgm-main-30s.wav bgm-ending-30s.wav; do
            if [ ! -f "$bgm_file" ]; then
              echo "::warning::BGMファイル $bgm_file が見つかりません、無音で代替"
              safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 30 -ar 44100 -ac 2 -c:a pcm_s16le "$bgm_file" || exit 1
            fi
          done
          
          # 各音声の長さを取得して、必要なBGMの長さを計算
          echo "📏 音声ファイルの長さを測定中..."
          VOICE_OPENING_DURATION=$(get_duration voice-opening.wav)
          VOICE_MAIN_DURATION=$(get_duration voice-main.wav)
          VOICE_ENDING_DURATION=$(get_duration voice-ending.wav)
          
          echo "  オープニング音声: ${VOICE_OPENING_DURATION}秒"
          echo "  メイン音声: ${VOICE_MAIN_DURATION}秒"
          echo "  エンディング音声: ${VOICE_ENDING_DURATION}秒"
          
          # 必要なBGMの長さを計算（音声の長さ + 各セクションに必要な余裕時間）
          BGM_OPENING_NEEDED=$(awk "BEGIN {print int($VOICE_OPENING_DURATION + 14)}")  # 6秒イントロ + 音声 + 3秒フル + 5秒フェードアウト
          BGM_MAIN_NEEDED=$(awk "BEGIN {print int($VOICE_MAIN_DURATION + 9)}")         # 4秒イントロ + 音声 + 5秒フェードアウト
          BGM_ENDING_NEEDED=$(awk "BEGIN {print int($VOICE_ENDING_DURATION + 11)}")    # 4秒イントロ + 音声 + 7秒フェードアウト
          
          echo "🎵 必要なBGMの長さ:"
          echo "  オープニング: ${BGM_OPENING_NEEDED}秒"
          echo "  メイン: ${BGM_MAIN_NEEDED}秒"
          echo "  エンディング: ${BGM_ENDING_NEEDED}秒"
          
          # BGMを必要な長さにループ拡張（0.5秒クロスフェード）
          if [ $BGM_OPENING_NEEDED -gt 30 ]; then
            echo "🔄 オープニングBGMを${BGM_OPENING_NEEDED}秒に拡張"
            # ループ回数を計算（29.5秒ごと、0.5秒のオーバーラップ）
            LOOP_COUNT=$(awk "BEGIN {print int($BGM_OPENING_NEEDED / 29.5) + 1}")
            # 最後の0.5秒と最初の0.5秒でクロスフェード
            safe_ffmpeg -i bgm-opening-30s.wav -filter_complex \
              "[0:a]atrim=0:29.5[part1];
               [0:a]atrim=0:30[full];
               [part1][full]acrossfade=d=0.5:c1=tri:c2=tri[crossed];
               [crossed]aloop=loop=$LOOP_COUNT:size=44100*29.5,atrim=0:$BGM_OPENING_NEEDED[looped]" \
              -map "[looped]" -ar 44100 -ac 2 -c:a pcm_s16le bgm-opening-extended.wav -y || exit 1
            mv bgm-opening-extended.wav bgm-opening-30s.wav
          fi
          
          if [ $BGM_MAIN_NEEDED -gt 30 ]; then
            echo "🔄 メインBGMを${BGM_MAIN_NEEDED}秒に拡張"
            # ループ回数を計算（29.5秒ごと、0.5秒のオーバーラップ）
            LOOP_COUNT=$(awk "BEGIN {print int($BGM_MAIN_NEEDED / 29.5) + 1}")
            # 最後の0.5秒と最初の0.5秒でクロスフェード
            safe_ffmpeg -i bgm-main-30s.wav -filter_complex \
              "[0:a]atrim=0:29.5[part1];
               [0:a]atrim=0:30[full];
               [part1][full]acrossfade=d=0.5:c1=tri:c2=tri[crossed];
               [crossed]aloop=loop=$LOOP_COUNT:size=44100*29.5,atrim=0:$BGM_MAIN_NEEDED[looped]" \
              -map "[looped]" -ar 44100 -ac 2 -c:a pcm_s16le bgm-main-extended.wav -y || exit 1
            mv bgm-main-extended.wav bgm-main-30s.wav
          fi
          
          if [ $BGM_ENDING_NEEDED -gt 30 ]; then
            echo "🔄 エンディングBGMを${BGM_ENDING_NEEDED}秒に拡張"
            # ループ回数を計算（29.5秒ごと、0.5秒のオーバーラップ）
            LOOP_COUNT=$(awk "BEGIN {print int($BGM_ENDING_NEEDED / 29.5) + 1}")
            # 最後の0.5秒と最初の0.5秒でクロスフェード
            safe_ffmpeg -i bgm-ending-30s.wav -filter_complex \
              "[0:a]atrim=0:29.5[part1];
               [0:a]atrim=0:30[full];
               [part1][full]acrossfade=d=0.5:c1=tri:c2=tri[crossed];
               [crossed]aloop=loop=$LOOP_COUNT:size=44100*29.5,atrim=0:$BGM_ENDING_NEEDED[looped]" \
              -map "[looped]" -ar 44100 -ac 2 -c:a pcm_s16le bgm-ending-extended.wav -y || exit 1
            mv bgm-ending-extended.wav bgm-ending-30s.wav
          fi
          
          # オープニングセクション: BGM6秒→音声+BGM→クロスフェード用にBGM継続
          echo "🎵 オープニングセクションの作成（楽曲とのクロスフェード対応）"
          
          # タイミング計算（セリフ中クロスフェード対応版）
          VOICE_START=6  # オープニング音声開始
          VOICE_END=$(awk "BEGIN {print $VOICE_OPENING_DURATION + 6}")  # オープニング音声終了
          # セリフの後半5秒でクロスフェードするため、音声終了まで延長
          TOTAL_OPENING_DURATION=$(awk "BEGIN {print $VOICE_OPENING_DURATION + 6}")  # 6秒イントロ + 音声（クロスフェードは楽曲側で調整）
          
          echo "  音声開始: ${VOICE_START}秒"
          echo "  音声終了: ${VOICE_END}秒"
          echo "  オープニング総時間: ${TOTAL_OPENING_DURATION}秒（セリフ中でクロスフェード）"
          
          # オープニングセクション: 音声+BGM（音声終了後もBGM継続してクロスフェード準備）
          safe_ffmpeg -i voice-opening.wav \
                      -i bgm-opening-30s.wav \
                      -filter_complex "[0]aresample=44100,adelay=${VOICE_START}s:all=1[voice_delayed];
                                      [1]aresample=44100,volume='if(lt(t,6),1,if(lt(t,6.5),1-0.5*(t-6)/0.5,0.5))':eval=frame[bgm_opening];
                                      [voice_delayed][bgm_opening]amix=inputs=2[opening]" \
                      -map "[opening]" \
                      -t ${TOTAL_OPENING_DURATION} \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      opening-mixed.wav || exit 1
          
          if [ -f "opening-mixed.wav" ]; then
            echo "✅ opening-mixed.wav 生成成功 ($(stat -c%s opening-mixed.wav) bytes)"
          else
            echo "::error::❌ opening-mixed.wav の生成に失敗"
            exit 1
          fi
          
          # メイン: BGM4秒イントロ（最大音量）→音声開始時50%→音声終了後BGMフェードアウト（5秒）
          VOICE_MAIN_END_WITH_DELAY=$(awk "BEGIN {print $VOICE_MAIN_DURATION + 4}")
          FADE_START_MAIN=$(awk "BEGIN {print $VOICE_MAIN_END_WITH_DELAY}")
          TOTAL_MAIN_DURATION=$(awk "BEGIN {print $VOICE_MAIN_DURATION + 9}")
          
          echo "🎵 メインセクションのミキシング開始"
          # メイン用の緩やかな音量変化
          MAIN_FADE_DOWN_START=4
          MAIN_FADE_DOWN_END=4.5
          
          echo "  音声終了（遅延考慮）: ${VOICE_MAIN_END_WITH_DELAY}秒"
          echo "  フェードアウト開始: ${FADE_START_MAIN}秒"
          
          safe_ffmpeg -i voice-main.wav \
                      -i bgm-main-30s.wav \
                      -filter_complex "[0]aresample=44100,adelay=4s:all=1[voice_delayed];
                                      [1]aresample=44100,volume='if(lt(t,$MAIN_FADE_DOWN_START),1,if(lt(t,$MAIN_FADE_DOWN_END),1-0.5*(t-$MAIN_FADE_DOWN_START)/0.5,0.5))':eval=frame,
                                      afade=t=out:st=${FADE_START_MAIN}:d=5[bgm2];
                                      [voice_delayed][bgm2]amix=inputs=2[main]" \
                      -map "[main]" \
                      -t ${TOTAL_MAIN_DURATION} \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      main-mixed.wav || exit 1
          
          if [ -f "main-mixed.wav" ]; then
            echo "✅ main-mixed.wav 生成成功 ($(stat -c%s main-mixed.wav) bytes)"
          else
            echo "::error::❌ main-mixed.wav の生成に失敗"
            exit 1
          fi
          
          # エンディング: BGM4秒イントロ（最大音量）→音声開始時50%→音声終了後最大音量→7秒フェードアウト
          VOICE_ENDING_END_WITH_DELAY=$(awk "BEGIN {print $VOICE_ENDING_DURATION + 4}")
          FADE_START_ENDING=$(awk "BEGIN {print $VOICE_ENDING_END_WITH_DELAY}")
          TOTAL_ENDING_DURATION=$(awk "BEGIN {print $VOICE_ENDING_DURATION + 11}")
          
          echo "🎵 エンディングセクションのミキシング開始"
          # エンディング用の緩やかな音量変化
          ENDING_FADE_DOWN_START=4
          ENDING_FADE_DOWN_END=4.5
          ENDING_FADE_UP_START=$(awk "BEGIN {print $VOICE_ENDING_END_WITH_DELAY}")
          ENDING_FADE_UP_END=$(awk "BEGIN {print $VOICE_ENDING_END_WITH_DELAY + 0.5}")
          
          echo "  音声終了（遅延考慮）: ${VOICE_ENDING_END_WITH_DELAY}秒"
          echo "  フェードアウト開始: ${FADE_START_ENDING}秒"
          
          safe_ffmpeg -i voice-ending.wav \
                      -i bgm-ending-30s.wav \
                      -filter_complex "[0]aresample=44100,adelay=4s:all=1[voice_delayed];
                                      [1]aresample=44100,volume='if(lt(t,$ENDING_FADE_DOWN_START),1,if(lt(t,$ENDING_FADE_DOWN_END),1-0.5*(t-$ENDING_FADE_DOWN_START)/0.5,if(lt(t,$ENDING_FADE_UP_START),0.5,if(lt(t,$ENDING_FADE_UP_END),0.5+0.5*(t-$ENDING_FADE_UP_START)/0.5,1))))':eval=frame,
                                      afade=t=out:st=${FADE_START_ENDING}:d=7[bgm3];
                                      [voice_delayed][bgm3]amix=inputs=2[ending]" \
                      -map "[ending]" \
                      -t ${TOTAL_ENDING_DURATION} \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      ending-mixed.wav || exit 1
          
          if [ -f "ending-mixed.wav" ]; then
            echo "✅ ending-mixed.wav 生成成功 ($(stat -c%s ending-mixed.wav) bytes)"
          else
            echo "::error::❌ ending-mixed.wav の生成に失敗"
            exit 1
          fi
          
          # 楽曲セクション: 選択楽曲を独立セクションとして作成
          echo "🎵 楽曲セクションの作成"
          
          # 楽曲の長さを取得
          MUSIC_DURATION=$(get_duration selected-music.mp3)
          echo "  楽曲の長さ: ${MUSIC_DURATION}秒"
          
          # 最大40秒に制限
          if [ $(awk "BEGIN {print ($MUSIC_DURATION > 40)}") -eq 1 ]; then
            MUSIC_TOTAL_DURATION=40
            MUSIC_FADEOUT_START=37  # 40秒 - 3秒フェードアウト
            echo "  楽曲を40秒に制限します"
          else
            MUSIC_TOTAL_DURATION=$MUSIC_DURATION
            if [ $(awk "BEGIN {print ($MUSIC_DURATION > 4)}") -eq 1 ]; then
              MUSIC_FADEOUT_START=$(awk "BEGIN {print $MUSIC_DURATION - 3}")
            else
              MUSIC_FADEOUT_START=$MUSIC_DURATION
            fi
            echo "  楽曲をフル長さ（${MUSIC_TOTAL_DURATION}秒）で使用"
          fi
          
          # 楽曲セクションの作成（音量制御：セリフ中30%→セリフ終了後100%）
          # クロスフェード5秒でセリフ終了を計算（オープニングセリフの最後5秒でクロスフェード開始）
          VOICE_CROSSFADE_END=5  # クロスフェード中のセリフ終了タイミング（楽曲セクション基準）
          
          if [ $(awk "BEGIN {print ($MUSIC_DURATION > 4)}") -eq 1 ]; then
            # 楽曲が4秒以上の場合：ラジオ標準音量正規化→音量制御→フェードアウト
            safe_ffmpeg -i selected-music.mp3 \
                        -filter_complex "[0]aresample=44100,loudnorm=I=-23:LRA=7:TP=-1[normalized];
                                        [normalized]volume='if(lt(t,${VOICE_CROSSFADE_END}),0.3,1)':eval=frame,afade=t=out:st=${MUSIC_FADEOUT_START}:d=3[music_faded]" \
                        -map "[music_faded]" \
                        -t ${MUSIC_TOTAL_DURATION} \
                        -ar 44100 -ac 2 -c:a pcm_s16le \
                        music-mixed.wav || exit 1
          else
            # 楽曲が4秒以下の場合：ラジオ標準音量正規化→音量制御
            safe_ffmpeg -i selected-music.mp3 \
                        -filter_complex "[0]aresample=44100,loudnorm=I=-23:LRA=7:TP=-1[normalized];
                                        [normalized]volume='if(lt(t,${VOICE_CROSSFADE_END}),0.3,1)':eval=frame[music]" \
                        -map "[music]" \
                        -t ${MUSIC_TOTAL_DURATION} \
                        -ar 44100 -ac 2 -c:a pcm_s16le \
                        music-mixed.wav || exit 1
          fi
          
          if [ -f "music-mixed.wav" ]; then
            echo "✅ music-mixed.wav 生成成功 ($(stat -c%s music-mixed.wav) bytes)"
          else
            echo "::error::❌ music-mixed.wav の生成に失敗"
            exit 1
          fi
          
          # 音声ファイルの音量正規化（聞こえやすく調整）
          echo "🔊 音声ファイルの音量正規化"
          
          # オープニング音声を正規化
          if [ -f "voice-opening.wav" ]; then
            echo "  オープニング音声を正規化中..."
            safe_ffmpeg -i voice-opening.wav \
                        -filter_complex "[0]loudnorm=I=-20:LRA=7:TP=-1[normalized]" \
                        -map "[normalized]" \
                        -ar 44100 -ac 2 -c:a pcm_s16le \
                        voice-opening-normalized.wav || exit 1
            mv voice-opening-normalized.wav voice-opening.wav
            echo "  ✅ オープニング音声正規化完了"
          fi
          
          # メイン音声を正規化
          if [ -f "voice-main.wav" ]; then
            echo "  メイン音声を正規化中..."
            safe_ffmpeg -i voice-main.wav \
                        -filter_complex "[0]loudnorm=I=-20:LRA=7:TP=-1[normalized]" \
                        -map "[normalized]" \
                        -ar 44100 -ac 2 -c:a pcm_s16le \
                        voice-main-normalized.wav || exit 1
            mv voice-main-normalized.wav voice-main.wav
            echo "  ✅ メイン音声正規化完了"
          fi
          
          # エンディング音声を正規化
          if [ -f "voice-ending.wav" ]; then
            echo "  エンディング音声を正規化中..."
            safe_ffmpeg -i voice-ending.wav \
                        -filter_complex "[0]loudnorm=I=-20:LRA=7:TP=-1[normalized]" \
                        -map "[normalized]" \
                        -ar 44100 -ac 2 -c:a pcm_s16le \
                        voice-ending-normalized.wav || exit 1
            mv voice-ending-normalized.wav voice-ending.wav
            echo "  ✅ エンディング音声正規化完了"
          fi
          
          # 1秒の無音ファイルを作成
          echo "🔇 無音ファイルを作成"
          safe_ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 1 -ar 44100 -ac 2 -c:a pcm_s16le silence-1s.wav || exit 1
          
          # セリフ部分のみを分離（クロスフェード用）
          echo "🎵 セリフ部分を分離してクロスフェード対応"
          safe_ffmpeg -i voice-opening.wav \
                      -filter_complex "[0]aresample=44100,adelay=${VOICE_START}s:all=1[voice_only]" \
                      -map "[voice_only]" \
                      -t ${TOTAL_OPENING_DURATION} \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      opening-voice-only.wav || exit 1
          
          # BGM部分のみを分離（クロスフェード用）
          safe_ffmpeg -i bgm-opening-30s.wav \
                      -filter_complex "[0]aresample=44100,volume='if(lt(t,6),1,if(lt(t,6.5),1-0.5*(t-6)/0.5,0.5))':eval=frame[bgm_only]" \
                      -map "[bgm_only]" \
                      -t ${TOTAL_OPENING_DURATION} \
                      -ar 44100 -ac 2 -c:a pcm_s16le \
                      opening-bgm-only.wav || exit 1
          
          # 4つのセクションを連結し、最終調整（セリフは保護、BGMと楽曲のみクロスフェード）
          echo "🎵 最終ミックス開始（セリフ保護付きクロスフェード）"
          echo "📁 連結するファイル:"
          ls -la opening-voice-only.wav opening-bgm-only.wav music-mixed.wav main-mixed.wav ending-mixed.wav
          
          safe_ffmpeg -i opening-voice-only.wav \
                      -i opening-bgm-only.wav \
                      -i music-mixed.wav \
                      -i main-mixed.wav \
                      -i ending-mixed.wav \
                      -filter_complex "[1][2]acrossfade=d=5:c1=tri:c2=tri[bgm_music_cross];
                                      [0][bgm_music_cross]amix=inputs=2[opening_complete];
                                      [opening_complete][3][4]concat=n=3:v=0:a=1[combined];
                                      [combined]loudnorm=I=-23:LRA=7:TP=-1[normalized]" \
                      -map "[normalized]" \
                      -c:a mp3 \
                      -b:a 320k \
                      final-radio.mp3 || exit 1
          
          if [ -f "final-radio.mp3" ]; then
            echo "✅ final-radio.mp3 生成成功 ($(stat -c%s final-radio.mp3) bytes)"
          else
            echo "::error::❌ final-radio.mp3 の生成に失敗"
            exit 1
          fi
          
          # 選択された音楽情報を取得してメタデータに含める
          SELECTED_MUSIC_INFO="unknown"
          if [ -f "artifacts/voice-uuid/USE_UUID.md" ]; then
            SELECTED_MUSIC_INFO=$(grep "Selected Music File:" artifacts/voice-uuid/USE_UUID.md | cut -d' ' -f4- || echo "unknown")
          fi
          
          # メタデータ生成
          echo "{
            \"duration\": \"variable\",
            \"selected_music\": \"$SELECTED_MUSIC_INFO\",
            \"sections\": [
              {\"name\": \"opening\", \"duration\": \"6s intro + voice (bgm fades 3s before end)\", \"bgm\": \"upbeat\", \"bgm_volume\": \"100%→50%→0\", \"intro\": \"6s\", \"fade_out\": \"3s before voice end\"},
              {\"name\": \"music\", \"duration\": \"max 40s with crossfade\", \"content\": \"$SELECTED_MUSIC_INFO\", \"fade_in\": \"3s (crossfade)\", \"fade_out\": \"3s\"},
              {\"name\": \"main\", \"duration\": \"4s intro + voice + 5s fade\", \"bgm\": \"talk-friendly\", \"bgm_volume\": \"100%→50%\", \"intro\": \"4s\", \"fade_out\": \"5s\"},
              {\"name\": \"ending\", \"duration\": \"4s intro + voice + 7s fade\", \"bgm\": \"warm-outro\", \"bgm_volume\": \"100%→50%→100%\", \"intro\": \"4s\", \"fade_out\": \"7s\"}
            ],
            \"audio_standard\": \"-23 LUFS\",
            \"format\": \"MP3 320kbps\"
          }" > metadata.json
          
          echo "final-file=final-radio.mp3" >> $GITHUB_OUTPUT
          echo "metadata=metadata.json" >> $GITHUB_OUTPUT
      
      - name: Upload final audio artifact
        uses: actions/upload-artifact@v4
        with:
          name: final-audio
          path: |
            final-radio.mp3
            metadata.json
          retention-days: 7