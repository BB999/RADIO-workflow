name: Audio Mixing Jingle
on:
  workflow_call:
    inputs:
      voice-jingle:
        required: true
        type: string
      bgm-jingle:
        required: true
        type: string
    outputs:
      mixed-audio:
        value: ${{ jobs.mix.outputs.file }}

jobs:
  mix:
    runs-on: ubuntu-latest
    outputs:
      file: ${{ steps.mix.outputs.mixed-file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Download jingle voice artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-jingle
          path: voice-files
      
      - name: Download jingle BGM artifact
        uses: actions/download-artifact@v4
        with:
          name: bgm-jingle
          path: bgm-files
      
      - name: Mix jingle audio (BGM + Voice with 5s delay)
        id: mix
        run: |
          echo "::group::ðŸŽµ ã‚¸ãƒ³ã‚°ãƒ«éŸ³å£°ãƒŸã‚­ã‚·ãƒ³ã‚°ï¼ˆBGM 5ç§’å¾Œã«ã‚»ãƒªãƒ•é–‹å§‹ï¼‰"
          echo "ðŸš€ ãƒŸã‚­ã‚·ãƒ³ã‚°é–‹å§‹: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          VOICE_FILE="voice-files/${{ inputs.voice-jingle }}"
          BGM_FILE="bgm-files/${{ inputs.bgm-jingle }}"
          
          echo "ðŸŽ¤ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«: $VOICE_FILE"
          echo "ðŸŽµ BGMãƒ•ã‚¡ã‚¤ãƒ«: $BGM_FILE"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
          if [ ! -f "$VOICE_FILE" ]; then
            echo "::error::âŒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $VOICE_FILE"
            exit 1
          fi
          
          if [ ! -f "$BGM_FILE" ]; then
            echo "::error::âŒ BGMãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $BGM_FILE"
            exit 1
          fi
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±å–å¾—
          echo "ðŸ“Š éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:"
          ls -la "$VOICE_FILE"
          VOICE_DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 "$VOICE_FILE" 2>/dev/null || echo "0")
          echo "â±ï¸ éŸ³å£°é•·ã•: ${VOICE_DURATION}ç§’"
          
          echo "ðŸ“Š BGMãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:"
          ls -la "$BGM_FILE"
          BGM_DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 "$BGM_FILE" 2>/dev/null || echo "0")
          echo "â±ï¸ BGMé•·ã•: ${BGM_DURATION}ç§’"
          
          # 5ç§’ãƒ‡ã‚£ãƒ¬ã‚¤å¾Œã®éŸ³å£°çµ‚äº†æ™‚é–“ã‚’è¨ˆç®—
          VOICE_END_TIME=$(echo "$VOICE_DURATION + 5" | bc -l 2>/dev/null || echo "10")
          echo "ðŸ“ˆ éŸ³å£°çµ‚äº†æ™‚é–“ï¼ˆ5ç§’ãƒ‡ã‚£ãƒ¬ã‚¤å«ã‚€ï¼‰: ${VOICE_END_TIME}ç§’"
          
          # å…¨ä½“ã®é•·ã•ã‚’æ±ºå®šï¼ˆBGMé•·ã•ã¨éŸ³å£°çµ‚äº†æ™‚é–“ã®é•·ã„æ–¹ï¼‰
          if [ $(echo "$BGM_DURATION > $VOICE_END_TIME" | bc -l 2>/dev/null || echo "0") -eq 1 ]; then
            TOTAL_DURATION="$BGM_DURATION"
            echo "ðŸ“ å…¨ä½“é•·ã•: ${TOTAL_DURATION}ç§’ï¼ˆBGMãƒ™ãƒ¼ã‚¹ï¼‰"
          else
            TOTAL_DURATION="$VOICE_END_TIME"
            echo "ðŸ“ å…¨ä½“é•·ã•: ${TOTAL_DURATION}ç§’ï¼ˆéŸ³å£°ãƒ™ãƒ¼ã‚¹ï¼‰"
          fi
          
          # ã‚¸ãƒ³ã‚°ãƒ«ãƒŸã‚­ã‚·ãƒ³ã‚°å‡¦ç†
          echo "ðŸŽšï¸ ã‚¸ãƒ³ã‚°ãƒ«ãƒŸã‚­ã‚·ãƒ³ã‚°å®Ÿè¡Œä¸­..."
          echo "  - BGM: æœ€åˆã‹ã‚‰å†ç”Ÿã€éŸ³é‡èª¿æ•´"
          echo "  - éŸ³å£°: 5ç§’å¾Œã‹ã‚‰é–‹å§‹ã€ãƒ¡ã‚¤ãƒ³éŸ³é‡"
          echo "  - ãƒ•ã‚§ãƒ¼ãƒ‰: çµ‚äº†2ç§’å‰ã‹ã‚‰ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ"
          
          # è¤‡é›‘ãªãƒŸã‚­ã‚·ãƒ³ã‚°å‡¦ç†
          ffmpeg -i "$BGM_FILE" -i "$VOICE_FILE" \
                 -filter_complex "
                   [0:a]volume=0.7,apad[bgm_padded];
                   [1:a]adelay=5000|5000,volume=1.0[voice_delayed];
                   [bgm_padded][voice_delayed]amix=inputs=2:duration=longest:dropout_transition=0.5[mixed];
                   [mixed]afade=t=out:st=$(echo "$TOTAL_DURATION - 2" | bc -l):d=2[faded]
                 " \
                 -map "[faded]" \
                 -t "$TOTAL_DURATION" \
                 -ar 44100 -ac 2 -c:a pcm_s16le \
                 jingle-mixed.wav -y
          
          # ãƒŸã‚­ã‚·ãƒ³ã‚°çµæžœç¢ºèª
          if [ -f jingle-mixed.wav ]; then
            MIXED_SIZE=$(stat -c%s jingle-mixed.wav)
            FINAL_DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 jingle-mixed.wav 2>/dev/null || echo "unknown")
            
            echo "âœ… ã‚¸ãƒ³ã‚°ãƒ«ãƒŸã‚­ã‚·ãƒ³ã‚°å®Œäº†"
            echo "ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${MIXED_SIZE} bytes"
            echo "â±ï¸ æœ€çµ‚é•·ã•: ${FINAL_DURATION}ç§’"
            
            # éŸ³é‡ãƒ¬ãƒ™ãƒ«ç¢ºèª
            echo "ðŸ”Š éŸ³é‡ãƒ¬ãƒ™ãƒ«ç¢ºèª:"
            ffmpeg -i jingle-mixed.wav -filter_complex "volumedetect" -f null - 2>&1 | grep "mean_volume\|max_volume" || true
            
            # WAVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ç¢ºèª
            if file jingle-mixed.wav | grep -q "WAVE"; then
              echo "âœ… WAVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ç¢ºèªæ¸ˆã¿"
            else
              echo "::warning::âš ï¸ WAVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
              file jingle-mixed.wav
            fi
            
          else
            echo "::error::âŒ ã‚¸ãƒ³ã‚°ãƒ«ãƒŸã‚­ã‚·ãƒ³ã‚°ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
          
          echo "mixed-file=jingle-mixed.wav" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Upload mixed jingle artifact
        uses: actions/upload-artifact@v4
        with:
          name: jingle-mixed
          path: jingle-mixed.wav
          retention-days: 1