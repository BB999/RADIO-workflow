name: Voice Generation Jingle
on:
  workflow_call:
    inputs:
      script-text:
        required: true
        type: string
      voice-config:
        required: true
        type: string
    outputs:
      audio-url:
        value: ${{ jobs.generate.outputs.url }}
      audio-file:
        value: ${{ jobs.generate.outputs.file }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.voice.outputs.audio-url }}
      file: ${{ steps.voice.outputs.audio-file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Download voice UUID artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-uuid
          path: radio-workflow/temp
      
      - name: Generate jingle voice with aivis-cloud-api
        id: voice
        run: |
          echo "::group::ðŸŽ¤ ã‚¸ãƒ³ã‚°ãƒ«éŸ³å£°ç”Ÿæˆ"
          echo "ðŸ“ å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ: ${{ inputs.script-text }}"
          echo "âš™ï¸ éŸ³å£°è¨­å®š: ${{ inputs.voice-config }}"
          echo "ðŸš€ é–‹å§‹æ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # USE_UUID.mdã‹ã‚‰éŸ³å£°IDã‚’èª­ã¿è¾¼ã‚€
          if [ -f "radio-workflow/temp/USE_UUID.md" ]; then
            SELECTED_VOICE_ID=$(grep "Voice UUID:" radio-workflow/temp/USE_UUID.md | cut -d' ' -f3)
            echo "âœ… USE_UUID.mdã‹ã‚‰éŸ³å£°IDã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: $SELECTED_VOICE_ID"
          else
            echo "::error::âŒ USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # aivis-cloud-apiå‘¼ã³å‡ºã—ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
          for i in {1..3}; do
            echo "ðŸ“ž Aivis APIå‘¼ã³å‡ºã— (è©¦è¡Œ $i/3)"
            
            # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œå›žé¿ï¼‰
            ESCAPED_TEXT=$(echo '${{ inputs.script-text }}' | sed 's/"/\\"/g' | tr '\n' ' ')
            echo "{\"model_uuid\":\"$SELECTED_VOICE_ID\",\"text\":\"$ESCAPED_TEXT\",\"output_format\":\"wav\",\"speaking_rate\":1.3,\"emotional_intensity\":1.8,\"pitch\":0.2}" > payload.json
            
            HTTP_CODE=$(curl -X POST https://api.aivis-project.com/v1/tts/synthesize \
              -H "Authorization: Bearer ${{ secrets.AIVIS_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d @payload.json \
              --output voice-jingle.wav \
              --write-out "%{http_code}" \
              --show-error --silent)
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
            rm -f payload.json
            
            echo "ðŸ“Š HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… APIå‘¼ã³å‡ºã—æˆåŠŸ"
              break
            elif [ $i -eq 3 ]; then
              echo "::error::âŒ aivis-cloud-api call failed after 3 attempts (HTTP: $HTTP_CODE)"
              # ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ã‚’è¡¨ç¤º
              if [ -s voice-jingle.wav ]; then
                echo "::error::ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹:"
                head -c 500 voice-jingle.wav
              fi
              exit 1
            else
              echo "::warning::âš ï¸ aivis-cloud-api attempt $i failed (HTTP: $HTTP_CODE), retrying..."
              sleep 30
            fi
          done
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒã‚§ãƒƒã‚¯
          echo "ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒã‚§ãƒƒã‚¯"
          if [ -f voice-jingle.wav ]; then
            FILE_SIZE=$(stat -c%s voice-jingle.wav)
            echo "ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $FILE_SIZE bytes"
            
            if [ $FILE_SIZE -eq 0 ]; then
              echo "::error::âŒ ç”Ÿæˆã•ã‚ŒãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™"
              exit 1
            elif [ $FILE_SIZE -lt 1000 ]; then
              echo "::warning::âš ï¸ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå°ã•ã™ãŽã¾ã™ (${FILE_SIZE} bytes)"
              echo "::warning::ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯:"
              head -c 200 voice-jingle.wav | hexdump -C | head -5
            else
              echo "âœ… éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ç”ŸæˆæˆåŠŸ (${FILE_SIZE} bytes)"
            fi
            
            # WAVãƒ•ã‚¡ã‚¤ãƒ«ã®ç°¡æ˜“æ¤œè¨¼
            if file voice-jingle.wav | grep -q "WAVE"; then
              echo "âœ… WAVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ç¢ºèªæ¸ˆã¿"
            else
              echo "::warning::âš ï¸ WAVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
              file voice-jingle.wav
            fi
            
            # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ­£è¦åŒ–ï¼ˆã‚¸ãƒ³ã‚°ãƒ«ç”¨ã«å°‘ã—å¤§ãã‚ã«èª¿æ•´ï¼‰
            echo "ðŸ”Š éŸ³å£°æ­£è¦åŒ–å‡¦ç†ï¼ˆã‚¸ãƒ³ã‚°ãƒ«ç”¨ï¼‰"
            ffmpeg -i voice-jingle.wav \
                   -filter_complex "[0]loudnorm=I=-18:LRA=7:TP=-1[normalized]" \
                   -map "[normalized]" \
                   -ar 44100 -ac 2 -c:a pcm_s16le \
                   voice-jingle-normalized.wav -y
            
            if [ -f voice-jingle-normalized.wav ]; then
              mv voice-jingle-normalized.wav voice-jingle.wav
              echo "âœ… éŸ³å£°æ­£è¦åŒ–å®Œäº†ï¼ˆã‚¸ãƒ³ã‚°ãƒ«ç”¨éŸ³é‡èª¿æ•´ï¼‰"
            else
              echo "::warning::éŸ³å£°æ­£è¦åŒ–ã«å¤±æ•—ã€å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨"
            fi
          else
            echo "::error::âŒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
          
          echo "audio-url=file://$(pwd)/voice-jingle.wav" >> $GITHUB_OUTPUT
          echo "audio-file=voice-jingle.wav" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Upload jingle voice artifact
        uses: actions/upload-artifact@v4
        with:
          name: voice-jingle
          path: voice-jingle.wav
          retention-days: 1