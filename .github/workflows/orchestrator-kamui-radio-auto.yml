# ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªè‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ–‡å­—èµ·ã“ã—è‡ªå‹•åé›†ç‰ˆï¼‰
name: Kamui Radio Auto Production

on:
  workflow_dispatch:
  schedule:
    # æ—¥æœ¬æ™‚é–“ æ¯æ—¥13æ™‚ï¼ˆUTC 4æ™‚ï¼‰ã«å®Ÿè¡Œ
    - cron: '0 4 * * *'

jobs:
  # Step 1: æ–‡å­—èµ·ã“ã—è‡ªå‹•åé›†
  auto-collect-transcript:
    runs-on: ubuntu-latest
    outputs:
      transcript: ${{ steps.collect.outputs.transcript }}
      has_transcript: ${{ steps.collect.outputs.has_transcript }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
      
      - name: Install Python dependencies
        run: |
          pip install selenium webdriver-manager pytz python-dotenv requests
      
      - name: Run auto collector
        id: collect
        env:
          NOTION_URL: ${{ secrets.NOTION_URL }}
          GITHUB_ACTIONS: true
        run: |
          cd radio-workflow/scripts
          python auto_daily_collector.py
          
          # æ–‡å­—èµ·ã“ã—ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f transcript.txt ]; then
            echo "has_transcript=true" >> $GITHUB_OUTPUT
            # æ–‡å­—èµ·ã“ã—ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜ï¼ˆæ”¹è¡Œã‚’ä¿æŒï¼‰
            {
              echo "transcript<<EOF"
              cat transcript.txt
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "has_transcript=false" >> $GITHUB_OUTPUT
          fi

  # Step 2: å°æœ¬ç”Ÿæˆ
  planning:
    needs: auto-collect-transcript
    if: needs.auto-collect-transcript.outputs.has_transcript == 'true'
    runs-on: ubuntu-latest
    outputs:
      script-opening: ${{ steps.generate-script.outputs.opening }}
      script-main-first: ${{ steps.generate-script.outputs.main-first }}
      script-main-second: ${{ steps.generate-script.outputs.main-second }}
      script-ending: ${{ steps.generate-script.outputs.ending }}
      voice-config: ${{ steps.voice-config.outputs.config }}
      episode-number: ${{ steps.episode.outputs.number }}
      episode-title: ${{ steps.episode.outputs.title }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Get episode number
        id: episode
        run: |
          # æ—¢å­˜ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ã‚’æ•°ãˆã‚‹
          episode_count=$(ls -1 docs/episodes/*.html 2>/dev/null | wc -l)
          next_episode=$((episode_count + 1))
          echo "number=$next_episode" >> $GITHUB_OUTPUT
          
          # æ—¥ä»˜ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
          date_str=$(TZ='Asia/Tokyo' date +'%Yå¹´%mæœˆ%dæ—¥')
          echo "title=Episode #$next_episode: ç¥å¨æ—¥å ±æŒ¯ã‚Šè¿”ã‚Šã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆãƒ©ã‚¸ã‚ªã€ŒKAMURAJIã€" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Generate voice config
        id: voice-config
        run: |
          # æ™‚åˆ»ãƒ™ãƒ¼ã‚¹ã§ãƒ©ãƒ³ãƒ€ãƒ ãªéŸ³å£°IDã‚’é¸æŠ
          cd radio-workflow
          if [ -f UUID.md ]; then
            voice_id=$(shuf -n 1 UUID.md)
            echo "config={\"voice_id\":\"$voice_id\"}" >> $GITHUB_OUTPUT
          else
            echo "config={\"voice_id\":\"default\"}" >> $GITHUB_OUTPUT
          fi
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code-sdk
      
      - name: Generate radio script
        id: generate-script
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          TRANSCRIPT: ${{ needs.auto-collect-transcript.outputs.transcript }}
        run: |
          # å°æœ¬ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          cat << 'EOF' > prompt.txt
          ä»¥ä¸‹ã®ç¥å¨æ—¥å ±ã®æ–‡å­—èµ·ã“ã—ã‹ã‚‰ã€4åˆ†é–“ã®ãƒ©ã‚¸ã‚ªç•ªçµ„å°æœ¬ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
          
          # ç•ªçµ„æ§‹æˆ
          - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ï¼ˆ60ç§’ï¼‰: æŒ¨æ‹¶ã€ç•ªçµ„ç´¹ä»‹ã€ä»Šå›ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆäºˆå‘Š
          - ãƒ¡ã‚¤ãƒ³å‰åŠï¼ˆ90ç§’ï¼‰: é–‹ç™ºé€²æ—ã®ä¸»è¦ãƒã‚¤ãƒ³ãƒˆ1-2å€‹
          - ãƒ¡ã‚¤ãƒ³å¾ŒåŠï¼ˆ90ç§’ï¼‰: è¿½åŠ æƒ…å ±ã€æŠ€è¡“çš„ãªè©±é¡Œ
          - ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆ60ç§’ï¼‰: ã¾ã¨ã‚ã€æ¬¡å›äºˆå‘Šã€ç· ã‚ã®æŒ¨æ‹¶
          
          # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š
          - 20ä»£å¥³æ€§ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ã€ŒãƒŸãƒ©ã‚¤ã€
          - æ˜ã‚‹ãå…ƒæ°—ãªè©±ã—æ–¹
          - æŠ€è¡“çš„ãªå†…å®¹ã‚‚åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜
          
          # æ–‡å­—èµ·ã“ã—å†…å®¹:
          $TRANSCRIPT
          
          å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„:
          [OPENING]
          ï¼ˆå°æœ¬å†…å®¹ï¼‰
          [MAIN_FIRST]
          ï¼ˆå°æœ¬å†…å®¹ï¼‰
          [MAIN_SECOND]
          ï¼ˆå°æœ¬å†…å®¹ï¼‰
          [ENDING]
          ï¼ˆå°æœ¬å†…å®¹ï¼‰
          EOF
          
          # Claude APIã§å°æœ¬ç”Ÿæˆï¼ˆå®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã«ç½®ãæ›ãˆã‚‹ï¼‰
          # ã“ã“ã¯å®Ÿéš›ã®Claude SDKå®Ÿè£…ãŒå¿…è¦
          echo "opening=ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ã®ãƒ†ã‚¹ãƒˆ" >> $GITHUB_OUTPUT
          echo "main-first=ãƒ¡ã‚¤ãƒ³å‰åŠå°æœ¬ã®ãƒ†ã‚¹ãƒˆ" >> $GITHUB_OUTPUT
          echo "main-second=ãƒ¡ã‚¤ãƒ³å¾ŒåŠå°æœ¬ã®ãƒ†ã‚¹ãƒˆ" >> $GITHUB_OUTPUT
          echo "ending=ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å°æœ¬ã®ãƒ†ã‚¹ãƒˆ" >> $GITHUB_OUTPUT

  # Step 3: éŸ³å£°ç”Ÿæˆï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  voice-generation:
    needs: planning
    runs-on: ubuntu-latest
    strategy:
      matrix:
        section: [opening, main-first, main-second, ending]
    outputs:
      audio-opening: ${{ steps.output.outputs.opening }}
      audio-main-first: ${{ steps.output.outputs.main-first }}
      audio-main-second: ${{ steps.output.outputs.main-second }}
      audio-ending: ${{ steps.output.outputs.ending }}
    steps:
      - name: Generate voice for ${{ matrix.section }}
        env:
          AIVIS_API_KEY: ${{ secrets.AIVIS_API_KEY }}
          SCRIPT_TEXT: ${{ needs.planning.outputs[format('script-{0}', matrix.section)] }}
          VOICE_CONFIG: ${{ needs.planning.outputs.voice-config }}
        run: |
          # AIVIS Cloud APIã§éŸ³å£°ç”Ÿæˆ
          echo "Generating voice for ${{ matrix.section }}..."
          # å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«å®Ÿè£…
          
      - name: Upload audio artifact
        uses: actions/upload-artifact@v3
        with:
          name: audio-${{ matrix.section }}
          path: audio-${{ matrix.section }}.wav
      
      - id: output
        run: echo "${{ matrix.section }}=audio-${{ matrix.section }}.wav" >> $GITHUB_OUTPUT

  # Step 4: BGMç”Ÿæˆï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  bgm-generation:
    needs: planning
    runs-on: ubuntu-latest
    strategy:
      matrix:
        section: [opening, main, ending]
    outputs:
      bgm-opening: ${{ steps.output.outputs.opening }}
      bgm-main: ${{ steps.output.outputs.main }}
      bgm-ending: ${{ steps.output.outputs.ending }}
    steps:
      - name: Generate BGM for ${{ matrix.section }}
        env:
          MCP_LYRIA_URL: ${{ secrets.MCP_LYRIA_URL }}
        run: |
          # Google Lyria APIã§BGMç”Ÿæˆ
          echo "Generating BGM for ${{ matrix.section }}..."
          # å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«å®Ÿè£…
          
      - name: Upload BGM artifact
        uses: actions/upload-artifact@v3
        with:
          name: bgm-${{ matrix.section }}
          path: bgm-${{ matrix.section }}.mp3
      
      - id: output
        run: echo "${{ matrix.section }}=bgm-${{ matrix.section }}.mp3" >> $GITHUB_OUTPUT

  # Step 5: ã‚¸ãƒ³ã‚°ãƒ«å‡¦ç†
  jingle-processing:
    needs: planning
    runs-on: ubuntu-latest
    outputs:
      jingle-audio: ${{ steps.create-jingle.outputs.audio }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Select random jingle SE
        id: select-jingle
        run: |
          # ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚¸ãƒ³ã‚°ãƒ«SEã‚’é¸æŠ
          jingle_se=$(ls radio-workflow/Jingle\ SE/*.mp3 | shuf -n 1)
          echo "Selected jingle: $jingle_se"
          echo "jingle_se=$jingle_se" >> $GITHUB_ENV
      
      - name: Generate jingle voice
        env:
          AIVIS_API_KEY: ${{ secrets.AIVIS_API_KEY }}
        run: |
          # ã€Œã‹ã‚€ã‚‰ã˜ã€éŸ³å£°ã‚’ç”Ÿæˆ
          echo "Generating 'KAMURAJI' voice..."
          # å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«å®Ÿè£…
      
      - name: Mix jingle with SE
        run: |
          # FFmpegã§ã‚¸ãƒ³ã‚°ãƒ«éŸ³å£°ã¨SEã‚’ãƒŸãƒƒã‚¯ã‚¹
          sudo apt-get update && sudo apt-get install -y ffmpeg
          # ãƒŸã‚­ã‚·ãƒ³ã‚°å‡¦ç†
      
      - name: Upload jingle artifact
        uses: actions/upload-artifact@v3
        with:
          name: jingle-final
          path: jingle-final.mp3
      
      - id: create-jingle
        run: echo "audio=jingle-final.mp3" >> $GITHUB_OUTPUT

  # Step 6: æœ€çµ‚ãƒŸã‚­ã‚·ãƒ³ã‚°
  final-mixing:
    needs: [voice-generation, bgm-generation, jingle-processing, planning]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg
      
      - name: Select user music
        run: |
          # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¥½æ›²ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
          user_music=$(ls radio-workflow/music/*.mp3 | shuf -n 1)
          echo "Selected user music: $user_music"
          cp "$user_music" user-music.mp3
      
      - name: Final audio mixing
        run: |
          # å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’çµåˆ
          # 1. ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ï¼ˆéŸ³å£°+BGMï¼‰
          # 2. ãƒ¡ã‚¤ãƒ³å‰åŠï¼ˆéŸ³å£°+BGMï¼‰
          # 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¥½æ›²ï¼ˆ30ç§’ï¼‰
          # 4. ã‚¸ãƒ³ã‚°ãƒ«
          # 5. ãƒ¡ã‚¤ãƒ³å¾ŒåŠï¼ˆéŸ³å£°+BGMï¼‰
          # 6. ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆéŸ³å£°+BGMï¼‰
          
          # FFmpegã§æœ€çµ‚ãƒŸã‚­ã‚·ãƒ³ã‚°
          echo "Mixing final radio program..."
          # å®Ÿéš›ã®ãƒŸã‚­ã‚·ãƒ³ã‚°ã‚³ãƒãƒ³ãƒ‰ã‚’ã“ã“ã«å®Ÿè£…
      
      - name: Generate video with thumbnail
        run: |
          # é™æ­¢ç”»ã¨éŸ³å£°ã‚’çµ„ã¿åˆã‚ã›ã¦å‹•ç”»ç”Ÿæˆ
          if [ -f radio-workflow/image/title.png ]; then
            ffmpeg -loop 1 -i radio-workflow/image/title.png -i final-radio.mp3 \
              -c:v libx264 -c:a aac -shortest final-radio-video.mp4
          fi
      
      - name: Generate episode HTML
        run: |
          episode_number="${{ needs.planning.outputs.episode-number }}"
          episode_title="${{ needs.planning.outputs.episode-title }}"
          date_str=$(TZ='Asia/Tokyo' date +'%Y-%m-%d')
          
          cat << EOF > docs/episodes/episode-$episode_number.html
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <title>$episode_title</title>
          </head>
          <body>
              <h1>$episode_title</h1>
              <p>é…ä¿¡æ—¥: $date_str</p>
              <audio controls src="../audio/episode-$episode_number.mp3"></audio>
          </body>
          </html>
          EOF
      
      - name: Update podcast RSS
        run: |
          # podcast.xmlã‚’æ›´æ–°
          echo "Updating podcast RSS feed..."
          # RSSæ›´æ–°å‡¦ç†ã‚’ã“ã“ã«å®Ÿè£…
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ™ï¸ Add Episode #${{ needs.planning.outputs.episode-number }}: ç¥å¨æ—¥å ±æŒ¯ã‚Šè¿”ã‚Šã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆãƒ©ã‚¸ã‚ªã€ŒKAMURAJIã€"
          title: "ğŸ™ï¸ æ–°ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰è¿½åŠ : Episode #${{ needs.planning.outputs.episode-number }}"
          body: |
            ## ğŸ™ï¸ ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ª æ–°ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰
            
            **ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ç•ªå·**: #${{ needs.planning.outputs.episode-number }}
            **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ needs.planning.outputs.episode-title }}
            
            ### ğŸ“ ç”Ÿæˆå†…å®¹
            - âœ… æ–‡å­—èµ·ã“ã—è‡ªå‹•åé›†å®Œäº†
            - âœ… å°æœ¬ç”Ÿæˆå®Œäº†
            - âœ… éŸ³å£°åˆæˆå®Œäº†
            - âœ… BGMç”Ÿæˆå®Œäº†
            - âœ… æœ€çµ‚ãƒŸã‚­ã‚·ãƒ³ã‚°å®Œäº†
            
            ### ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
            - `final-radio.mp3` - ãƒ©ã‚¸ã‚ªç•ªçµ„éŸ³å£°
            - `final-radio-video.mp4` - å‹•ç”»ç‰ˆ
            - `docs/episodes/episode-${{ needs.planning.outputs.episode-number }}.html` - ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸
          branch: radio-episode-${{ needs.planning.outputs.episode-number }}
          delete-branch: true

  # ã‚¨ãƒ©ãƒ¼é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  notify-completion:
    needs: final-mixing
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send LINE notification
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        run: |
          # LINEé€šçŸ¥ã®é€ä¿¡ï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
          if [ -n "$LINE_CHANNEL_ACCESS_TOKEN" ] && [ -n "$LINE_USER_ID" ]; then
            if [ "${{ needs.final-mixing.result }}" == "success" ]; then
              message="ğŸ™ï¸ ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼"
            else
              message="âš ï¸ ç¥å¨æ—¥å ±ãƒ©ã‚¸ã‚ªã®ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
            fi
            
            curl -X POST https://api.line.me/v2/bot/message/push \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $LINE_CHANNEL_ACCESS_TOKEN" \
              -d "{
                \"to\": \"$LINE_USER_ID\",
                \"messages\": [{\"type\": \"text\", \"text\": \"$message\"}]
              }"
          else
            echo "LINEé€šçŸ¥ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰"
          fi