name: Voice Generation Ending (Minimal)
on:
  workflow_call:
    inputs:
      script-text:
        required: true
        type: string
      voice-config:
        required: true
        type: string
    outputs:
      audio-url:
        value: ${{ jobs.generate.outputs.url }}
      audio-file:
        value: ${{ jobs.generate.outputs.file }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.voice.outputs.audio-url }}
      file: ${{ steps.voice.outputs.audio-file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download voice UUID artifact
        uses: actions/download-artifact@v4
        with:
          name: voice-uuid
          path: radio-workflow/temp
      
      - name: Generate voice with aivis-cloud-api
        id: voice
        run: |
          echo "::group::ðŸŽ¤ éŸ³å£°ç”Ÿæˆ (ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°)"
          echo "ðŸ“ å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ: ${{ inputs.script-text }}"
          echo "âš™ï¸ éŸ³å£°è¨­å®š: ${{ inputs.voice-config }}"
          echo "ðŸš€ é–‹å§‹æ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # USE_UUID.mdã‹ã‚‰éŸ³å£°IDã‚’èª­ã¿è¾¼ã‚€
          if [ -f "radio-workflow/temp/USE_UUID.md" ]; then
            SELECTED_VOICE_ID=$(grep "Voice UUID:" radio-workflow/temp/USE_UUID.md | cut -d' ' -f3)
            echo "âœ… USE_UUID.mdã‹ã‚‰éŸ³å£°IDã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: $SELECTED_VOICE_ID"
          else
            echo "::error::âŒ USE_UUID.mdãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # aivis-cloud-apiå‘¼ã³å‡ºã—ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
          for i in {1..3}; do
            echo "ðŸ“ž Aivis APIå‘¼ã³å‡ºã— (è©¦è¡Œ $i/3)"
            
            # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œå›žé¿ï¼‰
            ESCAPED_TEXT=$(echo '${{ inputs.script-text }}' | sed 's/"/\\"/g' | tr '\n' ' ')
            echo "{\"model_uuid\":\"$SELECTED_VOICE_ID\",\"text\":\"$ESCAPED_TEXT\",\"output_format\":\"wav\",\"emotional_intensity\":1.5,\"speaking_rate\":0.9}" > payload.json
            
            HTTP_CODE=$(curl -X POST https://api.aivis-project.com/v1/tts/synthesize \
              -H "Authorization: Bearer ${{ secrets.AIVIS_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d @payload.json \
              --output voice-ending.wav \
              --write-out "%{http_code}" \
              --show-error --silent)
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
            rm -f payload.json
            
            echo "ðŸ“Š HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… APIå‘¼ã³å‡ºã—æˆåŠŸ"
              break
            elif [ $i -eq 3 ]; then
              echo "::error::âŒ aivis-cloud-api call failed after 3 attempts (HTTP: $HTTP_CODE)"
              # ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ã‚’è¡¨ç¤º
              if [ -s voice-ending.wav ]; then
                echo "::error::ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹:"
                head -c 500 voice-ending.wav
              fi
              exit 1
            else
              echo "::warning::âš ï¸ aivis-cloud-api attempt $i failed (HTTP: $HTTP_CODE), retrying..."
              sleep 30
            fi
          done
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒã‚§ãƒƒã‚¯
          echo "ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒã‚§ãƒƒã‚¯"
          if [ -f voice-ending.wav ]; then
            FILE_SIZE=$(stat -c%s voice-ending.wav)
            echo "ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $FILE_SIZE bytes"
            
            if [ $FILE_SIZE -eq 0 ]; then
              echo "::error::âŒ ç”Ÿæˆã•ã‚ŒãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™"
              exit 1
            elif [ $FILE_SIZE -lt 1000 ]; then
              echo "::warning::âš ï¸ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå°ã•ã™ãŽã¾ã™ (${FILE_SIZE} bytes)"
              echo "::warning::ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯:"
              head -c 200 voice-ending.wav | hexdump -C | head -5
            else
              echo "âœ… éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ç”ŸæˆæˆåŠŸ (${FILE_SIZE} bytes)"
            fi
            
            # WAVãƒ•ã‚¡ã‚¤ãƒ«ã®ç°¡æ˜“æ¤œè¨¼
            if file voice-ending.wav | grep -q "WAVE"; then
              echo "âœ… WAVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ç¢ºèªæ¸ˆã¿"
            else
              echo "::warning::âš ï¸ WAVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
              file voice-ending.wav
            fi
          else
            echo "::error::âŒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
          
          echo "audio-url=file://$(pwd)/voice-ending.wav" >> $GITHUB_OUTPUT
          echo "audio-file=voice-ending.wav" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Upload voice artifact
        uses: actions/upload-artifact@v4
        with:
          name: voice-ending
          path: voice-ending.wav
          retention-days: 1