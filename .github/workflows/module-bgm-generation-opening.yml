name: BGM Generation Opening (Minimal)
on:
  workflow_call:
    outputs:
      bgm-url:
        value: ${{ jobs.generate.outputs.url }}
      bgm-file:
        value: ${{ jobs.generate.outputs.file }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.bgm.outputs.music-url }}
      file: ${{ steps.bgm.outputs.music-file }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate Opening BGM with Google Lyria
        id: bgm
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::🎵 Opening BGM Generation with Google Lyria"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # MCP設定の確認
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "📋 MCP Configuration Check:"
          echo "Working directory: $(pwd)"
          echo "MCP config path: $MCP_CONFIG_PATH"
          echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
          
          # MCP設定ファイルの存在確認
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            echo "✅ MCP config file exists"
          else
            echo "::warning::⚠️ MCP config file not found, proceeding without kamuicode"
          fi
          
          # プロンプトの構築
          PROMPT="kamuicodeを使って以下のオープニングBGMを生成してください：

          【BGM要件】
          - 長さ: 15秒（ループ用ベース音楽）
          - スタイル: 明るいオープニング系、アップテンポ
          - 雰囲気: エネルギッシュ、番組開始の盛り上がり
          - 楽器: シンセサイザー、軽快なドラム、ベース
          - 特徴: ループしやすい構成、始まりと終わりが自然に繋がる

          【生成設定】
          - モデル: Google Lyria (msc-google-lyria)
          - 品質: 高品質
          - フォーマット: WAV

          生成されたBGMのURLを出力してください。"
          
          echo "🚀 Starting Opening BGM Generation..."
          echo "📝 Prompt length: ${#PROMPT}"
          
          # Claude Code CLIの実行
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            BGM_RESULT=$(npx @anthropic-ai/claude-code \
              --mcp-config="$MCP_CONFIG_ABS_PATH" \
              --print \
              --verbose \
              "$PROMPT" 2>&1) || {
                echo "::warning::⚠️ Claude Code with MCP execution failed, using fallback"
                BGM_RESULT=""
              }
          else
            echo "::warning::⚠️ MCP config not available, skipping kamuicode BGM generation"
            BGM_RESULT=""
          fi
          
          echo "🎵 BGM generation result:"
          echo "$BGM_RESULT"
          
          # 結果からURLを抽出
          MUSIC_URL=$(echo "$BGM_RESULT" | grep -oP 'https://[^\s]+\.wav' | head -1)
          MUSIC_FILE="bgm-opening.wav"
          
          # URLからファイルをダウンロード
          if [ ! -z "$MUSIC_URL" ]; then
            echo "✅ BGM URL found: $MUSIC_URL"
            curl -L "$MUSIC_URL" -o "$MUSIC_FILE"
            # 30秒までループ拡張（音声品質統一）
            sudo apt-get update && sudo apt-get install -y ffmpeg
            ffmpeg -stream_loop -1 -i "$MUSIC_FILE" -t 30 -ar 44100 -ac 2 -c:a pcm_s16le "bgm-opening-30s.wav"
            echo "music-url=$MUSIC_URL" >> $GITHUB_OUTPUT
            echo "music-file=bgm-opening-30s.wav" >> $GITHUB_OUTPUT
          else
            echo "::warning::BGM生成に失敗、デフォルトBGMを使用"
            # フォールバック: シンプルなBGM生成
            sudo apt-get update && sudo apt-get install -y ffmpeg
            ffmpeg -f lavfi -i "sine=frequency=440:duration=30" -ar 44100 -ac 2 -c:a pcm_s16le bgm-opening-30s.wav
            echo "music-url=file://$(pwd)/bgm-opening-30s.wav" >> $GITHUB_OUTPUT
            echo "music-file=bgm-opening-30s.wav" >> $GITHUB_OUTPUT
          fi
          
          echo "::endgroup::"