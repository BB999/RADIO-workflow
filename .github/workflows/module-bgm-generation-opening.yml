name: BGM Generation Opening (Minimal)
on:
  workflow_call:
    outputs:
      bgm-url:
        value: ${{ jobs.generate.outputs.url }}
      bgm-file:
        value: ${{ jobs.generate.outputs.file }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.bgm.outputs.music-url }}
      file: ${{ steps.bgm.outputs.music-file }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate Opening BGM with Google Lyria
        id: bgm
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ðŸŽµ Opening BGM Generation with Google Lyria"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "ðŸ“‹ MCP Configuration Check:"
          echo "Working directory: $(pwd)"
          echo "MCP config path: $MCP_CONFIG_PATH"
          echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
          
          # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            echo "âœ… MCP config file exists"
          else
            echo "::warning::âš ï¸ MCP config file not found, proceeding without kamuicode"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="kamuicodeã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°BGMã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          ã€BGMè¦ä»¶ã€‘
          - é•·ã•: 15ç§’ï¼ˆãƒ«ãƒ¼ãƒ—ç”¨ãƒ™ãƒ¼ã‚¹éŸ³æ¥½ï¼‰
          - ã‚¹ã‚¿ã‚¤ãƒ«: æ˜Žã‚‹ã„ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ç³»ã€ã‚¢ãƒƒãƒ—ãƒ†ãƒ³ãƒ
          - é›°å›²æ°—: ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã€ç•ªçµ„é–‹å§‹ã®ç››ã‚Šä¸ŠãŒã‚Š
          - æ¥½å™¨: ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ã€è»½å¿«ãªãƒ‰ãƒ©ãƒ ã€ãƒ™ãƒ¼ã‚¹
          - ç‰¹å¾´: ãƒ«ãƒ¼ãƒ—ã—ã‚„ã™ã„æ§‹æˆã€å§‹ã¾ã‚Šã¨çµ‚ã‚ã‚ŠãŒè‡ªç„¶ã«ç¹‹ãŒã‚‹

          ã€ç”Ÿæˆè¨­å®šã€‘
          - ãƒ¢ãƒ‡ãƒ«: Google Lyria (msc-google-lyria)
          - å“è³ª: é«˜å“è³ª
          - ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ: WAV

          ç”Ÿæˆã•ã‚ŒãŸBGMã®URLã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"
          
          echo "ðŸš€ Starting Opening BGM Generation..."
          echo "ðŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            BGM_RESULT=$(npx @anthropic-ai/claude-code \
              --mcp-config="$MCP_CONFIG_ABS_PATH" \
              --print \
              --verbose \
              "$PROMPT" 2>&1) || {
                echo "::warning::âš ï¸ Claude Code with MCP execution failed, using fallback"
                BGM_RESULT=""
              }
          else
            echo "::warning::âš ï¸ MCP config not available, skipping kamuicode BGM generation"
            BGM_RESULT=""
          fi
          
          echo "ðŸŽµ BGM generation result:"
          echo "$BGM_RESULT"
          
          # çµæžœã‹ã‚‰URLã‚’æŠ½å‡º
          MUSIC_URL=$(echo "$BGM_RESULT" | grep -oP 'https://[^\s]+\.wav' | head -1)
          MUSIC_FILE="bgm-opening.wav"
          
          # URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          if [ ! -z "$MUSIC_URL" ]; then
            echo "âœ… BGM URL found: $MUSIC_URL"
            curl -L "$MUSIC_URL" -o "$MUSIC_FILE"
            # 30ç§’ã¾ã§ãƒ«ãƒ¼ãƒ—æ‹¡å¼µï¼ˆéŸ³å£°å“è³ªçµ±ä¸€ï¼‰
            sudo apt-get update && sudo apt-get install -y ffmpeg
            ffmpeg -stream_loop -1 -i "$MUSIC_FILE" -t 30 -ar 44100 -ac 2 -c:a pcm_s16le "bgm-opening-30s.wav"
            echo "music-url=$MUSIC_URL" >> $GITHUB_OUTPUT
            echo "music-file=bgm-opening-30s.wav" >> $GITHUB_OUTPUT
          else
            echo "::warning::BGMç”Ÿæˆã«å¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBGMã‚’ä½¿ç”¨"
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚·ãƒ³ãƒ—ãƒ«ãªBGMç”Ÿæˆ
            sudo apt-get update && sudo apt-get install -y ffmpeg
            ffmpeg -f lavfi -i "sine=frequency=440:duration=30" -ar 44100 -ac 2 -c:a pcm_s16le bgm-opening-30s.wav
            echo "music-url=file://$(pwd)/bgm-opening-30s.wav" >> $GITHUB_OUTPUT
            echo "music-file=bgm-opening-30s.wav" >> $GITHUB_OUTPUT
          fi
          
          echo "::endgroup::"