name: Image Generation (Minimal)
on:
  workflow_call:
    outputs:
      image-url:
        value: ${{ jobs.generate.outputs.url }}
      image-file:
        value: ${{ jobs.generate.outputs.file }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.image.outputs.image-url }}
      file: ${{ steps.image.outputs.image-file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: |
          echo "ğŸ“¦ Claude Code SDKã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
          npm install @anthropic-ai/claude-code --force 2>/dev/null || echo "âš ï¸ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã—ã¦ç¶šè¡Œ"
      
      - name: Generate Radio Title Image with Flux Schnell
        id: image
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          MCP_FLUX_SCHNELL_URL: ${{ secrets.MCP_FLUX_SCHNELL_URL }}
        run: |
          echo "::group::ğŸ¨ Radio Title Image Generation with Flux Schnell"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # MCP Flux Schnell URLã®ç¢ºèª
          if [ -z "$MCP_FLUX_SCHNELL_URL" ]; then
            echo "::error::MCP_FLUX_SCHNELL_URL is not set in GitHub Secrets"
            exit 1
          fi
          echo "âœ… MCP Flux Schnell URL is configured"
          
          # ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
          TODAY_DATE=$(date +%Y-%m-%d)
          echo "ğŸ“… Today's date: $TODAY_DATE"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿ã€æ—¥ä»˜ã‚’ä»Šæ—¥ã®æ—¥ä»˜ã«ç½®ãæ›ãˆ
          if [ -f "radio-workflow/picture_prompt.md" ]; then
            PROMPT_TEXT=$(cat radio-workflow/picture_prompt.md | sed "s/2025-08-12/$TODAY_DATE/g")
            echo "âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€æ—¥ä»˜ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
            echo "ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ï¼ˆæœ€åˆã®200æ–‡å­—ï¼‰:"
            echo "$PROMPT_TEXT" | head -c 200
            echo ""
          else
            echo "::error::ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: radio-workflow/picture_prompt.md"
            exit 1
          fi
          
          # ç”»åƒç”Ÿæˆãƒªãƒˆãƒ©ã‚¤ãƒ«ãƒ¼ãƒ—ï¼ˆæœ€å¤§3å›ï¼‰
          SUCCESS=false
          for RETRY_COUNT in {1..3}; do
            echo "ğŸ”„ ç”»åƒç”Ÿæˆè©¦è¡Œ $RETRY_COUNT/3"
            
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰ï¼ˆç”»åƒç”ŸæˆæŒ‡ç¤ºã‚’ã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼‰
            FULL_PROMPT="ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„: $PROMPT_TEXT è¨­å®š: ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”1:1(square), auto_download:true, auto_open:false Flux Schnellã®3æ®µéšãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ç”»åƒç”Ÿæˆã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚"
          
            echo "ğŸš€ Starting Radio Title Image Generation..."
            echo "ğŸ“ Prompt length: ${#FULL_PROMPT} (ã‚·ãƒ³ãƒ—ãƒ«åŒ–æ¸ˆã¿)"
            
            echo "ğŸ“‹ Environment Check:"
            echo "Working directory: $(pwd)"
            echo "MCP Flux Schnell URL configured: Yes"
            
            # Claude Code CLIã®å®Ÿè¡Œï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰ç›´æ¥MCPã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ï¼‰
            echo "ğŸ¤– Claude Code CLIå®Ÿè¡Œé–‹å§‹"
            
            # MCPè¨­å®šã‚’ä½œæˆ
            echo '{
              "mcpServers": {
                "i2i-fal-flux-schnell": {
                  "type": "http",
                  "url": "'${MCP_FLUX_SCHNELL_URL}'",
                  "description": "Flux Schnell Text-to-Image Generation"
                }
              }
            }' > mcp-config.json
            
            # Claude Codeã®å®Ÿè¡Œã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            echo "ğŸ¯ Claude Code CLIå®Ÿè¡Œä¸­ï¼ˆ180ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰..."
            IMAGE_RESULT=$(timeout 180 npx @anthropic-ai/claude-code \
              --mcp-config="$(pwd)/mcp-config.json" \
              --allowedTools "mcp__i2i-fal-flux-schnell__flux_schnell_submit,mcp__i2i-fal-flux-schnell__flux_schnell_status,mcp__i2i-fal-flux-schnell__flux_schnell_result,Bash" \
              --max-turns 12 \
              --permission-mode "bypassPermissions" \
              --print \
              --verbose \
              "$FULL_PROMPT" 2>&1) || {
                  CLAUDE_EXIT_CODE=$?
                  echo "::error::âŒ Claude Codeå®Ÿè¡Œå¤±æ•— (exit code: $CLAUDE_EXIT_CODE)"
                  if [ $CLAUDE_EXIT_CODE -eq 124 ]; then
                    echo "::error::âŒ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ (3åˆ†)"
                  fi
                  echo "::error::è©³ç´°ãªã‚¨ãƒ©ãƒ¼å‡ºåŠ›:"
                  echo "$IMAGE_RESULT" | head -50
                  echo "::error::ç’°å¢ƒå¤‰æ•°ç¢ºèª:"
                  echo "CLAUDE_CODE_OAUTH_TOKEN: ${CLAUDE_CODE_OAUTH_TOKEN:0:20}..."
                  IMAGE_RESULT=""
                }
            
            echo "ğŸ¨ ç”»åƒç”Ÿæˆçµæœ (è©³ç´°ãƒ­ã‚°):"
            echo "--- Claude Code å®Ÿè¡Œãƒ­ã‚° (é–‹å§‹) ---"
            echo "$IMAGE_RESULT"
            echo "--- Claude Code å®Ÿè¡Œãƒ­ã‚° (çµ‚äº†) ---"
            echo ""
            
            # çµæœã‹ã‚‰URLã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŠ½å‡º
            IMAGE_URL=$(echo "$IMAGE_RESULT" | grep -oP '(https://|gs://)[^\s]+\.(png|jpg|jpeg|webp)' | head -1)
            # Claude Codeã®å‡ºåŠ›ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŠ½å‡ºï¼ˆãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã¾ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ¤œç´¢ï¼‰
            CLAUDE_FILE=$(echo "$IMAGE_RESULT" | grep -oP '`[^`]+\.(png|jpg|jpeg|webp)`' | sed 's/`//g' | head -1)
            if [ ! -z "$CLAUDE_FILE" ]; then
              echo "âœ… Claude Codeã®å‡ºåŠ›ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ¤œå‡º: $CLAUDE_FILE"
            fi
            IMAGE_FILE="radio-title.png"
            
            # ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ï¼ˆã‚ˆã‚ŠåŒ…æ‹¬çš„ã«ï¼‰
            echo "ğŸ” ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­..."
            ls -la || true
            
            # è¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
            DOWNLOADED_FILE=""
            
            # ãƒ‘ã‚¿ãƒ¼ãƒ³0: Claude CodeãŒæ˜ç¤ºçš„ã«å‡ºåŠ›ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å
            if [ ! -z "$CLAUDE_FILE" ] && [ -f "$CLAUDE_FILE" ]; then
              DOWNLOADED_FILE="$CLAUDE_FILE"
              echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³0ï¼ˆClaudeå‡ºåŠ›ï¼‰ã§ç™ºè¦‹: $DOWNLOADED_FILE"
            fi
            
            # ãƒ‘ã‚¿ãƒ¼ãƒ³1: flux_schnell_ã§å§‹ã¾ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
            if [ -z "$DOWNLOADED_FILE" ]; then
              DOWNLOADED_FILE=$(find . -name "flux_schnell_*.png" -o -name "flux_schnell_*.jpg" -o -name "flux_schnell_*.jpeg" -o -name "flux_schnell_*.webp" -type f 2>/dev/null | head -1)
              [ ! -z "$DOWNLOADED_FILE" ] && echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³1ã§ç™ºè¦‹: $DOWNLOADED_FILE"
            fi
            
            # ãƒ‘ã‚¿ãƒ¼ãƒ³2: imageã§å§‹ã¾ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
            if [ -z "$DOWNLOADED_FILE" ]; then
              DOWNLOADED_FILE=$(find . -name "image*.png" -o -name "image*.jpg" -o -name "image*.jpeg" -o -name "image*.webp" -type f 2>/dev/null | head -1)
              [ ! -z "$DOWNLOADED_FILE" ] && echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³2ã§ç™ºè¦‹: $DOWNLOADED_FILE"
            fi
            
            # ãƒ‘ã‚¿ãƒ¼ãƒ³3: æœ€è¿‘ä½œæˆã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
            if [ -z "$DOWNLOADED_FILE" ]; then
              DOWNLOADED_FILE=$(find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" -type f -mmin -5 2>/dev/null | head -1)
              [ ! -z "$DOWNLOADED_FILE" ] && echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³3ã§ç™ºè¦‹: $DOWNLOADED_FILE"
            fi
            
            # ãƒ‘ã‚¿ãƒ¼ãƒ³4: ä»»æ„ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
            if [ -z "$DOWNLOADED_FILE" ]; then
              DOWNLOADED_FILE=$(find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" -type f 2>/dev/null | head -1)
              [ ! -z "$DOWNLOADED_FILE" ] && echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³4ã§ç™ºè¦‹: $DOWNLOADED_FILE"
            fi
            
            # ãƒ‘ã‚¿ãƒ¼ãƒ³5: /root/ã§ã®çµ¶å¯¾ãƒ‘ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«
            if [ -z "$DOWNLOADED_FILE" ] && [ ! -z "$CLAUDE_FILE" ]; then
              if [[ "$CLAUDE_FILE" == /root/* ]] && [ -f "$CLAUDE_FILE" ]; then
                echo "âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³5ï¼ˆ/root/çµ¶å¯¾ãƒ‘ã‚¹ï¼‰ã§ç™ºè¦‹: $CLAUDE_FILE"
                # ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
                BASENAME_FILE=$(basename "$CLAUDE_FILE")
                if cp "$CLAUDE_FILE" "./$BASENAME_FILE" 2>/dev/null; then
                  DOWNLOADED_FILE="./$BASENAME_FILE"
                  echo "âœ… /root/ã‹ã‚‰ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼å®Œäº†: $DOWNLOADED_FILE"
                else
                  echo "::warning::âš ï¸ /root/ã‹ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼ã«å¤±æ•—"
                fi
              fi
            fi
            
            echo "ğŸ” URLæŠ½å‡ºçµæœ: '$IMAGE_URL'"
            echo "ğŸ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: '$DOWNLOADED_FILE'"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å„ªå…ˆï¼‰
            if [ ! -z "$DOWNLOADED_FILE" ] && [ -s "$DOWNLOADED_FILE" ]; then
              echo "âœ… æ—¢ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨: $DOWNLOADED_FILE"
              
              FILE_SIZE=$(stat -c%s "$DOWNLOADED_FILE")
              echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${FILE_SIZE} bytes"
              
              # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
              FILE_TYPE=$(file "$DOWNLOADED_FILE")
              echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: $FILE_TYPE"
              
              # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
              if echo "$FILE_TYPE" | grep -qE "(image|PNG|JPEG|WebP|data)" && [ $FILE_SIZE -gt 1000 ]; then
                echo "âœ… æœ‰åŠ¹ãªç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¨åˆ¤å®š"
                
                # PNGã«å¤‰æ›
                sudo apt-get update && sudo apt-get install -y imagemagick
                if convert "$DOWNLOADED_FILE" "radio-title.png" 2>/dev/null; then
                  echo "âœ… ç”»åƒã‚’PNGå½¢å¼ã«å¤‰æ›æˆåŠŸ"
                  echo "image-url=file://$(pwd)/$DOWNLOADED_FILE" >> $GITHUB_OUTPUT
                  echo "image-file=radio-title.png" >> $GITHUB_OUTPUT
                else
                  echo "::warning::âš ï¸ ImageMagickå¤‰æ›å¤±æ•—ã€å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨"
                  cp "$DOWNLOADED_FILE" "radio-title.png"
                  echo "image-url=file://$(pwd)/$DOWNLOADED_FILE" >> $GITHUB_OUTPUT
                  echo "image-file=radio-title.png" >> $GITHUB_OUTPUT
                fi
              else
                echo "::warning::âš ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
                echo "::warning::ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: $FILE_TYPE"
                echo "::warning::ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${FILE_SIZE} bytes"
                echo "::warning::ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:"
                head -c 500 "$DOWNLOADED_FILE" || true
                echo ""
                
                # XMLã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆã€å†…å®¹ã‚’è¡¨ç¤º
                if echo "$FILE_TYPE" | grep -qE "(XML|HTML|text)"; then
                  echo "::warning::ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“:"
                  cat "$DOWNLOADED_FILE" | head -20
                fi
                
                # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                rm -f "$DOWNLOADED_FILE"
                DOWNLOADED_FILE=""
              fi
            else
              echo "::warning::âš ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            fi
            
            # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡åŠ¹ã ã£ãŸå ´åˆã€URLã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
            if [ -z "$DOWNLOADED_FILE" ] || [ ! -f "radio-title.png" ]; then
              if [ ! -z "$IMAGE_URL" ] && [[ "$IMAGE_URL" =~ ^https:// ]]; then
                echo "âœ… HTTPS URLã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è©¦è¡Œ: $IMAGE_URL"
                
                # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
                if curl -L "$IMAGE_URL" -o "$IMAGE_FILE" --max-time 60; then
                  if [ -s "$IMAGE_FILE" ]; then
                    FILE_SIZE=$(stat -c%s "$IMAGE_FILE")
                    FILE_TYPE=$(file "$IMAGE_FILE")
                    echo "ğŸ“Š ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${FILE_SIZE} bytes"
                    echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: $FILE_TYPE"
                    
                    # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
                    if echo "$FILE_TYPE" | grep -qE "(image|PNG|JPEG|WebP|data)" && [ $FILE_SIZE -gt 1000 ]; then
                      echo "âœ… æœ‰åŠ¹ãªç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                      
                      # PNGã«å¤‰æ›
                      sudo apt-get update && sudo apt-get install -y imagemagick
                      if convert "$IMAGE_FILE" "radio-title.png" 2>/dev/null; then
                        echo "âœ… ç”»åƒã‚’PNGå½¢å¼ã«å¤‰æ›æˆåŠŸ"
                        echo "image-url=$IMAGE_URL" >> $GITHUB_OUTPUT
                        echo "image-file=radio-title.png" >> $GITHUB_OUTPUT
                      else
                        echo "::warning::âš ï¸ ImageMagickå¤‰æ›å¤±æ•—ã€å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨"
                        mv "$IMAGE_FILE" "radio-title.png"
                        echo "image-url=$IMAGE_URL" >> $GITHUB_OUTPUT
                        echo "image-file=radio-title.png" >> $GITHUB_OUTPUT
                      fi
                    else
                      echo "::warning::âš ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
                      echo "::warning::ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:"
                      head -c 500 "$IMAGE_FILE" || true
                      rm -f "$IMAGE_FILE"
                    fi
                  else
                    echo "::warning::âš ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™"
                  fi
                else
                  echo "::warning::âš ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
                fi
              else
                echo "::warning::âš ï¸ æœ‰åŠ¹ãªURLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              fi
            fi
            
            # ç”»åƒç”ŸæˆæˆåŠŸãƒã‚§ãƒƒã‚¯
            if [ -f "radio-title.png" ] && [ -s "radio-title.png" ]; then
              echo "âœ… ç”»åƒç”ŸæˆæˆåŠŸï¼ˆè©¦è¡Œ $RETRY_COUNT/3ï¼‰"
              SUCCESS=true
              break
            else
              echo "::warning::âš ï¸ ç”»åƒç”Ÿæˆå¤±æ•—ï¼ˆè©¦è¡Œ $RETRY_COUNT/3ï¼‰"
              echo "::warning::è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°:"
              echo "::warning::Claude Codeå®Ÿè¡Œçµæœ: $IMAGE_RESULT"
              echo "::warning::æŠ½å‡ºã•ã‚ŒãŸURL: '$IMAGE_URL'"
              echo "::warning::ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: '$DOWNLOADED_FILE'"
              
              # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
              rm -f radio-title.png flux_schnell_*.png *.png 2>/dev/null || true
              
              if [ $RETRY_COUNT -lt 3 ]; then
                echo "ğŸ”„ 30ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™..."
                sleep 30
              fi
            fi
          done
          
          # æœ€çµ‚çµæœãƒã‚§ãƒƒã‚¯
          if [ "$SUCCESS" != "true" ]; then
            echo "::error::âŒ ç”»åƒç”Ÿæˆã«3å›å¤±æ•—ã—ã¾ã—ãŸ"
            echo "::error::ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:"
            ls -la || true
            echo "::error::MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
            if [ -f "mcp-config.json" ]; then
              echo "::error::MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™: mcp-config.json"
              head -20 "mcp-config.json" || true
            else
              echo "::error::MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: mcp-config.json"
            fi
            exit 1
          fi
          
          # æœ€çµ‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
          if [ -f "radio-title.png" ] && [ -s "radio-title.png" ]; then
            FINAL_SIZE=$(stat -c%s "radio-title.png")
            echo "âœ… æœ€çµ‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå®Œäº† (${FINAL_SIZE} bytes)"
          else
            echo "::error::âŒ æœ€çµ‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
          
          echo "::endgroup::"
      
      - name: Upload Image artifact
        uses: actions/upload-artifact@v4
        with:
          name: radio-image
          path: radio-title.png
          retention-days: 1