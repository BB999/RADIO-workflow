name: Create Tile Images (4x Grid)

on:
  workflow_dispatch:
    inputs:
      main_concept:
        description: 'ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼ˆ4æšã®ç”»åƒã®å…±é€šãƒ†ãƒ¼ãƒï¼‰'
        required: true
        type: string
      image_model:
        description: 'ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«'
        required: true
        type: choice
        options:
          - t2i-google-imagen3
          - t2i-fal-imagen4-ultra
          - t2i-fal-imagen4-fast
          - t2i-fal-flux-schnell
          - t2i-fal-rundiffusion-photo-flux
        default: t2i-fal-imagen4-fast
      tile_layout:
        description: 'ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ'
        required: true
        type: choice
        options:
          - '2x2'
          - '1x4'
          - '4x1'
        default: '2x2'
      custom_prompts:
        description: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆJSONå½¢å¼ã€ç©ºã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆï¼‰'
        required: false
        type: string
        default: ''

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      folder-name: ${{ steps.create-branch.outputs.folder-name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create branch for tile image generation
        id: create-branch
        run: |
          BRANCH_NAME="tile-images/$(date +%Y%m%d)-${{ github.run_id }}"
          FOLDER_NAME="tile-images-$(date +%Y%m%d)-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin $BRANCH_NAME
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"
          echo "Folder name: $FOLDER_NAME"

  planning:
    runs-on: ubuntu-latest
    needs: [setup-branch]
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.planning.outputs.completed }}
      image-prompt-1: ${{ steps.planning.outputs.image-prompt-1 }}
      image-prompt-2: ${{ steps.planning.outputs.image-prompt-2 }}
      image-prompt-3: ${{ steps.planning.outputs.image-prompt-3 }}
      image-prompt-4: ${{ steps.planning.outputs.image-prompt-4 }}
      tile-concept: ${{ steps.planning.outputs.tile-concept }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Pull latest changes
        run: git pull origin ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ã‚¿ã‚¤ãƒ«ç”»åƒåˆ¶ä½œè¨ˆç”»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: planning
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ“‹ Tile Image Planning Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MAIN_CONCEPT="${{ inputs.main_concept }}"
          IMAGE_MODEL="${{ inputs.image_model }}"
          TILE_LAYOUT="${{ inputs.tile_layout }}"
          CUSTOM_PROMPTS="${{ inputs.custom_prompts }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          PLANNING_DIR="$FOLDER_NAME/planning"
          
          echo "Main concept: $MAIN_CONCEPT"
          echo "Image model: $IMAGE_MODEL"
          echo "Tile layout: $TILE_LAYOUT"
          echo "Planning folder: $PLANNING_DIR"
          
          # è¨ˆç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$PLANNING_DIR" ]; then
            mkdir -p "$PLANNING_DIR"
            echo "ğŸ“ Created planning folder: $PLANNING_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯ç”»åƒåˆ¶ä½œã®å°‚é–€ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‹ã‚‰4æšã®é–¢é€£æ€§ã®ã‚ã‚‹ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®è©³ç´°ãªè¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

          **ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MAIN_CONCEPT
          **ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«**: $IMAGE_MODEL
          **ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**: $TILE_LAYOUT
          **ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $CUSTOM_PROMPTS

          **ã‚¿ã‚¹ã‚¯**:
          1. ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’åˆ†æã—ã€4æšã®ç”»åƒãŒçµ±ä¸€æ„Ÿã‚’æŒã¡ãªãŒã‚‰å¤šæ§˜æ€§ã‚‚è¡¨ç¾ã™ã‚‹è¨ˆç”»ã‚’ç«‹æ¡ˆ
          2. å„ç”»åƒã«å¯¾ã—ã¦å…·ä½“çš„ã§è©³ç´°ãªç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          3. ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«æœ€é©åŒ–ã•ã‚ŒãŸæ§‹å›³ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è€ƒæ…®
          4. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š
             - \`$PLANNING_DIR/tile-plan.md\` - å…¨ä½“è¨ˆç”»æ›¸
             - \`$PLANNING_DIR/image-prompt-1.txt\` - ç”»åƒ1ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
             - \`$PLANNING_DIR/image-prompt-2.txt\` - ç”»åƒ2ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
             - \`$PLANNING_DIR/image-prompt-3.txt\` - ç”»åƒ3ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
             - \`$PLANNING_DIR/image-prompt-4.txt\` - ç”»åƒ4ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
             - \`$PLANNING_DIR/tile-concept.txt\` - ã‚¿ã‚¤ãƒ«ç”»åƒå…¨ä½“ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

          **è¨ˆç”»ã®ãƒã‚¤ãƒ³ãƒˆ**:
          - 4æšã®ç”»åƒã®çµ±ä¸€æ„Ÿï¼ˆè‰²èª¿ã€ã‚¹ã‚¿ã‚¤ãƒ«ã€ãƒ†ãƒ¼ãƒï¼‰
          - å„ç”»åƒã®å€‹æ€§ã¨å¤šæ§˜æ€§
          - $TILE_LAYOUT ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«é©ã—ãŸæ§‹å›³
          - $IMAGE_MODEL ãƒ¢ãƒ‡ãƒ«ã®ç‰¹æ€§ã‚’æ´»ã‹ã—ãŸæœ€é©åŒ–
          - è¦–è¦šçš„ã«ç¾ã—ã„ã‚¿ã‚¤ãƒ«é…ç½®ã‚’æ„è­˜

          **ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
          - é¸æŠã•ã‚ŒãŸ$IMAGE_MODELã«æœ€é©åŒ–ã•ã‚ŒãŸè©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          - çµ±ä¸€ã•ã‚ŒãŸã‚¹ã‚¿ã‚¤ãƒ«ã¨è‰²èª¿ã‚’æŒ‡å®š
          - ã‚¿ã‚¤ãƒ«é…ç½®æ™‚ã®è¦‹æ „ãˆã‚’è€ƒæ…®ã—ãŸæ§‹å›³
          - é«˜è§£åƒåº¦ãƒ»é«˜å“è³ªã‚’æ„è­˜ã—ãŸè¨˜è¿°
          - å„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯50-100èªç¨‹åº¦

          **ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå‡¦ç†**:
          - ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒæä¾›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’å‚è€ƒã«èª¿æ•´
          - ç©ºã®å ´åˆã¯ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‹ã‚‰è‡ªå‹•ç”Ÿæˆ

          **é‡è¦**: 
          1. å¿…ãš6ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„
          2. txtãƒ•ã‚¡ã‚¤ãƒ«ã¯æ©Ÿæ¢°å‡¦ç†ç”¨ï¼ˆ1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
          3. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯å…·ä½“çš„ã§è©³ç´°ã«è¨˜è¿°
          4. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªãƒ»å ±å‘Š"
          
          echo "ğŸš€ Starting Planning Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸè¨ˆç”»ã®ç¢ºèªã¨å‡ºåŠ›
          echo ""
          echo "ğŸ“‹ Checking generated planning files..."
          
          # å„ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
          for i in 1 2 3 4; do
            PROMPT_FILE="$PLANNING_DIR/image-prompt-$i.txt"
            if [ -f "$PROMPT_FILE" ]; then
              IMAGE_PROMPT=$(cat "$PROMPT_FILE" | tr '\n' ' ')
              echo "::notice::âœ… Image prompt $i generated"
              echo "Image prompt $i: $IMAGE_PROMPT"
              echo "image-prompt-$i=$IMAGE_PROMPT" >> $GITHUB_OUTPUT
            else
              echo "::error::âŒ Image prompt $i file not found"
              exit 1
            fi
          done
          
          # ã‚¿ã‚¤ãƒ«ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ç¢ºèª
          if [ -f "$PLANNING_DIR/tile-concept.txt" ]; then
            TILE_CONCEPT=$(cat "$PLANNING_DIR/tile-concept.txt" | tr '\n' ' ')
            echo "::notice::âœ… Tile concept generated"
            echo "Tile concept: $TILE_CONCEPT"
            echo "tile-concept=$TILE_CONCEPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Tile concept file not found"
            exit 1
          fi
          
          # è¨ˆç”»æ›¸ã®ç¢ºèª
          if [ -f "$PLANNING_DIR/tile-plan.md" ]; then
            echo "::notice::âœ… Tile plan document generated"
            echo "First 10 lines of plan:"
            head -10 "$PLANNING_DIR/tile-plan.md"
          else
            echo "::warning::âš ï¸ Tile plan document not found"
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push planning
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No planning files to commit"
          else
            git commit -m "Add tile image planning: ${{ inputs.main_concept }}"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  # 4ã¤ã®ç”»åƒç”Ÿæˆã‚¸ãƒ§ãƒ–ã‚’ä¸¦åˆ—å®Ÿè¡Œ
  image-generation-1:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning]
    permissions:
      contents: write
    outputs:
      image-completed: ${{ steps.image.outputs.completed }}
      google-image-url: ${{ steps.image.outputs.google-image-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Pull latest changes
        run: git pull origin ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ç”»åƒç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ 1/4
        id: image
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ¨ Image Generation Agent 1/4 Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MAIN_CONCEPT="${{ inputs.main_concept }}"
          IMAGE_MODEL="${{ inputs.image_model }}"
          PLANNED_IMAGE_PROMPT="${{ needs.planning.outputs.image-prompt-1 }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          IMAGES_DIR="$FOLDER_NAME/images"
          
          echo "Main concept: $MAIN_CONCEPT"
          echo "Image model: $IMAGE_MODEL"
          echo "Planned image prompt: $PLANNED_IMAGE_PROMPT"
          echo "Target folder: $IMAGES_DIR"
          
          # ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$IMAGES_DIR" ]; then
            mkdir -p "$IMAGES_DIR"
            echo "ğŸ“ Created images folder: $IMAGES_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          echo "ğŸ“‹ MCP Configuration Check:"
          echo "Working directory: $(pwd)"
          echo "MCP config path: $MCP_CONFIG_PATH"
          echo "MCP config absolute path: $MCP_CONFIG_ABS_PATH"
          
          # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            echo "âœ… MCP config file exists at: $MCP_CONFIG_ABS_PATH"
            echo "MCP servers configured:"
            jq -r '.mcpServers | keys[]' "$MCP_CONFIG_ABS_PATH" 2>/dev/null || echo "MCP config format check skipped"
          else
            echo "âŒ MCP config file not found at: $MCP_CONFIG_ABS_PATH"
            exit 1
          fi
          
          # å‹•çš„ã«MCPãƒ„ãƒ¼ãƒ«åã‚’æ±ºå®š
          MCP_TOOLS=""
          BASH_TOOLS="Bash"
          case "$IMAGE_MODEL" in
            "t2i-google-imagen3")
              MCP_TOOLS="mcp__t2i-google-imagen3__imagen3_submit,mcp__t2i-google-imagen3__imagen3_status,mcp__t2i-google-imagen3__imagen3_result"
              ;;
            "t2i-fal-imagen4-ultra")
              MCP_TOOLS="mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result"
              ;;
            "t2i-fal-imagen4-fast")
              MCP_TOOLS="mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result"
              ;;
            "t2i-fal-flux-schnell")
              MCP_TOOLS="mcp__t2i-fal-flux-schnell__flux_schnell_submit,mcp__t2i-fal-flux-schnell__flux_schnell_status,mcp__t2i-fal-flux-schnell__flux_schnell_result"
              ;;
            "t2i-fal-rundiffusion-photo-flux")
              MCP_TOOLS="mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_submit,mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_status,mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_result"
              ;;
            *)
              echo "::error::âŒ Unsupported image model: $IMAGE_MODEL"
              exit 1
              ;;
          esac
          
          ALLOWED_TOOLS="$MCP_TOOLS,$BASH_TOOLS"
          echo "Allowed tools: $ALLOWED_TOOLS"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§$IMAGE_MODELã‚’ä½¿ç”¨ã—ã¦é«˜å“è³ªãªç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼ˆ4æšä¸­ã®1æšç›®ï¼‰ã€‚

          **ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MAIN_CONCEPT
          **ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $PLANNED_IMAGE_PROMPT
          **ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«**: $IMAGE_MODEL

          **å®Ÿè¡Œæ‰‹é †**:
          1. æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ$PLANNED_IMAGE_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦$IMAGE_MODELã§ç”»åƒç”Ÿæˆ
          2. é©åˆ‡ãªMCPãƒ„ãƒ¼ãƒ«ã§ç”»åƒç”Ÿæˆã‚’é–‹å§‹ï¼ˆsubmitï¼‰
          3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªï¼ˆstatusï¼‰
          4. çµæœå–å¾—ã—ã¦Google URLã‚’å–å¾—ï¼ˆresultï¼‰
          5. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$FOLDER_NAME/google-image-url-1.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          6. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$IMAGES_DIR/tile-image-1.pngã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - Google URLã®æœ‰åŠ¹æœŸé™ã¯ç´„1æ™‚é–“ã®ãŸã‚ã€ç”Ÿæˆå¾Œã™ãã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - å¿…ãšGoogleæä¾›ã®èªè¨¼æ¸ˆURLã‚’ä½¿ç”¨
          - ç”»åƒã¯å¿…ãšã€Œ$IMAGES_DIRã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œtile-image-1.pngã€ã¨ã™ã‚‹
          - **æœ€é‡è¦**: ç”Ÿæˆæ™‚ã®Google URLã‚’ã€Œ$FOLDER_NAME/google-image-url-1.txtã€ã«ä¿å­˜
          - **ä¸¡æ–¹ã‚’å®Ÿè¡Œ**: â‘ Google URLã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ â‘¡Google URLã‹ã‚‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜"
          
          echo "ğŸš€ Starting Image Generation Agent 1/4 Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "$ALLOWED_TOOLS" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®ç¢ºèª
          echo ""
          echo "ğŸ“¸ Checking generated image 1/4..."
          if [ -f "$IMAGES_DIR/tile-image-1.png" ]; then
            echo "::notice::âœ… Image 1/4 generated successfully"
            
            # Google URLã‚’ç¢ºèªã—ã¦GitHub Outputã«è¨­å®š
            if [ -f "$FOLDER_NAME/google-image-url-1.txt" ]; then
              GOOGLE_URL=$(cat "$FOLDER_NAME/google-image-url-1.txt")
              echo "Google image URL: $GOOGLE_URL"
              echo "google-image-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
            else
              echo "::warning::âš ï¸ Google image URL not found in file"
              echo "google-image-url=" >> $GITHUB_OUTPUT
            fi
          else
            echo "::error::âŒ Image 1/4 was not generated"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push image 1/4
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No files to commit for image 1/4"
          else
            git commit -m "Add generated image 1/4: ${{ inputs.main_concept }}"
            # æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ã—ã¦ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥
            git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  image-generation-2:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning]
    permissions:
      contents: write
    outputs:
      image-completed: ${{ steps.image.outputs.completed }}
      google-image-url: ${{ steps.image.outputs.google-image-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Pull latest changes
        run: git pull origin ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ç”»åƒç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ 2/4
        id: image
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ¨ Image Generation Agent 2/4 Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MAIN_CONCEPT="${{ inputs.main_concept }}"
          IMAGE_MODEL="${{ inputs.image_model }}"
          PLANNED_IMAGE_PROMPT="${{ needs.planning.outputs.image-prompt-2 }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          IMAGES_DIR="$FOLDER_NAME/images"
          
          echo "Main concept: $MAIN_CONCEPT"
          echo "Image model: $IMAGE_MODEL"
          echo "Planned image prompt: $PLANNED_IMAGE_PROMPT"
          echo "Target folder: $IMAGES_DIR"
          
          # ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$IMAGES_DIR" ]; then
            mkdir -p "$IMAGES_DIR"
            echo "ğŸ“ Created images folder: $IMAGES_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # å‹•çš„ã«MCPãƒ„ãƒ¼ãƒ«åã‚’æ±ºå®š
          MCP_TOOLS=""
          BASH_TOOLS="Bash"
          case "$IMAGE_MODEL" in
            "t2i-google-imagen3")
              MCP_TOOLS="mcp__t2i-google-imagen3__imagen3_submit,mcp__t2i-google-imagen3__imagen3_status,mcp__t2i-google-imagen3__imagen3_result"
              ;;
            "t2i-fal-imagen4-ultra")
              MCP_TOOLS="mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result"
              ;;
            "t2i-fal-imagen4-fast")
              MCP_TOOLS="mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result"
              ;;
            "t2i-fal-flux-schnell")
              MCP_TOOLS="mcp__t2i-fal-flux-schnell__flux_schnell_submit,mcp__t2i-fal-flux-schnell__flux_schnell_status,mcp__t2i-fal-flux-schnell__flux_schnell_result"
              ;;
            "t2i-fal-rundiffusion-photo-flux")
              MCP_TOOLS="mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_submit,mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_status,mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_result"
              ;;
            *)
              echo "::error::âŒ Unsupported image model: $IMAGE_MODEL"
              exit 1
              ;;
          esac
          
          ALLOWED_TOOLS="$MCP_TOOLS,$BASH_TOOLS"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§$IMAGE_MODELã‚’ä½¿ç”¨ã—ã¦é«˜å“è³ªãªç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼ˆ4æšä¸­ã®2æšç›®ï¼‰ã€‚

          **ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MAIN_CONCEPT
          **ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $PLANNED_IMAGE_PROMPT
          **ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«**: $IMAGE_MODEL

          **å®Ÿè¡Œæ‰‹é †**:
          1. æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ$PLANNED_IMAGE_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦$IMAGE_MODELã§ç”»åƒç”Ÿæˆ
          2. é©åˆ‡ãªMCPãƒ„ãƒ¼ãƒ«ã§ç”»åƒç”Ÿæˆã‚’é–‹å§‹ï¼ˆsubmitï¼‰
          3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªï¼ˆstatusï¼‰
          4. çµæœå–å¾—ã—ã¦Google URLã‚’å–å¾—ï¼ˆresultï¼‰
          5. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$FOLDER_NAME/google-image-url-2.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          6. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$IMAGES_DIR/tile-image-2.pngã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œtile-image-2.pngã€ã¨ã™ã‚‹
          - **æœ€é‡è¦**: ç”Ÿæˆæ™‚ã®Google URLã‚’ã€Œ$FOLDER_NAME/google-image-url-2.txtã€ã«ä¿å­˜"
          
          echo "ğŸš€ Starting Image Generation Agent 2/4 Claude Code CLI..."
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "$ALLOWED_TOOLS" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®ç¢ºèª
          if [ -f "$IMAGES_DIR/tile-image-2.png" ]; then
            echo "::notice::âœ… Image 2/4 generated successfully"
            
            if [ -f "$FOLDER_NAME/google-image-url-2.txt" ]; then
              GOOGLE_URL=$(cat "$FOLDER_NAME/google-image-url-2.txt")
              echo "google-image-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
            fi
          else
            echo "::error::âŒ Image 2/4 was not generated"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push image 2/4
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No files to commit for image 2/4"
          else
            git commit -m "Add generated image 2/4: ${{ inputs.main_concept }}"
            # æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ã—ã¦ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥
            git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  image-generation-3:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning]
    permissions:
      contents: write
    outputs:
      image-completed: ${{ steps.image.outputs.completed }}
      google-image-url: ${{ steps.image.outputs.google-image-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Pull latest changes
        run: git pull origin ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ç”»åƒç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ 3/4
        id: image
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ¨ Image Generation Agent 3/4 Execution"
          
          # è¨­å®š
          MAIN_CONCEPT="${{ inputs.main_concept }}"
          IMAGE_MODEL="${{ inputs.image_model }}"
          PLANNED_IMAGE_PROMPT="${{ needs.planning.outputs.image-prompt-3 }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          IMAGES_DIR="$FOLDER_NAME/images"
          
          # ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$IMAGES_DIR" ]; then
            mkdir -p "$IMAGES_DIR"
          fi
          
          # MCPè¨­å®š
          MCP_CONFIG_ABS_PATH="$(pwd)/.claude/mcp-kamuicode.json"
          
          # å‹•çš„ã«MCPãƒ„ãƒ¼ãƒ«åã‚’æ±ºå®š
          case "$IMAGE_MODEL" in
            "t2i-google-imagen3")
              MCP_TOOLS="mcp__t2i-google-imagen3__imagen3_submit,mcp__t2i-google-imagen3__imagen3_status,mcp__t2i-google-imagen3__imagen3_result"
              ;;
            "t2i-fal-imagen4-ultra")
              MCP_TOOLS="mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result"
              ;;
            "t2i-fal-imagen4-fast")
              MCP_TOOLS="mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result"
              ;;
            "t2i-fal-flux-schnell")
              MCP_TOOLS="mcp__t2i-fal-flux-schnell__flux_schnell_submit,mcp__t2i-fal-flux-schnell__flux_schnell_status,mcp__t2i-fal-flux-schnell__flux_schnell_result"
              ;;
            "t2i-fal-rundiffusion-photo-flux")
              MCP_TOOLS="mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_submit,mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_status,mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_result"
              ;;
          esac
          
          ALLOWED_TOOLS="$MCP_TOOLS,Bash"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§$IMAGE_MODELã‚’ä½¿ç”¨ã—ã¦é«˜å“è³ªãªç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼ˆ4æšä¸­ã®3æšç›®ï¼‰ã€‚

          **ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MAIN_CONCEPT
          **ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $PLANNED_IMAGE_PROMPT
          **ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«**: $IMAGE_MODEL

          **å®Ÿè¡Œæ‰‹é †**:
          1. æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ$PLANNED_IMAGE_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦$IMAGE_MODELã§ç”»åƒç”Ÿæˆ
          2. é©åˆ‡ãªMCPãƒ„ãƒ¼ãƒ«ã§ç”»åƒç”Ÿæˆã‚’é–‹å§‹ï¼ˆsubmitï¼‰
          3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªï¼ˆstatusï¼‰
          4. çµæœå–å¾—ã—ã¦Google URLã‚’å–å¾—ï¼ˆresultï¼‰
          5. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$FOLDER_NAME/google-image-url-3.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          6. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$IMAGES_DIR/tile-image-3.pngã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œtile-image-3.pngã€ã¨ã™ã‚‹
          - **æœ€é‡è¦**: ç”Ÿæˆæ™‚ã®Google URLã‚’ã€Œ$FOLDER_NAME/google-image-url-3.txtã€ã«ä¿å­˜"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "$ALLOWED_TOOLS" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®ç¢ºèª
          if [ -f "$IMAGES_DIR/tile-image-3.png" ]; then
            echo "::notice::âœ… Image 3/4 generated successfully"
            
            if [ -f "$FOLDER_NAME/google-image-url-3.txt" ]; then
              GOOGLE_URL=$(cat "$FOLDER_NAME/google-image-url-3.txt")
              echo "google-image-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
            fi
          else
            echo "::error::âŒ Image 3/4 was not generated"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push image 3/4
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No files to commit for image 3/4"
          else
            git commit -m "Add generated image 3/4: ${{ inputs.main_concept }}"
            # æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ã—ã¦ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥
            git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  image-generation-4:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning]
    permissions:
      contents: write
    outputs:
      image-completed: ${{ steps.image.outputs.completed }}
      google-image-url: ${{ steps.image.outputs.google-image-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Pull latest changes
        run: git pull origin ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ç”»åƒç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ 4/4
        id: image
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ¨ Image Generation Agent 4/4 Execution"
          
          # è¨­å®š
          MAIN_CONCEPT="${{ inputs.main_concept }}"
          IMAGE_MODEL="${{ inputs.image_model }}"
          PLANNED_IMAGE_PROMPT="${{ needs.planning.outputs.image-prompt-4 }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          IMAGES_DIR="$FOLDER_NAME/images"
          
          # ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$IMAGES_DIR" ]; then
            mkdir -p "$IMAGES_DIR"
          fi
          
          # MCPè¨­å®š
          MCP_CONFIG_ABS_PATH="$(pwd)/.claude/mcp-kamuicode.json"
          
          # å‹•çš„ã«MCPãƒ„ãƒ¼ãƒ«åã‚’æ±ºå®š
          case "$IMAGE_MODEL" in
            "t2i-google-imagen3")
              MCP_TOOLS="mcp__t2i-google-imagen3__imagen3_submit,mcp__t2i-google-imagen3__imagen3_status,mcp__t2i-google-imagen3__imagen3_result"
              ;;
            "t2i-fal-imagen4-ultra")
              MCP_TOOLS="mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result"
              ;;
            "t2i-fal-imagen4-fast")
              MCP_TOOLS="mcp__t2i-fal-imagen4-fast__imagen4_fast_submit,mcp__t2i-fal-imagen4-fast__imagen4_fast_status,mcp__t2i-fal-imagen4-fast__imagen4_fast_result"
              ;;
            "t2i-fal-flux-schnell")
              MCP_TOOLS="mcp__t2i-fal-flux-schnell__flux_schnell_submit,mcp__t2i-fal-flux-schnell__flux_schnell_status,mcp__t2i-fal-flux-schnell__flux_schnell_result"
              ;;
            "t2i-fal-rundiffusion-photo-flux")
              MCP_TOOLS="mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_submit,mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_status,mcp__t2i-fal-rundiffusion-photo-flux__rundiffusion_photo_flux_result"
              ;;
          esac
          
          ALLOWED_TOOLS="$MCP_TOOLS,Bash"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§$IMAGE_MODELã‚’ä½¿ç”¨ã—ã¦é«˜å“è³ªãªç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼ˆ4æšä¸­ã®4æšç›®ï¼‰ã€‚

          **ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $MAIN_CONCEPT
          **ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $PLANNED_IMAGE_PROMPT
          **ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«**: $IMAGE_MODEL

          **å®Ÿè¡Œæ‰‹é †**:
          1. æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ$PLANNED_IMAGE_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦$IMAGE_MODELã§ç”»åƒç”Ÿæˆ
          2. é©åˆ‡ãªMCPãƒ„ãƒ¼ãƒ«ã§ç”»åƒç”Ÿæˆã‚’é–‹å§‹ï¼ˆsubmitï¼‰
          3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªï¼ˆstatusï¼‰
          4. çµæœå–å¾—ã—ã¦Google URLã‚’å–å¾—ï¼ˆresultï¼‰
          5. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$FOLDER_NAME/google-image-url-4.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          6. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$IMAGES_DIR/tile-image-4.pngã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œtile-image-4.pngã€ã¨ã™ã‚‹
          - **æœ€é‡è¦**: ç”Ÿæˆæ™‚ã®Google URLã‚’ã€Œ$FOLDER_NAME/google-image-url-4.txtã€ã«ä¿å­˜"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "$ALLOWED_TOOLS" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®ç¢ºèª
          if [ -f "$IMAGES_DIR/tile-image-4.png" ]; then
            echo "::notice::âœ… Image 4/4 generated successfully"
            
            if [ -f "$FOLDER_NAME/google-image-url-4.txt" ]; then
              GOOGLE_URL=$(cat "$FOLDER_NAME/google-image-url-4.txt")
              echo "google-image-url=$GOOGLE_URL" >> $GITHUB_OUTPUT
            fi
          else
            echo "::error::âŒ Image 4/4 was not generated"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push image 4/4
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No files to commit for image 4/4"
          else
            git commit -m "Add generated image 4/4: ${{ inputs.main_concept }}"
            # æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ã—ã¦ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥
            git pull origin ${{ needs.setup-branch.outputs.branch-name }} --rebase
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  # å…¨ã¦ã®ç”»åƒç”Ÿæˆå®Œäº†å¾Œã«ã‚¿ã‚¤ãƒ«ç”»åƒã‚’ä½œæˆ
  tile-composition:
    runs-on: ubuntu-latest
    needs: [setup-branch, planning, image-generation-1, image-generation-2, image-generation-3, image-generation-4]
    if: needs.image-generation-1.result == 'success' && needs.image-generation-2.result == 'success' && needs.image-generation-3.result == 'success' && needs.image-generation-4.result == 'success'
    permissions:
      contents: write
    outputs:
      tile-completed: ${{ steps.tile.outputs.completed }}
      tile-image-url: ${{ steps.tile.outputs.tile-image-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Pull latest changes
        run: git pull origin ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick
      
      - name: ã‚¿ã‚¤ãƒ«ç”»åƒåˆæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: tile
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ğŸ–¼ï¸ Tile Composition Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          MAIN_CONCEPT="${{ inputs.main_concept }}"
          TILE_LAYOUT="${{ inputs.tile_layout }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          IMAGES_DIR="$FOLDER_NAME/images"
          FINAL_DIR="$FOLDER_NAME/final"
          
          echo "Main concept: $MAIN_CONCEPT"
          echo "Tile layout: $TILE_LAYOUT"
          echo "Images folder: $IMAGES_DIR"
          echo "Final folder: $FINAL_DIR"
          
          # æœ€çµ‚ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$FINAL_DIR" ]; then
            mkdir -p "$FINAL_DIR"
            echo "ğŸ“ Created final folder: $FINAL_DIR"
          fi
          
          # 4ã¤ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          echo "ğŸ“¸ Checking individual images..."
          for i in 1 2 3 4; do
            if [ -f "$IMAGES_DIR/tile-image-$i.png" ]; then
              echo "âœ… tile-image-$i.png found"
            else
              echo "::error::âŒ tile-image-$i.png not found"
              exit 1
            fi
          done
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="4æšã®å€‹åˆ¥ç”»åƒã‚’ä½¿ç”¨ã—ã¦ã€$TILE_LAYOUT ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã‚¿ã‚¤ãƒ«çŠ¶ã«é…ç½®ã—ãŸ1æšã®åˆæˆç”»åƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **ã‚¿ã‚¹ã‚¯æ¦‚è¦**:
          - 4æšã®ç”»åƒ: $IMAGES_DIR/tile-image-1.png, tile-image-2.png, tile-image-3.png, tile-image-4.png
          - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: $TILE_LAYOUT
          - æœ€çµ‚ç”»åƒ: $FINAL_DIR/tile-composed.png

          **å®Ÿè¡Œæ‰‹é †**:
          1. 4ã¤ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã¨è§£åƒåº¦ã‚’ç¢ºèª
          2. $TILE_LAYOUT ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¿œã˜ã¦é©åˆ‡ãªImageMagickã‚³ãƒãƒ³ãƒ‰ã‚’æ§‹ç¯‰
          3. ç”»åƒã‚’çµ±ä¸€ã‚µã‚¤ã‚ºã«ãƒªã‚µã‚¤ã‚ºï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
          4. ã‚¿ã‚¤ãƒ«çŠ¶ã«é…ç½®ã—ã¦åˆæˆ
          5. æœ€çµ‚ç”»åƒã‚’ã€Œ$FINAL_DIR/tile-composed.pngã€ã¨ã—ã¦ä¿å­˜
          6. åˆæˆç”»åƒã®æƒ…å ±ï¼ˆã‚µã‚¤ã‚ºã€å“è³ªç­‰ï¼‰ã‚’ç¢ºèªãƒ»å ±å‘Š

          **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä»•æ§˜**:
          - 2x2: 2è¡Œ2åˆ—ã®ã‚°ãƒªãƒƒãƒ‰é…ç½®
          - 1x4: 1è¡Œ4åˆ—ã®æ¨ªä¸¦ã³é…ç½®  
          - 4x1: 4è¡Œ1åˆ—ã®ç¸¦ä¸¦ã³é…ç½®

          **ImageMagickã‚³ãƒãƒ³ãƒ‰ä¾‹**:
          - 2x2ã®å ´åˆ: montage tile-image-1.png tile-image-2.png tile-image-3.png tile-image-4.png -tile 2x2 -geometry +0+0 output.png
          - 1x4ã®å ´åˆ: montage tile-image-1.png tile-image-2.png tile-image-3.png tile-image-4.png -tile 4x1 -geometry +0+0 output.png
          - 4x1ã®å ´åˆ: montage tile-image-1.png tile-image-2.png tile-image-3.png tile-image-4.png -tile 1x4 -geometry +0+0 output.png

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - å„ç”»åƒã®ç¸¦æ¨ªæ¯”ã‚’ä¿æŒ
          - çµ±ä¸€ã•ã‚ŒãŸå“è³ªã¨ã‚µã‚¤ã‚º
          - å¢ƒç•Œç·šã‚„ä½™ç™½ã®èª¿æ•´
          - æœ€çµ‚ç”»åƒã®å“è³ªç¢ºä¿
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯å¿…ãšã€Œtile-composed.pngã€ã¨ã™ã‚‹"
          
          echo "ğŸš€ Starting Tile Composition Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Bash,Read" \
            --max-turns 15 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # åˆæˆç”»åƒã®ç¢ºèª
          echo ""
          echo "ğŸ–¼ï¸ Checking composed tile image..."
          if [ -f "$FINAL_DIR/tile-composed.png" ]; then
            echo "::notice::âœ… Tile composition completed successfully"
            
            # ç”»åƒæƒ…å ±ã®è¡¨ç¤º
            echo "Image info:"
            file "$FINAL_DIR/tile-composed.png"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèª
            SIZE=$(stat -f%z "$FINAL_DIR/tile-composed.png" 2>/dev/null || stat -c%s "$FINAL_DIR/tile-composed.png" 2>/dev/null || echo "unknown")
            echo "File size: $SIZE bytes"
            
            # ä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’URLã¨ã—ã¦å‡ºåŠ›ï¼ˆå®Ÿéš›ã®ç’°å¢ƒã§ã¯é©åˆ‡ãªURLã«å¤‰æ›´ï¼‰
            TILE_IMAGE_URL="file://$(pwd)/$FINAL_DIR/tile-composed.png"
            echo "Tile image path: $TILE_IMAGE_URL"
            echo "tile-image-url=$TILE_IMAGE_URL" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Tile composition failed - file not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push all generated content
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ needs.setup-branch.outputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No files to commit"
          else
            git commit -m "Add tile images: ${{ inputs.main_concept }} (${{ inputs.tile_layout }} layout)"
            git push origin ${{ needs.setup-branch.outputs.branch-name }}
          fi

  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
  create-pr:
    runs-on: ubuntu-latest
    needs: [setup-branch, tile-composition]
    if: needs.tile-composition.result == 'success'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’ä½œæˆ
          PR_TITLE="ğŸ¨ Add Tile Images: ${{ inputs.main_concept }}"
          PR_BODY="## ğŸ–¼ï¸ Tile Image Generation Results

          **Main Concept**: ${{ inputs.main_concept }}
          **Layout**: ${{ inputs.tile_layout }}
          **Model**: ${{ inputs.image_model }}
          **Branch**: ${{ needs.setup-branch.outputs.branch-name }}

          ### ğŸ“ Generated Content
          - âœ… Planning documents
          - âœ… 4 individual images (tile-image-1.png ~ tile-image-4.png)
          - âœ… Composed tile image (tile-composed.png)
          - âœ… Google image URLs for external access

          ### ğŸ¯ Features
          - **Multi-model support**: Compatible with 5 different AI image models
          - **Flexible layouts**: 2x2, 1x4, 4x1 tile arrangements
          - **Parallel processing**: 4 images generated simultaneously
          - **Automatic composition**: ImageMagick-based tile assembly
          - **Quality assurance**: High-resolution output with unified styling

          ---
          ğŸ¤– Generated automatically by **Tile Image Generation Workflow**"

          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
          gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head ${{ needs.setup-branch.outputs.branch-name }} || {
              echo "::warning::Failed to create PR, possibly already exists"
            }
          
          echo "âœ… Pull request creation completed"