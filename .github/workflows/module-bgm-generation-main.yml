name: BGM Generation Main (Minimal)
on:
  workflow_call:
    outputs:
      bgm-url:
        value: ${{ jobs.generate.outputs.url }}
      bgm-file:
        value: ${{ jobs.generate.outputs.file }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.bgm.outputs.music-url }}
      file: ${{ steps.bgm.outputs.music-file }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Generate Main BGM with Google Lyria
        id: bgm
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "::group::ðŸŽµ Main BGM Generation with Google Lyria"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="kamuicodeã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ãƒ¡ã‚¤ãƒ³BGMã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

          ã€BGMè¦ä»¶ã€‘
          - é•·ã•: 15ç§’ï¼ˆãƒ«ãƒ¼ãƒ—ç”¨ãƒ™ãƒ¼ã‚¹éŸ³æ¥½ï¼‰
          - ã‚¹ã‚¿ã‚¤ãƒ«: è½ã¡ç€ã„ãŸãƒˆãƒ¼ã‚¯å‘ã‘ã€æŽ§ãˆã‚
          - é›°å›²æ°—: é›†ä¸­ã—ã‚„ã™ã„ã€é‚ªé­”ã«ãªã‚‰ãªã„
          - æ¥½å™¨: ã‚¢ã‚³ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚®ã‚¿ãƒ¼ã€è»½ã„ãƒ”ã‚¢ãƒŽã€ã‚½ãƒ•ãƒˆã‚·ãƒ³ã‚»
          - ç‰¹å¾´: è©±ã—å£°ã‚’é‚ªé­”ã—ãªã„éŸ³é‡ãƒ¬ãƒ™ãƒ«ã€ç™’ã—ç³»

          ã€ç”Ÿæˆè¨­å®šã€‘
          - ãƒ¢ãƒ‡ãƒ«: Google Lyria (msc-google-lyria)
          - å“è³ª: é«˜å“è³ª
          - ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ: WAV

          ç”Ÿæˆã•ã‚ŒãŸBGMã®URLã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"
          
          echo "ðŸš€ Starting Main BGM Generation..."
          echo "ðŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            BGM_RESULT=$(npx @anthropic-ai/claude-code \
              --mcp-config="$MCP_CONFIG_ABS_PATH" \
              --print \
              --verbose \
              "$PROMPT" 2>&1) || {
                echo "::warning::âš ï¸ Claude Code with MCP execution failed, using fallback"
                BGM_RESULT=""
              }
          else
            echo "::warning::âš ï¸ MCP config not available, skipping kamuicode BGM generation"
            BGM_RESULT=""
          fi
          
          echo "ðŸŽµ BGM generation result:"
          echo "$BGM_RESULT"
          
          # çµæžœã‹ã‚‰URLã‚’æŠ½å‡º
          MUSIC_URL=$(echo "$BGM_RESULT" | grep -oP 'https://[^\s]+\.wav' | head -1)
          MUSIC_FILE="bgm-main.wav"
          
          # URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          if [ ! -z "$MUSIC_URL" ]; then
            echo "âœ… BGM URL found: $MUSIC_URL"
            curl -L "$MUSIC_URL" -o "$MUSIC_FILE"
            # 30ç§’ã¾ã§ãƒ«ãƒ¼ãƒ—æ‹¡å¼µ
            sudo apt-get update && sudo apt-get install -y ffmpeg
            ffmpeg -stream_loop -1 -i "$MUSIC_FILE" -t 30 -ar 44100 -ac 2 -c:a pcm_s16le "bgm-main-30s.wav"
            echo "music-url=$MUSIC_URL" >> $GITHUB_OUTPUT
            echo "music-file=bgm-main-30s.wav" >> $GITHUB_OUTPUT
          else
            echo "::warning::BGMç”Ÿæˆã«å¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBGMã‚’ä½¿ç”¨"
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚·ãƒ³ãƒ—ãƒ«ãªBGMç”Ÿæˆ
            sudo apt-get update && sudo apt-get install -y ffmpeg
            ffmpeg -f lavfi -i "sine=frequency=330:duration=30" -ar 44100 -ac 2 -c:a pcm_s16le bgm-main-30s.wav
            echo "music-url=file://$(pwd)/bgm-main-30s.wav" >> $GITHUB_OUTPUT
            echo "music-file=bgm-main-30s.wav" >> $GITHUB_OUTPUT
          fi
          
          echo "::endgroup::"