name: Create Radio Opening

on:
  workflow_dispatch:
    inputs:
      opening_theme:
        description: 'ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã®é›°å›²æ°—ï¼ˆä¾‹ï¼šã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã€çˆ½ã‚„ã‹ã€ã‚¸ãƒ£ã‚ºé¢¨ï¼‰'
        required: true
        type: string

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      folder-name: ${{ steps.create-branch.outputs.folder-name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create branch for radio opening generation
        id: create-branch
        run: |
          BRANCH_NAME="radio-opening/$(date +%Y%m%d)-${{ github.run_id }}"
          FOLDER_NAME="radio-opening-$(date +%Y%m%d)-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin $BRANCH_NAME
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"
          echo "Folder name: $FOLDER_NAME"

  opening-planning:
    runs-on: ubuntu-latest
    needs: [setup-branch]
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.planning.outputs.completed }}
      opening-script: ${{ steps.planning.outputs.opening-script }}
      voice-style: ${{ steps.planning.outputs.voice-style }}
      music-prompt: ${{ steps.planning.outputs.music-prompt }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ä½œæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: planning
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸ™ï¸ Radio Opening Planning Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          SHOW_TITLE="ç¥å¨æ—¥å ±ãµã‚Šã‹ãˆã‚Šãƒ©ã‚¸ã‚ª"
          OPENING_THEME="${{ inputs.opening_theme }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          PLANNING_DIR="$FOLDER_NAME/planning"
          
          echo "Show title: $SHOW_TITLE"
          echo "Opening theme: $OPENING_THEME"
          echo "Planning folder: $PLANNING_DIR"
          
          # è¨ˆç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$PLANNING_DIR" ]; then
            mkdir -p "$PLANNING_DIR"
            echo "ğŸ“ Created planning folder: $PLANNING_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯ãƒ©ã‚¸ã‚ªç•ªçµ„åˆ¶ä½œã®å°‚é–€å®¶ã§ã™ã€‚ç•ªçµ„ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ç”¨ã®å°æœ¬ã‚’ä½œæˆã—ã€éŸ³æ¥½ã¨åˆæˆã™ã‚‹ãŸã‚ã®æˆ¦ç•¥ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

          **ç•ªçµ„ã‚¿ã‚¤ãƒˆãƒ«**: $SHOW_TITLE
          **ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã®é›°å›²æ°—**: $OPENING_THEME

          **ã‚¿ã‚¹ã‚¯**:
          1. ç•ªçµ„ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ç”¨ã®å°æœ¬ã‚’ä½œæˆï¼ˆ15-20ç§’ç¨‹åº¦ã€ç´„50-80æ–‡å­—ï¼‰
          2. ã‚«ãƒ ã‚¤æ—¥å ±ã®è©±è€…ã®å£èª¿ãƒ»ç‰¹å¾´ã‚’åæ˜ ã—ãŸæŒ¨æ‹¶å°æœ¬ã«èª¿æ•´
          3. ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³æ¥½ã®é›°å›²æ°—ã«åˆã‚ã›ãŸè©±ã—æ–¹ãƒ»ãƒˆãƒ¼ãƒ³ã‚’è¨­å®š
          4. aivis-apiç”¨ã®éŸ³å£°ç”Ÿæˆè¨­å®šã‚’è¨ˆç”»
          5. ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³æ¥½ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          6. éŸ³å£°ã¨éŸ³æ¥½ã®åˆæˆæˆ¦ç•¥ã‚’ç­–å®š
          7. ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ã‚’ã€Œ$PLANNING_DIR/opening-script.txtã€ã«ä¿å­˜
          8. éŸ³å£°ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šã‚’ã€Œ$PLANNING_DIR/voice-style.jsonã€ã«ä¿å­˜
          9. éŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$PLANNING_DIR/music-prompt.txtã€ã«ä¿å­˜
          10. åˆ¶ä½œæˆ¦ç•¥æ›¸ã‚’ã€Œ$PLANNING_DIR/opening-strategy.mdã€ã«ä¿å­˜

          **ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬ã®ä¾‹**:
          ã€Œçš†ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼$SHOW_TITLEã®æ™‚é–“ãŒã‚„ã£ã¦ãã¾ã—ãŸã€‚ä»Šæ—¥ã‚‚æœ€æ–°ã®ãƒ†ãƒƒã‚¯æƒ…å ±ã‚’ãŠå±Šã‘ã—ã¦ã„ãã¾ã™ã‚ˆï¼ã€

          **ã‚«ãƒ ã‚¤æ—¥å ±è©±è€…ã®ç‰¹å¾´**ï¼ˆvoice_analysis.txtã‹ã‚‰ï¼‰:
          - ã€Œãˆã£ã¨ã€ã€Œã§ã™ã­ã€ã€Œã¡ã‚‡ã£ã¨ã€ã‚’å¤šç”¨
          - ã€Œã€œã¿ãŸã„ãªæ„Ÿã˜ã€ã€Œã€œã£ã¦ã„ã†æ„Ÿã˜ã€ã§èª¬æ˜
          - æŠ€è¡“çš„ãªå†…å®¹ã‚’è¦ªã—ã¿ã‚„ã™ãè§£èª¬
          - ã€Œã™ã”ã„ã€ã€Œã‚„ã°ã„ã€ãªã©ã®æ„Ÿå˜†è©ã‚’ä½¿ç”¨
          - ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã ãŒä¸å¯§ãªèªèª¿

          **éŸ³å£°ç”Ÿæˆè¨­å®šä¾‹**:
          - model_uuid: a59cb814-0083-4369-8542-f51a29e72af7
          - speaking_rate: 1.1-1.3ï¼ˆã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã«ï¼‰
          - emotional_intensity: é«˜ã‚ï¼ˆã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚‰ã—ãæ˜ã‚‹ãï¼‰
          - output_format: wavï¼ˆé«˜éŸ³è³ªåˆæˆç”¨ï¼‰

          ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€æˆ¦ç•¥ã‚’è¨ˆç”»ã—ã¦ãã ã•ã„ã€‚"

          # Claude Codeã‚’å®Ÿè¡Œ
          npx claude-code --prompt "$PROMPT"
          
          # å‡ºåŠ›ã®ç¢ºèª
          if [ -f "$PLANNING_DIR/opening-script.txt" ]; then
            echo "âœ… Opening script created"
            OPENING_SCRIPT=$(cat "$PLANNING_DIR/opening-script.txt")
            echo "opening-script<<EOF" >> $GITHUB_OUTPUT
            echo "$OPENING_SCRIPT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âŒ Opening script not found"
            exit 1
          fi

          if [ -f "$PLANNING_DIR/voice-style.json" ]; then
            echo "âœ… Voice style settings created"
            VOICE_STYLE=$(cat "$PLANNING_DIR/voice-style.json")
            echo "voice-style<<EOF" >> $GITHUB_OUTPUT
            echo "$VOICE_STYLE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âŒ Voice style not found"
            exit 1
          fi

          if [ -f "$PLANNING_DIR/music-prompt.txt" ]; then
            echo "âœ… Music prompt created"
            MUSIC_PROMPT=$(cat "$PLANNING_DIR/music-prompt.txt")
            echo "music-prompt<<EOF" >> $GITHUB_OUTPUT
            echo "$MUSIC_PROMPT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âŒ Music prompt not found"
            exit 1
          fi

          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"

  generate-opening-audio-and-music:
    runs-on: ubuntu-latest
    needs: [setup-branch, opening-planning]
    permissions:
      contents: write
    outputs:
      voice-url: ${{ steps.voice-generation.outputs.voice-url }}
      music-url: ${{ steps.music-generation.outputs.music-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      # ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ç”Ÿæˆï¼ˆaivis-apiä½¿ç”¨ï¼‰
      - name: ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: voice-generation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AIVIS_API_KEY: ${{ secrets.AIVIS_API_KEY }}
        run: |
          echo "::group::ğŸ¤ Opening Voice Generation Agent Execution"
          
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          AUDIO_DIR="$FOLDER_NAME/audio"
          
          # éŸ³å£°ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$AUDIO_DIR"
          
          OPENING_SCRIPT="${{ needs.opening-planning.outputs.opening-script }}"
          VOICE_STYLE="${{ needs.opening-planning.outputs.voice-style }}"
          
          PROMPT="aivis-apiã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **å°æœ¬**: $OPENING_SCRIPT
          **éŸ³å£°è¨­å®š**: $VOICE_STYLE
          **API Key**: ç’°å¢ƒå¤‰æ•°AIVIS_API_KEYã‹ã‚‰å–å¾—

          **ã‚¿ã‚¹ã‚¯**:
          1. aivis-apiï¼ˆhttps://api.aivis-project.com/v1/tts/synthesizeï¼‰ã‚’ä½¿ã£ã¦éŸ³å£°ç”Ÿæˆ
          2. é«˜éŸ³è³ªWAVå½¢å¼ã§å‡ºåŠ›
          3. ç”Ÿæˆã—ãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œ$AUDIO_DIR/opening-voice.wavã€ã«ä¿å­˜
          4. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’å‡ºåŠ›

          aivis-apiã®ä½¿ç”¨æ–¹æ³•:
          - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: POST https://api.aivis-project.com/v1/tts/synthesize
          - Authorization: Bearer \$AIVIS_API_KEY
          - model_uuid: a59cb814-0083-4369-8542-f51a29e72af7
          - output_format: wav
          - å°æœ¬ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šã‚’ä½¿ç”¨

          éŸ³å£°ã‚’ç”Ÿæˆã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"

          npx claude-code --prompt "$PROMPT"
          
          # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "$AUDIO_DIR/opening-voice.wav" ]; then
            echo "âœ… Opening voice generated successfully"
            # ç›¸å¯¾ãƒ‘ã‚¹ã‚’GitHubå‡ºåŠ›ã«è¨­å®š
            echo "voice-url=$AUDIO_DIR/opening-voice.wav" >> $GITHUB_OUTPUT
          else
            echo "âŒ Opening voice generation failed"
            exit 1
          fi
          
          echo "::endgroup::"

      # ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³æ¥½ç”Ÿæˆï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
      - name: ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³æ¥½ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: music-generation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸµ Opening Music Generation Agent Execution"
          
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          MUSIC_DIR="$FOLDER_NAME/music"
          
          # éŸ³æ¥½ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$MUSIC_DIR"
          
          MUSIC_PROMPT="${{ needs.opening-planning.outputs.music-prompt }}"
          
          PROMPT="kamuicode MCPã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³æ¥½ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **éŸ³æ¥½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $MUSIC_PROMPT
          **å‡ºåŠ›é•·ã•**: ç´„20-30ç§’ï¼ˆã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ã®é•·ã•ï¼‹ä½™è£•ï¼‰

          **ã‚¿ã‚¹ã‚¯**:
          1. Google Lyriaã‚’ä½¿ã£ã¦ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³æ¥½ã‚’ç”Ÿæˆ
          2. éŸ³å£°ã«é©ã—ãŸãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ»ãƒ†ãƒ³ãƒã§ç”Ÿæˆ
          3. ç”Ÿæˆã—ãŸéŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œ$MUSIC_DIR/opening-music.wavã€ã«ä¿å­˜
          4. éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’å‡ºåŠ›

          kamuicode MCPã®éŸ³æ¥½ç”Ÿæˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ©ã‚¸ã‚ªç•ªçµ„ã®ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã«é©ã—ãŸéŸ³æ¥½ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"

          npx claude-code --prompt "$PROMPT"
          
          # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "$MUSIC_DIR/opening-music.wav" ]; then
            echo "âœ… Opening music generated successfully"
            echo "music-url=$MUSIC_DIR/opening-music.wav" >> $GITHUB_OUTPUT
          else
            echo "âŒ Opening music generation failed"
            exit 1
          fi
          
          echo "::endgroup::"

  compose-opening-audio:
    runs-on: ubuntu-latest
    needs: [setup-branch, opening-planning, generate-opening-audio-and-music]
    permissions:
      contents: write
    outputs:
      final-opening-url: ${{ steps.compose.outputs.final-opening-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
      
      - name: ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°åˆæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: compose
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸšï¸ Opening Audio Composition Agent Execution"
          
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          FINAL_DIR="$FOLDER_NAME/final"
          
          # æœ€çµ‚å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$FINAL_DIR"
          
          VOICE_FILE="${{ needs.generate-opening-audio-and-music.outputs.voice-url }}"
          MUSIC_FILE="${{ needs.generate-opening-audio-and-music.outputs.music-url }}"
          
          PROMPT="FFmpegã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ã¨éŸ³æ¥½ã‚’åˆæˆã—ã€æœ€çµ‚çš„ãªã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«**: $VOICE_FILE
          **éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«**: $MUSIC_FILE
          **å‡ºåŠ›å…ˆ**: $FINAL_DIR/final-opening-audio.wav

          **åˆæˆè¦ä»¶**:
          1. èƒŒæ™¯éŸ³æ¥½ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’éŸ³å£°ã®40-50%ã«èª¿æ•´ï¼ˆã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ãªã®ã§éŸ³æ¥½ã‚’å°‘ã—ç›®ç«‹ãŸã›ã‚‹ï¼‰
          2. éŸ³å£°ã‚’ãƒ¡ã‚¤ãƒ³ã«ã€éŸ³æ¥½ã‚’èƒŒæ™¯ã¨ã—ã¦é…ç½®
          3. ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚’é©ç”¨
          4. éŸ³å£°ã®é•·ã•ã«åˆã‚ã›ã¦éŸ³æ¥½ã‚’ãƒ«ãƒ¼ãƒ—ã¾ãŸã¯ãƒˆãƒªãƒŸãƒ³ã‚°
          5. æœ€çµ‚çš„ãªéŸ³è³ªã¯é«˜å“è³ªã‚’ç¶­æŒ

          **FFmpegã‚³ãƒãƒ³ãƒ‰ä¾‹**:
          - éŸ³æ¥½ãƒœãƒªãƒ¥ãƒ¼ãƒ èª¿æ•´: -filter:a \"volume=0.4\"
          - éŸ³å£°ã¨éŸ³æ¥½ã®åˆæˆ: -filter_complex \"[1:a]volume=0.4[bg];[0:a][bg]amix=inputs=2[out]\"
          - ãƒ•ã‚§ãƒ¼ãƒ‰åŠ¹æœ: afade=in:st=0:d=1,afade=out:st=(duration-1):d=1

          éŸ³å£°ã¨éŸ³æ¥½ã‚’åˆæˆã—ã€é«˜å“è³ªãªã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚"

          npx claude-code --prompt "$PROMPT"
          
          # æœ€çµ‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "$FINAL_DIR/final-opening-audio.wav" ]; then
            echo "âœ… Final opening audio created successfully"
            echo "final-opening-url=$FINAL_DIR/final-opening-audio.wav" >> $GITHUB_OUTPUT
            
            # ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
            echo "ğŸ“Š File information:"
            ls -lh "$FINAL_DIR/final-opening-audio.wav"
            
            # éŸ³å£°æ™‚é–“ã‚’è¡¨ç¤º
            DURATION=$(ffprobe -v quiet -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$FINAL_DIR/final-opening-audio.wav" 2>/dev/null || echo "Unknown")
            echo "â±ï¸ Duration: ${DURATION}s"
          else
            echo "âŒ Final opening audio composition failed"
            exit 1
          fi
          
          echo "::endgroup::"

      - name: Commit and push results
        run: |
          git add .
          git commit -m "Add generated radio opening: ç¥å¨æ—¥å ±ãµã‚Šã‹ãˆã‚Šãƒ©ã‚¸ã‚ª" || echo "No changes to commit"
          git push origin ${{ needs.setup-branch.outputs.branch-name }}

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          gh pr create \
            --title "Add new AI-generated radio opening: ç¥å¨æ—¥å ±ãµã‚Šã‹ãˆã‚Šãƒ©ã‚¸ã‚ª" \
            --body "## ç”Ÿæˆã•ã‚ŒãŸãƒ©ã‚¸ã‚ªã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°

          **ç•ªçµ„ã‚¿ã‚¤ãƒˆãƒ«**: ç¥å¨æ—¥å ±ãµã‚Šã‹ãˆã‚Šãƒ©ã‚¸ã‚ª
          **ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã®é›°å›²æ°—**: ${{ inputs.opening_theme }}

          ### ğŸ“ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
          \`\`\`
          ${{ needs.setup-branch.outputs.folder-name }}/
          â”œâ”€â”€ planning/
          â”‚   â”œâ”€â”€ opening-script.txt      # ç”Ÿæˆã•ã‚ŒãŸã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°æœ¬
          â”‚   â”œâ”€â”€ voice-style.json        # éŸ³å£°ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
          â”‚   â”œâ”€â”€ music-prompt.txt        # éŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          â”‚   â””â”€â”€ opening-strategy.md     # åˆ¶ä½œæˆ¦ç•¥
          â”œâ”€â”€ audio/
          â”‚   â””â”€â”€ opening-voice.wav       # ç”Ÿæˆã•ã‚ŒãŸã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°
          â”œâ”€â”€ music/
          â”‚   â””â”€â”€ opening-music.wav       # ç”Ÿæˆã•ã‚ŒãŸã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³æ¥½
          â””â”€â”€ final/
              â””â”€â”€ final-opening-audio.wav # æœ€çµ‚åˆæˆã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°
          \`\`\`

          ğŸ¤– Generated with [Claude Code](https://claude.ai/code) & [kamuicode MCP](https://www.kamui.ai/ja)

          Co-Authored-By: Claude <noreply@anthropic.com>" \
            --head ${{ needs.setup-branch.outputs.branch-name }} \
            --base main