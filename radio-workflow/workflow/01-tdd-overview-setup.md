# 神威日報ラジオ番組 GitHub Actions TDD実装手順 - 第1部

**作成日**: 2025年7月31日 13:45 JST  
**最終更新**: 2025年7月31日 13:45 JST

## 概要
神威日報の更新を検知し、自動的にラジオ番組を制作・配信するGitHub Actionsワークフローを**TDD（テスト駆動開発）**アプローチで実装する手順です。

## 変更履歴

### v2.0.0 - 2025/07/31 13:45 JST
**TDD完全対応版**
- **BREAKING CHANGE**: 実装アプローチを従来手法からTDD（テスト駆動開発）に全面移行
- **追加**: TDDの3フェーズ（RED→GREEN→REFACTOR）サイクル導入
- **追加**: テスト環境セットアップ（act, Jest, モックサーバー）
- **追加**: 受け入れテスト定義（90秒ラジオ番組生成品質要件）
- **追加**: モジュール別単体テストケース（台本生成、音声生成、BGM生成、音声合成）
- **追加**: エラーハンドリングテストケース（API障害、リトライ、フォールバック）
- **追加**: 最小実装手順（ダミーデータから実装開始）
- **追加**: リファクタリング段階（実API呼び出しへの置き換え）
- **追加**: TDD実装チェックリスト（段階別進捗管理）
- **追加**: 品質向上指標（テストカバレッジ90%以上、実行時間監視）
- **追加**: 継続的改善プロセス（モニタリング、フィードバックループ）
- **改善**: 並列処理設計の詳細化（60%時間短縮効果の定量化）
- **改善**: エラーハンドリング強化（部分失敗対応、自動リトライ）
- **改善**: セキュリティ考慮事項の追加（シークレット管理、レート制限対策）

### v1.0.0 - 初版
- 基本的なGitHub Actionsワークフロー実装手順
- オーケストレータ + モジュール分割アーキテクチャ
- 並列処理による時間短縮設計
- エラーハンドリング基本実装

## TDD実装方針
1. **Red**: テストケースを先に作成し、失敗することを確認
2. **Green**: テストが通る最小限のコードを実装
3. **Refactor**: コードを改善しつつテストを維持

## 実装ステップ

### 0. TDDテスト環境セットアップ

#### 0.1 テストツール導入
```bash
# act - GitHub Actionsローカル実行ツール
curl https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash

# jest - ワークフロー検証用
npm install -g jest

# docker - actに必要
docker --version
```

#### 0.2 テスト用ディレクトリ構造
```
tests/
  workflows/
    unit/                 # 各モジュールの単体テスト
    integration/          # 統合テスト
    fixtures/            # テストデータ
      mock-responses/    # APIモックレスポンス
      sample-audio/      # サンプル音声ファイル
  scripts/
    test-runner.js       # テスト実行スクリプト
    mock-server.js       # モックAPIサーバー
```

### 1. 事前準備

#### 1.1 必要なシークレット設定
```
Repository Settings > Secrets and variables > Actions
```
- `AIVIS_API_KEY` - aivis-cloud-api認証キー（設定済み）
- `CLAUDE_CODE_OAUTH_TOKEN` - Claude Code認証トークン（設定済み）

#### 1.2 ディレクトリ構造準備
```
.github/
  workflows/
    kamui-daily-radio.yml
radio-workflow/
  scripts/
    generate-radio.js
  templates/
    script-template.json
  output/
    [生成されたファイル]
```

#### 1.3 ワークフローアーキテクチャ（ジョブ分割）

##### オーケストレータワークフロー
`orchestrator-kamui-daily-radio.yml` - メインの統合ワークフロー

##### モジュールワークフロー（並列処理対応）
1. **radio-planning** - 番組企画・台本生成
2. **voice-opening** - オープニング音声生成（並列）
3. **voice-main** - メイン音声生成（並列）
4. **voice-ending** - エンディング音声生成（並列）
5. **bgm-opening** - オープニングBGM生成（並列）
6. **bgm-main** - メインBGM生成（並列）
7. **bgm-ending** - エンディングBGM生成（並列）
8. **audio-mixing** - セクション別音声合成・最終統合

#### 1.4 ジョブ依存関係と並列処理

```
┌─────────────────┐
│  radio-planning │ （台本生成）
└────────┬────────┘
         │ outputs: script-data
    ┌────┴─────┬─────────┬─────────┬─────────┬─────────┬─────────┐
    ▼          ▼         ▼         ▼         ▼         ▼         ▼
┌─────────┐┌─────────┐┌─────────┐┌─────────┐┌─────────┐┌─────────┐
│voice    ││voice    ││voice    ││bgm      ││bgm      ││bgm      │ ← 6並列実行
│opening  ││main     ││ending   ││opening  ││main     ││ending   │
└────┬────┘└────┬────┘└────┬────┘└────┬────┘└────┬────┘└────┬────┘
     │          │         │         │         │         │
     └──────────┴─────────┴─────────┴─────────┴─────────┘
                                    │
                                    ▼
                            ┌─────────────┐
                            │audio-mixing │ （セクション別合成）
                            └─────────────┘
```

## TDD実装の全体像

### TDDの3フェーズサイクル
1. **RED** - 失敗するテストを書く
2. **GREEN** - テストを通す最小限の実装
3. **REFACTOR** - コードを改善する

### 実装による効果
**従来の逐次実装**
```
設計 → 実装 → テスト → デバッグ → 修正 = 時間かかる + バグ多発
```

**TDD実装**
```
テスト → 最小実装 → リファクタリング = 高品質 + メンテナンス性向上
```

### 並列処理による時間短縮効果

#### 逐次処理の場合（従来）
```
台本生成(2分) → 音声1(1分) → 音声2(1分) → 音声3(1分) → BGM1(1分) → BGM2(1分) → BGM3(1分) → 合成(1分) = 10分
```

#### 並列処理の場合（本設計）
```
台本生成(2分) → [音声1,2,3 + BGM1,2,3 並列](1分) → 合成(1分) = 4分
```

**約60%の時間短縮を実現**

---

**続きは第2部「TDDテストケース定義(RED Phase)」を参照**