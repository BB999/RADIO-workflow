name: Generate Voice Audio

on:
  workflow_call:
    inputs:
      branch_name:
        required: true
        type: string
      folder_name:
        required: true
        type: string
      radio_script:
        required: true
        type: string
      voice_style:
        required: true
        type: string
    outputs:
      voice_url:
        description: "Generated voice file URL"
        value: ${{ jobs.generate-voice.outputs.voice-url }}

jobs:
  generate-voice:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      voice-url: ${{ steps.voice-generation.outputs.voice-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Èü≥Â£∞ÁîüÊàê„Ç®„Éº„Ç∏„Çß„É≥„Éà
        id: voice-generation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AIVIS_API_KEY: ${{ secrets.AIVIS_API_KEY }}
        run: |
          echo "::group::üé§ Voice Generation Agent Execution"
          
          FOLDER_NAME="${{ inputs.folder_name }}"
          AUDIO_DIR="$FOLDER_NAME/audio"
          
          # Èü≥Â£∞„Éï„Ç©„É´„ÉÄ‰ΩúÊàê
          mkdir -p "$AUDIO_DIR"
          
          RADIO_SCRIPT="${{ inputs.radio_script }}"
          VOICE_STYLE="${{ inputs.voice_style }}"
          
          PROMPT="aivis-api„Çí‰ΩøÁî®„Åó„Å¶„É©„Ç∏„Ç™Èü≥Â£∞„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          **Âè∞Êú¨**: $RADIO_SCRIPT
          **Èü≥Â£∞Ë®≠ÂÆö**: $VOICE_STYLE
          **API Key**: Áí∞Â¢ÉÂ§âÊï∞AIVIS_API_KEY„Åã„ÇâÂèñÂæó

          **„Çø„Çπ„ÇØ**:
          1. aivis-apiÔºàhttps://api.aivis-project.com/v1/tts/synthesizeÔºâ„Çí‰Ωø„Å£„Å¶Èü≥Â£∞ÁîüÊàê
          2. È´òÈü≥Ë≥™WAVÂΩ¢Âºè„ÅßÂá∫Âäõ
          3. ÁîüÊàê„Åó„ÅüÈü≥Â£∞„Éï„Ç°„Ç§„É´„Çí„Äå$AUDIO_DIR/radio-voice.wav„Äç„Å´‰øùÂ≠ò
          4. Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆURL„ÇíÂá∫Âäõ

          aivis-api„ÅÆ‰ΩøÁî®ÊñπÊ≥ï:
          - „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà: POST https://api.aivis-project.com/v1/tts/synthesize
          - Authorization: Bearer \$AIVIS_API_KEY
          - model_uuid: a59cb814-0083-4369-8542-f51a29e72af7
          - output_format: wav
          - Âè∞Êú¨„ÉÜ„Ç≠„Çπ„Éà„Å®„Çπ„Çø„Ç§„É´Ë®≠ÂÆö„Çí‰ΩøÁî®

          Èü≥Â£∞„ÇíÁîüÊàê„Åó„ÄÅ„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"

          npx claude-code --prompt "$PROMPT"
          
          # Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
          if [ -f "$AUDIO_DIR/radio-voice.wav" ]; then
            echo "‚úÖ Voice generated successfully"
            echo "voice-url=$AUDIO_DIR/radio-voice.wav" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Voice generation failed"
            exit 1
          fi
          
          echo "::endgroup::"

      - name: Commit voice file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Add generated voice file" || echo "No changes to commit"
          git push origin ${{ inputs.branch_name }}