name: Generate Background Music

on:
  workflow_dispatch:
    inputs:
      branch_name:
        required: true
        type: string
      folder_name:
        required: true
        type: string
      music_prompt:
        required: true
        type: string

jobs:
  generate-music:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      music-url: ${{ steps.music-generation.outputs.music-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Èü≥Ê•ΩÁîüÊàê„Ç®„Éº„Ç∏„Çß„É≥„Éà
        id: music-generation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::üéµ Music Generation Agent Execution"
          
          FOLDER_NAME="${{ inputs.folder_name }}"
          MUSIC_DIR="$FOLDER_NAME/music"
          
          # Èü≥Ê•Ω„Éï„Ç©„É´„ÉÄ‰ΩúÊàê
          mkdir -p "$MUSIC_DIR"
          
          MUSIC_PROMPT="${{ inputs.music_prompt }}"
          
          PROMPT="kamuicode MCP„Çí‰ΩøÁî®„Åó„Å¶ËÉåÊôØÈü≥Ê•Ω„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          **Èü≥Ê•Ω„Éó„É≠„É≥„Éó„Éà**: $MUSIC_PROMPT
          **Âá∫ÂäõÈï∑„Åï**: Á¥Ñ60-90ÁßíÔºàÈü≥Â£∞„ÅÆ1ÂàÜÈñìÔºã‰ΩôË£ïÔºâ

          **„Çø„Çπ„ÇØ**:
          1. Google Lyria„Çí‰Ωø„Å£„Å¶ËÉåÊôØÈü≥Ê•Ω„ÇíÁîüÊàê
          2. Èü≥Â£∞„Å´ÈÅ©„Åó„Åü„Éú„É™„É•„Éº„É†„Éª„ÉÜ„É≥„Éù„ÅßÁîüÊàê
          3. ÁîüÊàê„Åó„ÅüÈü≥Ê•Ω„Éï„Ç°„Ç§„É´„Çí„Äå$MUSIC_DIR/background-music.wav„Äç„Å´‰øùÂ≠ò
          4. Èü≥Ê•Ω„Éï„Ç°„Ç§„É´„ÅÆURL„ÇíÂá∫Âäõ

          kamuicode MCP„ÅÆÈü≥Ê•ΩÁîüÊàêÊ©üËÉΩ„Çí‰ΩøÁî®„Åó„Å¶„ÄÅ„É©„Ç∏„Ç™Áï™ÁµÑ„Å´ÈÅ©„Åó„ÅüËÉåÊôØÈü≥Ê•Ω„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"

          npx claude-code --prompt "$PROMPT"
          
          # Èü≥Ê•Ω„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
          if [ -f "$MUSIC_DIR/background-music.wav" ]; then
            echo "‚úÖ Music generated successfully"
            echo "music-url=$MUSIC_DIR/background-music.wav" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Music generation failed"
            exit 1
          fi
          
          echo "::endgroup::"

      - name: Commit music file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Add generated music file" || echo "No changes to commit"
          git push origin ${{ inputs.branch_name }}