name: Create Full Radio Show (Opening + Main)

on:
  workflow_dispatch:
    inputs:
      opening_audio_path:
        description: 'ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆä¾‹: radio-opening-20250127-123456/final/final-opening-audio.wavï¼‰'
        required: true
        type: string
      main_audio_path:
        description: 'ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆä¾‹: radio-main-20250127-123456/final/final-main-audio.wavï¼‰'
        required: true
        type: string
      show_title:
        description: 'ç•ªçµ„ã‚¿ã‚¤ãƒˆãƒ«'
        required: true
        type: string

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      folder-name: ${{ steps.create-branch.outputs.folder-name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create branch for full radio show generation
        id: create-branch
        run: |
          BRANCH_NAME="radio-full/$(date +%Y%m%d)-${{ github.run_id }}"
          FOLDER_NAME="radio-full-$(date +%Y%m%d)-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin $BRANCH_NAME
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH_NAME"
          echo "Folder name: $FOLDER_NAME"

  validate-audio-files:
    runs-on: ubuntu-latest
    needs: [setup-branch]
    permissions:
      contents: write
    outputs:
      validation-completed: ${{ steps.validate.outputs.completed }}
      opening-duration: ${{ steps.validate.outputs.opening-duration }}
      main-duration: ${{ steps.validate.outputs.main-duration }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
          fetch-depth: 0
      
      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
      
      - name: éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ã¨ã‚³ãƒ”ãƒ¼
        id: validate
        run: |
          echo "::group::ğŸ” Audio Files Validation"
          
          OPENING_PATH="${{ inputs.opening_audio_path }}"
          MAIN_PATH="${{ inputs.main_audio_path }}"
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          INPUT_DIR="$FOLDER_NAME/input"
          
          # å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p "$INPUT_DIR"
          
          echo "Checking opening audio: $OPENING_PATH"
          echo "Checking main audio: $MAIN_PATH"
          
          # mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰æœ€æ–°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          git fetch origin main
          
          # ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªã¨ã‚³ãƒ”ãƒ¼
          git checkout origin/main -- "$OPENING_PATH" 2>/dev/null || {
            echo "âŒ Opening audio file not found in repository: $OPENING_PATH"
            echo "Note: Make sure the opening workflow has been merged to main branch"
            exit 1
          }
          
          if [ -f "$OPENING_PATH" ]; then
            echo "âœ… Opening audio file found"
            cp "$OPENING_PATH" "$INPUT_DIR/opening-audio.wav"
            OPENING_DURATION=$(ffprobe -v quiet -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$OPENING_PATH" 2>/dev/null || echo "0")
            echo "ğŸµ Opening duration: ${OPENING_DURATION}s"
            echo "opening-duration=$OPENING_DURATION" >> $GITHUB_OUTPUT
          else
            echo "âŒ Opening audio file not found after checkout: $OPENING_PATH"
            exit 1
          fi
          
          # ãƒ¡ã‚¤ãƒ³éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªã¨ã‚³ãƒ”ãƒ¼
          git checkout origin/main -- "$MAIN_PATH" 2>/dev/null || {
            echo "âŒ Main audio file not found in repository: $MAIN_PATH"
            echo "Note: Make sure the main content workflow has been merged to main branch"
            exit 1
          }
          
          if [ -f "$MAIN_PATH" ]; then
            echo "âœ… Main audio file found"
            cp "$MAIN_PATH" "$INPUT_DIR/main-audio.wav"
            MAIN_DURATION=$(ffprobe -v quiet -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$MAIN_PATH" 2>/dev/null || echo "0")
            echo "ğŸ“» Main duration: ${MAIN_DURATION}s"
            echo "main-duration=$MAIN_DURATION" >> $GITHUB_OUTPUT
          else
            echo "âŒ Main audio file not found after checkout: $MAIN_PATH"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"

  compose-full-radio-show:
    runs-on: ubuntu-latest
    needs: [setup-branch, validate-audio-files]
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
      
      - name: å®Œå…¨ç‰ˆãƒ©ã‚¸ã‚ªç•ªçµ„åˆæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "::group::ğŸšï¸ Full Radio Show Composition Agent Execution"
          
          FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
          FINAL_DIR="$FOLDER_NAME/final"
          
          # æœ€çµ‚å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
          mkdir -p "$FINAL_DIR"
          
          INPUT_DIR="$FOLDER_NAME/input"
          OPENING_FILE="$INPUT_DIR/opening-audio.wav"
          MAIN_FILE="$INPUT_DIR/main-audio.wav"
          SHOW_TITLE="${{ inputs.show_title }}"
          OPENING_DURATION="${{ needs.validate-audio-files.outputs.opening-duration }}"
          MAIN_DURATION="${{ needs.validate-audio-files.outputs.main-duration }}"
          
          PROMPT="FFmpegã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã¨ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’çµåˆã—ã€å®Œå…¨ç‰ˆã®ãƒ©ã‚¸ã‚ªç•ªçµ„ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°**: $OPENING_FILE ï¼ˆæ™‚é–“: ${OPENING_DURATION}ç§’ï¼‰
          **ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éŸ³å£°**: $MAIN_FILE ï¼ˆæ™‚é–“: ${MAIN_DURATION}ç§’ï¼‰
          **ç•ªçµ„ã‚¿ã‚¤ãƒˆãƒ«**: $SHOW_TITLE
          **å‡ºåŠ›å…ˆ**: $FINAL_DIR/full-radio-show.wav

          **çµåˆè¦ä»¶**:
          1. ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ã‚’æœ€åˆã«é…ç½®
          2. ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã¨ãƒ¡ã‚¤ãƒ³ã®é–“ã«0.5ç§’ã®ç„¡éŸ³ã‚’æŒ¿å…¥ï¼ˆè‡ªç„¶ãªé–“ã‚’ä½œã‚‹ï¼‰
          3. ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éŸ³å£°ã‚’ç¶šã‘ã¦é…ç½®
          4. å…¨ä½“ã®éŸ³é‡ãƒ¬ãƒ™ãƒ«ã‚’çµ±ä¸€
          5. æœ€çµ‚çš„ãªéŸ³è³ªã¯é«˜å“è³ªã‚’ç¶­æŒ
          6. ç•ªçµ„ã®æœ€å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚’é©ç”¨ï¼ˆ2ç§’é–“ï¼‰

          **FFmpegã‚³ãƒãƒ³ãƒ‰ä¾‹**:
          - éŸ³å£°çµåˆ: -filter_complex \"[0:a][1:a]concat=n=2:v=0:a=1[out]\"
          - ç„¡éŸ³æŒ¿å…¥: anullsrc=channel_layout=stereo:sample_rate=48000
          - éŸ³é‡çµ±ä¸€: volume=1.0
          - ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ: afade=out:st=(total_duration-2):d=2

          **è¿½åŠ ã‚¿ã‚¹ã‚¯**:
          1. çµåˆã—ãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
          2. ç•ªçµ„ã®ç·æ™‚é–“ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
          3. ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ï¼ˆã‚µã‚¤ã‚ºã€æ™‚é–“ãªã©ï¼‰ã‚’å‡ºåŠ›
          4. å“è³ªãƒã‚§ãƒƒã‚¯ç”¨ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã€Œ$FINAL_DIR/show-metadata.txtã€ã«ä¿å­˜

          å®Œå…¨ç‰ˆã®ãƒ©ã‚¸ã‚ªç•ªçµ„ã‚’é«˜å“è³ªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚"

          npx claude-code --prompt "$PROMPT"
          
          # æœ€çµ‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "$FINAL_DIR/full-radio-show.wav" ]; then
            echo "âœ… Full radio show created successfully"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
            echo "ğŸ“Š File information:"
            ls -lh "$FINAL_DIR/full-radio-show.wav"
            
            # éŸ³å£°æ™‚é–“ã‚’è¡¨ç¤º
            TOTAL_DURATION=$(ffprobe -v quiet -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$FINAL_DIR/full-radio-show.wav" 2>/dev/null || echo "Unknown")
            echo "â±ï¸ Total Duration: ${TOTAL_DURATION}s"
            
            # ç•ªçµ„æ§‹æˆæƒ…å ±ã‚’å‡ºåŠ›
            echo "ğŸ“» Show Composition:"
            echo "  - Opening: ${OPENING_DURATION}s"
            echo "  - Transition: 0.5s"
            echo "  - Main Content: ${MAIN_DURATION}s"
            echo "  - Fade Out: 2s"
            echo "  - Total: ${TOTAL_DURATION}s"
            
          else
            echo "âŒ Full radio show composition failed"
            exit 1
          fi
          
          echo "::endgroup::"

      - name: Commit and push results
        run: |
          git add .
          git commit -m "Add full radio show: ${{ inputs.show_title }}" || echo "No changes to commit"
          git push origin ${{ needs.setup-branch.outputs.branch-name }}

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          gh pr create \
            --title "Add full AI-generated radio show: ${{ inputs.show_title }}" \
            --body "## å®Œæˆã—ãŸãƒ©ã‚¸ã‚ªç•ªçµ„

          **ç•ªçµ„ã‚¿ã‚¤ãƒˆãƒ«**: ${{ inputs.show_title }}

          ### ğŸ“» ç•ªçµ„æ§‹æˆ
          - **ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°**: ${{ inputs.opening_audio_path }} (${{ needs.validate-audio-files.outputs.opening-duration }}ç§’)
          - **ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**: ${{ inputs.main_audio_path }} (${{ needs.validate-audio-files.outputs.main-duration }}ç§’)

          ### ğŸ“ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
          \`\`\`
          ${{ needs.setup-branch.outputs.folder-name }}/
          â””â”€â”€ final/
              â”œâ”€â”€ full-radio-show.wav     # å®Œæˆã—ãŸãƒ©ã‚¸ã‚ªç•ªçµ„
              â””â”€â”€ show-metadata.txt       # ç•ªçµ„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
          \`\`\`

          ### ğŸµ åˆ¶ä½œãƒ•ãƒ­ãƒ¼
          1. ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°éŸ³å£°ã¨ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éŸ³å£°ã®æ¤œè¨¼
          2. FFmpegã‚’ä½¿ç”¨ã—ãŸé«˜å“è³ªãªéŸ³å£°çµåˆ
          3. è‡ªç„¶ãªé–“ï¼ˆ0.5ç§’ï¼‰ã¨ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆ2ç§’ï¼‰ã®è¿½åŠ 
          4. éŸ³é‡ãƒ¬ãƒ™ãƒ«ã®çµ±ä¸€ã¨å“è³ªãƒã‚§ãƒƒã‚¯

          ğŸ¤– Generated with [Claude Code](https://claude.ai/code) & [kamuicode MCP](https://www.kamui.ai/ja)

          Co-Authored-By: Claude <noreply@anthropic.com>" \
            --head ${{ needs.setup-branch.outputs.branch-name }} \
            --base main