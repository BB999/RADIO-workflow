# ラジオワークフロー要件定義書

## 概要

神威日報ラジオ自動生成システムの包括的要件定義書です。この要件定義に基づいて、同一のワークフローシステムを構築することが可能です。

## システム全体構成

### 1. システム概要
- **システム名**: 神威日報ラジオ自動生成システム (Kamui Daily Radio Production)
- **目的**: 開発進捗レポートを基に、完全自動化されたラジオ番組を生成・配信
- **実行環境**: GitHub Actions
- **生成時間**: 約4分（240秒）のラジオ番組

### 2. 番組構成
- **オープニング**: 30秒（挨拶・番組紹介・楽曲紹介）
- **メイン前半**: 90秒（開発進捗の前半部分解説）
- **ジングル**: 10秒（「かむらじ」音声）
- **メイン後半**: 90秒（開発進捗の後半部分解説）
- **エンディング**: 20秒（まとめ・締めの挨拶）

## API・外部サービス要件

### 1. 必須APIキー
```yaml
secrets:
  AIVIS_API_KEY: "AIVIS Cloud API認証用トークン"
  CLAUDE_CODE_OAUTH_TOKEN: "Claude Code SDK認証用トークン"
  MCP_LYRIA_URL: "Google Lyria MCP サーバーURL"
  LINE_CHANNEL_ACCESS_TOKEN: "LINE通知用トークン（オプション）"
  LINE_USER_ID: "LINE通知先ユーザーID（オプション）"
```

### 2. 使用サービス詳細
- **AIVIS Cloud API**: 音声合成（TTS）
  - エンドポイント: `https://api.aivis-project.com/v1/tts/synthesize`
  - 形式: JSON POST リクエスト
  - 出力: WAV形式音声ファイル

- **Claude Code SDK**: 台本生成・スクリプト作成
  - パッケージ: `@anthropic-ai/claude-code`
  - 用途: 各セクションの台本自動生成

- **Google Lyria**: BGM自動生成
  - MCP サーバー経由でアクセス
  - ツール名: `mcp__t2m-google-lyria__lyria_generate`

## ディレクトリ構成要件

```
kamuicode-workflow/
├── .github/
│   └── workflows/
│       ├── orchestrator-kamui-daily-radio.yml     # メイン実行ワークフロー
│       ├── module-radio-planning.yml              # 台本生成モジュール
│       ├── module-voice-generation-*.yml          # 音声生成モジュール（5種）
│       ├── module-bgm-generation-*.yml           # BGM生成モジュール（5種）
│       ├── module-audio-mixing-*.yml             # 音声ミキシングモジュール（6種）
│       └── module-input-processing.yml           # 入力処理モジュール
└── radio-workflow/
    ├── UUID.md                                   # 音声合成用UUID一覧
    ├── ssml_formatter.js                         # SSML自動整形スクリプト
    ├── radio-personality-data.md                 # パーソナリティ設定
    ├── music/                                    # ユーザー楽曲ディレクトリ
    │   └── *.mp3                                # 楽曲ファイル（「楽曲名・アーティスト名.mp3」形式）
    ├── Jingle SE/                               # ジングルSE素材
    │   └── MusMus-JGL-*.mp3                     # ジングル効果音
    └── image/
        └── title.png                            # 動画生成用タイトル画像
```

## ワークフロー要件

### 1. メインオーケストレーターワークフロー

#### 入力パラメータ
```yaml
inputs:
  development-report:
    description: '神威アプリの開発進捗・最新情報'
    required: true
    type: string
  public:
    description: '公開設定'
    required: false
    type: boolean
    default: false
  gemini-summary:
    description: 'Geminiまとめ'
    required: false
    type: boolean
    default: false
```

#### 実行フロー
1. **API接続チェック**
   - AIVIS Cloud API の動作確認
   - 認証・接続テスト実行

2. **入力処理**（gemini-summary = true の場合）
   - Gemini CLI による入力情報の構造化処理

3. **台本生成**（並列実行）
   - オープニング台本生成
   - メイン前半台本生成
   - メイン後半台本生成
   - ジングル台本生成（固定テキスト「かむらじ」）
   - エンディング台本生成

4. **音声生成**（並列実行）
   - 5つの音声セクション同時生成
   - AIVIS Cloud API を使用

5. **BGM生成**（並列実行）
   - 5つのBGMセクション同時生成
   - Google Lyria を使用（ジングルのみSE素材使用）

6. **音声ミキシング**（段階的実行）
   - 各セクションの音声とBGMをミキシング
   - 最終統合ミキシング

7. **成果物出力**
   - プルリクエスト自動作成
   - LINE通知送信（設定されている場合）
   - サマリーレポート生成

### 2. 台本生成モジュール要件

#### 音楽ファイル選択処理
```bash
# radio-workflow/musicディレクトリからランダム選択
# ファイル命名規則: "楽曲名・アーティスト名.mp3"
# シード値: 現在時刻 + プロセスID + ランダム値
```

#### 音声UUID選択処理
```bash
# radio-workflow/UUID.mdからランダム選択
# 時刻ベースインデックス計算
```

#### 台本生成パターン
- **オープニング**: 1分（300-400文字）、明るい挨拶→番組紹介→楽曲紹介
- **メイン前半**: 3分（900-1200文字）、開発進捗の主要ポイント解説
- **メイン後半**: 3分（900-1200文字）、時事ニュースや追加情報、リスナーメッセージ
- **ジングル**: 固定テキスト「かむらじ」
- **エンディング**: 1分（300-400文字）、まとめと次回予告

#### SSML自動整形
```javascript
// ssml_formatter.js による自動ブレイク挿入
// 句読点・感嘆符・疑問符・改行に適切な間を設定
// 固有名詞の読み方変換（「神威日報」→「かむいにっぽう」、「神威」→「カムイ」）
```

### 3. 音声生成モジュール要件

#### AIVIS Cloud API 設定
```json
{
  "model_uuid": "ランダム選択されたUUID",
  "text": "SSML整形済みテキスト",
  "output_format": "wav",
  "speaking_rate": 1.2,
  "emotional_intensity": 1.5,
  "pitch": 0.1
}
```

#### 音声正規化処理
```bash
ffmpeg -i input.wav \
       -filter_complex "[0]loudnorm=I=-20:LRA=7:TP=-1[normalized]" \
       -map "[normalized]" \
       -ar 44100 -ac 2 -c:a pcm_s16le \
       output.wav
```

### 4. BGM生成モジュール要件

#### Google Lyria BGM生成パラメータ

##### オープニングBGM
```
長さ: 30秒
スタイル: 高速テンポのラジオオープニング、BPM180-200の疾走感あるテクノポップ
雰囲気: 朝のラジオの躍動感、番組開始の高揚感
楽器: パンチのあるシンセベース、アタック強めのキック、スピード感のあるハイハット
```

##### メインBGM
```
長さ: 60秒
スタイル: 親しみやすいトークBGM、BPM100-120の安定したテンポ
雰囲気: 聞きやすく邪魔にならない、温かみのある雰囲気
楽器: ソフトなアコースティックギター、軽やかなピアノ、控えめなパーカッション
```

##### エンディングBGM
```
長さ: 30秒
スタイル: 温かみのあるアコースティック、BPM90-110のゆったりテンポ
雰囲気: 安らぎと満足感、次回への期待
楽器: アコースティックギター主体、ソフトなストリングス
```

#### ジングルSE選択
```bash
# radio-workflow/Jingle SE/ ディレクトリからランダム選択
# MusMus-JGL-*.mp3 ファイル
```

### 5. 音声ミキシングモジュール要件

#### セクション別ミキシング設定

##### オープニングミキシング
```bash
# 音声フェードイン（0-3秒）
# BGM（0-6秒フル音量）→（6-11秒クロスフェード）→（11秒-楽曲フェードイン）
# 楽曲（11-16秒フェードイン）→（16-26秒フル音量）→（26-30秒フェードアウト）
# 音声（11-30秒）
```

##### メインセクションミキシング
```bash
# BGM（0-4秒フェードイン）→（4秒-終了5秒前）50%音量→（最後5秒フェードアウト）
# 音声（4秒開始）フル音量
```

##### ジングルミキシング
```bash
# SE（0-5秒フェードイン→フル音量）
# 音声（5秒遅延開始）
# SE（最後2秒フェードアウト）
```

##### エンディングミキシング
```bash
# BGM（0-4秒フェードイン）→（4-13秒50%音量）→（13-20秒フル音量フェードアウト）
# 音声（4-17秒）
```

#### 最終統合ミキシング
```bash
# セクション間無音区間
# オープニング → 1-2秒ランダム → メイン前半 → 0.5秒 → ジングル → 0.5秒 → メイン後半 → 0.5秒 → ジングル → 0.5秒 → エンディング

# 最終正規化: -23 LUFS（放送基準）
ffmpeg -filter_complex "loudnorm=I=-23:LRA=7:TP=-1"
```

### 6. 動画生成要件

```bash
# 静止画（radio-workflow/image/title.png）+ 音声で動画生成
ffmpeg -loop 1 -i title.png \
       -i final-radio.mp3 \
       -c:v libx264 \
       -tune stillimage \
       -c:a aac \
       -b:a 192k \
       -pix_fmt yuv420p \
       -shortest \
       final-radio-video.mp4
```

## データ・設定ファイル要件

### 1. UUID.md（音声合成用UUID一覧）
```
baaae3c0-7b22-4605-8ba5-80c959b41a48
a59cb814-0083-4369-8542-f51a29e72af7
```

### 2. radio-personality-data.md（パーソナリティ設定）
```markdown
# 神威日報ラジオ番組設計

## 音声設定（aivis-cloud-api）
### メインパーソナリティ: 神威（カムイ）
- **名前**: 神威（カムイ）
- **年齢**: 23歳
- **性格**: 明るくて親しみやすい、好奇心旺盛、少し天然で愛嬌がある
- **話し方**: テンポがよく聞きやすい、適度に感情豊か、親近感のある口調、一人称は僕
- **トーン**: フレンドリーで自然、技術解説もわかりやすく丁寧
```

### 3. ssml_formatter.js（SSML自動整形）
```javascript
class SSMLFormatter {
    constructor() {
        this.breakDurations = {
            period: 0.9,        // 句点「。」
            comma: 0.4,         // 読点「、」
            exclamation: 0.8,   // 感嘆符「！」
            question: 1.0,      // 疑問符「？」
            lineBreak: 1.1,     // 改行
            dialogue: 1.3,      // セリフ切り替わり
            ellipsis: 1.5,      // 「……」「…」
        };
    }
    // [フォーマット処理メソッド]
}
```

## システム構築手順

### 1. 前提条件
- GitHub Actionsが利用可能なリポジトリ
- 必須APIキーの取得・設定
- Node.js 20.x環境

### 2. 初期設定

#### GitHub Secrets設定
```bash
gh secret set AIVIS_API_KEY --body "your_aivis_api_key"
gh secret set CLAUDE_CODE_OAUTH_TOKEN --body "your_claude_token"
gh secret set MCP_LYRIA_URL --body "your_mcp_lyria_url"
gh secret set LINE_CHANNEL_ACCESS_TOKEN --body "your_line_token"  # オプション
gh secret set LINE_USER_ID --body "your_line_user_id"  # オプション
```

#### ディレクトリ・ファイル作成
```bash
mkdir -p .github/workflows
mkdir -p radio-workflow/{music,image,"Jingle SE"}

# 必須ファイルの配置
# - UUID.md（音声合成用UUID）
# - ssml_formatter.js（SSML整形スクリプト）
# - radio-personality-data.md（パーソナリティデータ）
# - title.png（タイトル画像）
# - 楽曲ファイル（*.mp3）
# - ジングルSEファイル（MusMus-JGL-*.mp3）
```

### 3. ワークフローファイル配置

#### 必要なワークフローファイル（20個）
```
orchestrator-kamui-daily-radio.yml          # メインオーケストレーター
module-radio-planning.yml                   # 台本生成
module-voice-generation-opening.yml         # 音声生成（オープニング）
module-voice-generation-main.yml           # 音声生成（メイン前半）
module-voice-generation-main-part2.yml     # 音声生成（メイン後半）
module-voice-generation-jingle.yml         # 音声生成（ジングル）
module-voice-generation-ending.yml         # 音声生成（エンディング）
module-bgm-generation-opening.yml          # BGM生成（オープニング）
module-bgm-generation-main.yml            # BGM生成（メイン前半）
module-bgm-generation-main-part2.yml      # BGM生成（メイン後半）
module-bgm-generation-jingle.yml          # BGM生成（ジングル）
module-bgm-generation-ending.yml          # BGM生成（エンディング）
module-audio-mixing-opening.yml           # 音声ミキシング（オープニング）
module-audio-mixing-main.yml              # 音声ミキシング（メイン前半）
module-audio-mixing-main-part2.yml        # 音声ミキシング（メイン後半）
module-audio-mixing-jingle.yml            # 音声ミキシング（ジングル）
module-audio-mixing-ending.yml            # 音声ミキシング（エンディング）
module-audio-mixing-final.yml             # 最終統合ミキシング
module-input-processing.yml               # 入力処理
```

### 4. 実行方法

#### 手動実行
```bash
gh workflow run orchestrator-kamui-daily-radio.yml \
  --field development-report="今日の開発進捗：新機能のUIを実装しました。ユーザー体験が大幅に向上し、アクセシビリティも改善されています。" \
  --field public=false \
  --field gemini-summary=false
```

#### 定期実行設定
```yaml
on:
  schedule:
    - cron: '0 9 * * *'  # 毎日9時実行
  workflow_dispatch:
    # 手動実行パラメータ
```

## 出力成果物

### 1. 生成ファイル
- `final-radio.mp3`: 完成したラジオ番組音声（240秒、-23 LUFS）
- `final-radio-video.mp4`: 静止画+音声の動画ファイル
- `metadata.json`: 番組メタデータ
- `USE_UUID.md`: 使用した音声UUID・楽曲情報

### 2. 自動プルリクエスト
- ブランチ名: `radio/daily-radio-YYYY-MM-DD-{run_id}`
- タイトル: `🎙️ 神威日報ラジオ - YYYY-MM-DD`
- 台本内容・統計情報・ファイル一覧を含むPR本文

### 3. 通知（LINE）
- ワークフロー実行結果
- 各ステップの成功/失敗状況
- エラー詳細（失敗時）

## トラブルシューティング

### 1. よくあるエラー

#### AIVIS API 認証エラー
```bash
HTTP 401: APIキーが無効または期限切れ
→ GitHub SecretsのAIVIS_API_KEYを確認
```

#### Claude Code実行エラー
```bash
CLAUDE_CODE_OAUTH_TOKEN認証失敗
→ トークンの有効性を確認
```

#### Google Lyria接続エラー
```bash
MCP_LYRIA_URL接続失敗
→ URLとMCPサーバー状態を確認
```

### 2. パフォーマンス最適化

#### 並列実行の最大活用
- 音声生成（5ジョブ同時実行）
- BGM生成（5ジョブ同時実行）
- 台本生成（5ジョブ同時実行）

#### リソース効率化
- アーティファクト保持期間: 1-7日
- 不要ファイルの自動削除
- タイムアウト設定（120秒）

### 3. 品質管理

#### 音声品質チェック
- ファイルサイズ検証（最小1000バイト）
- WAVE形式確認
- 音声正規化適用

#### BGM品質チェック
- 音声ファイル形式検証
- 最小長さチェック（10秒以上）
- 自動ループ拡張

## 運用・保守要件

### 1. 定期メンテナンス
- APIキーの有効期限確認（月次）
- 楽曲ファイルの更新（四半期）
- UUIDリストの更新（必要に応じて）

### 2. モニタリング
- ワークフロー実行成功率
- 各ステップの実行時間
- API利用状況

### 3. スケーラビリティ
- 楽曲数拡張（music/ディレクトリ）
- 音声モデル追加（UUID.md）
- パーソナリティ設定調整

## セキュリティ要件

### 1. 認証情報管理
- GitHub Secrets利用
- APIキーのローテーション
- 最小権限の原則

### 2. 出力制御
- プライベートリポジトリでの実行
- 公開設定による制御
- 生成ファイルのアクセス制限

この要件定義書に従って構築することで、同一機能を持つラジオワークフローシステムを再現できます。